import{playWave as k_,setWaveVolume as X1,stopMidi as N_,setMidiVolume as M1,playMidi as Y_}from"./deps.js";class M0{key=0n;next=null;prev=null;unlink(){if(this.prev!=null){if(this.prev.next=this.next,this.next)this.next.prev=this.prev;this.next=null,this.prev=null}}}class Y0 extends M0{next2=null;prev2=null;unlink2(){if(this.prev2!==null){if(this.prev2.next2=this.next2,this.next2)this.next2.prev2=this.prev2;this.next2=null,this.prev2=null}}}class K0{sentinel=new M0;cursor=null;constructor(){this.sentinel.next=this.sentinel,this.sentinel.prev=this.sentinel}push(_){if(_.prev)_.unlink();if(_.prev=this.sentinel.prev,_.next=this.sentinel,_.prev)_.prev.next=_;_.next.prev=_}addHead(_){if(_.prev)_.unlink();if(_.prev=this.sentinel,_.next=this.sentinel.next,_.prev.next=_,_.next)_.next.prev=_}pop(){let _=this.sentinel.next;if(_===this.sentinel)return null;return _?.unlink(),_}head(){let _=this.sentinel.next;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.next||null,_}tail(){let _=this.sentinel.prev;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.prev||null,_}next(){let _=this.cursor;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.next||null,_}prev(){let _=this.cursor;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.prev||null,_}clear(){while(!0){let _=this.sentinel.next;if(_===this.sentinel)return;_?.unlink()}}}var j0=async(_)=>new Promise((R)=>setTimeout(R,_)),v0=async(_)=>new Uint8Array(await(await fetch(_)).arrayBuffer());function f1(_,R,E,u,O){while(O--)E[u++]=_[R++]}function r1(_){let R=0n;for(let E=0;E<_.length;E++)R=R<<8n|BigInt(_[E]);return R}function y1(_){let R=[];while(_>0n)R.unshift(Number(_&0xffn)),_>>=8n;if(R[0]&128)R.unshift(0);return new Uint8Array(R)}function i1(_,R,E){let u=1n;while(R>0n){if(R%2n===1n)u=u*_%E;_=_*_%E,R>>=1n}return u}class P extends Y0{static CRC32_POLYNOMIAL=3988292384;static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static cacheMin=new K0;static cacheMid=new K0;static cacheMax=new K0;static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static{for(let _=0;_<32;_++)P.bitmask[_]=(1<<_)-1;P.bitmask[32]=4294967295;for(let _=0;_<256;_++){let R=_;for(let E=0;E<8;E++)if((R&1)===1)R=R>>>1^P.CRC32_POLYNOMIAL;else R>>>=1;P.crctable[_]=R}}static getcrc(_,R,E){let u=4294967295;for(let O=R;O<E;O++)u=u>>>8^this.crctable[(u^_[O])&255];return~u}static checkcrc(_,R,E,u=0){return P.getcrc(_,R,E)==u}view;data;pos=0;bitPos=0;random=null;constructor(_){if(!_)throw Error();super();if(_ instanceof Int8Array)this.data=new Uint8Array(_);else this.data=_;this.view=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}get length(){return this.view.byteLength}get available(){return this.view.byteLength-this.pos}static alloc(_){let R=null;if(_===0&&P.cacheMinCount>0)P.cacheMinCount--,R=P.cacheMin.pop();else if(_===1&&P.cacheMidCount>0)P.cacheMidCount--,R=P.cacheMid.pop();else if(_===2&&P.cacheMaxCount>0)P.cacheMaxCount--,R=P.cacheMax.pop();if(R)return R.pos=0,R;if(_===0)return new P(new Uint8Array(100));else if(_===1)return new P(new Uint8Array(5000));else return new P(new Uint8Array(30000))}release(){if(this.pos=0,this.length===100&&P.cacheMinCount<1000)P.cacheMin.push(this),P.cacheMinCount++;else if(this.length===5000&&P.cacheMidCount<250)P.cacheMid.push(this),P.cacheMidCount++;else if(this.length===30000&&P.cacheMaxCount<50)P.cacheMax.push(this),P.cacheMaxCount++}g1(){return this.view.getUint8(this.pos++)}g1b(){return this.view.getInt8(this.pos++)}g2(){let _=this.view.getUint16(this.pos);return this.pos+=2,_}g2b(){let _=this.view.getInt16(this.pos);return this.pos+=2,_}g3(){let _=this.view.getUint8(this.pos++)<<16|this.view.getUint16(this.pos);return this.pos+=2,_}g4(){let _=this.view.getInt32(this.pos);return this.pos+=4,_}g8(){let _=this.view.getBigInt64(this.pos);return this.pos+=8,_}gsmart(){return this.view.getUint8(this.pos)<128?this.g1()-64:this.g2()-49152}gsmarts(){return this.view.getUint8(this.pos)<128?this.g1():this.g2()-32768}gjstr(){let _=this.view,R=_.byteLength,E="",u;while((u=_.getUint8(this.pos++))!==10&&this.pos<R)E+=String.fromCharCode(u);return E}gdata(_,R,E){E.set(this.data.subarray(this.pos,this.pos+_),R),this.pos+=_}p1isaac(_){this.view.setUint8(this.pos++,_+(this.random?.nextInt??0)&255)}p1(_){this.view.setUint8(this.pos++,_)}p2(_){this.view.setUint16(this.pos,_),this.pos+=2}ip2(_){this.view.setUint16(this.pos,_,!0),this.pos+=2}p3(_){this.view.setUint8(this.pos++,_>>16),this.view.setUint16(this.pos,_),this.pos+=2}p4(_){this.view.setInt32(this.pos,_),this.pos+=4}ip4(_){this.view.setInt32(this.pos,_,!0),this.pos+=4}p8(_){this.view.setBigInt64(this.pos,_),this.pos+=8}pjstr(_){let R=this.view,E=_.length;for(let u=0;u<E;u++)R.setUint8(this.pos++,_.charCodeAt(u));R.setUint8(this.pos++,10)}pdata(_,R,E){this.data.set(_.subarray(E,E+R),this.pos),this.pos+=R-E}psize1(_){this.view.setUint8(this.pos-_-1,_)}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(_){let R=this.bitPos>>>3,E=8-(this.bitPos&7),u=0;this.bitPos+=_;for(;_>E;E=8)u+=(this.view.getUint8(R++)&P.bitmask[E])<<_-E,_-=E;if(_===E)u+=this.view.getUint8(R)&P.bitmask[E];else u+=this.view.getUint8(R)>>>E-_&P.bitmask[_];return u}rsaenc(_,R){let E=this.pos;this.pos=0;let u=new Uint8Array(E);this.gdata(E,0,u);let O=r1(u),b=i1(O,R,_),L=y1(b);this.pos=0,this.p1(L.length),this.pdata(L,L.length,0)}}class b0{static enabled=!1;static outBuffer=null;static oldBuffer=null;static lastTime=0;static trackedCount=0;static lastMoveTime=0;static lastX=0;static lastY=0;static setEnabled(){this.outBuffer=P.alloc(1),this.oldBuffer=null,this.lastTime=performance.now(),this.enabled=!0}static setDisabled(){this.enabled=!1,this.outBuffer=null,this.oldBuffer=null}static flush(){let _=null;if(this.oldBuffer&&this.enabled)_=this.oldBuffer;return this.oldBuffer=null,_}static stop(){let _=null;if(this.outBuffer&&this.outBuffer.pos>0&&this.enabled)_=this.outBuffer;return this.setDisabled(),_}static ensureCapacity(_){if(!this.outBuffer)return;if(this.outBuffer.pos+_>=500){let R=this.outBuffer;this.outBuffer=P.alloc(1),this.oldBuffer=R}}static mousePressed(_,R,E,u){if(!this.outBuffer)return;if(!this.enabled&&(_>=0&&_<789&&R>=0&&R<532))return;this.trackedCount++;let O=performance.now(),b=(O-this.lastTime)/10|0;if(b>250)b=250;if(this.lastTime=O,this.ensureCapacity(5),E===2)this.outBuffer.p1(1);else this.outBuffer.p1(2);this.outBuffer.p1(b),this.outBuffer.p3(_+(R<<10))}static mouseReleased(_,R){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let E=performance.now(),u=(E-this.lastTime)/10|0;if(u>250)u=250;if(this.lastTime=E,this.ensureCapacity(2),_===2)this.outBuffer.p1(3);else this.outBuffer.p1(4);this.outBuffer.p1(u)}static mouseMoved(_,R,E){if(!this.outBuffer)return;if(!this.enabled&&(_>=0&&_<789&&R>=0&&R<532))return;let u=performance.now();if(u-this.lastMoveTime<50)return;this.lastMoveTime=u,this.trackedCount++;let O=(u-this.lastTime)/10|0;if(O>250)O=250;if(this.lastTime=u,_-this.lastX<8&&_-this.lastX>=-8&&R-this.lastY<8&&R-this.lastY>=-8)this.ensureCapacity(3),this.outBuffer.p1(5),this.outBuffer.p1(O),this.outBuffer.p1(_+(R-this.lastY+8<<4)+8-this.lastX);else if(_-this.lastX<128&&_-this.lastX>=-128&&R-this.lastY<128&&R-this.lastY>=-128)this.ensureCapacity(4),this.outBuffer.p1(6),this.outBuffer.p1(O),this.outBuffer.p1(_+128-this.lastX),this.outBuffer.p1(R+128-this.lastY);else this.ensureCapacity(5),this.outBuffer.p1(7),this.outBuffer.p1(O),this.outBuffer.p3(_+(R<<10));this.lastX=_,this.lastY=R}static keyPressed(_){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let R=performance.now(),E=(R-this.lastTime)/10|0;if(E>250)E=250;if(this.lastTime=R,_===1000)_=11;else if(_===1001)_=12;else if(_===1002)_=14;else if(_===1003)_=15;else if(_>=1008)_-=992;this.ensureCapacity(3),this.outBuffer.p1(8),this.outBuffer.p1(E),this.outBuffer.p1(_)}static keyReleased(_){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let R=performance.now(),E=(R-this.lastTime)/10|0;if(E>250)E=250;if(this.lastTime=R,_===1000)_=11;else if(_===1001)_=12;else if(_===1002)_=14;else if(_===1003)_=15;else if(_>=1008)_-=992;this.ensureCapacity(3),this.outBuffer.p1(9),this.outBuffer.p1(E),this.outBuffer.p1(_)}static focusGained(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let _=performance.now(),R=(_-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer.p1(10),this.outBuffer.p1(R)}static focusLost(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let _=performance.now(),R=(_-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer.p1(11),this.outBuffer.p1(R)}static mouseEntered(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let _=performance.now(),R=(_-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer.p1(12),this.outBuffer.p1(R)}static mouseExited(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let _=performance.now(),R=(_-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer.p1(13),this.outBuffer.p1(R)}}var h1=["F11","F12"],z=new Map;z.set("ArrowLeft",{code:37,ch:1});z.set("ArrowRight",{code:39,ch:2});z.set("ArrowUp",{code:38,ch:3});z.set("ArrowDown",{code:40,ch:4});z.set("Control",{code:17,ch:5});z.set("Shift",{code:16,ch:6});z.set("Alt",{code:18,ch:7});z.set("Backspace",{code:8,ch:8});z.set("Tab",{code:9,ch:9});z.set("Enter",{code:10,ch:10});z.set("Escape",{code:27,ch:27});z.set(" ",{code:32,ch:32});z.set("Delete",{code:127,ch:127});z.set("Home",{code:36,ch:1000});z.set("End",{code:35,ch:1001});z.set("PageUp",{code:33,ch:1002});z.set("PageDown",{code:34,ch:1003});z.set("F1",{code:112,ch:1008});z.set("F2",{code:113,ch:1009});z.set("F3",{code:114,ch:1010});z.set("F4",{code:115,ch:1011});z.set("F5",{code:116,ch:1012});z.set("F6",{code:117,ch:1013});z.set("F7",{code:118,ch:1014});z.set("F8",{code:119,ch:1015});z.set("F9",{code:120,ch:1016});z.set("F10",{code:121,ch:1017});z.set("F11",{code:122,ch:1018});z.set("F12",{code:123,ch:1019});z.set("CapsLock",{code:20,ch:65535});z.set("Meta",{code:524,ch:65535});z.set("Insert",{code:155,ch:65535});z.set("`",{code:192,ch:96});z.set("~",{code:192,ch:126});z.set("!",{code:49,ch:33});z.set("@",{code:50,ch:64});z.set("#",{code:51,ch:35});z.set("£",{code:51,ch:163});z.set("$",{code:52,ch:36});z.set("%",{code:53,ch:37});z.set("^",{code:54,ch:94});z.set("&",{code:55,ch:38});z.set("*",{code:56,ch:42});z.set("(",{code:57,ch:40});z.set(")",{code:48,ch:41});z.set("-",{code:45,ch:45});z.set("_",{code:45,ch:95});z.set("=",{code:61,ch:61});z.set("+",{code:61,ch:43});z.set("[",{code:91,ch:91});z.set("{",{code:91,ch:123});z.set("]",{code:93,ch:93});z.set("}",{code:93,ch:125});z.set("\\",{code:92,ch:92});z.set("|",{code:92,ch:124});z.set(";",{code:59,ch:59});z.set(":",{code:59,ch:58});z.set("'",{code:222,ch:39});z.set('"',{code:222,ch:34});z.set(",",{code:44,ch:44});z.set("<",{code:44,ch:60});z.set(".",{code:46,ch:46});z.set(">",{code:46,ch:62});z.set("/",{code:47,ch:47});z.set("?",{code:47,ch:63});z.set("0",{code:48,ch:48});z.set("1",{code:49,ch:49});z.set("2",{code:50,ch:50});z.set("3",{code:51,ch:51});z.set("4",{code:52,ch:52});z.set("5",{code:53,ch:53});z.set("6",{code:54,ch:54});z.set("7",{code:55,ch:55});z.set("8",{code:56,ch:56});z.set("9",{code:57,ch:57});z.set("a",{code:65,ch:97});z.set("b",{code:66,ch:98});z.set("c",{code:67,ch:99});z.set("d",{code:68,ch:100});z.set("e",{code:69,ch:101});z.set("f",{code:70,ch:102});z.set("g",{code:71,ch:103});z.set("h",{code:72,ch:104});z.set("i",{code:73,ch:105});z.set("j",{code:74,ch:106});z.set("k",{code:75,ch:107});z.set("l",{code:76,ch:108});z.set("m",{code:77,ch:109});z.set("n",{code:78,ch:110});z.set("o",{code:79,ch:111});z.set("p",{code:80,ch:112});z.set("q",{code:81,ch:113});z.set("r",{code:82,ch:114});z.set("s",{code:83,ch:115});z.set("t",{code:84,ch:116});z.set("u",{code:85,ch:117});z.set("v",{code:86,ch:118});z.set("w",{code:87,ch:119});z.set("x",{code:88,ch:120});z.set("y",{code:89,ch:121});z.set("z",{code:90,ch:122});z.set("A",{code:65,ch:65});z.set("B",{code:66,ch:66});z.set("C",{code:67,ch:67});z.set("D",{code:68,ch:68});z.set("E",{code:69,ch:69});z.set("F",{code:70,ch:70});z.set("G",{code:71,ch:71});z.set("H",{code:72,ch:72});z.set("I",{code:73,ch:73});z.set("J",{code:74,ch:74});z.set("K",{code:75,ch:75});z.set("L",{code:76,ch:76});z.set("M",{code:77,ch:77});z.set("N",{code:78,ch:78});z.set("O",{code:79,ch:79});z.set("P",{code:80,ch:80});z.set("Q",{code:81,ch:81});z.set("R",{code:82,ch:82});z.set("S",{code:83,ch:83});z.set("T",{code:84,ch:84});z.set("U",{code:85,ch:85});z.set("V",{code:86,ch:86});z.set("W",{code:87,ch:87});z.set("X",{code:88,ch:88});z.set("Y",{code:89,ch:89});z.set("Z",{code:90,ch:90});var l=document.getElementById("canvas"),r=l.getContext("2d",{willReadFrequently:!0}),r0=document.createElement("canvas"),n0=document.createElement("img"),u1=r0.getContext("2d",{willReadFrequently:!0});var B1=["q","w","e","r","t","y","u","i","o","p","a","s","d","f","g","h","j","k","l","Shift","z","x","c","v","b","n","m","Del","123",","," ",".","Enter"],H_=["Q","W","E","R","T","Y","U","I","O","P","A","S","D","F","G","H","J","K","L","Shift","Z","X","C","V","B","N","M","Del","123",","," ",".","Enter"],Q_=["1","2","3","4","5","6","7","8","9","0","!",'"',"$","%","_","&","*","(",")","1/2","@","=","<",">","~",";",":","Del","abc","#"," ","?","Enter"],$_=["£","^","[","]","{","}","'","-","+","/","\\","|","","","","","","","","2/2","","","","","","","","Del","abc",""," ","","Enter"],s0=[0,10,19,28],f0=50,c0=30,J_=1000,x1=5,a1=75;function m_(){return document.fullscreenElement!==null}class t1{canvasKeyboard;nativeKeyboard;mode;constructor(){this.canvasKeyboard=new c1,this.nativeKeyboard=new d1;let _=localStorage.getItem("mobileKeyboardMode");if(_==="native")this.mode=1;else if(_==="canvas")this.mode=2;else this.mode=0}show(_,R,E,u){if(this.mode===0)if(m_())this.canvasKeyboard.show(_,R);else this.nativeKeyboard.show(E??_,u??R);else if(this.mode===2)this.canvasKeyboard.show(_,R);else if(this.mode===1)this.nativeKeyboard.show(E??_,u??R)}hide(){this.canvasKeyboard.hide(),this.nativeKeyboard.hide()}draw(){this.canvasKeyboard.draw()}isDisplayed(){return this.canvasKeyboard.isDisplayed()||this.nativeKeyboard.isDisplayed()}isWithinCanvasKeyboard(_,R){return this.canvasKeyboard.isDisplayed()&&this.canvasKeyboard.posWithinKeyboard(_,R)}captureMouseUp(_,R){if(this.canvasKeyboard.isDisplayed())return this.canvasKeyboard.captureMouseUp(_,R);else if(this.nativeKeyboard.isDisplayed())return this.nativeKeyboard.captureMouseUp(_,R);return!1}captureMouseDown(_,R){if(this.canvasKeyboard.isDisplayed())return this.canvasKeyboard.captureMouseDown(_,R);else if(this.nativeKeyboard.isDisplayed())return this.nativeKeyboard.captureMouseDown(_,R);return!1}notifyTouchMove(_,R){if(this.canvasKeyboard.isDisplayed())this.canvasKeyboard.notifyTouchMove(_,R);else if(this.nativeKeyboard.isDisplayed())this.nativeKeyboard.notifyTouchMove(_,R)}}class c1{displayed=!1;height=c0*4+10;width=f0*10+10;startX=0;startY=503-this.height;mode=0;animateBoxIndex=-1;animateBoxTimeout=0;touchStartAtX=0;touchStartAtY=0;touching=!1;touchStartTimestamp=0;getBoxColorForIndex(_){if(this.animateBoxIndex>-1){if(this.animateBoxIndex===_)return"#a6a6a6"}let R=this.getCharForIndex(_);if(R!==void 0&&R.length>1)return"#a9afba";return"#c8cdd1"}getBoxForIndex(_){let R=_<s0[1]?0:_<s0[2]?1:_<s0[3]?2:3,u={startX:(_-s0[R])*f0+5,startY:R*c0+5,width:f0,height:c0};if(R===1)u.startX+=f0/2;if(_===30)u.width*=6;if(_>30)u.startX+=f0*5;return u}getCharForIndex(_){if(this.mode===1)return H_[_];else if(this.mode===2)return Q_[_];else if(this.mode===3)return $_[_];return B1[_]}drawKeyBoxes(){for(let _=0;_<B1.length;_++){let R=this.getBoxForIndex(_);r.fillStyle=this.getBoxColorForIndex(_),r.beginPath(),r.roundRect(this.startX+R.startX+2,this.startY+R.startY+2,R.width-2,R.height-2,5),r.fill()}}drawKeyChars(){r.fillStyle="black",r.textAlign="center",r.textBaseline="middle";for(let _=0;_<B1.length;_++){r.font="16px Roboto, sans-serif";let R=this.getBoxForIndex(_),E=this.startX+R.startX+f0/2,u=this.startY+R.startY+c0/2+2,O=this.getCharForIndex(_);if(O.length>1)r.font="14px Roboto, sans-serif";r.fillText(O,E,u)}}drawBackground(){r.fillStyle="#dadde2",r.beginPath(),r.roundRect(this.startX,this.startY,this.width,this.height,5),r.fill()}draw(){if(!this.isDisplayed())return;r.save(),this.drawBackground(),this.drawKeyBoxes(),this.drawKeyChars(),r.restore()}show(_,R){this.mode=0,this.displayed=!0}hide(){this.displayed=!1}isDisplayed(){return this.displayed}posWithinKeyboard(_,R){let E=_>=this.startX&&_<this.startX+this.width,u=R>=this.startY&&R<this.startY+this.height;return E&&u}getBoxIndexForClick(_,R){let E=_-this.startX,u=R-this.startY;if(E<0||u<0||E>=this.width||u>=this.height)return-1;let O=Math.floor(u/c0),b=Math.floor(E/f0);if(O===0)return b;if(O===1){if(E<f0/2||E>this.width-f0/2)return-1;return s0[1]+Math.floor((E-f0/2)/f0)}if(O===2){if(b>=9)return-1;return s0[2]+b}return s0[3]+b}getCharForClick(_,R){let E=this.getBoxIndexForClick(_,R);if(E>-1){let u="";if(E>=30&&E<=35)u=" ";else if(E===36)u=this.getCharForIndex(31);else if(E===37)u="Enter";else u=this.getCharForIndex(E);if(u==="Del")u="Backspace";return u}return""}captureMouseDown(_,R){if(this.posWithinKeyboard(_,R))return!0;return!1}captureMouseUp(_,R){if(this.touching=!1,this.posWithinKeyboard(_,R)){let E=this.getBoxIndexForClick(_,R),u=this.getCharForClick(_,R);if(u==="Shift"){if(this.mode===0)this.mode=1;else this.mode=0;return!0}else if(u==="123"||u==="2/2")return this.mode=2,!0;else if(u==="1/2")return this.mode=3,!0;else if(u==="abc")return this.mode=0,!0;else if(u==="")return!0;let O=new KeyboardEvent("keydown",{key:u,code:u}),b=new KeyboardEvent("keyup",{key:u,code:u});if(l.dispatchEvent(O),l.dispatchEvent(b),!this.animateBoxTimeout){if(E>=30&&E<=35)this.animateBoxIndex=30;else if(E>35)this.animateBoxIndex=E-5;else this.animateBoxIndex=E;this.animateBoxTimeout=window.setTimeout(()=>{this.animateBoxIndex=-1,this.animateBoxTimeout=0},100)}return!0}return!1}notifyTouchMove(_,R){if(!this.posWithinKeyboard(_,R))return;if(this.touching&&performance.now()>this.touchStartTimestamp+J_){this.touching=!1;return}if(!this.touching){this.touching=!0,this.touchStartTimestamp=performance.now(),this.touchStartAtX=_-this.startX,this.touchStartAtY=R-this.startY;return}let E=Math.abs(Math.abs(this.touchStartAtX-_)-this.startX),u=Math.abs(Math.abs(this.touchStartAtY-R)-this.startY);if(E>a1||u>a1)return;if(E>x1||u>x1){let O=Math.max(0,Math.min(789-this.width,_-this.touchStartAtX)),b=Math.max(0,Math.min(532-this.height,R-this.touchStartAtY));this.startX=O,this.startY=b,l.dispatchEvent(new FocusEvent("focus"))}}}class d1{virtualInputElement;displayed=!1;isAndroid=!1;constructor(){if(this.isAndroid=navigator.userAgent.includes("Android"),this.virtualInputElement=document.createElement("input"),this.virtualInputElement.setAttribute("type","password"),this.virtualInputElement.setAttribute("autofocus","autofocus"),this.virtualInputElement.setAttribute("spellcheck","false"),this.virtualInputElement.setAttribute("autocomplete","off"),this.virtualInputElement.setAttribute("autocorrect","off"),this.virtualInputElement.setAttribute("autocapitalize","off"),this.virtualInputElement.setAttribute("style","position: fixed; top: 0px; left: 0px; width: 1px; height: 1px; opacity: 0;"),this.isAndroid)this.virtualInputElement.addEventListener("input",(_)=>{if(!(_ instanceof InputEvent))return;let R=_.data;if(R===null)return;if(_.inputType!=="insertText")return;l.dispatchEvent(new KeyboardEvent("keydown",{key:R,code:R})),l.dispatchEvent(new KeyboardEvent("keyup",{key:R,code:R}))}),this.virtualInputElement.addEventListener("keydown",(_)=>{if(_.key==="Enter"||_.key==="Backspace")l.dispatchEvent(new KeyboardEvent("keydown",{key:_.key,code:_.key}))}),this.virtualInputElement.addEventListener("keyup",(_)=>{if(_.key==="Enter"||_.key==="Backspace")l.dispatchEvent(new KeyboardEvent("keyup",{key:_.key,code:_.key}))});else this.virtualInputElement.addEventListener("keydown",(_)=>{l.dispatchEvent(new KeyboardEvent("keydown",{key:_.key,code:_.key}))}),this.virtualInputElement.addEventListener("keyup",(_)=>{l.dispatchEvent(new KeyboardEvent("keyup",{key:_.key,code:_.key}))});document.body.appendChild(this.virtualInputElement)}draw(){}show(_,R){if(_&&R)this.virtualInputElement.style.left=`${_}px`,this.virtualInputElement.style.top=`${R}px`;l.blur(),this.virtualInputElement.focus(),this.virtualInputElement.click(),this.displayed=!0}hide(){this.virtualInputElement.blur(),l.focus(),this.displayed=!1}isDisplayed(){return this.displayed}captureMouseUp(_,R){return!1}captureMouseDown(_,R){return!1}notifyTouchMove(_,R){return}}var F0=new t1;class I extends Y0{static pixels=new Int32Array;static width2d=0;static height2d=0;static top=0;static bottom=0;static left=0;static right=0;static boundX=0;static centerX2d=0;static centerY2d=0;static bind(_,R,E){this.pixels=_,this.width2d=R,this.height2d=E,this.setBounds(0,0,R,E)}static resetBounds(){this.left=0,this.top=0,this.right=this.width2d,this.bottom=this.height2d,this.boundX=this.right-1,this.centerX2d=this.right/2|0}static setBounds(_,R,E,u){if(_<0)_=0;if(R<0)R=0;if(E>this.width2d)E=this.width2d;if(u>this.height2d)u=this.height2d;this.top=R,this.bottom=u,this.left=_,this.right=E,this.boundX=this.right-1,this.centerX2d=this.right/2|0,this.centerY2d=this.bottom/2|0}static clear(){let _=this.width2d*this.height2d;for(let R=0;R<_;R++)this.pixels[R]=0}static drawRect(_,R,E,u,O){this.drawHorizontalLine(_,R,O,E),this.drawHorizontalLine(_,R+u-1,O,E),this.drawVerticalLine(_,R,O,u),this.drawVerticalLine(_+E-1,R,O,u)}static drawRectAlpha(_,R,E,u,O,b){if(this.drawHorizontalLineAlpha(_,R,O,E,b),this.drawHorizontalLineAlpha(_,R+u-1,O,E,b),u>=3)this.drawVerticalLineAlpha(_,R,O,u,b),this.drawVerticalLineAlpha(_+E-1,R,O,u,b)}static drawHorizontalLine(_,R,E,u){if(R<this.top||R>=this.bottom)return;if(_<this.left)u-=this.left-_,_=this.left;if(_+u>this.right)u=this.right-_;let O=_+R*this.width2d;for(let b=0;b<u;b++)this.pixels[O+b]=E}static drawHorizontalLineAlpha=(_,R,E,u,O)=>{if(R<this.top||R>=this.bottom)return;if(_<this.left)u-=this.left-_,_=this.left;if(_+u>this.right)u=this.right-_;let b=256-O,L=(E>>16&255)*O,N=(E>>8&255)*O,G=(E&255)*O,H=this.width2d-u,Q=_+R*this.width2d;for(let $=0;$<u;$++){let J=(this.pixels[Q]>>16&255)*b,T=(this.pixels[Q]>>8&255)*b,m=(this.pixels[Q]&255)*b,q=(L+J>>8<<16)+(N+T>>8<<8)+(G+m>>8);this.pixels[Q++]=q}};static drawVerticalLine(_,R,E,u){if(_<this.left||_>=this.right)return;if(R<this.top)u-=this.top-R,R=this.top;if(R+u>this.bottom)u=this.bottom-R;let O=_+R*this.width2d;for(let b=0;b<u;b++)this.pixels[O+b*this.width2d]=E}static drawVerticalLineAlpha=(_,R,E,u,O)=>{if(_<this.left||_>=this.right)return;if(R<this.top)u-=this.top-R,R=this.top;if(R+u>this.bottom)u=this.bottom-R;let b=256-O,L=(E>>16&255)*O,N=(E>>8&255)*O,G=(E&255)*O,H=_+R*this.width2d;for(let Q=0;Q<u;Q++){let $=(this.pixels[H]>>16&255)*b,J=(this.pixels[H]>>8&255)*b,T=(this.pixels[H]&255)*b,m=(L+$>>8<<16)+(N+J>>8<<8)+(G+T>>8);this.pixels[H]=m,H+=this.width2d}};static drawLine(_,R,E,u,O){let b=Math.abs(E-_),L=Math.abs(u-R),N=_<E?1:-1,G=R<u?1:-1,H=b-L;while(!0){if(_>=this.left&&_<this.right&&R>=this.top&&R<this.bottom)this.pixels[_+R*this.width2d]=O;if(_===E&&R===u)break;let Q=2*H;if(Q>-L)H=H-L,_=_+N;if(Q<b)H=H+b,R=R+G}}static fillRect2d(_,R,E,u,O){if(_<this.left)E-=this.left-_,_=this.left;if(R<this.top)u-=this.top-R,R=this.top;if(_+E>this.right)E=this.right-_;if(R+u>this.bottom)u=this.bottom-R;let b=this.width2d-E,L=_+R*this.width2d;for(let N=-u;N<0;N++){for(let G=-E;G<0;G++)this.pixels[L++]=O;L+=b}}static fillRectAlpha(_,R,E,u,O,b){if(_<this.left)E-=this.left-_,_=this.left;if(R<this.top)u-=this.top-R,R=this.top;if(_+E>this.right)E=this.right-_;if(R+u>this.bottom)u=this.bottom-R;let L=256-b,N=(O>>16&255)*b,G=(O>>8&255)*b,H=(O&255)*b,Q=this.width2d-E,$=_+R*this.width2d;for(let J=0;J<u;J++){for(let T=-E;T<0;T++){let m=(this.pixels[$]>>16&255)*L,q=(this.pixels[$]>>8&255)*L,K=(this.pixels[$]&255)*L,F=(N+m>>8<<16)+(G+q>>8<<8)+(H+K>>8);this.pixels[$++]=F}$+=Q}}static fillCircle(_,R,E,u,O){let b=256-O,L=(u>>16&255)*O,N=(u>>8&255)*O,G=(u&255)*O,H=R-E;if(H<0)H=0;let Q=R+E;if(Q>=this.height2d)Q=this.height2d-1;for(let $=H;$<=Q;$++){let J=$-R,T=Math.sqrt(E*E-J*J)|0,m=_-T;if(m<0)m=0;let q=_+T;if(q>=this.width2d)q=this.width2d-1;let K=m+$*this.width2d;for(let F=m;F<=q;F++){let w=(this.pixels[K]>>16&255)*b,k=(this.pixels[K]>>8&255)*b,Y=(this.pixels[K]&255)*b,A=(L+w>>8<<16)+(N+k>>8<<8)+(G+Y>>8);this.pixels[K++]=A}}}static setPixel(_,R,E){if(_<this.left||_>=this.right||R<this.top||R>=this.bottom)return;this.pixels[_+R*this.width2d]=E}}class G0 extends Y0{pixels;width2d;height2d;cropX;cropY;cropW;cropH;rgbPal;constructor(_,R,E){super();this.pixels=new Int8Array(_*R),this.width2d=this.cropW=_,this.height2d=this.cropH=R,this.cropX=this.cropY=0,this.rgbPal=E}static fromArchive(_,R,E=0){let u=new P(_.read(R+".dat")),O=new P(_.read("index.dat"));O.pos=u.g2();let b=O.g2(),L=O.g2(),N=O.g1(),G=new Int32Array(N);for(let K=1;K<N;K++)if(G[K]=O.g3(),G[K]===0)G[K]=1;for(let K=0;K<E;K++)O.pos+=2,u.pos+=O.g2()*O.g2(),O.pos+=1;if(u.pos>u.length||O.pos>O.length)throw Error();let H=O.g1(),Q=O.g1(),$=O.g2(),J=O.g2(),T=new G0($,J,G);T.cropX=H,T.cropY=Q,T.cropW=b,T.cropH=L;let m=T.pixels,q=O.g1();if(q===0){let K=T.width2d*T.height2d;for(let F=0;F<K;F++)m[F]=u.g1b()}else if(q===1){let{width2d:K,height2d:F}=T;for(let w=0;w<K;w++)for(let k=0;k<F;k++)m[w+k*K]=u.g1b()}return T}draw(_,R){_|=0,R|=0,_+=this.cropX,R+=this.cropY;let E=_+R*I.width2d,u=0,O=this.height2d,b=this.width2d,L=I.width2d-b,N=0;if(R<I.top){let G=I.top-R;O-=G,R=I.top,u+=G*b,E+=G*I.width2d}if(R+O>I.bottom)O-=R+O-I.bottom;if(_<I.left){let G=I.left-_;b-=G,_=I.left,u+=G,E+=G,N+=G,L+=G}if(_+b>I.right){let G=_+b-I.right;b-=G,N+=G,L+=G}if(b>0&&O>0)this.copyImage(b,O,this.pixels,u,N,I.pixels,E,L)}flipHorizontally(){let _=this.pixels,R=this.width2d,E=this.height2d;for(let u=0;u<E;u++){let O=R/2|0;for(let b=0;b<O;b++){let L=b+u*R,N=R-b-1+u*R,G=_[L];_[L]=_[N],_[N]=G}}}flipVertically(){let _=this.pixels,R=this.width2d,E=this.height2d;for(let u=0;u<(E/2|0);u++)for(let O=0;O<R;O++){let b=O+u*R,L=O+(E-u-1)*R,N=_[b];_[b]=_[L],_[L]=N}}translate2d(_,R,E){for(let u=0;u<this.rgbPal.length;u++){let O=this.rgbPal[u]>>16&255;if(O+=_,O<0)O=0;else if(O>255)O=255;let b=this.rgbPal[u]>>8&255;if(b+=R,b<0)b=0;else if(b>255)b=255;let L=this.rgbPal[u]&255;if(L+=E,L<0)L=0;else if(L>255)L=255;this.rgbPal[u]=(O<<16)+(b<<8)+L}}shrink(){this.cropW|=0,this.cropH|=0,this.cropW/=2,this.cropH/=2,this.cropW|=0,this.cropH|=0;let _=new Int8Array(this.cropW*this.cropH),R=0;for(let E=0;E<this.height2d;E++)for(let u=0;u<this.width2d;u++)_[(u+this.cropX>>1)+(E+this.cropY>>1)*this.cropW]=this.pixels[R++];this.pixels=_,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}crop(){if(this.width2d===this.cropW&&this.height2d===this.cropH)return;let _=new Int8Array(this.cropW*this.cropH),R=0;for(let E=0;E<this.height2d;E++)for(let u=0;u<this.width2d;u++)_[u+this.cropX+(E+this.cropY)*this.cropW]=this.pixels[R++];this.pixels=_,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}copyImage(_,R,E,u,O,b,L,N){let G=-(_>>2);_=-(_&3);for(let H=-R;H<0;H++){for(let Q=G;Q<0;Q++){let $=E[u++];if($===0)L++;else b[L++]=this.rgbPal[$&255];if($=E[u++],$===0)L++;else b[L++]=this.rgbPal[$&255];if($=E[u++],$===0)L++;else b[L++]=this.rgbPal[$&255];if($=E[u++],$===0)L++;else b[L++]=this.rgbPal[$&255]}for(let Q=_;Q<0;Q++){let $=E[u++];if($===0)L++;else b[L++]=this.rgbPal[$&255]}L+=N,u+=O}}clip(_,R,E,u){try{let O=this.width2d,b=this.height2d,L=0,N=0,G=(O<<16)/E|0,H=(b<<16)/u|0,Q=this.cropW,$=this.cropH,J=(Q<<16)/E|0,T=($<<16)/u|0;if(_=_+(this.cropX*E+Q-1)/Q|0,R=R+(this.cropY*u+$-1)/$|0,this.cropX*E%Q!=0)L=(Q-this.cropX*E%Q<<16)/E|0;if(this.cropY*u%$!=0)N=($-this.cropY*u%$<<16)/u|0;E=E*(this.width2d-(L>>16))/Q|0,u=u*(this.height2d-(N>>16))/$|0;let m=_+R*I.width2d,q=I.width2d-E,K;if(R<I.top)K=I.top-R,u-=K,R=0,m+=K*I.width2d,N+=T*K;if(R+u>I.bottom)u-=R+u-I.bottom;if(_<I.left)K=I.left-_,E-=K,_=0,m+=K,L+=J*K,q+=K;if(_+E>I.right)K=_+E-I.right,E-=K,q+=K;this.plot_scale(I.pixels,this.pixels,this.rgbPal,L,N,m,q,E,u,J,T,O)}catch(O){}}plot_scale(_,R,E,u,O,b,L,N,G,H,Q,$){try{let J=u;for(let T=-G;T<0;T++){let m=(O>>16)*$;for(let q=-N;q<0;q++){let K=R[(u>>16)+m];if(K==0)b++;else _[b++]=E[K&255];u+=H}O+=Q,u=J,b+=L}}catch(J){}}}class C extends Array{constructor(_,R){super(_);for(let E=0;E<_;E++)this[E]=R}}class S1 extends Array{constructor(_,R,E){super(_);for(let u=0;u<_;u++){this[u]=Array(R);for(let O=0;O<R;O++)this[u][O]=E}}}class d0 extends Array{constructor(_,R,E,u){super(_);for(let O=0;O<_;O++){this[O]=Array(R);for(let b=0;b<R;b++){this[O][b]=Array(E);for(let L=0;L<E;L++)this[O][b][L]=u}}}}class E1 extends Array{constructor(_,R,E,u,O){super(_);for(let b=0;b<_;b++){this[b]=Array(R);for(let L=0;L<R;L++){this[b][L]=Array(E);for(let N=0;N<E;N++){this[b][L][N]=Array(u);for(let G=0;G<u;G++)this[b][L][N][G]=O}}}}}class W0 extends Array{constructor(_,R,E){super(_);for(let u=0;u<_;u++){this[u]=Array(R);for(let O=0;O<R;O++)this[u][O]=new Uint8Array(E)}}}class h0 extends Array{constructor(_,R){super(_);for(let E=0;E<_;E++)this[E]=new Int32Array(R)}}class C0 extends Array{constructor(_,R,E){super(_);for(let u=0;u<_;u++){this[u]=Array(R);for(let O=0;O<R;O++)this[u][O]=new Int32Array(E)}}}class X extends I{static lowMemory=!1;static divTable=new Int32Array(512);static divTable2=new Int32Array(2048);static sinTable=new Int32Array(2048);static cosTable=new Int32Array(2048);static colourTable=new Int32Array(65536);static textures=new C(50,null);static textureCount=0;static lineOffset=new Int32Array;static centerX=0;static centerY=0;static jagged=!0;static clipX=!1;static alpha=0;static texelPool=null;static activeTexels=new C(50,null);static poolSize=0;static cycle=0;static textureCycle=new Int32Array(50);static texPal=new C(50,null);static opaque=!1;static textureTranslucent=new C(50,!1);static averageTextureRgb=new Int32Array(50);static{for(let _=1;_<512;_++)this.divTable[_]=32768/_|0;for(let _=1;_<2048;_++)this.divTable2[_]=65536/_|0;for(let _=0;_<2048;_++)this.sinTable[_]=Math.sin(_*0.0030679615757712823)*65536|0,this.cosTable[_]=Math.cos(_*0.0030679615757712823)*65536|0}static init2D(){this.lineOffset=new Int32Array(I.height2d);for(let _=0;_<I.height2d;_++)this.lineOffset[_]=I.width2d*_;this.centerX=I.width2d/2|0,this.centerY=I.height2d/2|0}static init3D(_,R){this.lineOffset=new Int32Array(R);for(let E=0;E<R;E++)this.lineOffset[E]=_*E;this.centerX=_/2|0,this.centerY=R/2|0}static clearTexels(){this.texelPool=null,this.activeTexels.fill(null)}static unpackTextures(_){this.textureCount=0;for(let R=0;R<50;R++)try{if(this.textures[R]=G0.fromArchive(_,R.toString()),this.lowMemory&&this.textures[R]?.cropW===128)this.textures[R]?.shrink();else this.textures[R]?.crop();this.textureCount++}catch(E){}}static getAverageTextureRgb(_){if(this.averageTextureRgb[_]!==0)return this.averageTextureRgb[_];let R=this.texPal[_];if(!R)return 0;let E=0,u=0,O=0,b=R.length;for(let N=0;N<b;N++)E+=R[N]>>16&255,u+=R[N]>>8&255,O+=R[N]&255;let L=((E/b|0)<<16)+((u/b|0)<<8)+(O/b|0);if(L=this.gammaCorrect(L,1.4),L===0)L=1;return this.averageTextureRgb[_]=L,L}static initColourTable(_){let R=_+Math.random()*0.03-0.015,E=0;for(let u=0;u<512;u++){let O=(u/8|0)/64+0.0078125,b=(u&7)/8+0.0625;for(let L=0;L<128;L++){let N=L/128,G=N,H=N,Q=N;if(b!==0){let q;if(N<0.5)q=N*(b+1);else q=N+b-N*b;let K=N*2-q,F=O+0.3333333333333333;if(F>1)F--;let w=O-0.3333333333333333;if(w<0)w++;if(F*6<1)G=K+(q-K)*6*F;else if(F*2<1)G=q;else if(F*3<2)G=K+(q-K)*(0.6666666666666666-F)*6;else G=K;if(O*6<1)H=K+(q-K)*6*O;else if(O*2<1)H=q;else if(O*3<2)H=K+(q-K)*(0.6666666666666666-O)*6;else H=K;if(w*6<1)Q=K+(q-K)*6*w;else if(w*2<1)Q=q;else if(w*3<2)Q=K+(q-K)*(0.6666666666666666-w)*6;else Q=K}let $=G*256|0,J=H*256|0,T=Q*256|0,m=($<<16)+(J<<8)+T;this.colourTable[E++]=this.gammaCorrect(m,R)}}for(let u=0;u<50;u++){let O=this.textures[u];if(!O)continue;let b=O.rgbPal;this.texPal[u]=new Int32Array(b.length);for(let L=0;L<b.length;L++){let N=this.texPal[u];if(!N)continue;N[L]=this.gammaCorrect(b[L],R)}}for(let u=0;u<50;u++)this.pushTexture(u)}static gammaCorrect(_,R){let E=(_>>16)/256,u=(_>>8&255)/256,O=(_&255)/256,b=Math.pow(E,R),L=Math.pow(u,R),N=Math.pow(O,R),G=b*256|0,H=L*256|0,Q=N*256|0;return(G<<16)+(H<<8)+Q}static initPool(_){if(this.texelPool)return;if(this.poolSize=_,this.lowMemory)this.texelPool=new h0(_,16384);else this.texelPool=new h0(_,65536);this.activeTexels.fill(null)}static pushTexture(_){if(this.activeTexels[_]&&this.texelPool)this.texelPool[this.poolSize++]=this.activeTexels[_],this.activeTexels[_]=null}static getTexels(_){if(this.textureCycle[_]=this.cycle++,this.activeTexels[_])return this.activeTexels[_];let R;if(this.poolSize>0&&this.texelPool)R=this.texelPool[--this.poolSize],this.texelPool[this.poolSize]=null;else{let O=0,b=-1;for(let L=0;L<this.textureCount;L++)if(this.activeTexels[L]&&(this.textureCycle[L]<O||b===-1))O=this.textureCycle[L],b=L;R=this.activeTexels[b],this.activeTexels[b]=null}this.activeTexels[_]=R;let E=this.textures[_],u=this.texPal[_];if(!R||!E||!u)return null;if(this.lowMemory){this.textureTranslucent[_]=!1;for(let O=0;O<4096;O++){let b=R[O]=u[E.pixels[O]]&16316671;if(b===0)this.textureTranslucent[_]=!0;R[O+4096]=b-(b>>>3)&16316671,R[O+8192]=b-(b>>>2)&16316671,R[O+12288]=b-(b>>>2)-(b>>>3)&16316671}}else{if(E.width2d===64)for(let O=0;O<128;O++)for(let b=0;b<128;b++)R[b+(O<<7|0)]=u[E.pixels[(b>>1)+(O>>1<<6|0)]];else for(let O=0;O<16384;O++)R[O]=u[E.pixels[O]];this.textureTranslucent[_]=!1;for(let O=0;O<16384;O++){R[O]&=16316671;let b=R[O];if(b===0)this.textureTranslucent[_]=!0;R[O+16384]=b-(b>>>3)&16316671,R[O+32768]=b-(b>>>2)&16316671,R[O+49152]=b-(b>>>2)-(b>>>3)&16316671}}return R}static gouraudTriangle(_,R,E,u,O,b,L,N,G){let H=0,Q=0;if(O!==u)H=(R-_<<16)/(O-u)|0,Q=(N-L<<15)/(O-u)|0;let $=0,J=0;if(b!==O)$=(E-R<<16)/(b-O)|0,J=(G-N<<15)/(b-O)|0;let T=0,m=0;if(b!==u)T=(_-E<<16)/(u-b)|0,m=(L-G<<15)/(u-b)|0;if(u<=O&&u<=b){if(u<I.bottom){if(O>I.bottom)O=I.bottom;if(b>I.bottom)b=I.bottom;if(O<b){if(E=_<<=16,G=L<<=15,u<0)E-=T*u,_-=H*u,G-=m*u,L-=Q*u,u=0;if(R<<=16,N<<=15,O<0)R-=$*O,N-=J*O,O=0;if(u!==O&&T<H||u===O&&T>$){b-=O,O-=u,u=X.lineOffset[u];while(!0){if(O--,O<0)while(!0){if(b--,b<0)return;this.gouraudRaster(E>>16,R>>16,G>>7,N>>7,I.pixels,u,0),E+=T,R+=$,G+=m,N+=J,u+=I.width2d}this.gouraudRaster(E>>16,_>>16,G>>7,L>>7,I.pixels,u,0),E+=T,_+=H,G+=m,L+=Q,u+=I.width2d}}else{b-=O,O-=u,u=X.lineOffset[u];while(!0){if(O--,O<0)while(!0){if(b--,b<0)return;this.gouraudRaster(R>>16,E>>16,N>>7,G>>7,I.pixels,u,0),E+=T,R+=$,G+=m,N+=J,u+=I.width2d}this.gouraudRaster(_>>16,E>>16,L>>7,G>>7,I.pixels,u,0),E+=T,_+=H,G+=m,L+=Q,u+=I.width2d}}}else{if(R=_<<=16,N=L<<=15,u<0)R-=T*u,_-=H*u,N-=m*u,L-=Q*u,u=0;if(E<<=16,G<<=15,b<0)E-=$*b,G-=J*b,b=0;if(u!==b&&T<H||u===b&&$>H){O-=b,b-=u,u=X.lineOffset[u];while(!0){if(b--,b<0)while(!0){if(O--,O<0)return;this.gouraudRaster(E>>16,_>>16,G>>7,L>>7,I.pixels,u,0),E+=$,_+=H,G+=J,L+=Q,u+=I.width2d}this.gouraudRaster(R>>16,_>>16,N>>7,L>>7,I.pixels,u,0),R+=T,_+=H,N+=m,L+=Q,u+=I.width2d}}else{O-=b,b-=u,u=X.lineOffset[u];while(!0){if(b--,b<0)while(!0){if(O--,O<0)return;this.gouraudRaster(_>>16,E>>16,L>>7,G>>7,I.pixels,u,0),E+=$,_+=H,G+=J,L+=Q,u+=I.width2d}this.gouraudRaster(_>>16,R>>16,L>>7,N>>7,I.pixels,u,0),R+=T,_+=H,N+=m,L+=Q,u+=I.width2d}}}}}else if(O<=b){if(O<I.bottom){if(b>I.bottom)b=I.bottom;if(u>I.bottom)u=I.bottom;if(b<u){if(_=R<<=16,L=N<<=15,O<0)_-=H*O,R-=$*O,L-=Q*O,N-=J*O,O=0;if(E<<=16,G<<=15,b<0)E-=T*b,G-=m*b,b=0;if(O!==b&&H<$||O===b&&H>T){u-=b,b-=O,O=X.lineOffset[O];while(!0){if(b--,b<0)while(!0){if(u--,u<0)return;this.gouraudRaster(_>>16,E>>16,L>>7,G>>7,I.pixels,O,0),_+=H,E+=T,L+=Q,G+=m,O+=I.width2d}this.gouraudRaster(_>>16,R>>16,L>>7,N>>7,I.pixels,O,0),_+=H,R+=$,L+=Q,N+=J,O+=I.width2d}}else{u-=b,b-=O,O=X.lineOffset[O];while(!0){if(b--,b<0)while(!0){if(u--,u<0)return;this.gouraudRaster(E>>16,_>>16,G>>7,L>>7,I.pixels,O,0),_+=H,E+=T,L+=Q,G+=m,O+=I.width2d}this.gouraudRaster(R>>16,_>>16,N>>7,L>>7,I.pixels,O,0),_+=H,R+=$,L+=Q,N+=J,O+=I.width2d}}}else{if(E=R<<=16,G=N<<=15,O<0)E-=H*O,R-=$*O,G-=Q*O,N-=J*O,O=0;if(_<<=16,L<<=15,u<0)_-=T*u,L-=m*u,u=0;if(b-=u,u-=O,O=X.lineOffset[O],H<$)while(!0){if(u--,u<0)while(!0){if(b--,b<0)return;this.gouraudRaster(_>>16,R>>16,L>>7,N>>7,I.pixels,O,0),_+=T,R+=$,L+=m,N+=J,O+=I.width2d}this.gouraudRaster(E>>16,R>>16,G>>7,N>>7,I.pixels,O,0),E+=H,R+=$,G+=Q,N+=J,O+=I.width2d}else while(!0){if(u--,u<0)while(!0){if(b--,b<0)return;this.gouraudRaster(R>>16,_>>16,N>>7,L>>7,I.pixels,O,0),_+=T,R+=$,L+=m,N+=J,O+=I.width2d}this.gouraudRaster(R>>16,E>>16,N>>7,G>>7,I.pixels,O,0),E+=H,R+=$,G+=Q,N+=J,O+=I.width2d}}}}else if(b<I.bottom){if(u>I.bottom)u=I.bottom;if(O>I.bottom)O=I.bottom;if(u<O){if(R=E<<=16,N=G<<=15,b<0)R-=$*b,E-=T*b,N-=J*b,G-=m*b,b=0;if(_<<=16,L<<=15,u<0)_-=H*u,L-=Q*u,u=0;if(O-=u,u-=b,b=X.lineOffset[b],$<T)while(!0){if(u--,u<0)while(!0){if(O--,O<0)return;this.gouraudRaster(R>>16,_>>16,N>>7,L>>7,I.pixels,b,0),R+=$,_+=H,N+=J,L+=Q,b+=I.width2d}this.gouraudRaster(R>>16,E>>16,N>>7,G>>7,I.pixels,b,0),R+=$,E+=T,N+=J,G+=m,b+=I.width2d}else while(!0){if(u--,u<0)while(!0){if(O--,O<0)return;this.gouraudRaster(_>>16,R>>16,L>>7,N>>7,I.pixels,b,0),R+=$,_+=H,N+=J,L+=Q,b+=I.width2d}this.gouraudRaster(E>>16,R>>16,G>>7,N>>7,I.pixels,b,0),R+=$,E+=T,N+=J,G+=m,b+=I.width2d}}else{if(_=E<<=16,L=G<<=15,b<0)_-=$*b,E-=T*b,L-=J*b,G-=m*b,b=0;if(R<<=16,N<<=15,O<0)R-=H*O,N-=Q*O,O=0;if(u-=O,O-=b,b=X.lineOffset[b],$<T)while(!0){if(O--,O<0)while(!0){if(u--,u<0)return;this.gouraudRaster(R>>16,E>>16,N>>7,G>>7,I.pixels,b,0),R+=H,E+=T,N+=Q,G+=m,b+=I.width2d}this.gouraudRaster(_>>16,E>>16,L>>7,G>>7,I.pixels,b,0),_+=$,E+=T,L+=J,G+=m,b+=I.width2d}else while(!0){if(O--,O<0)while(!0){if(u--,u<0)return;this.gouraudRaster(E>>16,R>>16,G>>7,N>>7,I.pixels,b,0),R+=H,E+=T,N+=Q,G+=m,b+=I.width2d}this.gouraudRaster(E>>16,_>>16,G>>7,L>>7,I.pixels,b,0),_+=$,E+=T,L+=J,G+=m,b+=I.width2d}}}}static gouraudRaster(_,R,E,u,O,b,L){let N;if(X.jagged){let G;if(X.clipX){if(R-_>3)G=(u-E)/(R-_)|0;else G=0;if(R>I.boundX)R=I.boundX;if(_<0)E-=_*G,_=0;if(_>=R)return;b+=_,L=R-_>>2,G<<=2}else if(_<R)if(b+=_,L=R-_>>2,L>0)G=(u-E)*X.divTable[L]>>15;else G=0;else return;if(X.alpha===0)while(!0){if(L--,L<0){if(L=R-_&3,L>0){N=X.colourTable[E>>8];do O[b++]=N,L--;while(L>0);return}break}N=X.colourTable[E>>8],E+=G,O[b++]=N,O[b++]=N,O[b++]=N,O[b++]=N}else{let H=X.alpha,Q=256-X.alpha;while(!0){if(L--,L<0){if(L=R-_&3,L>0){N=X.colourTable[E>>8],N=((N&16711935)*Q>>8&16711935)+((N&65280)*Q>>8&65280);do O[b++]=N+((O[b]&16711935)*H>>8&16711935)+((O[b]&65280)*H>>8&65280),L--;while(L>0)}break}N=X.colourTable[E>>8],E+=G,N=((N&16711935)*Q>>8&16711935)+((N&65280)*Q>>8&65280),O[b++]=N+((O[b]&16711935)*H>>8&16711935)+((O[b]&65280)*H>>8&65280),O[b++]=N+((O[b]&16711935)*H>>8&16711935)+((O[b]&65280)*H>>8&65280),O[b++]=N+((O[b]&16711935)*H>>8&16711935)+((O[b]&65280)*H>>8&65280),O[b++]=N+((O[b]&16711935)*H>>8&16711935)+((O[b]&65280)*H>>8&65280)}}}else if(_<R){let G=(u-E)/(R-_)|0;if(X.clipX){if(R>I.boundX)R=I.boundX;if(_<0)E-=_*G,_=0;if(_>=R)return}if(b+=_,L=R-_,X.alpha===0)do O[b++]=X.colourTable[E>>8],E+=G,L--;while(L>0);else{let H=X.alpha,Q=256-X.alpha;do N=X.colourTable[E>>8],E+=G,N=((N&16711935)*Q>>8&16711935)+((N&65280)*Q>>8&65280),O[b++]=N+((O[b]&16711935)*H>>8&16711935)+((O[b]&65280)*H>>8&65280),L--;while(L>0)}}}static flatTriangle(_,R,E,u,O,b,L){let N=0;if(O!==u)N=(R-_<<16)/(O-u)|0;let G=0;if(b!==O)G=(E-R<<16)/(b-O)|0;let H=0;if(b!==u)H=(_-E<<16)/(u-b)|0;if(u<=O&&u<=b){if(u<I.bottom){if(O>I.bottom)O=I.bottom;if(b>I.bottom)b=I.bottom;if(O<b){if(E=_<<=16,u<0)E-=H*u,_-=N*u,u=0;if(R<<=16,O<0)R-=G*O,O=0;if(u!==O&&H<N||u===O&&H>G){b-=O,O-=u,u=this.lineOffset[u];while(!0){if(O--,O<0)while(!0){if(b--,b<0)return;this.flatRaster(E>>16,R>>16,I.pixels,u,L),E+=H,R+=G,u+=I.width2d}this.flatRaster(E>>16,_>>16,I.pixels,u,L),E+=H,_+=N,u+=I.width2d}}else{b-=O,O-=u,u=this.lineOffset[u];while(!0){if(O--,O<0)while(!0){if(b--,b<0)return;this.flatRaster(R>>16,E>>16,I.pixels,u,L),E+=H,R+=G,u+=I.width2d}this.flatRaster(_>>16,E>>16,I.pixels,u,L),E+=H,_+=N,u+=I.width2d}}}else{if(R=_<<=16,u<0)R-=H*u,_-=N*u,u=0;if(E<<=16,b<0)E-=G*b,b=0;if(u!==b&&H<N||u===b&&G>N){O-=b,b-=u,u=this.lineOffset[u];while(!0){if(b--,b<0)while(!0){if(O--,O<0)return;this.flatRaster(E>>16,_>>16,I.pixels,u,L),E+=G,_+=N,u+=I.width2d}this.flatRaster(R>>16,_>>16,I.pixels,u,L),R+=H,_+=N,u+=I.width2d}}else{O-=b,b-=u,u=this.lineOffset[u];while(!0){if(b--,b<0)while(!0){if(O--,O<0)return;this.flatRaster(_>>16,E>>16,I.pixels,u,L),E+=G,_+=N,u+=I.width2d}this.flatRaster(_>>16,R>>16,I.pixels,u,L),R+=H,_+=N,u+=I.width2d}}}}}else if(O<=b){if(O<I.bottom){if(b>I.bottom)b=I.bottom;if(u>I.bottom)u=I.bottom;if(b<u){if(_=R<<=16,O<0)_-=N*O,R-=G*O,O=0;if(E<<=16,b<0)E-=H*b,b=0;if(O!==b&&N<G||O===b&&N>H){u-=b,b-=O,O=this.lineOffset[O];while(!0){if(b--,b<0)while(!0){if(u--,u<0)return;this.flatRaster(_>>16,E>>16,I.pixels,O,L),_+=N,E+=H,O+=I.width2d}this.flatRaster(_>>16,R>>16,I.pixels,O,L),_+=N,R+=G,O+=I.width2d}}else{u-=b,b-=O,O=this.lineOffset[O];while(!0){if(b--,b<0)while(!0){if(u--,u<0)return;this.flatRaster(E>>16,_>>16,I.pixels,O,L),_+=N,E+=H,O+=I.width2d}this.flatRaster(R>>16,_>>16,I.pixels,O,L),_+=N,R+=G,O+=I.width2d}}}else{if(E=R<<=16,O<0)E-=N*O,R-=G*O,O=0;if(_<<=16,u<0)_-=H*u,u=0;if(N<G){b-=u,u-=O,O=this.lineOffset[O];while(!0){if(u--,u<0)while(!0){if(b--,b<0)return;this.flatRaster(_>>16,R>>16,I.pixels,O,L),_+=H,R+=G,O+=I.width2d}this.flatRaster(E>>16,R>>16,I.pixels,O,L),E+=N,R+=G,O+=I.width2d}}else{b-=u,u-=O,O=this.lineOffset[O];while(!0){if(u--,u<0)while(!0){if(b--,b<0)return;this.flatRaster(R>>16,_>>16,I.pixels,O,L),_+=H,R+=G,O+=I.width2d}this.flatRaster(R>>16,E>>16,I.pixels,O,L),E+=N,R+=G,O+=I.width2d}}}}}else if(b<I.bottom){if(u>I.bottom)u=I.bottom;if(O>I.bottom)O=I.bottom;if(u<O){if(R=E<<=16,b<0)R-=G*b,E-=H*b,b=0;if(_<<=16,u<0)_-=N*u,u=0;if(G<H){O-=u,u-=b,b=this.lineOffset[b];while(!0){if(u--,u<0)while(!0){if(O--,O<0)return;this.flatRaster(R>>16,_>>16,I.pixels,b,L),R+=G,_+=N,b+=I.width2d}this.flatRaster(R>>16,E>>16,I.pixels,b,L),R+=G,E+=H,b+=I.width2d}}else{O-=u,u-=b,b=this.lineOffset[b];while(!0){if(u--,u<0)while(!0){if(O--,O<0)return;this.flatRaster(_>>16,R>>16,I.pixels,b,L),R+=G,_+=N,b+=I.width2d}this.flatRaster(E>>16,R>>16,I.pixels,b,L),R+=G,E+=H,b+=I.width2d}}}else{if(_=E<<=16,b<0)_-=G*b,E-=H*b,b=0;if(R<<=16,O<0)R-=N*O,O=0;if(G<H){u-=O,O-=b,b=this.lineOffset[b];while(!0){if(O--,O<0)while(!0){if(u--,u<0)return;this.flatRaster(R>>16,E>>16,I.pixels,b,L),R+=N,E+=H,b+=I.width2d}this.flatRaster(_>>16,E>>16,I.pixels,b,L),_+=G,E+=H,b+=I.width2d}}else{u-=O,O-=b,b=this.lineOffset[b];while(!0){if(O--,O<0)while(!0){if(u--,u<0)return;this.flatRaster(E>>16,R>>16,I.pixels,b,L),R+=N,E+=H,b+=I.width2d}this.flatRaster(E>>16,_>>16,I.pixels,b,L),_+=G,E+=H,b+=I.width2d}}}}}static flatRaster(_,R,E,u,O){if(this.clipX){if(R>I.boundX)R=I.boundX;if(_<0)_=0}if(_>=R)return;u+=_;let b=R-_>>2;if(this.alpha===0)while(!0){if(b--,b<0){b=R-_&3;while(!0){if(b--,b<0)return;E[u++]=O}}E[u++]=O,E[u++]=O,E[u++]=O,E[u++]=O}let L=this.alpha,N=256-this.alpha;O=((O&16711935)*N>>8&16711935)+((O&65280)*N>>8&65280);while(!0){if(b--,b<0){b=R-_&3;while(!0){if(b--,b<0)return;E[u++]=O+((E[u]&16711935)*L>>8&16711935)+((E[u]&65280)*L>>8&65280)}}E[u++]=O+((E[u]&16711935)*L>>8&16711935)+((E[u]&65280)*L>>8&65280),E[u++]=O+((E[u]&16711935)*L>>8&16711935)+((E[u]&65280)*L>>8&65280),E[u++]=O+((E[u]&16711935)*L>>8&16711935)+((E[u]&65280)*L>>8&65280),E[u++]=O+((E[u]&16711935)*L>>8&16711935)+((E[u]&65280)*L>>8&65280)}}static textureTriangle(_,R,E,u,O,b,L,N,G,H,Q,$,J,T,m,q,K,F,w){let k=this.getTexels(w);this.opaque=!this.textureTranslucent[w];let Y=H-J,A=Q-m,h=$-K,Z=T-H,f=q-Q,S=F-$,j=Z*Q-f*H<<14,W=f*$-S*Q<<8,B=S*H-Z*$<<5,M=Y*Q-A*H<<14,v=A*$-h*Q<<8,p=h*H-Y*$<<5,D=A*Z-Y*f<<14,a=h*f-A*S<<8,t=Y*S-h*Z<<5,d=0,N0=0;if(O!==u)d=(R-_<<16)/(O-u)|0,N0=(N-L<<16)/(O-u)|0;let u0=0,$0=0;if(b!==O)u0=(E-R<<16)/(b-O)|0,$0=(G-N<<16)/(b-O)|0;let Q0=0,m0=0;if(b!==u)Q0=(_-E<<16)/(u-b)|0,m0=(L-G<<16)/(u-b)|0;if(u<=O&&u<=b){if(u<I.bottom){if(O>I.bottom)O=I.bottom;if(b>I.bottom)b=I.bottom;if(O<b){if(E=_<<=16,G=L<<=16,u<0)E-=Q0*u,_-=d*u,G-=m0*u,L-=N0*u,u=0;if(R<<=16,N<<=16,O<0)R-=u0*O,N-=$0*O,O=0;let T0=u-this.centerY;if(j+=B*T0,M+=p*T0,D+=t*T0,j|=0,M|=0,D|=0,u!==O&&Q0<d||u===O&&Q0>u0){b-=O,O-=u,u=this.lineOffset[u];while(!0){if(O--,O<0)while(!0){if(b--,b<0)return;this.textureRaster(E>>16,R>>16,I.pixels,u,k,0,0,j,M,D,W,v,a,G>>8,N>>8),E+=Q0,R+=u0,G+=m0,N+=$0,u+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}this.textureRaster(E>>16,_>>16,I.pixels,u,k,0,0,j,M,D,W,v,a,G>>8,L>>8),E+=Q0,_+=d,G+=m0,L+=N0,u+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}}else{b-=O,O-=u,u=this.lineOffset[u];while(!0){if(O--,O<0)while(!0){if(b--,b<0)return;this.textureRaster(R>>16,E>>16,I.pixels,u,k,0,0,j,M,D,W,v,a,N>>8,G>>8),E+=Q0,R+=u0,G+=m0,N+=$0,u+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}this.textureRaster(_>>16,E>>16,I.pixels,u,k,0,0,j,M,D,W,v,a,L>>8,G>>8),E+=Q0,_+=d,G+=m0,L+=N0,u+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}}}else{if(R=_<<=16,N=L<<=16,u<0)R-=Q0*u,_-=d*u,N-=m0*u,L-=N0*u,u=0;if(E<<=16,G<<=16,b<0)E-=u0*b,G-=$0*b,b=0;let T0=u-this.centerY;if(j+=B*T0,M+=p*T0,D+=t*T0,j|=0,M|=0,D|=0,(u===b||Q0>=d)&&(u!==b||u0<=d)){O-=b,b-=u,u=this.lineOffset[u];while(!0){if(b--,b<0)while(!0){if(O--,O<0)return;this.textureRaster(_>>16,E>>16,I.pixels,u,k,0,0,j,M,D,W,v,a,L>>8,G>>8),E+=u0,_+=d,G+=$0,L+=N0,u+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}this.textureRaster(_>>16,R>>16,I.pixels,u,k,0,0,j,M,D,W,v,a,L>>8,N>>8),R+=Q0,_+=d,N+=m0,L+=N0,u+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}}else{O-=b,b-=u,u=this.lineOffset[u];while(!0){if(b--,b<0)while(!0){if(O--,O<0)return;this.textureRaster(E>>16,_>>16,I.pixels,u,k,0,0,j,M,D,W,v,a,G>>8,L>>8),E+=u0,_+=d,G+=$0,L+=N0,u+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}this.textureRaster(R>>16,_>>16,I.pixels,u,k,0,0,j,M,D,W,v,a,N>>8,L>>8),R+=Q0,_+=d,N+=m0,L+=N0,u+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}}}}}else if(O<=b){if(O<I.bottom){if(b>I.bottom)b=I.bottom;if(u>I.bottom)u=I.bottom;if(b<u){if(_=R<<=16,L=N<<=16,O<0)_-=d*O,R-=u0*O,L-=N0*O,N-=$0*O,O=0;if(E<<=16,G<<=16,b<0)E-=Q0*b,G-=m0*b,b=0;let T0=O-this.centerY;if(j+=B*T0,M+=p*T0,D+=t*T0,j|=0,M|=0,D|=0,O!==b&&d<u0||O===b&&d>Q0){u-=b,b-=O,O=this.lineOffset[O];while(!0){if(b--,b<0)while(!0){if(u--,u<0)return;this.textureRaster(_>>16,E>>16,I.pixels,O,k,0,0,j,M,D,W,v,a,L>>8,G>>8),_+=d,E+=Q0,L+=N0,G+=m0,O+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}this.textureRaster(_>>16,R>>16,I.pixels,O,k,0,0,j,M,D,W,v,a,L>>8,N>>8),_+=d,R+=u0,L+=N0,N+=$0,O+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}}else{u-=b,b-=O,O=this.lineOffset[O];while(!0){if(b--,b<0)while(!0){if(u--,u<0)return;this.textureRaster(E>>16,_>>16,I.pixels,O,k,0,0,j,M,D,W,v,a,G>>8,L>>8),_+=d,E+=Q0,L+=N0,G+=m0,O+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}this.textureRaster(R>>16,_>>16,I.pixels,O,k,0,0,j,M,D,W,v,a,N>>8,L>>8),_+=d,R+=u0,L+=N0,N+=$0,O+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}}}else{if(E=R<<=16,G=N<<=16,O<0)E-=d*O,R-=u0*O,G-=N0*O,N-=$0*O,O=0;if(_<<=16,L<<=16,u<0)_-=Q0*u,L-=m0*u,u=0;let T0=O-this.centerY;if(j+=B*T0,M+=p*T0,D+=t*T0,j|=0,M|=0,D|=0,b-=u,u-=O,O=this.lineOffset[O],d<u0)while(!0){if(u--,u<0)while(!0){if(b--,b<0)return;this.textureRaster(_>>16,R>>16,I.pixels,O,k,0,0,j,M,D,W,v,a,L>>8,N>>8),_+=Q0,R+=u0,L+=m0,N+=$0,O+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}this.textureRaster(E>>16,R>>16,I.pixels,O,k,0,0,j,M,D,W,v,a,G>>8,N>>8),E+=d,R+=u0,G+=N0,N+=$0,O+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}else while(!0){if(u--,u<0)while(!0){if(b--,b<0)return;this.textureRaster(R>>16,_>>16,I.pixels,O,k,0,0,j,M,D,W,v,a,N>>8,L>>8),_+=Q0,R+=u0,L+=m0,N+=$0,O+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}this.textureRaster(R>>16,E>>16,I.pixels,O,k,0,0,j,M,D,W,v,a,N>>8,G>>8),E+=d,R+=u0,G+=N0,N+=$0,O+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}}}}else if(b<I.bottom){if(u>I.bottom)u=I.bottom;if(O>I.bottom)O=I.bottom;if(u<O){if(R=E<<=16,N=G<<=16,b<0)R-=u0*b,E-=Q0*b,N-=$0*b,G-=m0*b,b=0;if(_<<=16,L<<=16,u<0)_-=d*u,L-=N0*u,u=0;let T0=b-this.centerY;if(j+=B*T0,M+=p*T0,D+=t*T0,j|=0,M|=0,D|=0,O-=u,u-=b,b=this.lineOffset[b],u0<Q0)while(!0){if(u--,u<0)while(!0){if(O--,O<0)return;this.textureRaster(R>>16,_>>16,I.pixels,b,k,0,0,j,M,D,W,v,a,N>>8,L>>8),R+=u0,_+=d,N+=$0,L+=N0,b+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}this.textureRaster(R>>16,E>>16,I.pixels,b,k,0,0,j,M,D,W,v,a,N>>8,G>>8),R+=u0,E+=Q0,N+=$0,G+=m0,b+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}else while(!0){if(u--,u<0)while(!0){if(O--,O<0)return;this.textureRaster(_>>16,R>>16,I.pixels,b,k,0,0,j,M,D,W,v,a,L>>8,N>>8),R+=u0,_+=d,N+=$0,L+=N0,b+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}this.textureRaster(E>>16,R>>16,I.pixels,b,k,0,0,j,M,D,W,v,a,G>>8,N>>8),R+=u0,E+=Q0,N+=$0,G+=m0,b+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}}else{if(_=E<<=16,L=G<<=16,b<0)_-=u0*b,E-=Q0*b,L-=$0*b,G-=m0*b,b=0;if(R<<=16,N<<=16,O<0)R-=d*O,N-=N0*O,O=0;let T0=b-this.centerY;if(j+=B*T0,M+=p*T0,D+=t*T0,j|=0,M|=0,D|=0,u-=O,O-=b,b=this.lineOffset[b],u0<Q0)while(!0){if(O--,O<0)while(!0){if(u--,u<0)return;this.textureRaster(R>>16,E>>16,I.pixels,b,k,0,0,j,M,D,W,v,a,N>>8,G>>8),R+=d,E+=Q0,N+=N0,G+=m0,b+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}this.textureRaster(_>>16,E>>16,I.pixels,b,k,0,0,j,M,D,W,v,a,L>>8,G>>8),_+=u0,E+=Q0,L+=$0,G+=m0,b+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}else while(!0){if(O--,O<0)while(!0){if(u--,u<0)return;this.textureRaster(E>>16,R>>16,I.pixels,b,k,0,0,j,M,D,W,v,a,G>>8,N>>8),R+=d,E+=Q0,N+=N0,G+=m0,b+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}this.textureRaster(E>>16,_>>16,I.pixels,b,k,0,0,j,M,D,W,v,a,G>>8,L>>8),_+=u0,E+=Q0,L+=$0,G+=m0,b+=I.width2d,j+=B,M+=p,D+=t,j|=0,M|=0,D|=0}}}}static textureRaster(_,R,E,u,O,b,L,N,G,H,Q,$,J,T,m){if(_>=R)return;let q,K;if(this.clipX){if(q=(m-T)/(R-_)|0,R>I.boundX)R=I.boundX;if(_<0)T-=_*q,_=0;if(_>=R)return;K=R-_>>3,q<<=12}else if(R-_>7)K=R-_>>3,q=(m-T)*this.divTable[K]>>6;else K=0,q=0;T<<=9,u+=_;let F,w,k,Y,A,h,Z;if(this.lowMemory&&O){if(F=0,w=0,Y=_-this.centerX,N=N+(Q>>3)*Y,G=G+($>>3)*Y,H=H+(J>>3)*Y,N|=0,G|=0,H|=0,k=H>>12,k!==0){if(b=N/k|0,L=G/k|0,b<0)b=0;else if(b>4032)b=4032}if(N=N+Q,G=G+$,H=H+J,N|=0,G|=0,H|=0,k=H>>12,k!==0){if(F=N/k|0,w=G/k|0,F<7)F=7;else if(F>4032)F=4032}if(A=F-b>>3,h=w-L>>3,b+=T>>3&786432,Z=T>>23,this.opaque){while(K-- >0){if(E[u++]=O[(L&4032)+(b>>6)]>>>Z,b+=A,L+=h,E[u++]=O[(L&4032)+(b>>6)]>>>Z,b+=A,L+=h,E[u++]=O[(L&4032)+(b>>6)]>>>Z,b+=A,L+=h,E[u++]=O[(L&4032)+(b>>6)]>>>Z,b+=A,L+=h,E[u++]=O[(L&4032)+(b>>6)]>>>Z,b+=A,L+=h,E[u++]=O[(L&4032)+(b>>6)]>>>Z,b+=A,L+=h,E[u++]=O[(L&4032)+(b>>6)]>>>Z,b+=A,L+=h,E[u++]=O[(L&4032)+(b>>6)]>>>Z,b=F,L=w,N+=Q,G+=$,H+=J,k=H>>12,k!==0){if(F=N/k|0,w=G/k|0,F<7)F=7;else if(F>4032)F=4032}A=F-b>>3,h=w-L>>3,T+=q,b+=T>>3&786432,Z=T>>23}K=R-_&7;while(K-- >0)E[u++]=O[(L&4032)+(b>>6)]>>>Z,b+=A,L+=h}else{while(K-- >0){let f;if((f=O[(L&4032)+(b>>6)]>>>Z)!==0)E[u]=f;if(u=u+1,b+=A,L+=h,(f=O[(L&4032)+(b>>6)]>>>Z)!==0)E[u]=f;if(u++,b+=A,L+=h,(f=O[(L&4032)+(b>>6)]>>>Z)!==0)E[u]=f;if(u++,b+=A,L+=h,(f=O[(L&4032)+(b>>6)]>>>Z)!==0)E[u]=f;if(u++,b+=A,L+=h,(f=O[(L&4032)+(b>>6)]>>>Z)!==0)E[u]=f;if(u++,b+=A,L+=h,(f=O[(L&4032)+(b>>6)]>>>Z)!==0)E[u]=f;if(u++,b+=A,L+=h,(f=O[(L&4032)+(b>>6)]>>>Z)!==0)E[u]=f;if(u++,b+=A,L+=h,(f=O[(L&4032)+(b>>6)]>>>Z)!==0)E[u]=f;if(u=u+1,b=F,L=w,N+=Q,G+=$,H+=J,N|=0,G|=0,H|=0,k=H>>12,k!==0){if(F=N/k|0,w=G/k|0,F<7)F=7;else if(F>4032)F=4032}A=F-b>>3,h=w-L>>3,T+=q,b+=T>>3&786432,Z=T>>23}K=R-_&7;while(K-- >0){let f;if((f=O[(L&4032)+(b>>6)]>>>Z)!==0)E[u]=f;u++,b+=A,L+=h}}return}if(F=0,w=0,Y=_-this.centerX,N=N+(Q>>3)*Y,G=G+($>>3)*Y,H=H+(J>>3)*Y,N|=0,G|=0,H|=0,k=H>>14,k!==0){if(b=N/k|0,L=G/k|0,b<0)b=0;else if(b>16256)b=16256}if(N=N+Q,G=G+$,H=H+J,N|=0,G|=0,H|=0,k=H>>14,k!==0){if(F=N/k|0,w=G/k|0,F<7)F=7;else if(F>16256)F=16256}if(A=F-b>>3,h=w-L>>3,b+=T&6291456,Z=T>>23,this.opaque&&O){while(K-- >0){if(E[u++]=O[(L&16256)+(b>>7)]>>>Z,b+=A,L+=h,E[u++]=O[(L&16256)+(b>>7)]>>>Z,b+=A,L+=h,E[u++]=O[(L&16256)+(b>>7)]>>>Z,b+=A,L+=h,E[u++]=O[(L&16256)+(b>>7)]>>>Z,b+=A,L+=h,E[u++]=O[(L&16256)+(b>>7)]>>>Z,b+=A,L+=h,E[u++]=O[(L&16256)+(b>>7)]>>>Z,b+=A,L+=h,E[u++]=O[(L&16256)+(b>>7)]>>>Z,b+=A,L+=h,E[u++]=O[(L&16256)+(b>>7)]>>>Z,b=F,L=w,N+=Q,G+=$,H+=J,N|=0,G|=0,H|=0,k=H>>14,k!==0){if(F=N/k|0,w=G/k|0,F<7)F=7;else if(F>16256)F=16256}A=F-b>>3,h=w-L>>3,T+=q,b+=T&6291456,Z=T>>23}K=R-_&7;while(K-- >0)E[u++]=O[(L&16256)+(b>>7)]>>>Z,b+=A,L+=h;return}while(K-- >0&&O){let f;if((f=O[(L&16256)+(b>>7)]>>>Z)!==0)E[u]=f;if(u=u+1,b+=A,L+=h,(f=O[(L&16256)+(b>>7)]>>>Z)!==0)E[u]=f;if(u++,b+=A,L+=h,(f=O[(L&16256)+(b>>7)]>>>Z)!==0)E[u]=f;if(u++,b+=A,L+=h,(f=O[(L&16256)+(b>>7)]>>>Z)!==0)E[u]=f;if(u++,b+=A,L+=h,(f=O[(L&16256)+(b>>7)]>>>Z)!==0)E[u]=f;if(u++,b+=A,L+=h,(f=O[(L&16256)+(b>>7)]>>>Z)!==0)E[u]=f;if(u++,b+=A,L+=h,(f=O[(L&16256)+(b>>7)]>>>Z)!==0)E[u]=f;if(u++,b+=A,L+=h,(f=O[(L&16256)+(b>>7)]>>>Z)!==0)E[u]=f;if(u++,b=F,L=w,N+=Q,G+=$,H+=J,N|=0,G|=0,H|=0,k=H>>14,k!==0){if(F=N/k|0,w=G/k|0,F<7)F=7;else if(F>16256)F=16256}A=F-b>>3,h=w-L>>3,T+=q,b+=T&6291456,Z=T>>23}K=R-_&7;while(K-- >0&&O){let f;if((f=O[(L&16256)+(b>>7)]>>>Z)!==0)E[u]=f;u++,b+=A,L+=h}}}class H0{image;width2d;height2d;ctx;paint;pixels;constructor(_,R,E=r){this.ctx=E,this.image=this.ctx.getImageData(0,0,_,R),this.paint=new Uint32Array(this.image.data.buffer),this.pixels=new Int32Array(_*R),this.width2d=_,this.height2d=R,this.bind()}clear(){this.pixels.fill(0)}bind(){I.bind(this.pixels,this.width2d,this.height2d)}draw(_,R){this.#_(),this.ctx.putImageData(this.image,_,R)}#_(){let _=this.pixels.length,R=this.pixels,E=this.paint;for(let u=0;u<_;u++){let O=R[u];E[u]=O>>16&255|(O>>8&255)<<8|(O&255)<<16|4278190080}}}class O1{state=0;deltime=14;mindel=1;otim=[,,,,,,,,,,];fps=0;debug=!1;drawArea=null;redrawScreen=!0;hasFocus=!0;idleCycles=performance.now();mouseButton=0;mouseX=-1;mouseY=-1;nextMouseClickButton=0;nextMouseClickX=-1;nextMouseClickY=-1;mouseClickButton=0;mouseClickX=-1;mouseClickY=-1;nextMouseClickTime=0;mouseClickTime=0;actionKey=[];keyQueue=[];keyQueueReadPos=0;keyQueueWritePos=0;slowestMS=0;averageMS=[];averageIndexMS=0;resizeToFit=!1;tfps=50;fpos=0;frameTime=[];ingame=!1;startedInViewport=!1;startedInTabArea=!1;startedInChatScroll=!1;ttime=-1;sx=0;sy=0;mx=0;my=0;nx=0;ny=0;dragging=!1;panning=!1;async load(){}async update(){}async draw(){}refresh(){}constructor(_=!1){if(l.tabIndex=-1,r.fillStyle="black",r.fillRect(0,0,l.width,l.height),this.resizeToFit=_,this.resizeToFit)this.resize(window.innerWidth,window.innerHeight);else this.resize(l.width,l.height)}get width(){return l.width}get height(){return l.height}resize(_,R){l.width=_,l.height=R,this.drawArea=new H0(_,R),X.init2D()}async run(){if(l.addEventListener("resize",()=>{if(this.resizeToFit)this.resize(window.innerWidth,window.innerHeight)},!1),l.onfocus=this.onfocus.bind(this),l.onblur=this.onblur.bind(this),l.onkeydown=this.onkeydown.bind(this),l.onkeyup=this.onkeyup.bind(this),l.onmousedown=this.onmousedown.bind(this),l.onpointerdown=this.onpointerdown.bind(this),l.onmouseup=this.onmouseup.bind(this),l.onpointerup=this.onpointerup.bind(this),l.onpointerenter=this.onpointerenter.bind(this),l.onpointerleave=this.onpointerleave.bind(this),l.onpointermove=this.onpointermove.bind(this),this.isTouchDevice)if(this.hasTouchEvents)l.ontouchstart=this.ontouchstart.bind(this);else l.style.touchAction="none";l.oncontextmenu=(b)=>{b.preventDefault()},window.oncontextmenu=(b)=>{b.preventDefault()},await this.drawProgress(0,"Loading..."),await this.load();let _=0,R=0,E=256,u=1,O=0;for(let b=0;b<10;b++)this.otim[b]=performance.now();while(this.state>=0){if(this.state>0){if(this.state--,this.state===0){this.shutdown();return}}let b=E,L=u;E=300,u=1,_=performance.now();let N=this.otim[R];if(N===0)E=b,u=L;else if(_>N)E=this.deltime*2560/(_-N)|0;if(E<25)E=25;else if(E>256)E=256,u=this.deltime-(_-N)/10|0;if(this.otim[R]=_,R=(R+1)%10,u>1){for(let H=0;H<10;H++)if(this.otim[H]!==0)this.otim[H]+=u}if(u<this.mindel)u=this.mindel;await j0(u);while(O<256)this.mouseClickButton=this.nextMouseClickButton,this.mouseClickX=this.nextMouseClickX,this.mouseClickY=this.nextMouseClickY,this.mouseClickTime=this.nextMouseClickTime,this.nextMouseClickButton=0,await this.update(),O+=E;if(O&=255,this.deltime>0)this.fps=E*1000/(this.deltime*256)|0;let G=performance.now();if(await this.draw(),this.isMobile)F0.draw();if(this.frameTime[this.fpos]=(performance.now()-G)/1000,this.fpos=(this.fpos+1)%this.frameTime.length,this.tfps<50){let H=1000/this.tfps-(performance.now()-_);if(H>0)await j0(H)}if(this.debug){for(let H=0;H<10;H++){let Q=(R-H-1+20)%10}this.debug=!1}}if(this.state===-1)this.shutdown()}shutdown(){this.state=-2}setFramerate(_){this.deltime=1000/_|0}setTargetedFramerate(_){this.tfps=Math.max(Math.min(50,_|0),0)}start(){if(this.state>=0)this.state=0}stop(){if(this.state>=0)this.state=4000/this.deltime|0}async drawProgress(_,R){let E=this.width,u=this.height;if(this.redrawScreen)r.fillStyle="black",r.fillRect(0,0,E,u),this.redrawScreen=!1;let O=u/2-18;r.strokeStyle="rgb(140, 17, 17)",r.strokeRect((E/2|0)-152,O,304,34),r.fillStyle="rgb(140, 17, 17)",r.fillRect((E/2|0)-150,O+2,_*3,30),r.fillStyle="black",r.fillRect((E/2|0)-150+_*3,O+2,300-_*3,30),r.font="bold 13px helvetica, sans-serif",r.textAlign="center",r.fillStyle="white",r.fillText(R,E/2|0,O+22),await j0(5)}get ms(){let _=this.frameTime.length,R=0;for(let u=0;u<_;u++)R+=this.frameTime[u];let E=R/_*1000;if(E>this.slowestMS)this.slowestMS=E;return this.averageMS[this.averageIndexMS]=E,this.averageIndexMS=(this.averageIndexMS+1)%250,E}get msAvg(){return this.averageMS.reduce((_,R)=>_+R,0)/250}onmousedown(_){if(_.clientX<0||_.clientY<0)return;let{x:R,y:E}=this.getMousePos(_);if(this.idleCycles=performance.now(),this.nextMouseClickX=R,this.nextMouseClickY=E,this.nextMouseClickTime=performance.now(),this.mouseX=R,this.mouseY=E,_.button===2)this.nextMouseClickButton=2,this.mouseButton=2;else this.nextMouseClickButton=1,this.mouseButton=1;if(b0.enabled)b0.mousePressed(R,E,_.button,"mouse")}onpointerdown(_){if(_.clientX<0||_.clientY<0)return;let{x:R,y:E}=this.getMousePos(_);if(F0.isWithinCanvasKeyboard(R,E)&&!this.exceedsGrabThreshold(20)){F0.captureMouseDown(R,E);return}if(_.pointerType!=="mouse")this.idleCycles=performance.now(),this.nextMouseClickX=-1,this.nextMouseClickY=-1,this.nextMouseClickButton=0,this.mouseX=R,this.mouseY=E,this.mouseButton=0,this.sx=this.nx=this.mx=_.screenX|0,this.sy=this.ny=this.my=_.screenY|0,this.ttime=_.timeStamp,this.startedInViewport=this.insideViewportArea(),this.startedInTabArea=this.insideTabArea(),this.startedInChatScroll=this.insideChatScrollArea()}onmouseup(_){let{x:R,y:E}=this.getMousePos(_);if(this.idleCycles=performance.now(),this.mouseButton=0,b0.enabled)b0.mouseReleased(_.button,"mouse");this.mouseX=R,this.mouseY=E}onpointerup(_){let{x:R,y:E}=this.getMousePos(_);if(F0.isWithinCanvasKeyboard(R,E)&&!this.exceedsGrabThreshold(20)){F0.captureMouseUp(R,E);return}if(_.pointerType!=="mouse")if(this.idleCycles=performance.now(),this.mouseX=R,this.mouseY=E,this.dragging){if(this.dragging=!1,this.nextMouseClickX=-1,this.nextMouseClickY=-1,this.nextMouseClickButton=0,this.mouseButton=0,b0.enabled)b0.mouseReleased(0,_.pointerType)}else if(this.panning){this.panning=!1,this.actionKey[1]=0,this.actionKey[2]=0,this.actionKey[3]=0,this.actionKey[4]=0;return}else{if(!F0.isDisplayed()&&this.insideMobileInputArea())F0.show(R,E,_.clientX,_.clientY);else if(F0.isDisplayed()&&!F0.isWithinCanvasKeyboard(R,E))F0.hide(),this.refresh();this.nextMouseClickX=R,this.nextMouseClickY=E,this.nextMouseClickTime=performance.now();let u=_.timeStamp>=this.ttime+500;if(u)this.nextMouseClickButton=2,this.mouseButton=2;else this.nextMouseClickButton=1,this.mouseButton=1;if(b0.enabled)b0.mousePressed(R,E,u?2:0,_.pointerType);setTimeout(()=>{if(this.mouseButton=0,b0.enabled)b0.mouseReleased(u?2:0,_.pointerType)},40)}}onpointerenter(_){if(_.clientX<0||_.clientY<0)return;let{x:R,y:E}=this.getMousePos(_);if(_.pointerType==="mouse"){if(this.mouseX=R,this.mouseY=E,b0.enabled)b0.mouseEntered()}else this.idleCycles=performance.now(),this.nextMouseClickX=-1,this.nextMouseClickY=-1,this.nextMouseClickButton=0,this.mouseX=R,this.mouseY=E,this.mouseButton=0,this.sx=this.nx=this.mx=_.screenX|0,this.sy=this.ny=this.my=_.screenY|0,this.ttime=_.timeStamp,this.startedInViewport=this.insideViewportArea(),this.startedInTabArea=this.insideTabArea()}onpointerleave(_){if(_.pointerType==="mouse"){if(this.idleCycles=performance.now(),this.mouseX=-1,this.mouseY=-1,b0.enabled)b0.mouseExited();this.nextMouseClickX=-1,this.nextMouseClickY=-1,this.nextMouseClickButton=0,this.mouseButton=0}else this.idleCycles=performance.now(),this.actionKey[1]=0,this.actionKey[2]=0,this.actionKey[3]=0,this.actionKey[4]=0}onpointermove(_){if(_.clientX<0||_.clientY<0)return;let{x:R,y:E}=this.getMousePos(_);if(_.pointerType==="mouse"){if(this.idleCycles=performance.now(),this.mouseX=R,this.mouseY=E,b0.enabled)b0.mouseMoved(R,E,_.pointerType)}else{if(this.idleCycles=performance.now(),this.mouseX=R,this.mouseY=E,this.nx=_.screenX|0,this.ny=_.screenY|0,this.dragging);else if(F0.isWithinCanvasKeyboard(R,E)&&this.exceedsGrabThreshold(20))F0.notifyTouchMove(R,E);else if(this.startedInViewport&&this.getViewportInterfaceId()===-1&&this.exceedsGrabThreshold(20)){if(this.panning=!0,this.mx-this.nx>0)this.actionKey[1]=0,this.actionKey[2]=1;else if(this.mx-this.nx<0)this.actionKey[1]=1,this.actionKey[2]=0;if(this.my-this.ny>0)this.actionKey[3]=0,this.actionKey[4]=1;else if(this.my-this.ny<0)this.actionKey[3]=1,this.actionKey[4]=0}else if(this.startedInTabArea||this.startedInChatScroll||this.getViewportInterfaceId()!==-1){if(!this.dragging&&this.exceedsGrabThreshold(5))this.dragging=!0,this.nextMouseClickX=R,this.nextMouseClickY=E,this.nextMouseClickButton=1,this.mouseButton=1}this.mx=this.nx,this.my=this.ny}}ontouchstart(_){if(_.touches.length<2||this.dragging)_.preventDefault()}onkeydown(_){this.idleCycles=performance.now();let R=z.get(_.key);if(!R||_.code.length===0&&!_.isTrusted)return;let E=R.ch;if(_.ctrlKey){if(E>=65&&E<=93||E==95)E-=64;else if(E>=97&&E<=122)E-=96}if(E>0&&E<128)this.actionKey[E]=1;if(E>4)this.keyQueue[this.keyQueueWritePos]=E,this.keyQueueWritePos=this.keyQueueWritePos+1&127;if(b0.enabled)b0.keyPressed(E);if(!h1.includes(_.key))_.preventDefault()}onkeyup(_){if(_.isTrusted&&F0.isDisplayed())F0.hide(),this.refresh();this.idleCycles=performance.now();let R=z.get(_.key);if(!R||_.code.length===0&&!_.isTrusted)return;let E=R.ch;if(_.ctrlKey){if(E>=65&&E<=93||E==95)E-=64;else if(E>=97&&E<=122)E-=96}if(E>0&&E<128)this.actionKey[E]=0;if(b0.enabled)b0.keyReleased(E);if(!h1.includes(_.key))_.preventDefault()}pollKey(){let _=-1;if(this.keyQueueWritePos!==this.keyQueueReadPos)_=this.keyQueue[this.keyQueueReadPos],this.keyQueueReadPos=this.keyQueueReadPos+1&127;return _}onfocus(_){if(this.hasFocus=!0,this.redrawScreen=!0,this.refresh(),b0.enabled)b0.focusGained()}onblur(_){this.hasFocus=!1;for(let R=0;R<128;R++)this.actionKey[R]=0;if(b0.enabled)b0.focusLost()}get hasTouchEvents(){return"ontouchstart"in window}get isTouchDevice(){return this.hasTouchEvents||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}get isMobile(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|Windows Phone|Mobile/i.test(navigator.userAgent))return!0;return this.isTouchDevice}insideViewportArea(){return this.ingame&&this.mouseX>=4&&this.mouseX<=516&&this.mouseY>=4&&this.mouseY<=338}insideMobileInputArea(){return this.insideChatInputArea()||this.insideChatPopupArea()||this.insideUsernameArea()||this.inPasswordArea()||this.insideReportInterfaceTextArea()}insideChatInputArea(){return this.ingame&&this.getChatInterfaceId()===-1&&!this.isChatBackInputOpen()&&!this.isShowSocialInput()&&this.mouseX>=17&&this.mouseX<=496&&this.mouseY>=434&&this.mouseY<=460}insideChatPopupArea(){return this.ingame&&(this.isChatBackInputOpen()||this.isShowSocialInput())&&this.mouseX>=17&&this.mouseX<=496&&this.mouseY>=357&&this.mouseY<=453}insideChatScrollArea(){return this.ingame&&(!this.isChatBackInputOpen()&&!this.isShowSocialInput())&&this.mouseX>=480&&this.mouseX<=496&&this.mouseY>=357&&this.mouseY<=434}insideReportInterfaceTextArea(){if(!this.ingame)return!1;let _=this.getViewportInterfaceId(),R=this.getReportAbuseInterfaceId();if(_===-1||R===-1)return!1;if(_!==R)return!1;let E=87,u=119,O=E+348,b=u+37;return this.mouseX>=E&&this.mouseX<=O&&this.mouseY>=u&&this.mouseY<=b}insideTabArea(){return this.ingame&&this.mouseX>=553&&this.mouseX<=743&&this.mouseY>=205&&this.mouseY<=466}insideUsernameArea(){return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=280&&this.mouseX<=470&&this.mouseY>=233&&this.mouseY<=264}inPasswordArea(){return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=280&&this.mouseX<=558&&this.mouseY>=264&&this.mouseY<=284}isFullScreen(){return document.fullscreenElement!==null}getMousePos(_){let R=this.width,E=this.height,u=l.getBoundingClientRect(),O={x:_.clientX-u.left,y:_.clientY-u.top},b=0,L=0;if(this.isFullScreen()){let N=R/E,H=window.innerWidth/window.innerHeight>=N,Q=0,$=0,J=0,T=0;if(H)Q=window.innerHeight*N,$=window.innerHeight,J=(window.innerWidth-Q)/2;else Q=window.innerWidth,$=window.innerWidth/N,T=(window.innerHeight-$)/2;let m=R/Q,q=E/$;b=(O.x-J)*m|0,L=(O.y-T)*q|0}else{let N=l.width/u.width,G=l.height/u.height;b=O.x*N|0,L=O.y*G|0}if(b<0)b=0;if(b>R)b=R;if(L<0)L=0;if(L>E)L=E;return{x:b,y:L}}exceedsGrabThreshold(_){return Math.abs(this.sx-this.nx)>_||Math.abs(this.sy-this.ny)>_}}class I0{id;debugname=null;constructor(_){this.id=_}unpackType(_){while(!0){let R=_.g1();if(R===0)break;this.unpack(R,_)}return this}}class B0 extends I0{static count=0;static types=[];rgb=0;texture=-1;overlay=!1;occlude=!0;hue=0;saturation=0;lightness=0;luminance=0;chroma=0;hsl=0;static unpack(_){let R=new P(_.read("flo.dat"));this.count=R.g2(),this.types=Array(this.count);for(let E=0;E<this.count;E++){if(!this.types[E])this.types[E]=new B0(E);this.types[E].unpackType(R)}}unpack(_,R){if(_===1)this.rgb=R.g3(),this.setColour(this.rgb);else if(_===2)this.texture=R.g1();else if(_===3)this.overlay=!0;else if(_===5)this.occlude=!1;else if(_===6)this.debugname=R.gjstr()}setColour(_){let R=(_>>16&255)/256,E=(_>>8&255)/256,u=(_&255)/256,O=R;if(E<R)O=E;if(u<O)O=u;let b=R;if(E>R)b=E;if(u>b)b=u;let L=0,N=0,G=(O+b)/2;if(O!==b){if(G<0.5)N=(b-O)/(b+O);if(G>=0.5)N=(b-O)/(2-b-O);if(R===b)L=(E-u)/(b-O);else if(E===b)L=(u-R)/(b-O)+2;else if(u===b)L=(R-E)/(b-O)+4}if(L/=6,this.hue=L*256|0,this.saturation=N*256|0,this.lightness=G*256|0,this.saturation<0)this.saturation=0;else if(this.saturation>255)this.saturation=255;if(this.lightness<0)this.lightness=0;else if(this.lightness>255)this.lightness=255;if(G>0.5)this.luminance=(1-G)*N*512|0;else this.luminance=G*N*512|0;if(this.luminance<1)this.luminance=1;this.chroma=L*this.luminance|0;let H=this.hue+(Math.random()*16|0)-8;if(H<0)H=0;else if(H>255)H=255;let Q=this.saturation+(Math.random()*48|0)-24;if(Q<0)Q=0;else if(Q>255)Q=255;let $=this.lightness+(Math.random()*48|0)-24;if($<0)$=0;else if($>255)$=255;this.hsl=B0.hsl24to16(H,Q,$)}static hsl24to16(_,R,E){if(E>179)R=R/2|0;if(E>192)R=R/2|0;if(E>217)R=R/2|0;if(E>243)R=R/2|0;return((_/4|0)<<10)+((R/32|0)<<7)+(E/2|0)}}class b1{length=0;types=null;labels=null;constructor(_){this.length=_.g1(),this.types=new Uint8Array(this.length),this.labels=new C(this.length,null);for(let R=0;R<this.length;R++)this.types[R]=_.g1();for(let R=0;R<this.length;R++){let E=_.g1();this.labels[R]=new Uint8Array(E);for(let u=0;u<E;u++)this.labels[R][u]=_.g1()}}}class Z0{static instances=[];delay=-1;base=null;length=0;groups=null;x=null;y=null;z=null;static init(_){this.instances=Array(_+1)}static unpack(_){let R=new P(_);R.pos=_.length-8;let E=R.g2(),u=R.g2(),O=R.g2(),b=R.g2(),L=0,N=new P(_);N.pos=L,L+=E+2;let G=new P(_);G.pos=L,L+=u;let H=new P(_);H.pos=L,L+=O;let Q=new P(_);Q.pos=L,L+=b;let $=new P(_);$.pos=L;let J=new b1($),T=N.g2(),m=new Int32Array(500),q=new Int32Array(500),K=new Int32Array(500),F=new Int32Array(500);for(let w=0;w<T;w++){let k=N.g2(),Y=this.instances[k]=new Z0;Y.delay=Q.g1(),Y.base=J;let A=N.g1(),h=-1,Z=0;for(let f=0;f<A;f++){if(!J.types)throw Error();let S=G.g1();if(S>0){if(J.types[f]!==0){for(let W=f-1;W>h;W--)if(J.types[W]===0){m[Z]=W,q[Z]=0,K[Z]=0,F[Z]=0,Z++;break}}m[Z]=f;let j=0;if(J.types[m[Z]]===3)j=128;if((S&1)===0)q[Z]=j;else q[Z]=H.gsmart();if((S&2)===0)K[Z]=j;else K[Z]=H.gsmart();if((S&4)===0)F[Z]=j;else F[Z]=H.gsmart();h=f,Z++}}Y.length=Z,Y.groups=new Int32Array(Z),Y.x=new Int32Array(Z),Y.y=new Int32Array(Z),Y.z=new Int32Array(Z);for(let f=0;f<Z;f++)Y.groups[f]=m[f],Y.x[f]=q[f],Y.y[f]=K[f],Y.z[f]=F[f]}}static get(_){return Z0.instances[_]}}class e extends I0{static count=0;static types=[];frameCount=0;frames=null;iframes=null;delay=null;loops=-1;walkmerge=null;stretches=!1;priority=5;replaceheldleft=-1;replaceheldright=-1;maxloops=99;preanim_move=-1;postanim_move=-1;duplicatebehavior=-1;static unpack(_){let R=new P(_.read("seq.dat"));this.count=R.g2(),this.types=Array(this.count);for(let E=0;E<this.count;E++){if(!this.types[E])this.types[E]=new e(E);let u=this.types[E].unpackType(R);if(u.preanim_move===-1)if(u.walkmerge===null)u.preanim_move=0;else u.preanim_move=2;if(u.postanim_move===-1)if(u.walkmerge===null)u.postanim_move=0;else u.postanim_move=2;if(u.frameCount===0)u.frameCount=1,u.frames=new Int16Array(1),u.frames[0]=-1,u.iframes=new Int16Array(1),u.iframes[0]=-1,u.delay=new Int16Array(1),u.delay[0]=-1}}getFrameDuration(_){if(!this.delay||!this.frames)return 0;let R=this.delay[_];if(R===0){let E=Z0.get(this.frames[_]);if(E!=null)R=this.delay[_]=E.delay}if(R===0)R=1;return R}unpack(_,R){if(_===1){this.frameCount=R.g1(),this.frames=new Int16Array(this.frameCount),this.iframes=new Int16Array(this.frameCount),this.delay=new Int16Array(this.frameCount);for(let E=0;E<this.frameCount;E++){if(this.frames[E]=R.g2(),this.iframes[E]=R.g2(),this.iframes[E]===65535)this.iframes[E]=-1;this.delay[E]=R.g2()}}else if(_===2)this.loops=R.g2();else if(_===3){let E=R.g1();this.walkmerge=new Int32Array(E+1);for(let u=0;u<E;u++)this.walkmerge[u]=R.g1();this.walkmerge[E]=9999999}else if(_===4)this.stretches=!0;else if(_===5)this.priority=R.g1();else if(_===6)this.replaceheldleft=R.g2();else if(_===7)this.replaceheldright=R.g2();else if(_===8)this.maxloops=R.g1();else if(_===9)this.preanim_move=R.g1();else if(_===10)this.postanim_move=R.g1();else if(_===11)this.duplicatebehavior=R.g1()}}class L1{bucketCount;buckets;constructor(_){this.buckets=Array(_),this.bucketCount=_;for(let R=0;R<_;R++){let E=this.buckets[R]=new M0;E.next=E,E.prev=E}}get(_){let R=this.buckets[Number(_&BigInt(this.bucketCount-1))];for(let E=R.next;E&&E!==R;E=E.next)if(E.key===_)return E;return null}put(_,R){if(R.prev)R.unlink();let E=this.buckets[Number(_&BigInt(this.bucketCount-1))];if(R.prev=E.prev,R.next=E,R.prev)R.prev.next=R;R.next.prev=R,R.key=_}}class y0{sentinel=new Y0;cursor=null;constructor(){this.sentinel.next2=this.sentinel,this.sentinel.prev2=this.sentinel}push(_){if(_.prev2)_.unlink2();if(_.prev2=this.sentinel.prev2,_.next2=this.sentinel,_.prev2)_.prev2.next2=_;_.next2.prev2=_}pop(){let _=this.sentinel.next2;if(_===this.sentinel)return null;else return _?.unlink2(),_}head(){let _=this.sentinel.next2;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.next2||null,_}next(){let _=this.cursor;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.next2||null,_}size(){let _=0;for(let R=this.sentinel.next2;R!==this.sentinel&&R;R=R.next2)_++;return _}}class V0{capacity;hashtable=new L1(1024);cacheHistory=new y0;cacheAvailable;constructor(_){this.capacity=_,this.cacheAvailable=_}get(_){let R=this.hashtable.get(_);if(R)this.cacheHistory.push(R);return R}put(_,R){if(this.cacheAvailable===0){let E=this.cacheHistory.pop();E?.unlink(),E?.unlink2()}else this.cacheAvailable--;this.hashtable.put(_,R),this.cacheHistory.push(R)}clear(){while(!0){let _=this.cacheHistory.pop();if(!_){this.cacheAvailable=this.capacity;return}_.unlink(),_.unlink2()}}}class n{static WALL_STRAIGHT=new n(0,0);static WALL_DIAGONAL_CORNER=new n(1,0);static WALL_L=new n(2,0);static WALL_SQUARE_CORNER=new n(3,0);static WALLDECOR_STRAIGHT_NOOFFSET=new n(4,1);static WALLDECOR_STRAIGHT_OFFSET=new n(5,1);static WALLDECOR_DIAGONAL_OFFSET=new n(6,1);static WALLDECOR_DIAGONAL_NOOFFSET=new n(7,1);static WALLDECOR_DIAGONAL_BOTH=new n(8,1);static WALL_DIAGONAL=new n(9,2);static CENTREPIECE_STRAIGHT=new n(10,2);static CENTREPIECE_DIAGONAL=new n(11,2);static ROOF_STRAIGHT=new n(12,2);static ROOF_DIAGONAL_WITH_ROOFEDGE=new n(13,2);static ROOF_DIAGONAL=new n(14,2);static ROOF_L_CONCAVE=new n(15,2);static ROOF_L_CONVEX=new n(16,2);static ROOF_FLAT=new n(17,2);static ROOFEDGE_STRAIGHT=new n(18,2);static ROOFEDGE_DIAGONAL_CORNER=new n(19,2);static ROOFEDGE_L=new n(20,2);static ROOFEDGE_SQUARE_CORNER=new n(21,2);static GROUND_DECOR=new n(22,3);static values(){return[this.WALL_STRAIGHT,this.WALL_DIAGONAL_CORNER,this.ROOF_FLAT,this.ROOF_L_CONCAVE,this.WALL_L,this.ROOF_DIAGONAL,this.WALL_DIAGONAL,this.WALL_SQUARE_CORNER,this.GROUND_DECOR,this.ROOF_STRAIGHT,this.CENTREPIECE_DIAGONAL,this.WALLDECOR_DIAGONAL_OFFSET,this.ROOFEDGE_L,this.CENTREPIECE_STRAIGHT,this.WALLDECOR_STRAIGHT_OFFSET,this.ROOF_DIAGONAL_WITH_ROOFEDGE,this.WALLDECOR_DIAGONAL_NOOFFSET,this.WALLDECOR_STRAIGHT_NOOFFSET,this.ROOF_L_CONVEX,this.WALLDECOR_DIAGONAL_BOTH,this.ROOFEDGE_DIAGONAL_CORNER,this.ROOFEDGE_SQUARE_CORNER,this.ROOFEDGE_STRAIGHT]}static of(_){let R=this.values();for(let E=0;E<R.length;E++){let u=R[E];if(u.id===_)return u}throw Error("shape not found")}id;layer;constructor(_,R){this.id=_,this.layer=R}}class i0{x=0;y=0;z=0;w=0}class w0 extends Y0{vertexNormal=null;minY=1000;draw(_,R,E,u,O,b,L,N,G,H){let Q=this.getModel(_);if(Q)this.minY=Q.minY,Q.draw(0,R,E,u,O,b,L,N,G,H)}getModel(_){return null}}class W1{data=null;vertexCount=0;faceCount=0;texturedFaceCount=0;vertexFlagsOffset=-1;vertexXOffset=-1;vertexYOffset=-1;vertexZOffset=-1;vertexLabelsOffset=-1;faceVerticesOffset=-1;faceOrientationsOffset=-1;faceColoursOffset=-1;faceInfosOffset=-1;facePrioritiesOffset=0;faceAlphasOffset=-1;faceLabelsOffset=-1;faceTextureAxisOffset=-1}class U extends w0{static loaded=0;static empty=new U;static tmpVertexX=new Int32Array(2000);static tmpVertexY=new Int32Array(2000);static tmpVertexZ=new Int32Array(2000);static tmpFaceAlpha=new Int32Array(2000);maxDepth=0;minDepth=0;objRaise=0;vertexLabel=null;faceLabel=null;labelVertices=null;labelFaces=null;picking=!1;vertexNormalOriginal=null;static meta=null;static provider;static faceClippedX=new C(4096,!1);static faceNearClipped=new C(4096,!1);static vertexScreenX=new Int32Array(4096);static vertexScreenY=new Int32Array(4096);static vertexScreenZ=new Int32Array(4096);static vertexViewSpaceX=new Int32Array(4096);static vertexViewSpaceY=new Int32Array(4096);static vertexViewSpaceZ=new Int32Array(4096);static tmpDepthFaceCount=new Int32Array(1500);static tmpDepthFaces=new h0(1500,512);static tmpPriorityFaceCount=new Int32Array(12);static tmpPriorityFaces=new h0(12,2000);static tmpPriority10FaceDepth=new Int32Array(2000);static tmpPriority11FaceDepth=new Int32Array(2000);static tmpPriorityDepthSum=new Int32Array(12);vertexCount=0;faceCount=0;texturedFaceCount=0;vertexX=null;vertexY=null;vertexZ=null;faceVertexA=null;faceVertexB=null;faceVertexC=null;texturedVertexA=null;texturedVertexB=null;texturedVertexC=null;faceInfo=null;facePriority=null;priority=0;faceAlpha=null;faceColour=null;faceColourA=null;faceColourB=null;faceColourC=null;maxY=0;radius=0;minX=0;maxX=0;minZ=0;maxZ=0;static clippedX=new Int32Array(10);static clippedY=new Int32Array(10);static clippedColour=new Int32Array(10);static pickedBitsets=new Int32Array(1000);static baseX=0;static baseY=0;static baseZ=0;static mouseX=0;static mouseY=0;static pickedCount=0;static checkHover=!1;static init(_,R){U.meta=Array(_),U.provider=R}static unpack(_,R){if(!U.meta)return;if(!R){let m=U.meta[_]=new W1;m.vertexCount=0,m.faceCount=0,m.texturedFaceCount=0;return}let E=new P(R);E.pos=R.length-18;let u=U.meta[_]=new W1;u.data=R,u.vertexCount=E.g2(),u.faceCount=E.g2(),u.texturedFaceCount=E.g1();let O=E.g1(),b=E.g1(),L=E.g1(),N=E.g1(),G=E.g1(),H=E.g2(),Q=E.g2(),$=E.g2(),J=E.g2(),T=0;if(u.vertexFlagsOffset=T,T+=u.vertexCount,u.faceOrientationsOffset=T,T+=u.faceCount,u.facePrioritiesOffset=T,b==255)T+=u.faceCount;else u.facePrioritiesOffset=-b-1;if(u.faceLabelsOffset=T,N==1)T+=u.faceCount;else u.faceLabelsOffset=-1;if(u.faceInfosOffset=T,O==1)T+=u.faceCount;else u.faceInfosOffset=-1;if(u.vertexLabelsOffset=T,G==1)T+=u.vertexCount;else u.vertexLabelsOffset=-1;if(u.faceAlphasOffset=T,L==1)T+=u.faceCount;else u.faceAlphasOffset=-1;u.faceVerticesOffset=T,T+=J,u.faceColoursOffset=T,T+=u.faceCount*2,u.faceTextureAxisOffset=T,T+=u.texturedFaceCount*6,u.vertexXOffset=T,T+=H,u.vertexYOffset=T,T+=Q,u.vertexZOffset=T,T+=$}static unload(_){if(U.meta)U.meta[_]=null}static tryGet(_){if(!U.meta)return null;if(!U.meta[_])return U.provider.requestModel(_),null;return U.fromId(_)}static isReady(_){if(!U.meta)return!1;if(!U.meta[_])return U.provider.requestModel(_),!1;return!0}constructor(_){super();if(_)this.vertexCount=_.vertexCount,this.vertexX=_.vertexX,this.vertexY=_.vertexY,this.vertexZ=_.vertexZ,this.faceCount=_.faceCount,this.faceVertexA=_.faceVertexA,this.faceVertexB=_.faceVertexB,this.faceVertexC=_.faceVertexC,this.faceColourA=_.faceColorA,this.faceColourB=_.faceColorB,this.faceColourC=_.faceColorC,this.faceInfo=_.faceInfo,this.facePriority=_.facePriority,this.faceAlpha=_.faceAlpha,this.faceColour=_.faceColor,this.priority=_.priorityVal,this.texturedFaceCount=_.texturedFaceCount,this.texturedVertexA=_.texturedVertexA,this.texturedVertexB=_.texturedVertexB,this.texturedVertexC=_.texturedVertexC,this.minX=_.minX??0,this.maxX=_.maxX??0,this.minZ=_.minZ??0,this.maxZ=_.maxZ??0,this.radius=_.radius??0,this.maxY=_.minY??0,this.minY=_.maxY??0,this.maxDepth=_.maxDepth??0,this.minDepth=_.minDepth??0,this.vertexLabel=_.vertexLabel??null,this.faceLabel=_.faceLabel??null,this.labelVertices=_.labelVertices??null,this.labelFaces=_.labelFaces??null,this.vertexNormal=_.vertexNormal??null,this.vertexNormalOriginal=_.vertexNormalOriginal??null}static fromId(_){if(!U.meta||!U.meta[_])return new U;U.loaded++;let R=U.meta[_],E=new U;if(E.vertexCount=R.vertexCount,E.faceCount=R.faceCount,E.texturedFaceCount=R.texturedFaceCount,E.vertexX=new Int32Array(E.vertexCount),E.vertexY=new Int32Array(E.vertexCount),E.vertexZ=new Int32Array(E.vertexCount),E.faceVertexA=new Int32Array(E.faceCount),E.faceVertexB=new Int32Array(E.faceCount),E.faceVertexC=new Int32Array(E.faceCount),E.texturedVertexA=new Int32Array(E.texturedFaceCount),E.texturedVertexB=new Int32Array(E.texturedFaceCount),E.texturedVertexC=new Int32Array(E.texturedFaceCount),R.vertexLabelsOffset>=0)E.vertexLabel=new Int32Array(E.vertexCount);if(R.faceInfosOffset>=0)E.faceInfo=new Int32Array(E.faceCount);if(R.facePrioritiesOffset>=0)E.facePriority=new Int32Array(E.faceCount);else E.priority=-R.facePrioritiesOffset-1;if(R.faceAlphasOffset>=0)E.faceAlpha=new Int32Array(E.faceCount);if(R.faceLabelsOffset>=0)E.faceLabel=new Int32Array(E.faceCount);E.faceColour=new Int32Array(E.faceCount);let u=new P(R.data);u.pos=R.vertexFlagsOffset;let O=new P(R.data);O.pos=R.vertexXOffset;let b=new P(R.data);b.pos=R.vertexYOffset;let L=new P(R.data);L.pos=R.vertexZOffset;let N=new P(R.data);N.pos=R.vertexLabelsOffset;let G=0,H=0,Q=0;for(let Z=0;Z<E.vertexCount;Z++){let f=u.g1(),S=0;if((f&1)!=0)S=O.gsmart();let j=0;if((f&2)!=0)j=b.gsmart();let W=0;if((f&4)!=0)W=L.gsmart();if(E.vertexX[Z]=G+S,E.vertexY[Z]=H+j,E.vertexZ[Z]=Q+W,G=E.vertexX[Z],H=E.vertexY[Z],Q=E.vertexZ[Z],E.vertexLabel!=null)E.vertexLabel[Z]=N.g1()}let $=new P(R.data);$.pos=R.faceColoursOffset;let J=new P(R.data);J.pos=R.faceInfosOffset;let T=new P(R.data);T.pos=R.facePrioritiesOffset;let m=new P(R.data);m.pos=R.faceAlphasOffset;let q=new P(R.data);q.pos=R.faceLabelsOffset;for(let Z=0;Z<E.faceCount;Z++){if(E.faceColour[Z]=$.g2(),E.faceInfo!=null)E.faceInfo[Z]=J.g1();if(E.facePriority!=null)E.facePriority[Z]=T.g1();if(E.faceAlpha!=null)E.faceAlpha[Z]=m.g1();if(E.faceLabel!=null)E.faceLabel[Z]=q.g1()}let K=new P(R.data);K.pos=R.faceVerticesOffset;let F=new P(R.data);F.pos=R.faceOrientationsOffset;let w=0,k=0,Y=0,A=0;for(let Z=0;Z<E.faceCount;Z++){let f=F.g1();if(f==1)w=K.gsmart()+A,k=K.gsmart()+w,Y=K.gsmart()+k,A=Y;else if(f==2)w=w,k=Y,Y=K.gsmart()+A,A=Y;else if(f==3)w=Y,k=k,Y=K.gsmart()+A,A=Y;else if(f==4){let S=w;w=k,k=S,Y=K.gsmart()+A,A=Y}E.faceVertexA[Z]=w,E.faceVertexB[Z]=k,E.faceVertexC[Z]=Y}let h=new P(R.data);h.pos=R.faceTextureAxisOffset;for(let Z=0;Z<E.texturedFaceCount;Z++)E.texturedVertexA[Z]=h.g2(),E.texturedVertexB[Z]=h.g2(),E.texturedVertexC[Z]=h.g2();return E}static modelCopyFaces(_,R,E){let{vertexCount:u,faceCount:O,texturedFaceCount:b}=_,L;if(R){L=new Int32Array(u);for(let T=0;T<u;T++)L[T]=_.vertexY[T]}else L=_.vertexY;let N,G,H,Q,$=null,J=null;if(E){N=new Int32Array(O),G=new Int32Array(O),H=new Int32Array(O);for(let T=0;T<O;T++){if(_.faceColourA)N[T]=_.faceColourA[T];if(_.faceColourB)G[T]=_.faceColourB[T];if(_.faceColourC)H[T]=_.faceColourC[T]}if(Q=new Int32Array(O),!_.faceInfo)for(let T=0;T<O;T++)Q[T]=0;else for(let T=0;T<O;T++)Q[T]=_.faceInfo[T];$=new C(u,null);for(let T=0;T<u;T++){let m=$[T]=new i0;if(_.vertexNormal){let q=_.vertexNormal[T];if(q)m.x=q.x,m.y=q.y,m.z=q.z,m.w=q.w}}J=_.vertexNormalOriginal}else N=_.faceColourA,G=_.faceColourB,H=_.faceColourC,Q=_.faceInfo;return new U({vertexCount:u,vertexX:_.vertexX,vertexY:L,vertexZ:_.vertexZ,faceCount:O,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:N,faceColorB:G,faceColorC:H,faceInfo:Q,facePriority:_.facePriority,faceAlpha:_.faceAlpha,faceColor:_.faceColour,priorityVal:_.priority,texturedFaceCount:b,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,minX:_.minX,maxX:_.maxX,minZ:_.minZ,maxZ:_.maxZ,radius:_.radius,minY:_.maxY,maxY:_.minY,maxDepth:_.maxDepth,minDepth:_.minDepth,vertexNormal:$,vertexNormalOriginal:J})}static modelShareColored(_,R,E,u){let{vertexCount:O,faceCount:b,texturedFaceCount:L}=_,N,G,H;if(u)N=_.vertexX,G=_.vertexY,H=_.vertexZ;else{N=new Int32Array(O),G=new Int32Array(O),H=new Int32Array(O);for(let J=0;J<O;J++)N[J]=_.vertexX[J],G[J]=_.vertexY[J],H[J]=_.vertexZ[J]}let Q;if(R)Q=_.faceColour;else{Q=new Int32Array(b);for(let J=0;J<b;J++)if(_.faceColour)Q[J]=_.faceColour[J]}let $;if(E)$=_.faceAlpha;else if($=new Int32Array(b),!_.faceAlpha)for(let J=0;J<b;J++)$[J]=0;else for(let J=0;J<b;J++)$[J]=_.faceAlpha[J];return new U({vertexCount:O,vertexX:N,vertexY:G,vertexZ:H,faceCount:b,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:_.faceInfo,facePriority:_.facePriority,faceAlpha:$,faceColor:Q,priorityVal:_.priority,texturedFaceCount:L,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,vertexLabel:_.vertexLabel,faceLabel:_.faceLabel})}static modelFromModelsBounds(_,R){let E=!1,u=!1,O=!1,b=!1,L=0,N=0,G=0,H=-1;for(let W=0;W<R;W++){let B=_[W];if(B){if(L+=B.vertexCount,N+=B.faceCount,G+=B.texturedFaceCount,E||=B.faceInfo!==null,!B.facePriority){if(H===-1)H=B.priority;if(H!==B.priority)u=!0}else u=!0;O||=B.faceAlpha!==null,b||=B.faceColour!==null}}let Q=new Int32Array(L),$=new Int32Array(L),J=new Int32Array(L),T=new Int32Array(N),m=new Int32Array(N),q=new Int32Array(N),K=new Int32Array(N),F=new Int32Array(N),w=new Int32Array(N),k=new Int32Array(G),Y=new Int32Array(G),A=new Int32Array(G),h=null;if(E)h=new Int32Array(N);let Z=null;if(u)Z=new Int32Array(N);let f=null;if(O)f=new Int32Array(N);let S=null;if(b)S=new Int32Array(N);L=0,N=0,G=0;for(let W=0;W<R;W++){let B=_[W];if(B){let M=L;for(let v=0;v<B.vertexCount;v++)Q[L]=B.vertexX[v],$[L]=B.vertexY[v],J[L]=B.vertexZ[v],L++;for(let v=0;v<B.faceCount;v++){if(T[N]=B.faceVertexA[v]+M,m[N]=B.faceVertexB[v]+M,q[N]=B.faceVertexC[v]+M,B.faceColourA)K[N]=B.faceColourA[v];if(B.faceColourB)F[N]=B.faceColourB[v];if(B.faceColourC)w[N]=B.faceColourC[v];if(E){if(!B.faceInfo){if(h)h[N]=0}else if(h)h[N]=B.faceInfo[v]}if(u){if(!B.facePriority){if(Z)Z[N]=B.priority}else if(Z)Z[N]=B.facePriority[v]}if(O){if(!B.faceAlpha){if(f)f[N]=0}else if(f)f[N]=B.faceAlpha[v]}if(b&&B.faceColour){if(S)S[N]=B.faceColour[v]}N++}for(let v=0;v<B.texturedFaceCount;v++)k[G]=B.texturedVertexA[v]+M,Y[G]=B.texturedVertexB[v]+M,A[G]=B.texturedVertexC[v]+M,G++}}let j=new U({vertexCount:L,vertexX:Q,vertexY:$,vertexZ:J,faceCount:N,faceVertexA:T,faceVertexB:m,faceVertexC:q,faceColorA:K,faceColorB:F,faceColorC:w,faceInfo:h,facePriority:Z,faceAlpha:f,faceColor:S,priorityVal:H,texturedFaceCount:G,texturedVertexA:k,texturedVertexB:Y,texturedVertexC:A});return j.calculateBoundsCylinder(),j}static modelFromModels(_,R){let E=!1,u=!1,O=!1,b=!1,L=0,N=0,G=0,H=-1;for(let S=0;S<R;S++){let j=_[S];if(j){if(L+=j.vertexCount,N+=j.faceCount,G+=j.texturedFaceCount,E||=j.faceInfo!==null,!j.facePriority){if(H===-1)H=j.priority;if(H!==j.priority)u=!0}else u=!0;O||=j.faceAlpha!==null,b||=j.faceLabel!==null}}let Q=new Int32Array(L),$=new Int32Array(L),J=new Int32Array(L),T=new Int32Array(L),m=new Int32Array(N),q=new Int32Array(N),K=new Int32Array(N),F=new Int32Array(G),w=new Int32Array(G),k=new Int32Array(G),Y=null;if(E)Y=new Int32Array(N);let A=null;if(u)A=new Int32Array(N);let h=null;if(O)h=new Int32Array(N);let Z=null;if(b)Z=new Int32Array(N);let f=new Int32Array(N);L=0,N=0,G=0;for(let S=0;S<R;S++){let j=_[S];if(j){for(let W=0;W<j.faceCount;W++){if(E){if(!j.faceInfo){if(Y)Y[N]=0}else if(Y)Y[N]=j.faceInfo[W]}if(u){if(!j.facePriority){if(A)A[N]=j.priority}else if(A)A[N]=j.facePriority[W]}if(O){if(!j.faceAlpha){if(h)h[N]=0}else if(h)h[N]=j.faceAlpha[W]}if(b&&j.faceLabel){if(Z)Z[N]=j.faceLabel[W]}if(j.faceColour)f[N]=j.faceColour[W];let B=U.addVertex(j,j.faceVertexA[W],Q,$,J,T,L);L=B.vertexCount;let M=U.addVertex(j,j.faceVertexB[W],Q,$,J,T,L);L=M.vertexCount;let v=U.addVertex(j,j.faceVertexC[W],Q,$,J,T,L);L=v.vertexCount,m[N]=B.vertex,q[N]=M.vertex,K[N]=v.vertex,N++}for(let W=0;W<j.texturedFaceCount;W++){let B=U.addVertex(j,j.texturedVertexA[W],Q,$,J,T,L);L=B.vertexCount;let M=U.addVertex(j,j.texturedVertexB[W],Q,$,J,T,L);L=M.vertexCount;let v=U.addVertex(j,j.texturedVertexC[W],Q,$,J,T,L);L=v.vertexCount,F[G]=B.vertex,w[G]=M.vertex,k[G]=v.vertex,G++}}}return new U({vertexCount:L,vertexX:Q,vertexY:$,vertexZ:J,faceCount:N,faceVertexA:m,faceVertexB:q,faceVertexC:K,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:Y,facePriority:A,faceAlpha:h,faceColor:f,priorityVal:H,texturedFaceCount:G,texturedVertexA:F,texturedVertexB:w,texturedVertexC:k,vertexLabel:T,faceLabel:Z})}set(_,R){if(this.vertexCount=_.vertexCount,this.faceCount=_.faceCount,this.texturedFaceCount=_.texturedFaceCount,U.tmpVertexX.length<this.vertexCount)U.tmpVertexX=new Int32Array(this.vertexCount+100),U.tmpVertexY=new Int32Array(this.vertexCount+100),U.tmpVertexZ=new Int32Array(this.vertexCount+100);this.vertexX=U.tmpVertexX,this.vertexY=U.tmpVertexY,this.vertexZ=U.tmpVertexZ;for(let E=0;E<this.vertexCount;E++)this.vertexX[E]=_.vertexX[E],this.vertexY[E]=_.vertexY[E],this.vertexZ[E]=_.vertexZ[E];if(R)this.faceAlpha=_.faceAlpha;else{if(U.tmpFaceAlpha.length<this.faceCount)U.tmpFaceAlpha=new Int32Array(this.faceCount+100);if(this.faceAlpha=U.tmpFaceAlpha,!_.faceAlpha)for(let E=0;E<this.faceCount;E++)this.faceAlpha[E]=0;else for(let E=0;E<this.faceCount;E++)this.faceAlpha[E]=_.faceAlpha[E]}this.faceInfo=_.faceInfo,this.faceColour=_.faceColour,this.facePriority=_.facePriority,this.priority=_.priority,this.labelFaces=_.labelFaces,this.labelVertices=_.labelVertices,this.faceVertexA=_.faceVertexA,this.faceVertexB=_.faceVertexB,this.faceVertexC=_.faceVertexC,this.faceColourA=_.faceColourA,this.faceColourB=_.faceColourB,this.faceColourC=_.faceColourC,this.texturedVertexA=_.texturedVertexA,this.texturedVertexB=_.texturedVertexB,this.texturedVertexC=_.texturedVertexC}static addVertex=(_,R,E,u,O,b,L)=>{let N=-1;if(_.vertexX&&_.vertexY&&_.vertexZ){let G=_.vertexX[R],H=_.vertexY[R],Q=_.vertexZ[R];for(let $=0;$<L;$++)if(G===E[$]&&H===u[$]&&Q===O[$]){N=$;break}if(N===-1){if(E[L]=G,u[L]=H,O[L]=Q,b&&_.vertexLabel)b[L]=_.vertexLabel[R];N=L++}}return{vertex:N,vertexCount:L}};calculateBoundsCylinder(){this.minY=0,this.radius=0,this.maxY=0;for(let _=0;_<this.vertexCount;_++){let R=this.vertexX[_],E=this.vertexY[_],u=this.vertexZ[_];if(-E>this.minY)this.minY=-E;if(E>this.maxY)this.maxY=E;let O=R*R+u*u;if(O>this.radius)this.radius=O}this.radius=Math.sqrt(this.radius)+0.99|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0)}calculateBoundsY(){this.minY=0,this.maxY=0;for(let _=0;_<this.vertexCount;_++){let R=this.vertexY[_];if(-R>this.minY)this.minY=-R;if(R>this.maxY)this.maxY=R}this.minDepth=Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0)}calculateBoundsAABB(){this.minY=0,this.radius=0,this.maxY=0,this.minX=999999,this.maxX=-999999,this.maxZ=-99999,this.minZ=99999;for(let _=0;_<this.vertexCount;_++){let R=this.vertexX[_],E=this.vertexY[_],u=this.vertexZ[_];if(R<this.minX)this.minX=R;if(R>this.maxX)this.maxX=R;if(u<this.minZ)this.minZ=u;if(u>this.maxZ)this.maxZ=u;if(-E>this.minY)this.minY=-E;if(E>this.maxY)this.maxY=E;let O=R*R+u*u;if(O>this.radius)this.radius=O}this.radius=Math.sqrt(this.radius)|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.minY*this.minY)|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)|0)}createLabelReferences(){if(this.vertexLabel){let _=new Int32Array(256),R=0;for(let u=0;u<this.vertexCount;u++){let O=this.vertexLabel[u];if(_[O]++,O>R)R=O}this.labelVertices=new C(R+1,null);for(let u=0;u<=R;u++)this.labelVertices[u]=new Int32Array(_[u]),_[u]=0;let E=0;while(E<this.vertexCount){let u=this.vertexLabel[E],O=this.labelVertices[u];if(!O)continue;O[_[u]++]=E++}this.vertexLabel=null}if(this.faceLabel){let _=new Int32Array(256),R=0;for(let u=0;u<this.faceCount;u++){let O=this.faceLabel[u];if(_[O]++,O>R)R=O}this.labelFaces=new C(R+1,null);for(let u=0;u<=R;u++)this.labelFaces[u]=new Int32Array(_[u]),_[u]=0;let E=0;while(E<this.faceCount){let u=this.faceLabel[E],O=this.labelFaces[u];if(!O)continue;O[_[u]++]=E++}this.faceLabel=null}}applyTransform(_){if(!this.labelVertices||_===-1)return;let R=Z0.instances[_];if(!R)return;let E=R.base;U.baseX=0,U.baseY=0,U.baseZ=0;for(let u=0;u<R.length;u++){if(!R.groups||!R.x||!R.y||!R.z||!E||!E.labels||!E.types)continue;let O=R.groups[u];this.applyTransform2(R.x[u],R.y[u],R.z[u],E.labels[O],E.types[O])}}applyTransforms(_,R,E){if(_===-1)return;if(!E||R===-1){this.applyTransform(_);return}let u=Z0.get(_);if(!u)return;let O=Z0.get(R);if(!O){this.applyTransform(_);return}let b=u.base;U.baseX=0,U.baseY=0,U.baseZ=0;let L=0,N=E[L++];for(let G=0;G<u.length;G++){if(!u.groups)continue;let H=u.groups[G];while(H>N)N=E[L++];if(b&&b.types&&u.x&&u.y&&u.z&&b.labels&&(H!==N||b.types[H]===0))this.applyTransform2(u.x[G],u.y[G],u.z[G],b.labels[H],b.types[H])}U.baseX=0,U.baseY=0,U.baseZ=0,L=0,N=E[L++];for(let G=0;G<O.length;G++){if(!O.groups)continue;let H=O.groups[G];while(H>N)N=E[L++];if(b&&b.types&&O.x&&O.y&&O.z&&b.labels&&(H===N||b.types[H]===0))this.applyTransform2(O.x[G],O.y[G],O.z[G],b.labels[H],b.types[H])}}applyTransform2(_,R,E,u,O){if(!u)return;let b=u.length;if(O===0){let L=0;U.baseX=0,U.baseY=0,U.baseZ=0;for(let N=0;N<b;N++){if(!this.labelVertices)continue;let G=u[N];if(G<this.labelVertices.length){let H=this.labelVertices[G];if(H)for(let Q=0;Q<H.length;Q++){let $=H[Q];U.baseX+=this.vertexX[$],U.baseY+=this.vertexY[$],U.baseZ+=this.vertexZ[$],L++}}}if(L>0)U.baseX=(U.baseX/L|0)+_,U.baseY=(U.baseY/L|0)+R,U.baseZ=(U.baseZ/L|0)+E;else U.baseX=_,U.baseY=R,U.baseZ=E}else if(O===1)for(let L=0;L<b;L++){let N=u[L];if(!this.labelVertices||N>=this.labelVertices.length)continue;let G=this.labelVertices[N];if(G)for(let H=0;H<G.length;H++){let Q=G[H];this.vertexX[Q]+=_,this.vertexY[Q]+=R,this.vertexZ[Q]+=E}}else if(O===2)for(let L=0;L<b;L++){let N=u[L];if(!this.labelVertices||N>=this.labelVertices.length)continue;let G=this.labelVertices[N];if(G)for(let H=0;H<G.length;H++){let Q=G[H];this.vertexX[Q]-=U.baseX,this.vertexY[Q]-=U.baseY,this.vertexZ[Q]-=U.baseZ;let $=(_&255)*8,J=(R&255)*8,T=(E&255)*8,m,q;if(T!==0){m=X.sinTable[T],q=X.cosTable[T];let K=this.vertexY[Q]*m+this.vertexX[Q]*q>>16;this.vertexY[Q]=this.vertexY[Q]*q-this.vertexX[Q]*m>>16,this.vertexX[Q]=K}if($!==0){m=X.sinTable[$],q=X.cosTable[$];let K=this.vertexY[Q]*q-this.vertexZ[Q]*m>>16;this.vertexZ[Q]=this.vertexY[Q]*m+this.vertexZ[Q]*q>>16,this.vertexY[Q]=K}if(J!==0){m=X.sinTable[J],q=X.cosTable[J];let K=this.vertexZ[Q]*m+this.vertexX[Q]*q>>16;this.vertexZ[Q]=this.vertexZ[Q]*q-this.vertexX[Q]*m>>16,this.vertexX[Q]=K}this.vertexX[Q]+=U.baseX,this.vertexY[Q]+=U.baseY,this.vertexZ[Q]+=U.baseZ}}else if(O===3)for(let L=0;L<b;L++){let N=u[L];if(!this.labelVertices||N>=this.labelVertices.length)continue;let G=this.labelVertices[N];if(G)for(let H=0;H<G.length;H++){let Q=G[H];this.vertexX[Q]-=U.baseX,this.vertexY[Q]-=U.baseY,this.vertexZ[Q]-=U.baseZ,this.vertexX[Q]=this.vertexX[Q]*_/128|0,this.vertexY[Q]=this.vertexY[Q]*R/128|0,this.vertexZ[Q]=this.vertexZ[Q]*E/128|0,this.vertexX[Q]+=U.baseX,this.vertexY[Q]+=U.baseY,this.vertexZ[Q]+=U.baseZ}}else if(O===5&&this.labelFaces&&this.faceAlpha)for(let L=0;L<b;L++){let N=u[L];if(N>=this.labelFaces.length)continue;let G=this.labelFaces[N];if(G)for(let H=0;H<G.length;H++){let Q=G[H];if(this.faceAlpha[Q]+=_*8,this.faceAlpha[Q]<0)this.faceAlpha[Q]=0;if(this.faceAlpha[Q]>255)this.faceAlpha[Q]=255}}}rotateY90(){for(let _=0;_<this.vertexCount;_++){let R=this.vertexX[_];this.vertexX[_]=this.vertexZ[_],this.vertexZ[_]=-R}}rotateX(_){let R=X.sinTable[_],E=X.cosTable[_];for(let u=0;u<this.vertexCount;u++){let O=this.vertexY[u]*E-this.vertexZ[u]*R>>16;this.vertexZ[u]=this.vertexY[u]*R+this.vertexZ[u]*E>>16,this.vertexY[u]=O}}translate(_,R,E){for(let u=0;u<this.vertexCount;u++)this.vertexX[u]+=R,this.vertexY[u]+=_,this.vertexZ[u]+=E}recolour(_,R){if(!this.faceColour)return;for(let E=0;E<this.faceCount;E++)if(this.faceColour[E]===_)this.faceColour[E]=R}rotateY180(){for(let _=0;_<this.vertexCount;_++)this.vertexZ[_]=-this.vertexZ[_];for(let _=0;_<this.faceCount;_++){let R=this.faceVertexA[_];this.faceVertexA[_]=this.faceVertexC[_],this.faceVertexC[_]=R}}scale(_,R,E){for(let u=0;u<this.vertexCount;u++)this.vertexX[u]=this.vertexX[u]*_/128|0,this.vertexY[u]=this.vertexY[u]*R/128|0,this.vertexZ[u]=this.vertexZ[u]*E/128|0}calculateNormals(_,R,E,u,O,b){let L=Math.sqrt(E*E+u*u+O*O)|0,N=R*L>>8;if(!this.faceColourA||!this.faceColourB||!this.faceColourC)this.faceColourA=new Int32Array(this.faceCount),this.faceColourB=new Int32Array(this.faceCount),this.faceColourC=new Int32Array(this.faceCount);if(!this.vertexNormal){this.vertexNormal=new C(this.vertexCount,null);for(let G=0;G<this.vertexCount;G++)this.vertexNormal[G]=new i0}for(let G=0;G<this.faceCount;G++){let H=this.faceVertexA[G],Q=this.faceVertexB[G],$=this.faceVertexC[G],J=this.vertexX[Q]-this.vertexX[H],T=this.vertexY[Q]-this.vertexY[H],m=this.vertexZ[Q]-this.vertexZ[H],q=this.vertexX[$]-this.vertexX[H],K=this.vertexY[$]-this.vertexY[H],F=this.vertexZ[$]-this.vertexZ[H],w=T*F-K*m,k=m*q-F*J,Y=J*K-q*T;while(w>8192||k>8192||Y>8192||w<-8192||k<-8192||Y<-8192)w>>=1,k>>=1,Y>>=1;let A=Math.sqrt(w*w+k*k+Y*Y)|0;if(A<=0)A=1;if(w=w*256/A|0,k=k*256/A|0,Y=Y*256/A|0,!this.faceInfo||(this.faceInfo[G]&1)===0){let h=this.vertexNormal[H];if(h)h.x+=w,h.y+=k,h.z+=Y,h.w++;if(h=this.vertexNormal[Q],h)h.x+=w,h.y+=k,h.z+=Y,h.w++;if(h=this.vertexNormal[$],h)h.x+=w,h.y+=k,h.z+=Y,h.w++}else{let h=_+((E*w+u*k+O*Y)/(N+(N/2|0))|0);if(this.faceColour)this.faceColourA[G]=U.mulColourLightness(this.faceColour[G],h,this.faceInfo[G])}}if(b)this.applyLighting(_,N,E,u,O);else{this.vertexNormalOriginal=new C(this.vertexCount,null);for(let G=0;G<this.vertexCount;G++){let H=this.vertexNormal[G],Q=new i0;if(H)Q.x=H.x,Q.y=H.y,Q.z=H.z,Q.w=H.w;this.vertexNormalOriginal[G]=Q}}if(b)this.calculateBoundsCylinder();else this.calculateBoundsAABB()}applyLighting(_,R,E,u,O){for(let b=0;b<this.faceCount;b++){let L=this.faceVertexA[b],N=this.faceVertexB[b],G=this.faceVertexC[b];if(!this.faceInfo&&this.faceColour&&this.vertexNormal&&this.faceColourA&&this.faceColourB&&this.faceColourC){let H=this.faceColour[b],Q=this.vertexNormal[L];if(Q)this.faceColourA[b]=U.mulColourLightness(H,_+((E*Q.x+u*Q.y+O*Q.z)/(R*Q.w)|0),0);let $=this.vertexNormal[N];if($)this.faceColourB[b]=U.mulColourLightness(H,_+((E*$.x+u*$.y+O*$.z)/(R*$.w)|0),0);let J=this.vertexNormal[G];if(J)this.faceColourC[b]=U.mulColourLightness(H,_+((E*J.x+u*J.y+O*J.z)/(R*J.w)|0),0)}else if(this.faceInfo&&(this.faceInfo[b]&1)===0&&this.faceColour&&this.vertexNormal&&this.faceColourA&&this.faceColourB&&this.faceColourC){let H=this.faceColour[b],Q=this.faceInfo[b],$=this.vertexNormal[L];if($)this.faceColourA[b]=U.mulColourLightness(H,_+((E*$.x+u*$.y+O*$.z)/(R*$.w)|0),Q);let J=this.vertexNormal[N];if(J)this.faceColourB[b]=U.mulColourLightness(H,_+((E*J.x+u*J.y+O*J.z)/(R*J.w)|0),Q);let T=this.vertexNormal[G];if(T)this.faceColourC[b]=U.mulColourLightness(H,_+((E*T.x+u*T.y+O*T.z)/(R*T.w)|0),Q)}}if(this.vertexNormal=null,this.vertexNormalOriginal=null,this.vertexLabel=null,this.faceLabel=null,this.faceInfo){for(let b=0;b<this.faceCount;b++)if((this.faceInfo[b]&2)===2)return}this.faceColour=null}static mulColourLightness(_,R,E){if((E&2)===2){if(R<0)R=0;else if(R>127)R=127;return 127-R}if(R=R*(_&127)>>7,R<2)R=2;else if(R>126)R=126;return(_&65408)+R}drawSimple(_,R,E,u,O,b,L){let N=X.sinTable[_],G=X.cosTable[_],H=X.sinTable[R],Q=X.cosTable[R],$=X.sinTable[E],J=X.cosTable[E],T=X.sinTable[u],m=X.cosTable[u],q=b*T+L*m>>16;for(let K=0;K<this.vertexCount;K++){let F=this.vertexX[K],w=this.vertexY[K],k=this.vertexZ[K],Y;if(E!==0)Y=w*$+F*J>>16,w=w*J-F*$>>16,F=Y;if(_!==0)Y=w*G-k*N>>16,k=w*N+k*G>>16,w=Y;if(R!==0)Y=k*H+F*Q>>16,k=k*Q-F*H>>16,F=Y;if(F+=O,w+=b,k+=L,Y=w*m-k*T>>16,k=w*T+k*m>>16,w=Y,U.vertexScreenX&&U.vertexScreenY&&U.vertexScreenZ)U.vertexScreenZ[K]=k-q,U.vertexScreenX[K]=X.centerX+((F<<9)/k|0),U.vertexScreenY[K]=X.centerY+((w<<9)/k|0);if(this.texturedFaceCount>0&&U.vertexViewSpaceX&&U.vertexViewSpaceY&&U.vertexViewSpaceZ)U.vertexViewSpaceX[K]=F,U.vertexViewSpaceY[K]=w,U.vertexViewSpaceZ[K]=k}try{this.draw2(!1,!1,0)}catch(K){}}draw(_,R,E,u,O,b,L,N,G,H){let Q=G*b-L*O>>16,$=N*E+Q*u>>16,J=this.radius*u>>16,T=$+J;if(T<=50||$>=3500)return;let m=G*O+L*b>>16,q=m-this.radius<<9;if((q/T|0)>=I.centerX2d)return;let K=m+this.radius<<9;if((K/T|0)<=-I.centerX2d)return;let F=N*u-Q*E>>16,w=this.radius*E>>16,k=F+w<<9;if((k/T|0)<=-I.centerY2d)return;let Y=w+(this.minY*u>>16),A=F-Y<<9;if((A/T|0)>=I.centerY2d)return;let h=J+(this.minY*E>>16),Z=$-h<=50,f=!1;if(H>0&&U.checkHover){let M=$-J;if(M<=50)M=50;if(m>0)q=q/T|0,K=K/M|0;else K=K/T|0,q=q/M|0;if(F>0)A=A/T|0,k=k/M|0;else k=k/T|0,A=A/M|0;let v=U.mouseX-X.centerX,p=U.mouseY-X.centerY;if(v>q&&v<K&&p>A&&p<k)if(this.picking)U.pickedBitsets[U.pickedCount++]=H;else f=!0}let S=X.centerX,j=X.centerY,W=0,B=0;if(R!==0)W=X.sinTable[R],B=X.cosTable[R];for(let M=0;M<this.vertexCount;M++){let v=this.vertexX[M],p=this.vertexY[M],D=this.vertexZ[M],a;if(R!==0)a=D*W+v*B>>16,D=D*B-v*W>>16,v=a;if(v+=L,p+=N,D+=G,a=D*O+v*b>>16,D=D*b-v*O>>16,v=a,a=p*u-D*E>>16,D=p*E+D*u>>16,p=a,U.vertexScreenZ)U.vertexScreenZ[M]=D-$;if(D>=50&&U.vertexScreenX&&U.vertexScreenY)U.vertexScreenX[M]=S+((v<<9)/D|0),U.vertexScreenY[M]=j+((p<<9)/D|0);else if(U.vertexScreenX)U.vertexScreenX[M]=-5000,Z=!0;if((Z||this.texturedFaceCount>0)&&U.vertexViewSpaceX&&U.vertexViewSpaceY&&U.vertexViewSpaceZ)U.vertexViewSpaceX[M]=v,U.vertexViewSpaceY[M]=p,U.vertexViewSpaceZ[M]=D}try{this.draw2(Z,f,H)}catch(M){}}draw2(_,R,E,u=!1){for(let N=0;N<this.maxDepth;N++)if(U.tmpDepthFaceCount)U.tmpDepthFaceCount[N]=0;for(let N=0;N<this.faceCount;N++){if(this.faceInfo&&this.faceInfo[N]===-1)continue;if(U.vertexScreenX&&U.vertexScreenY&&U.vertexScreenZ&&U.tmpDepthFaces&&U.tmpDepthFaceCount){let G=this.faceVertexA[N],H=this.faceVertexB[N],Q=this.faceVertexC[N],$=U.vertexScreenX[G],J=U.vertexScreenX[H],T=U.vertexScreenX[Q],m=U.vertexScreenY[G],q=U.vertexScreenY[H],K=U.vertexScreenY[Q],F=U.vertexScreenZ[G],w=U.vertexScreenZ[H],k=U.vertexScreenZ[Q];if(_&&($===-5000||J===-5000||T===-5000)){if(U.faceNearClipped)U.faceNearClipped[N]=!0;if(U.tmpDepthFaces&&U.tmpDepthFaceCount){let Y=((F+w+k)/3|0)+this.minDepth;U.tmpDepthFaces[Y][U.tmpDepthFaceCount[Y]++]=N}}else{if(R&&this.pointWithinTriangle(U.mouseX,U.mouseY,m,q,K,$,J,T))U.pickedBitsets[U.pickedCount++]=E,R=!1;let Y=$-J,A=m-q,h=T-J,Z=K-q;if(Y*Z-A*h<=0)continue;if(U.faceNearClipped)U.faceNearClipped[N]=!1;if(U.faceClippedX)U.faceClippedX[N]=$<0||J<0||T<0||$>I.boundX||J>I.boundX||T>I.boundX;if(U.tmpDepthFaces&&U.tmpDepthFaceCount){let f=((F+w+k)/3|0)+this.minDepth;U.tmpDepthFaces[f][U.tmpDepthFaceCount[f]++]=N}}}}if(!this.facePriority&&U.tmpDepthFaceCount){for(let N=this.maxDepth-1;N>=0;N--){let G=U.tmpDepthFaceCount[N];if(G<=0)continue;if(U.tmpDepthFaces){let H=U.tmpDepthFaces[N];for(let Q=0;Q<G;Q++)try{this.drawFace(H[Q],u)}catch($){}}}return}for(let N=0;N<12;N++)if(U.tmpPriorityFaceCount&&U.tmpPriorityDepthSum)U.tmpPriorityFaceCount[N]=0,U.tmpPriorityDepthSum[N]=0;if(U.tmpDepthFaceCount)for(let N=this.maxDepth-1;N>=0;N--){let G=U.tmpDepthFaceCount[N];if(G>0&&U.tmpDepthFaces){let H=U.tmpDepthFaces[N];for(let Q=0;Q<G;Q++)if(this.facePriority&&U.tmpPriorityFaceCount&&U.tmpPriorityFaces){let $=H[Q],J=this.facePriority[$],T=U.tmpPriorityFaceCount[J]++;if(U.tmpPriorityFaces[J][T]=$,J<10&&U.tmpPriorityDepthSum)U.tmpPriorityDepthSum[J]+=N;else if(J===10&&U.tmpPriority10FaceDepth)U.tmpPriority10FaceDepth[T]=N;else if(U.tmpPriority11FaceDepth)U.tmpPriority11FaceDepth[T]=N}}}let O=0;if(U.tmpPriorityFaceCount&&U.tmpPriorityDepthSum&&(U.tmpPriorityFaceCount[1]>0||U.tmpPriorityFaceCount[2]>0))O=(U.tmpPriorityDepthSum[1]+U.tmpPriorityDepthSum[2])/(U.tmpPriorityFaceCount[1]+U.tmpPriorityFaceCount[2])|0;let b=0;if(U.tmpPriorityFaceCount&&U.tmpPriorityDepthSum&&(U.tmpPriorityFaceCount[3]>0||U.tmpPriorityFaceCount[4]>0))b=(U.tmpPriorityDepthSum[3]+U.tmpPriorityDepthSum[4])/(U.tmpPriorityFaceCount[3]+U.tmpPriorityFaceCount[4])|0;let L=0;if(U.tmpPriorityFaceCount&&U.tmpPriorityDepthSum&&(U.tmpPriorityFaceCount[6]>0||U.tmpPriorityFaceCount[8]>0))L=(U.tmpPriorityDepthSum[6]+U.tmpPriorityDepthSum[8])/(U.tmpPriorityFaceCount[6]+U.tmpPriorityFaceCount[8])|0;if(U.tmpPriorityFaceCount&&U.tmpPriorityFaces){let N=0,G=U.tmpPriorityFaceCount[10],H=U.tmpPriorityFaces[10],Q=U.tmpPriority10FaceDepth;if(N===G)N=0,G=U.tmpPriorityFaceCount[11],H=U.tmpPriorityFaces[11],Q=U.tmpPriority11FaceDepth;let $;if(N<G&&Q)$=Q[N];else $=-1000;for(let J=0;J<10;J++){while(J===0&&$>O)try{if(this.drawFace(H[N++],u),N===G&&H!==U.tmpPriorityFaces[11])N=0,G=U.tmpPriorityFaceCount[11],H=U.tmpPriorityFaces[11],Q=U.tmpPriority11FaceDepth;if(N<G&&Q)$=Q[N];else $=-1000}catch(q){}while(J===3&&$>b)try{if(this.drawFace(H[N++],u),N===G&&H!==U.tmpPriorityFaces[11])N=0,G=U.tmpPriorityFaceCount[11],H=U.tmpPriorityFaces[11],Q=U.tmpPriority11FaceDepth;if(N<G&&Q)$=Q[N];else $=-1000}catch(q){}while(J===5&&$>L)try{if(this.drawFace(H[N++],u),N===G&&H!==U.tmpPriorityFaces[11])N=0,G=U.tmpPriorityFaceCount[11],H=U.tmpPriorityFaces[11],Q=U.tmpPriority11FaceDepth;if(N<G&&Q)$=Q[N];else $=-1000}catch(q){}let T=U.tmpPriorityFaceCount[J],m=U.tmpPriorityFaces[J];for(let q=0;q<T;q++)try{this.drawFace(m[q],u)}catch(K){}}while($!==-1000)try{if(this.drawFace(H[N++],u),N===G&&H!==U.tmpPriorityFaces[11])N=0,H=U.tmpPriorityFaces[11],G=U.tmpPriorityFaceCount[11],Q=U.tmpPriority11FaceDepth;if(N<G&&Q)$=Q[N];else $=-1000}catch(J){}}}drawFace(_,R=!1){if(U.faceNearClipped&&U.faceNearClipped[_]){this.drawNearClippedFace(_,R);return}let E=this.faceVertexA[_],u=this.faceVertexB[_],O=this.faceVertexC[_];if(U.faceClippedX)X.clipX=U.faceClippedX[_];if(!this.faceAlpha)X.alpha=0;else X.alpha=this.faceAlpha[_];let b;if(!this.faceInfo)b=0;else b=this.faceInfo[_]&3;if(R&&U.vertexScreenX&&U.vertexScreenY&&this.faceColourA&&this.faceColourB&&this.faceColourC)X.drawLine(U.vertexScreenX[E],U.vertexScreenY[E],U.vertexScreenX[u],U.vertexScreenY[u],X.colourTable[this.faceColourA[_]]),X.drawLine(U.vertexScreenX[u],U.vertexScreenY[u],U.vertexScreenX[O],U.vertexScreenY[O],X.colourTable[this.faceColourB[_]]),X.drawLine(U.vertexScreenX[O],U.vertexScreenY[O],U.vertexScreenX[E],U.vertexScreenY[E],X.colourTable[this.faceColourC[_]]);else if(b===0&&this.faceColourA&&this.faceColourB&&this.faceColourC&&U.vertexScreenX&&U.vertexScreenY)X.gouraudTriangle(U.vertexScreenX[E],U.vertexScreenX[u],U.vertexScreenX[O],U.vertexScreenY[E],U.vertexScreenY[u],U.vertexScreenY[O],this.faceColourA[_],this.faceColourB[_],this.faceColourC[_]);else if(b===1&&this.faceColourA&&U.vertexScreenX&&U.vertexScreenY)X.flatTriangle(U.vertexScreenX[E],U.vertexScreenX[u],U.vertexScreenX[O],U.vertexScreenY[E],U.vertexScreenY[u],U.vertexScreenY[O],X.colourTable[this.faceColourA[_]]);else if(b===2&&this.faceInfo&&this.faceColour&&this.faceColourA&&this.faceColourB&&this.faceColourC&&U.vertexScreenX&&U.vertexScreenY&&U.vertexViewSpaceX&&U.vertexViewSpaceY&&U.vertexViewSpaceZ){let L=this.faceInfo[_]>>2,N=this.texturedVertexA[L],G=this.texturedVertexB[L],H=this.texturedVertexC[L];X.textureTriangle(U.vertexScreenX[E],U.vertexScreenX[u],U.vertexScreenX[O],U.vertexScreenY[E],U.vertexScreenY[u],U.vertexScreenY[O],this.faceColourA[_],this.faceColourB[_],this.faceColourC[_],U.vertexViewSpaceX[N],U.vertexViewSpaceY[N],U.vertexViewSpaceZ[N],U.vertexViewSpaceX[G],U.vertexViewSpaceX[H],U.vertexViewSpaceY[G],U.vertexViewSpaceY[H],U.vertexViewSpaceZ[G],U.vertexViewSpaceZ[H],this.faceColour[_])}else if(b===3&&this.faceInfo&&this.faceColour&&this.faceColourA&&U.vertexScreenX&&U.vertexScreenY&&U.vertexViewSpaceX&&U.vertexViewSpaceY&&U.vertexViewSpaceZ){let L=this.faceInfo[_]>>2,N=this.texturedVertexA[L],G=this.texturedVertexB[L],H=this.texturedVertexC[L];X.textureTriangle(U.vertexScreenX[E],U.vertexScreenX[u],U.vertexScreenX[O],U.vertexScreenY[E],U.vertexScreenY[u],U.vertexScreenY[O],this.faceColourA[_],this.faceColourA[_],this.faceColourA[_],U.vertexViewSpaceX[N],U.vertexViewSpaceY[N],U.vertexViewSpaceZ[N],U.vertexViewSpaceX[G],U.vertexViewSpaceX[H],U.vertexViewSpaceY[G],U.vertexViewSpaceY[H],U.vertexViewSpaceZ[G],U.vertexViewSpaceZ[H],this.faceColour[_])}}drawNearClippedFace(_,R=!1){let E=0;if(U.vertexViewSpaceZ){let H=X.centerX,Q=X.centerY,$=this.faceVertexA[_],J=this.faceVertexB[_],T=this.faceVertexC[_],m=U.vertexViewSpaceZ[$],q=U.vertexViewSpaceZ[J],K=U.vertexViewSpaceZ[T];if(m>=50&&U.vertexScreenX&&U.vertexScreenY&&this.faceColourA)U.clippedX[E]=U.vertexScreenX[$],U.clippedY[E]=U.vertexScreenY[$],U.clippedColour[E++]=this.faceColourA[_];else if(U.vertexViewSpaceX&&U.vertexViewSpaceY&&this.faceColourA){let F=U.vertexViewSpaceX[$],w=U.vertexViewSpaceY[$],k=this.faceColourA[_];if(K>=50&&this.faceColourC){let Y=(50-m)*X.divTable2[K-m];U.clippedX[E]=H+((F+((U.vertexViewSpaceX[T]-F)*Y>>16)<<9)/50|0),U.clippedY[E]=Q+((w+((U.vertexViewSpaceY[T]-w)*Y>>16)<<9)/50|0),U.clippedColour[E++]=k+((this.faceColourC[_]-k)*Y>>16)}if(q>=50&&this.faceColourB){let Y=(50-m)*X.divTable2[q-m];U.clippedX[E]=H+((F+((U.vertexViewSpaceX[J]-F)*Y>>16)<<9)/50|0),U.clippedY[E]=Q+((w+((U.vertexViewSpaceY[J]-w)*Y>>16)<<9)/50|0),U.clippedColour[E++]=k+((this.faceColourB[_]-k)*Y>>16)}}if(q>=50&&U.vertexScreenX&&U.vertexScreenY&&this.faceColourB)U.clippedX[E]=U.vertexScreenX[J],U.clippedY[E]=U.vertexScreenY[J],U.clippedColour[E++]=this.faceColourB[_];else if(U.vertexViewSpaceX&&U.vertexViewSpaceY&&this.faceColourB){let F=U.vertexViewSpaceX[J],w=U.vertexViewSpaceY[J],k=this.faceColourB[_];if(m>=50&&this.faceColourA){let Y=(50-q)*X.divTable2[m-q];U.clippedX[E]=H+((F+((U.vertexViewSpaceX[$]-F)*Y>>16)<<9)/50|0),U.clippedY[E]=Q+((w+((U.vertexViewSpaceY[$]-w)*Y>>16)<<9)/50|0),U.clippedColour[E++]=k+((this.faceColourA[_]-k)*Y>>16)}if(K>=50&&this.faceColourC){let Y=(50-q)*X.divTable2[K-q];U.clippedX[E]=H+((F+((U.vertexViewSpaceX[T]-F)*Y>>16)<<9)/50|0),U.clippedY[E]=Q+((w+((U.vertexViewSpaceY[T]-w)*Y>>16)<<9)/50|0),U.clippedColour[E++]=k+((this.faceColourC[_]-k)*Y>>16)}}if(K>=50&&U.vertexScreenX&&U.vertexScreenY&&this.faceColourC)U.clippedX[E]=U.vertexScreenX[T],U.clippedY[E]=U.vertexScreenY[T],U.clippedColour[E++]=this.faceColourC[_];else if(U.vertexViewSpaceX&&U.vertexViewSpaceY&&this.faceColourC){let F=U.vertexViewSpaceX[T],w=U.vertexViewSpaceY[T],k=this.faceColourC[_];if(q>=50&&this.faceColourB){let Y=(50-K)*X.divTable2[q-K];U.clippedX[E]=H+((F+((U.vertexViewSpaceX[J]-F)*Y>>16)<<9)/50|0),U.clippedY[E]=Q+((w+((U.vertexViewSpaceY[J]-w)*Y>>16)<<9)/50|0),U.clippedColour[E++]=k+((this.faceColourB[_]-k)*Y>>16)}if(m>=50&&this.faceColourA){let Y=(50-K)*X.divTable2[m-K];U.clippedX[E]=H+((F+((U.vertexViewSpaceX[$]-F)*Y>>16)<<9)/50|0),U.clippedY[E]=Q+((w+((U.vertexViewSpaceY[$]-w)*Y>>16)<<9)/50|0),U.clippedColour[E++]=k+((this.faceColourA[_]-k)*Y>>16)}}}let u=U.clippedX[0],O=U.clippedX[1],b=U.clippedX[2],L=U.clippedY[0],N=U.clippedY[1],G=U.clippedY[2];if((u-O)*(G-N)-(L-N)*(b-O)<=0)return;if(X.clipX=!1,E===3){if(u<0||O<0||b<0||u>I.boundX||O>I.boundX||b>I.boundX)X.clipX=!0;let H;if(!this.faceInfo)H=0;else H=this.faceInfo[_]&3;if(R)X.drawLine(u,O,L,N,U.clippedColour[0]),X.drawLine(O,b,N,G,U.clippedColour[1]),X.drawLine(b,u,G,L,U.clippedColour[2]);else if(H===0)X.gouraudTriangle(u,O,b,L,N,G,U.clippedColour[0],U.clippedColour[1],U.clippedColour[2]);else if(H===1&&this.faceColourA)X.flatTriangle(u,O,b,L,N,G,X.colourTable[this.faceColourA[_]]);else if(H===2&&this.faceInfo&&this.faceColour&&U.vertexViewSpaceX&&U.vertexViewSpaceY&&U.vertexViewSpaceZ){let Q=this.faceInfo[_]>>2,$=this.texturedVertexA[Q],J=this.texturedVertexB[Q],T=this.texturedVertexC[Q];X.textureTriangle(u,O,b,L,N,G,U.clippedColour[0],U.clippedColour[1],U.clippedColour[2],U.vertexViewSpaceX[$],U.vertexViewSpaceY[$],U.vertexViewSpaceZ[$],U.vertexViewSpaceX[J],U.vertexViewSpaceX[T],U.vertexViewSpaceY[J],U.vertexViewSpaceY[T],U.vertexViewSpaceZ[J],U.vertexViewSpaceZ[T],this.faceColour[_])}else if(H===3&&this.faceInfo&&this.faceColour&&this.faceColourA&&U.vertexViewSpaceX&&U.vertexViewSpaceY&&U.vertexViewSpaceZ){let Q=this.faceInfo[_]>>2,$=this.texturedVertexA[Q],J=this.texturedVertexB[Q],T=this.texturedVertexC[Q];X.textureTriangle(u,O,b,L,N,G,this.faceColourA[_],this.faceColourA[_],this.faceColourA[_],U.vertexViewSpaceX[$],U.vertexViewSpaceY[$],U.vertexViewSpaceZ[$],U.vertexViewSpaceX[J],U.vertexViewSpaceX[T],U.vertexViewSpaceY[J],U.vertexViewSpaceY[T],U.vertexViewSpaceZ[J],U.vertexViewSpaceZ[T],this.faceColour[_])}}else if(E===4){if(u<0||O<0||b<0||u>I.boundX||O>I.boundX||b>I.boundX||U.clippedX[3]<0||U.clippedX[3]>I.boundX)X.clipX=!0;let H;if(!this.faceInfo)H=0;else H=this.faceInfo[_]&3;if(R)X.drawLine(u,O,L,N,U.clippedColour[0]),X.drawLine(O,b,N,G,U.clippedColour[1]),X.drawLine(b,U.clippedX[3],G,U.clippedY[3],U.clippedColour[2]),X.drawLine(U.clippedX[3],u,U.clippedY[3],L,U.clippedColour[3]);else if(H===0)X.gouraudTriangle(u,O,b,L,N,G,U.clippedColour[0],U.clippedColour[1],U.clippedColour[2]),X.gouraudTriangle(u,b,U.clippedX[3],L,G,U.clippedY[3],U.clippedColour[0],U.clippedColour[2],U.clippedColour[3]);else if(H===1){if(this.faceColourA){let Q=X.colourTable[this.faceColourA[_]];X.flatTriangle(u,O,b,L,N,G,Q),X.flatTriangle(u,b,U.clippedX[3],L,G,U.clippedY[3],Q)}}else if(H===2&&this.faceInfo&&this.faceColour&&U.vertexViewSpaceX&&U.vertexViewSpaceY&&U.vertexViewSpaceZ){let Q=this.faceInfo[_]>>2,$=this.texturedVertexA[Q],J=this.texturedVertexB[Q],T=this.texturedVertexC[Q];X.textureTriangle(u,O,b,L,N,G,U.clippedColour[0],U.clippedColour[1],U.clippedColour[2],U.vertexViewSpaceX[$],U.vertexViewSpaceY[$],U.vertexViewSpaceZ[$],U.vertexViewSpaceX[J],U.vertexViewSpaceX[T],U.vertexViewSpaceY[J],U.vertexViewSpaceY[T],U.vertexViewSpaceZ[J],U.vertexViewSpaceZ[T],this.faceColour[_]),X.textureTriangle(u,b,U.clippedX[3],L,G,U.clippedY[3],U.clippedColour[0],U.clippedColour[2],U.clippedColour[3],U.vertexViewSpaceX[$],U.vertexViewSpaceY[$],U.vertexViewSpaceZ[$],U.vertexViewSpaceX[J],U.vertexViewSpaceX[T],U.vertexViewSpaceY[J],U.vertexViewSpaceY[T],U.vertexViewSpaceZ[J],U.vertexViewSpaceZ[T],this.faceColour[_])}else if(H===3&&this.faceInfo&&this.faceColour&&this.faceColourA&&U.vertexViewSpaceX&&U.vertexViewSpaceY&&U.vertexViewSpaceZ){let Q=this.faceInfo[_]>>2,$=this.texturedVertexA[Q],J=this.texturedVertexB[Q],T=this.texturedVertexC[Q];X.textureTriangle(u,O,b,L,N,G,this.faceColourA[_],this.faceColourA[_],this.faceColourA[_],U.vertexViewSpaceX[$],U.vertexViewSpaceY[$],U.vertexViewSpaceZ[$],U.vertexViewSpaceX[J],U.vertexViewSpaceX[T],U.vertexViewSpaceY[J],U.vertexViewSpaceY[T],U.vertexViewSpaceZ[J],U.vertexViewSpaceZ[T],this.faceColour[_]),X.textureTriangle(u,b,U.clippedX[3],L,G,U.clippedY[3],this.faceColourA[_],this.faceColourA[_],this.faceColourA[_],U.vertexViewSpaceX[$],U.vertexViewSpaceY[$],U.vertexViewSpaceZ[$],U.vertexViewSpaceX[J],U.vertexViewSpaceX[T],U.vertexViewSpaceY[J],U.vertexViewSpaceY[T],U.vertexViewSpaceZ[J],U.vertexViewSpaceZ[T],this.faceColour[_])}}}pointWithinTriangle(_,R,E,u,O,b,L,N){if(R<E&&R<u&&R<O)return!1;else if(R>E&&R>u&&R>O)return!1;else if(_<b&&_<L&&_<N)return!1;else return _<=b||_<=L||_<=N}}class o extends I0{static ignoreCache=!1;static count=0;static idx=null;static data=null;static cache=null;static cachePos=0;models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;active=!1;_active=-1;hillskew=!1;sharelight=!1;occlude=!1;static modelCacheStatic=new V0(500);static modelCacheDynamic=new V0(30);ambient=0;contrast=0;anim=-1;wallwidth=16;mapfunction=-1;mapscene=-1;resizex=128;resizey=128;resizez=128;offsetx=0;offsety=0;offsetz=0;forceapproach=0;animHasAlpha=!1;mirror=!1;shadow=!0;forcedecor=!1;breakroutefinding=!1;op=null;static unpack(_){this.data=new P(_.read("loc.dat"));let R=new P(_.read("loc.idx"));this.count=R.g2(),this.idx=new Int32Array(this.count);let E=2;for(let u=0;u<this.count;u++)this.idx[u]=E,E+=R.g2();this.cache=new C(10,null);for(let u=0;u<10;u++)this.cache[u]=new o(-1)}static get(_){if(!this.cache||!this.idx||!this.data)throw Error();for(let E=0;E<10;E++){let u=this.cache[E];if(!u)continue;if(u.id===_)return u}this.cachePos=(this.cachePos+1)%10;let R=this.cache[this.cachePos];if(this.data.pos=this.idx[_],R.id=_,R.reset(),R.unpackType(this.data),!R.shapes)R.shapes=new Int32Array(1);if(R._active===-1&&R.shapes){if(R.active=R.shapes.length>0&&R.shapes[0]===n.CENTREPIECE_STRAIGHT.id,R.op)R.active=!0}if(R.breakroutefinding)R.blockwalk=!1,R.blockrange=!1;return R}unpack(_,R){if(_===1){let E=R.g1();this.models=new Int32Array(E),this.shapes=new Int32Array(E);for(let u=0;u<E;u++)this.models[u]=R.g2(),this.shapes[u]=R.g1()}else if(_===2)this.name=R.gjstr();else if(_===3)this.desc=R.gjstr();else if(_===14)this.width=R.g1();else if(_===15)this.length=R.g1();else if(_===17)this.blockwalk=!1;else if(_===18)this.blockrange=!1;else if(_===19){if(this._active=R.g1(),this._active===1)this.active=!0}else if(_===21)this.hillskew=!0;else if(_===22)this.sharelight=!0;else if(_===23)this.occlude=!0;else if(_===24){if(this.anim=R.g2(),this.anim===65535)this.anim=-1}else if(_===25)this.animHasAlpha=!0;else if(_===28)this.wallwidth=R.g1();else if(_===29)this.ambient=R.g1b();else if(_===39)this.contrast=R.g1b();else if(_>=30&&_<39){if(!this.op)this.op=new C(5,null);if(this.op[_-30]=R.gjstr(),this.op[_-30]?.toLowerCase()==="hidden")this.op[_-30]=null}else if(_===40){let E=R.g1();this.recol_s=new Uint16Array(E),this.recol_d=new Uint16Array(E);for(let u=0;u<E;u++)this.recol_s[u]=R.g2(),this.recol_d[u]=R.g2()}else if(_===60)this.mapfunction=R.g2();else if(_===62)this.mirror=!0;else if(_===64)this.shadow=!1;else if(_===65)this.resizex=R.g2();else if(_===66)this.resizey=R.g2();else if(_===67)this.resizez=R.g2();else if(_===68)this.mapscene=R.g2();else if(_===69)this.forceapproach=R.g1();else if(_===70)this.offsetx=R.g2b();else if(_===71)this.offsety=R.g2b();else if(_===72)this.offsetz=R.g2b();else if(_===73)this.forcedecor=!0;else if(_===74)this.breakroutefinding=!0}shapeModelsAreReady(_){if(this.shapes===null)return!0;let R=-1;for(let u=0;u<this.shapes.length;u++)if(this.shapes[u]==_){R=u;break}if(R==-1)return!0;if(this.models==null)return!0;let E=this.models[R];return E==-1?!0:U.isReady(E&65535)}modelsAreReady(){let _=!0;if(this.models==null)return!0;for(let R=0;R<this.models.length;R++){let E=this.models[R];if(E!=-1)_&&=U.isReady(E&65535)}return _}prefetch(_){if(this.models==null)return;for(let R=0;R<this.models.length;R++){let E=this.models[R];if(E!=-1)_.prefetch(0,E&65535)}}getModel(_,R,E,u,O,b,L){if(!this.shapes)return null;let N=-1;for(let K=0;K<this.shapes.length;K++)if(this.shapes[K]===_){N=K;break}if(N===-1)return null;let G=(BigInt(L)+1n<<32n)+(BigInt(this.id)<<6n)+(BigInt(N)<<3n)+BigInt(R);if(o.ignoreCache)G=0n;let H=o.modelCacheDynamic?.get(G);if(H){if(o.ignoreCache)return H;if(this.hillskew||this.sharelight)H=U.modelCopyFaces(H,this.hillskew,this.sharelight);if(this.hillskew){let K=(E+u+O+b)/4|0;for(let F=0;F<H.vertexCount;F++){let w=H.vertexX[F],k=H.vertexZ[F],Y=E+((u-E)*(w+64)/128|0),A=b+((O-b)*(w+64)/128|0),h=Y+((A-Y)*(k+64)/128|0);H.vertexY[F]+=h-K}H.calculateBoundsY()}return H}if(!this.models||N>=this.models.length)return null;let Q=this.models[N];if(Q===-1)return null;let $=this.mirror!==R>3;if($)Q+=65536;let J=o.modelCacheStatic?.get(BigInt(Q));if(!J){if(J=U.tryGet(Q&65535),!J)return null;if($)J.rotateY180();o.modelCacheStatic?.put(BigInt(Q),J)}let T=this.resizex!==128||this.resizey!==128||this.resizez!==128,m=this.offsetx!==0||this.offsety!==0||this.offsetz!==0,q=U.modelShareColored(J,!this.recol_s,!this.animHasAlpha,R===0&&L===-1&&!T&&!m);if(L!==-1)q.createLabelReferences(),q.applyTransform(L),q.labelFaces=null,q.labelVertices=null;while(R-- >0)q.rotateY90();if(this.recol_s&&this.recol_d)for(let K=0;K<this.recol_s.length;K++)q.recolour(this.recol_s[K],this.recol_d[K]);if(T)q.scale(this.resizex,this.resizey,this.resizez);if(m)q.translate(this.offsety,this.offsetx,this.offsetz);if(q.calculateNormals((this.ambient&255)+64,(this.contrast&255)*5+768,-50,-10,-50,!this.sharelight),this.blockwalk)q.objRaise=q.minY;if(o.modelCacheDynamic?.put(G,q),this.hillskew||this.sharelight)q=U.modelCopyFaces(q,this.hillskew,this.sharelight);if(this.hillskew){let K=(E+u+O+b)/4|0;for(let F=0;F<q.vertexCount;F++){let w=q.vertexX[F],k=q.vertexZ[F],Y=E+((u-E)*(w+64)/128|0),A=b+((O-b)*(w+64)/128|0),h=Y+((A-Y)*(k+64)/128|0);q.vertexY[F]+=h-K}q.calculateBoundsY()}return q}reset(){this.models=null,this.shapes=null,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.width=1,this.length=1,this.blockwalk=!0,this.blockrange=!0,this.active=!1,this._active=-1,this.hillskew=!1,this.sharelight=!1,this.occlude=!1,this.anim=-1,this.wallwidth=16,this.ambient=0,this.contrast=0,this.op=null,this.animHasAlpha=!1,this.mapfunction=-1,this.mapscene=-1,this.mirror=!1,this.shadow=!0,this.resizex=128,this.resizey=128,this.resizez=128,this.forceapproach=0,this.offsetx=0,this.offsety=0,this.offsetz=0,this.forcedecor=!1,this.breakroutefinding=!1}}async function l1(_){if(_[0]!==255)_[0]=255;URL.revokeObjectURL(n0.src),n0.src=URL.createObjectURL(new Blob([_.slice()],{type:"image/jpeg"})),await new Promise((u)=>n0.onload=()=>u()),u1.clearRect(0,0,r0.width,r0.height);let R=n0.naturalWidth,E=n0.naturalHeight;return r0.width=R,r0.height=E,u1.drawImage(n0,0,0),u1.getImageData(0,0,R,E)}class E0 extends I{pixels;cropRight;cropBottom;cropLeft;cropTop;width;height;constructor(_,R){super();this.pixels=new Int32Array(_*R),this.cropRight=this.width=_,this.cropBottom=this.height=R,this.cropLeft=this.cropTop=0}static async fromJpeg(_,R){let E=_.read(R+".dat");if(!E)throw Error();let u=await l1(E),O=new E0(u.width,u.height),b=new Uint32Array(u.data.buffer),L=O.pixels;for(let N=0;N<L.length;N++){let G=b[N];L[N]=(G>>24&255)<<24|(G&255)<<16|(G>>8&255)<<8|G>>16&255}return O}static fromArchive(_,R,E=0){let u=new P(_.read(R+".dat")),O=new P(_.read("index.dat"));O.pos=u.g2();let b=O.g2(),L=O.g2(),N=O.g1(),G=[],H=N-1;for(let K=0;K<H;K++)if(G[K+1]=O.g3(),G[K+1]===0)G[K+1]=1;for(let K=0;K<E;K++)O.pos+=2,u.pos+=O.g2()*O.g2(),O.pos+=1;if(u.pos>u.length||O.pos>O.length)throw Error();let Q=O.g1(),$=O.g1(),J=O.g2(),T=O.g2(),m=new E0(J,T);m.cropLeft=Q,m.cropTop=$,m.width=b,m.height=L;let q=O.g1();if(q===0){let K=m.cropRight*m.cropBottom;for(let F=0;F<K;F++)m.pixels[F]=G[u.g1()]}else if(q===1){let K=m.cropRight;for(let F=0;F<K;F++){let w=m.cropBottom;for(let k=0;k<w;k++)m.pixels[F+k*K]=G[u.g1()]}}return m}bind(){I.bind(this.pixels,this.cropRight,this.cropBottom)}draw(_,R){_|=0,R|=0,_+=this.cropLeft,R+=this.cropTop;let E=_+R*I.width2d,u=0,O=this.cropBottom,b=this.cropRight,L=I.width2d-b,N=0;if(R<I.top){let G=I.top-R;O-=G,R=I.top,u+=G*b,E+=G*I.width2d}if(R+O>I.bottom)O-=R+O-I.bottom;if(_<I.left){let G=I.left-_;b-=G,_=I.left,u+=G,E+=G,N+=G,L+=G}if(_+b>I.right){let G=_+b-I.right;b-=G,N+=G,L+=G}if(b>0&&O>0)this.copyImageDraw(b,O,this.pixels,u,N,I.pixels,E,L)}drawAlpha(_,R,E){R|=0,E|=0,R+=this.cropLeft,E+=this.cropTop;let u=R+E*I.width2d,O=0,b=this.cropBottom,L=this.cropRight,N=I.width2d-L,G=0;if(E<I.top){let H=I.top-E;b-=H,E=I.top,O+=H*L,u+=H*I.width2d}if(E+b>I.bottom)b-=E+b-I.bottom;if(R<I.left){let H=I.left-R;L-=H,R=I.left,O+=H,u+=H,G+=H,N+=H}if(R+L>I.right){let H=R+L-I.right;L-=H,G+=H,N+=H}if(L>0&&b>0)this.copyPixelsAlpha(L,b,this.pixels,O,G,I.pixels,u,N,_)}blitOpaque(_,R){_|=0,R|=0,_+=this.cropLeft,R+=this.cropTop;let E=_+R*I.width2d,u=0,O=this.cropBottom,b=this.cropRight,L=I.width2d-b,N=0;if(R<I.top){let G=I.top-R;O-=G,R=I.top,u+=G*b,E+=G*I.width2d}if(R+O>I.bottom)O-=R+O-I.bottom;if(_<I.left){let G=I.left-_;b-=G,_=I.left,u+=G,E+=G,N+=G,L+=G}if(_+b>I.right){let G=_+b-I.right;b-=G,N+=G,L+=G}if(b>0&&O>0)this.copyImageBlitOpaque(b,O,this.pixels,u,N,I.pixels,E,L)}flipHorizontally(){let _=this.pixels,R=this.cropRight,E=this.cropBottom;for(let u=0;u<E;u++){let O=R/2|0;for(let b=0;b<O;b++){let L=b+u*R,N=R-b-1+u*R,G=_[L];_[L]=_[N],_[N]=G}}}flipVertically(){let _=this.pixels,R=this.cropRight,E=this.cropBottom;for(let u=0;u<(E/2|0);u++)for(let O=0;O<R;O++){let b=O+u*R,L=O+(E-u-1)*R,N=_[b];_[b]=_[L],_[L]=N}}translate2d(_,R,E){for(let u=0;u<this.pixels.length;u++){let O=this.pixels[u];if(O!==0){let b=O>>16&255;if(b+=_,b<1)b=1;else if(b>255)b=255;let L=O>>8&255;if(L+=R,L<1)L=1;else if(L>255)L=255;let N=O&255;if(N+=E,N<1)N=1;else if(N>255)N=255;this.pixels[u]=(b<<16)+(L<<8)+N}}}crop(){let _=new Int32Array(this.width*this.height);for(let R=0;R<this.cropBottom;R++)for(let E=0;E<this.cropRight;E++)_[(this.cropTop+R)*this.width+this.cropLeft+E]=this.pixels[this.cropRight*R+E];this.pixels=_,this.cropRight=this.width,this.cropBottom=this.height,this.cropLeft=0,this.cropTop=0}drawRotated(_,R,E,u,O,b,L,N){N|=0,_|=0,b|=0,L|=0;try{let G=-b/2|0,H=-L/2|0,Q=Math.sin(R)*65536|0,$=Math.cos(R)*65536|0,J=Q*E>>8,T=$*E>>8,m=(u<<16)+(H*J+G*T),q=(O<<16)+(H*T-G*J),K=N+_*I.width2d;for(let F=0;F<L;F++){let w=K,k=m,Y=q;for(let A=-b;A<0;A++){let h=this.pixels[(k>>16)+(Y>>16)*this.width];if(h==0)w++;else I.pixels[w++]=h;k+=T,Y-=J}m+=J,q+=T,K+=I.width2d}}catch(G){}}drawRotatedMasked(_,R,E,u,O,b,L,N,G,H){_|=0,R|=0,E|=0,u|=0;try{let Q=-E/2|0,$=-u/2|0,J=Math.sin(G/326.11)*65536|0,T=Math.cos(G/326.11)*65536|0,m=J*H>>8,q=T*H>>8,K=(L<<16)+$*m+Q*q,F=(N<<16)+($*q-Q*m),w=_+R*I.width2d;for(let k=0;k<u;k++){let Y=O[k],A=w+Y,h=K+q*Y,Z=F-m*Y;for(let f=-b[k];f<0;f++)I.pixels[A++]=this.pixels[(h>>16)+(Z>>16)*this.cropRight],h+=q,Z-=m;K+=m,F+=q,w+=I.width2d}}catch(Q){}}drawMasked(_,R,E){_|=0,R|=0,_+=this.cropLeft,R+=this.cropTop;let u=_+R*I.width2d,O=0,b=this.cropBottom,L=this.cropRight,N=I.width2d-L,G=0;if(R<I.top){let H=I.top-R;b-=H,R=I.top,O+=H*L,u+=H*I.width2d}if(R+b>I.bottom)b-=R+b-I.bottom;if(_<I.left){let H=I.left-_;L-=H,_=I.left,O+=H,u+=H,G+=H,N+=H}if(_+L>I.right){let H=_+L-I.right;L-=H,G+=H,N+=H}if(L>0&&b>0)this.copyPixelsMasked(L,b,this.pixels,G,O,I.pixels,u,N,E.pixels)}scale(_,R,E,u,O,b,L,N,G,H,Q){try{let $=u;for(let J=-R;J<0;J++){let T=(O>>16)*G;for(let m=-_;m<0;m++){let q=E[(u>>16)+T];if(q===0)N++;else b[N++]=q;u+=H}O+=Q,u=$,N+=L}}catch($){}}copyImageBlitOpaque(_,R,E,u,O,b,L,N){let G=-(_>>2);_=-(_&3);for(let H=-R;H<0;H++){for(let Q=G;Q<0;Q++)b[L++]=E[u++],b[L++]=E[u++],b[L++]=E[u++],b[L++]=E[u++];for(let Q=_;Q<0;Q++)b[L++]=E[u++];L+=N,u+=O}}copyPixelsAlpha(_,R,E,u,O,b,L,N,G){let H=256-G;for(let Q=-R;Q<0;Q++){for(let $=-_;$<0;$++){let J=E[u++];if(J===0)L++;else{let T=b[L];b[L++]=((J&16711935)*G+(T&16711935)*H&4278255360)+((J&65280)*G+(T&65280)*H&16711680)>>8}}L+=N,u+=O}}copyImageDraw(_,R,E,u,O,b,L,N){let G=-(_>>2);_=-(_&3);for(let H=-R;H<0;H++){for(let Q=G;Q<0;Q++){let $=E[u++];if($===0)L++;else b[L++]=$;if($=E[u++],$===0)L++;else b[L++]=$;if($=E[u++],$===0)L++;else b[L++]=$;if($=E[u++],$===0)L++;else b[L++]=$}for(let Q=_;Q<0;Q++){let $=E[u++];if($===0)L++;else b[L++]=$}L+=N,u+=O}}copyPixelsMasked(_,R,E,u,O,b,L,N,G){let H=-(_>>2);_=-(_&3);for(let Q=-R;Q<0;Q++){for(let $=H;$<0;$++){let J=E[O++];if(J!==0&&G[L]===0)b[L++]=J;else L++;if(J=E[O++],J!==0&&G[L]===0)b[L++]=J;else L++;if(J=E[O++],J!==0&&G[L]===0)b[L++]=J;else L++;if(J=E[O++],J!==0&&G[L]===0)b[L++]=J;else L++}for(let $=_;$<0;$++){let J=E[O++];if(J!==0&&G[L]===0)b[L++]=J;else L++}L+=N,O+=u}}}class x extends I0{static count=0;static idx=null;static data=null;static cache=null;static cachePos=0;static membersWorld=!0;model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2000;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;static modelCache=new V0(50);static iconCache=new V0(200);manwearOffsetY=0;womanwearOffsetY=0;manwear=-1;manwear2=-1;womanwear=-1;womanwear2=-1;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;certlink=-1;certtemplate=-1;resizex=0;resizey=0;resizez=0;ambient=0;contrast=0;countobj=null;countco=null;op=null;iop=null;static unpack(_,R){this.membersWorld=R,this.data=new P(_.read("obj.dat"));let E=new P(_.read("obj.idx"));this.count=E.g2(),this.idx=new Int32Array(this.count);let u=2;for(let O=0;O<this.count;O++)this.idx[O]=u,u+=E.g2();this.cache=new C(10,null);for(let O=0;O<10;O++)this.cache[O]=new x(-1)}static get(_){if(!this.cache||!this.idx||!this.data)throw Error();for(let E=0;E<10;E++){let u=this.cache[E];if(u&&u.id===_)return u}this.cachePos=(this.cachePos+1)%10;let R=this.cache[this.cachePos];if(this.data.pos=this.idx[_],R.id=_,R.reset(),R.unpackType(this.data),R.certtemplate!==-1)R.toCertificate();if(!this.membersWorld&&R.members)R.name="Members Object",R.desc="Login to a members' server to use this object.",R.op=null,R.iop=null;return R}reset(){this.model=0,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.zoom2d=2000,this.xan2d=0,this.yan2d=0,this.zan2d=0,this.xof2d=0,this.yof2d=0,this.code9=!1,this.code10=-1,this.stackable=!1,this.cost=1,this.members=!1,this.op=null,this.iop=null,this.manwear=-1,this.manwear2=-1,this.manwearOffsetY=0,this.womanwear=-1,this.womanwear2=-1,this.womanwearOffsetY=0,this.manwear3=-1,this.womanwear3=-1,this.manhead=-1,this.manhead2=-1,this.womanhead=-1,this.womanhead2=-1,this.countobj=null,this.countco=null,this.certlink=-1,this.certtemplate=-1,this.resizex=128,this.resizey=128,this.resizez=128,this.ambient=0,this.contrast=0}unpack(_,R){if(_===1)this.model=R.g2();else if(_===2)this.name=R.gjstr();else if(_===3)this.desc=R.gjstr();else if(_===4)this.zoom2d=R.g2();else if(_===5)this.xan2d=R.g2();else if(_===6)this.yan2d=R.g2();else if(_===7){if(this.xof2d=R.g2b(),this.xof2d>32767)this.xof2d-=65536}else if(_===8){if(this.yof2d=R.g2b(),this.yof2d>32767)this.yof2d-=65536}else if(_===9)this.code9=!0;else if(_===10)this.code10=R.g2();else if(_===11)this.stackable=!0;else if(_===12)this.cost=R.g4();else if(_===16)this.members=!0;else if(_===23)this.manwear=R.g2(),this.manwearOffsetY=R.g1b();else if(_===24)this.manwear2=R.g2();else if(_===25)this.womanwear=R.g2(),this.womanwearOffsetY=R.g1b();else if(_===26)this.womanwear2=R.g2();else if(_>=30&&_<35){if(!this.op)this.op=new C(5,null);if(this.op[_-30]=R.gjstr(),this.op[_-30]?.toLowerCase()==="hidden")this.op[_-30]=null}else if(_>=35&&_<40){if(!this.iop)this.iop=new C(5,null);this.iop[_-35]=R.gjstr()}else if(_===40){let E=R.g1();this.recol_s=new Uint16Array(E),this.recol_d=new Uint16Array(E);for(let u=0;u<E;u++)this.recol_s[u]=R.g2(),this.recol_d[u]=R.g2()}else if(_===78)this.manwear3=R.g2();else if(_===79)this.womanwear3=R.g2();else if(_===90)this.manhead=R.g2();else if(_===91)this.womanhead=R.g2();else if(_===92)this.manhead2=R.g2();else if(_===93)this.womanhead2=R.g2();else if(_===95)this.zan2d=R.g2();else if(_===97)this.certlink=R.g2();else if(_===98)this.certtemplate=R.g2();else if(_>=100&&_<110){if(!this.countobj||!this.countco)this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10);this.countobj[_-100]=R.g2(),this.countco[_-100]=R.g2()}else if(_===110)this.resizex=R.g2();else if(_===111)this.resizey=R.g2();else if(_===112)this.resizez=R.g2();else if(_===113)this.ambient=R.g1b();else if(_===114)this.contrast=R.g1b()*5}toCertificate(){let _=x.get(this.certtemplate);this.model=_.model,this.zoom2d=_.zoom2d,this.xan2d=_.xan2d,this.yan2d=_.yan2d,this.zan2d=_.zan2d,this.xof2d=_.xof2d,this.yof2d=_.yof2d,this.recol_s=_.recol_s,this.recol_d=_.recol_d;let R=x.get(this.certlink);this.name=R.name,this.members=R.members,this.cost=R.cost;let E="a",u=(R.name||"").toLowerCase().charAt(0);if(u==="a"||u==="e"||u==="i"||u==="o"||u==="u")E="an";this.desc=`Swap this note at any bank for ${E} ${R.name}.`,this.stackable=!0}getModel(_){if(this.countobj&&this.countco&&_>1){let E=-1;for(let u=0;u<10;u++)if(_>=this.countco[u]&&this.countco[u]!==0)E=this.countobj[u];if(E!==-1)return x.get(E).getModel(1)}let R=null;if(x.modelCache){if(R=x.modelCache.get(BigInt(this.id)),R)return R}if(R=U.tryGet(this.model),!R)return null;if(this.resizex!==128||this.resizey!==128||this.resizez!==128)R.scale(this.resizex,this.resizey,this.resizez);if(this.recol_s&&this.recol_d)for(let E=0;E<this.recol_s.length;E++)R.recolour(this.recol_s[E],this.recol_d[E]);if(R.calculateNormals(this.ambient+64,this.contrast+768,-50,-10,-50,!0),R.picking=!0,x.modelCache)x.modelCache.put(BigInt(this.id),R);return R}getInvModel(_){if(this.countobj&&this.countco&&_>1){let E=-1;for(let u=0;u<10;u++)if(_>=this.countco[u]&&this.countco[u]!==0)E=this.countobj[u];if(E!==-1)return x.get(E).getInvModel(1)}let R=U.tryGet(this.model);if(!R)return null;if(this.recol_s&&this.recol_d)for(let E=0;E<this.recol_s.length;E++)R.recolour(this.recol_s[E],this.recol_d[E]);return R}static getIcon(_,R,E){if(x.iconCache&&E===0){let Y=x.iconCache.get(BigInt(_));if(Y&&Y.height!==R&&Y.height!==-1)Y.unlink(),Y=null;if(Y)return Y}let u=x.get(_);if(!u.countobj)R=-1;if(u.countobj&&u.countco&&R>1){let Y=-1;for(let A=0;A<10;A++)if(R>=u.countco[A]&&u.countco[A]!==0)Y=u.countobj[A];if(Y!==-1)u=x.get(Y)}let O=u.getModel(1);if(!O)return null;let b=null;if(u.certtemplate!==-1){if(b=this.getIcon(u.certlink,10,-1),!b)return null}let L=new E0(32,32),N=X.centerX,G=X.centerY,H=X.lineOffset,Q=I.pixels,$=I.width2d,J=I.height2d,T=I.left,m=I.right,q=I.top,K=I.bottom;X.jagged=!1,I.bind(L.pixels,32,32),I.fillRect2d(0,0,32,32,0),X.init2D();let F=u.zoom2d;if(E===-1)F=F*1.5|0;else if(E>0)F=F*1.04|0;let w=X.sinTable[u.xan2d]*F>>16,k=X.cosTable[u.xan2d]*F>>16;O.drawSimple(0,u.yan2d,u.zan2d,u.xan2d,u.xof2d,w+(O.minY/2|0)+u.yof2d,k+u.yof2d);for(let Y=31;Y>=0;Y--)for(let A=31;A>=0;A--){if(L.pixels[Y+A*32]!==0)continue;if(Y>0&&L.pixels[Y+A*32-1]>1)L.pixels[Y+A*32]=1;else if(A>0&&L.pixels[Y+(A-1)*32]>1)L.pixels[Y+A*32]=1;else if(Y<31&&L.pixels[Y+A*32+1]>1)L.pixels[Y+A*32]=1;else if(A<31&&L.pixels[Y+(A+1)*32]>1)L.pixels[Y+A*32]=1}if(E>0)for(let Y=31;Y>=0;Y--)for(let A=31;A>=0;A--){if(L.pixels[Y+A*32]!==0)continue;if(Y>0&&L.pixels[Y+A*32-1]===1)L.pixels[Y+A*32]=E;else if(A>0&&L.pixels[Y+(A-1)*32]===1)L.pixels[Y+A*32]=E;else if(Y<31&&L.pixels[Y+A*32+1]===1)L.pixels[Y+A*32]=E;else if(A<31&&L.pixels[Y+(A+1)*32]===1)L.pixels[Y+A*32]=E}else for(let Y=31;Y>=0;Y--)for(let A=31;A>=0;A--)if(L.pixels[Y+A*32]===0&&Y>0&&A>0&&L.pixels[Y+(A-1)*32-1]>0)L.pixels[Y+A*32]=3153952;if(b&&u.certtemplate!==-1){let{width:Y,height:A}=b;b.width=32,b.height=32,b.draw(0,0),b.width=Y,b.height=A}if(x.iconCache&&E===0)x.iconCache.put(BigInt(_),L);if(I.bind(Q,$,J),I.setBounds(T,q,m,K),X.centerX=N,X.centerY=G,X.lineOffset=H,X.jagged=!0,u.stackable)L.width=33;else L.width=32;return L.height=R,L}wornModelIsReady(_){let R=this.manwear,E=this.manwear2,u=this.manwear3;if(_==1)R=this.womanwear,E=this.womanwear2,u=this.womanwear3;if(R==-1)return!0;let O=!0;if(!U.isReady(R))O=!1;if(E!=-1&&!U.isReady(E))O=!1;if(u!=-1&&!U.isReady(u))O=!1;return O}getWornModel(_){let R=this.manwear;if(_===1)R=this.womanwear;if(R===-1)return null;let E=this.manwear2,u=this.manwear3;if(_===1)E=this.womanwear2,u=this.womanwear3;let O=U.tryGet(R);if(!O)return null;if(E!==-1){let b=U.tryGet(E);if(!b)return null;if(u===-1){let L=[O,b];O=U.modelFromModels(L,2)}else{let L=U.tryGet(u);if(!L)return null;let N=[O,b,L];O=U.modelFromModels(N,3)}}if(_===0&&this.manwearOffsetY!==0)O.translate(this.manwearOffsetY,0,0);else if(_===1&&this.womanwearOffsetY!==0)O.translate(this.womanwearOffsetY,0,0);if(this.recol_s&&this.recol_d)for(let b=0;b<this.recol_s.length;b++)O.recolour(this.recol_s[b],this.recol_d[b]);return O}headModelIsReady(_){let R=this.manhead,E=this.manhead2;if(_==1)R=this.womanhead,E=this.womanhead2;if(R==-1)return!0;let u=!0;if(!U.isReady(R))u=!1;if(E!=-1&&!U.isReady(E))u=!1;return u}getHeadModel(_){let R=this.manhead;if(_===1)R=this.womanhead;if(R===-1)return null;let E=this.manhead2;if(_===1)E=this.womanhead2;let u=U.tryGet(R);if(!u)return null;if(E!==-1){let O=U.tryGet(E);if(!O)return null;let b=[u,O];u=U.modelFromModels(b,2)}if(this.recol_s&&this.recol_d)for(let O=0;O<this.recol_s.length;O++)u.recolour(this.recol_s[O],this.recol_d[O]);return u}}class A0 extends I0{static count=0;static idx=null;static data=null;static cache=null;static cachePos=0;name=null;desc=null;size=1;models=null;heads=null;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;animHasAlpha=!1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=!0;vislevel=-1;resizeh=128;resizev=128;alwaysontop=!1;headicon=-1;static modelCache=new V0(30);ambient=0;contrast=0;static unpack(_){this.data=new P(_.read("npc.dat"));let R=new P(_.read("npc.idx"));this.count=R.g2(),this.idx=new Int32Array(this.count);let E=2;for(let u=0;u<this.count;u++)this.idx[u]=E,E+=R.g2();this.cache=new C(20,null);for(let u=0;u<20;u++)this.cache[u]=new A0(-1)}static get(_){if(!this.cache||!this.idx||!this.data)throw Error();for(let E=0;E<20;E++){let u=this.cache[E];if(u&&u.id===_)return u}this.cachePos=(this.cachePos+1)%20;let R=this.cache[this.cachePos]=new A0(_);return this.data.pos=this.idx[_],R.unpackType(this.data),R}unpack(_,R){if(_===1){let E=R.g1();this.models=new Uint16Array(E);for(let u=0;u<E;u++)this.models[u]=R.g2()}else if(_===2)this.name=R.gjstr();else if(_===3)this.desc=R.gjstr();else if(_===12)this.size=R.g1b();else if(_===13)this.readyanim=R.g2();else if(_===14)this.walkanim=R.g2();else if(_===16)this.animHasAlpha=!0;else if(_===17)this.walkanim=R.g2(),this.walkanim_b=R.g2(),this.walkanim_r=R.g2(),this.walkanim_l=R.g2();else if(_>=30&&_<40){if(!this.op)this.op=new C(5,null);if(this.op[_-30]=R.gjstr(),this.op[_-30]?.toLowerCase()==="hidden")this.op[_-30]=null}else if(_===40){let E=R.g1();this.recol_s=new Uint16Array(E),this.recol_d=new Uint16Array(E);for(let u=0;u<E;u++)this.recol_s[u]=R.g2(),this.recol_d[u]=R.g2()}else if(_===60){let E=R.g1();this.heads=new Uint16Array(E);for(let u=0;u<E;u++)this.heads[u]=R.g2()}else if(_===90)this.resizex=R.g2();else if(_===91)this.resizey=R.g2();else if(_===92)this.resizez=R.g2();else if(_===93)this.minimap=!1;else if(_===95)this.vislevel=R.g2();else if(_===97)this.resizeh=R.g2();else if(_===98)this.resizev=R.g2();else if(_===99)this.alwaysontop=!0;else if(_===100)this.ambient=R.g1b();else if(_===101)this.contrast=R.g1b()*5;else if(_===102)this.headicon=R.g2()}getModel(_,R,E){let u=null;if(A0.modelCache){if(u=A0.modelCache.get(BigInt(this.id)),!u&&this.models){let b=!1;for(let N=0;N<this.models.length;N++)if(!U.isReady(this.models[N]))b=!0;if(b)return null;let L=new C(this.models.length,null);for(let N=0;N<this.models.length;N++)L[N]=U.tryGet(this.models[N]);if(L.length===1)u=L[0];else u=U.modelFromModels(L,L.length);if(u){if(this.recol_s&&this.recol_d)for(let N=0;N<this.recol_s.length;N++)u.recolour(this.recol_s[N],this.recol_d[N]);u.createLabelReferences(),u.calculateNormals(64,850,-30,-50,-30,!0),A0.modelCache.put(BigInt(this.id),u)}}}if(!u)return null;let O=U.empty;if(O.set(u,!this.animHasAlpha),_!==-1&&R!==-1)O.applyTransforms(_,R,E);else if(_!==-1)O.applyTransform(_);if(this.resizeh!==128||this.resizev!==128)O.scale(this.resizeh,this.resizev,this.resizeh);if(O.calculateBoundsCylinder(),O.labelFaces=null,O.labelVertices=null,this.size===1)O.picking=!0;return O}getHeadModel(){if(!this.heads)return null;let _=!1;for(let u=0;u<this.heads.length;u++)if(!U.isReady(this.heads[u]))_=!0;if(_)return null;let R=new C(this.heads.length,null);for(let u=0;u<this.heads.length;u++)R[u]=U.tryGet(this.heads[u]);let E;if(R.length===1)E=R[0];else E=U.modelFromModels(R,R.length);if(E&&this.recol_s&&this.recol_d)for(let u=0;u<this.recol_s.length;u++)E.recolour(this.recol_s[u],this.recol_d[u]);return E}}class U0 extends I0{static count=0;static types=[];type=-1;models=null;recol_s=new Int32Array(6);recol_d=new Int32Array(6);heads=new Int32Array(5).fill(-1);disable=!1;static unpack(_){let R=new P(_.read("idk.dat"));this.count=R.g2(),this.types=Array(this.count);for(let E=0;E<this.count;E++){if(!this.types[E])this.types[E]=new U0(E);this.types[E].unpackType(R)}}unpack(_,R){if(_===1)this.type=R.g1();else if(_===2){let E=R.g1();this.models=new Int32Array(E);for(let u=0;u<E;u++)this.models[u]=R.g2()}else if(_===3)this.disable=!0;else if(_>=40&&_<50)this.recol_s[_-40]=R.g2();else if(_>=50&&_<60)this.recol_d[_-50]=R.g2();else if(_>=60&&_<70)this.heads[_-60]=R.g2()}modelIsReady(){if(!this.models)return!0;let _=!0;for(let R=0;R<this.models.length;R++)if(!U.isReady(this.models[R]))_=!1;return _}getModel(){if(!this.models)return null;let _=new C(this.models.length,null);for(let E=0;E<this.models.length;E++)_[E]=U.tryGet(this.models[E]);let R;if(_.length===1)R=_[0];else R=U.modelFromModels(_,_.length);for(let E=0;E<6&&this.recol_s[E]!==0;E++)R?.recolour(this.recol_s[E],this.recol_d[E]);return R}headModelIsReady(){let _=!0;for(let R=0;R<this.heads.length;R++)if(this.heads[R]!=-1&&!U.isReady(this.heads[R]))_=!1;return _}getHeadModel(){let _=0,R=new C(5,null);for(let u=0;u<5;u++)if(this.heads[u]!==-1)R[_++]=U.tryGet(this.heads[u]);let E=U.modelFromModels(R,_);for(let u=0;u<6&&this.recol_s[u]!==0;u++)E.recolour(this.recol_s[u],this.recol_d[u]);return E}}class q0 extends I0{static count=0;static types=[];model=0;anim=-1;seq=null;animHasAlpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;angle=0;ambient=0;contrast=0;static modelCache=new V0(30);static unpack(_){let R=new P(_.read("spotanim.dat"));this.count=R.g2();for(let E=0;E<this.count;E++)this.types[E]=new q0(E).unpackType(R)}unpack(_,R){if(_===1)this.model=R.g2();else if(_===2){if(this.anim=R.g2(),e.types)this.seq=e.types[this.anim]}else if(_===3)this.animHasAlpha=!0;else if(_===4)this.resizeh=R.g2();else if(_===5)this.resizev=R.g2();else if(_===6)this.angle=R.g2();else if(_===7)this.ambient=R.g1();else if(_===8)this.contrast=R.g1();else if(_>=40&&_<50)this.recol_s[_-40]=R.g2();else if(_>=50&&_<60)this.recol_d[_-50]=R.g2()}getModel(){let _=null;if(q0.modelCache){if(_=q0.modelCache.get(BigInt(this.id)),_)return _}if(_=U.tryGet(this.model),!_)return null;for(let R=0;R<6;R++)if(this.recol_s[0]!==0)_.recolour(this.recol_s[R],this.recol_d[R]);if(q0.modelCache)q0.modelCache.put(BigInt(this.id),_);return _}}class D0 extends I0{static count=0;static types=[];static code3s=[];static code3Count=0;code1=0;code2=0;code3=!1;code4=!0;clientcode=0;code7=0;code6=!1;code8=!1;code11=!1;static unpack(_){let R=new P(_.read("varp.dat"));this.count=R.g2();for(let E=0;E<this.count;E++)this.types[E]=new D0(E).unpackType(R)}unpack(_,R){if(_===1)this.code1=R.g1();else if(_===2)this.code2=R.g1();else if(_===3)this.code3=!0,D0.code3s[D0.code3Count++]=this.id;else if(_===4)this.code4=!1;else if(_===5)this.clientcode=R.g2();else if(_===6)this.code6=!0;else if(_===7)this.code7=R.g4();else if(_===8)this.code8=!0,this.code11=!0;else if(_===10)this.debugname=R.gjstr();else if(_===11)this.code11=!0}}class c{static BASE37_LOOKUP=["_","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];static toBase37(_){_=_.trim();let R=0n;for(let E=0;E<_.length&&E<12;E++){let u=_.charCodeAt(E);if(R*=37n,u>=65&&u<=90)R+=BigInt(u+1-65);else if(u>=97&&u<=122)R+=BigInt(u+1-97);else if(u>=48&&u<=57)R+=BigInt(u+27-48)}return R}static fromBase37(_){if(_<0n||_>=6582952005840035281n)return"invalid_name";if(_%37n===0n)return"invalid_name";let R=0,E=Array(12);while(_!==0n){let u=_;_/=37n,E[11-R++]=this.BASE37_LOOKUP[Number(u-_*37n)]}return E.slice(12-R).join("")}static toSentenceCase(_){let R=[..._.toLowerCase()],E=!0;for(let u=0;u<R.length;u++){let O=R[u];if(E&&O>="a"&&O<="z")R[u]=O.toUpperCase(),E=!1;if(O==="."||O==="!")E=!0}return R.join("")}static toAsterisks(_){let R="";for(let E=0;E<_.length;E++)R=R+"*";return R}static formatIPv4(_){return(_>>24&255)+"."+(_>>16&255)+"."+(_>>8&255)+"."+(_&255)}static formatName(_){if(_.length===0)return _;let R=[..._];for(let E=0;E<R.length;E++)if(R[E]==="_"){if(R[E]=" ",E+1<R.length&&R[E+1]>="a"&&R[E+1]<="z")R[E+1]=String.fromCharCode(R[E+1].charCodeAt(0)+65-97)}if(R[0]>="a"&&R[0]<="z")R[0]=String.fromCharCode(R[0].charCodeAt(0)+65-97);return R.join("")}static hashCode(_){let R=_.toUpperCase(),E=0n;for(let u=0;u<R.length;u++)E=E*61n+BigInt(R.charCodeAt(u))-32n,E=E+(E>>56n)&0xffffffffffffffn;return E}}class g{static types=[];invSlotObjId=null;invSlotObjCount=null;seqFrame=0;seqCycle=0;id=-1;layer=-1;type=-1;buttonType=-1;clientCode=0;width=0;height=0;alpha=0;x=0;y=0;scripts=null;scriptComparator=null;scriptOperand=null;overlayer=-1;scroll=0;scrollPosition=0;hide=!1;children=null;activeModelType=0;activeModel=0;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;targetVerb=null;targetText=null;targetMask=-1;option=null;static modelCache=new V0(30);static imageCache=null;marginX=0;marginY=0;colour=0;activeColour=0;overColour=0;activeOverColour=0;modelType=0;model=0;graphic=null;activeGraphic=null;font=null;text=null;activeText=null;draggable=!1;interactable=!1;usable=!1;swappable=!1;fill=!1;center=!1;shadowed=!1;invSlotOffsetX=null;invSlotOffsetY=null;childX=null;childY=null;invSlotGraphic=null;iop=null;static unpack(_,R,E){this.imageCache=new V0(50000);let u=new P(_.read("data")),O=-1,b=u.g2();this.types=Array(b);while(u.pos<u.length){let L=u.g2();if(L===65535)O=u.g2(),L=u.g2();let N=this.types[L]=new g;if(N.id=L,N.layer=O,N.type=u.g1(),N.buttonType=u.g1(),N.clientCode=u.g2(),N.width=u.g2(),N.height=u.g2(),N.alpha=u.g1(),N.overlayer=u.g1(),N.overlayer===0)N.overlayer=-1;else N.overlayer=(N.overlayer-1<<8)+u.g1();let G=u.g1();if(G>0){N.scriptComparator=new Uint8Array(G),N.scriptOperand=new Uint16Array(G);for(let Q=0;Q<G;Q++)N.scriptComparator[Q]=u.g1(),N.scriptOperand[Q]=u.g2()}let H=u.g1();if(H>0){N.scripts=new C(H,null);for(let Q=0;Q<H;Q++){let $=u.g2(),J=new Uint16Array($);N.scripts[Q]=J;for(let T=0;T<$;T++)J[T]=u.g2()}}if(N.type===0){N.scroll=u.g2(),N.hide=u.g1()===1;let Q=u.g2();N.children=Array(Q),N.childX=Array(Q),N.childY=Array(Q);for(let $=0;$<Q;$++)N.children[$]=u.g2(),N.childX[$]=u.g2b(),N.childY[$]=u.g2b()}if(N.type===1)u.pos+=3;if(N.type===2){N.invSlotObjId=new Int32Array(N.width*N.height),N.invSlotObjCount=new Int32Array(N.width*N.height),N.draggable=u.g1()===1,N.interactable=u.g1()===1,N.usable=u.g1()===1,N.swappable=u.g1()===1,N.marginX=u.g1(),N.marginY=u.g1(),N.invSlotOffsetX=new Int16Array(20),N.invSlotOffsetY=new Int16Array(20),N.invSlotGraphic=new C(20,null);for(let Q=0;Q<20;Q++)if(u.g1()===1){N.invSlotOffsetX[Q]=u.g2b(),N.invSlotOffsetY[Q]=u.g2b();let $=u.gjstr();if(R&&$.length>0){let J=$.lastIndexOf(",");N.invSlotGraphic[Q]=this.getImage(R,$.substring(0,J),parseInt($.substring(J+1)))}}N.iop=new C(5,null);for(let Q=0;Q<5;Q++)if(N.iop[Q]=u.gjstr(),N.iop[Q].length===0)N.iop[Q]=null}if(N.type===3)N.fill=u.g1()===1;if(N.type===4||N.type===1){N.center=u.g1()===1;let Q=u.g1();if(E)N.font=E[Q];N.shadowed=u.g1()===1}if(N.type===4)N.text=u.gjstr(),N.activeText=u.gjstr();if(N.type===1||N.type===3||N.type===4)N.colour=u.g4();if(N.type===3||N.type===4)N.activeColour=u.g4(),N.overColour=u.g4(),N.activeOverColour=u.g4();if(N.type===5){let Q=u.gjstr();if(R&&Q.length>0){let J=Q.lastIndexOf(",");N.graphic=this.getImage(R,Q.substring(0,J),parseInt(Q.substring(J+1),10))}let $=u.gjstr();if(R&&$.length>0){let J=$.lastIndexOf(",");N.activeGraphic=this.getImage(R,$.substring(0,J),parseInt($.substring(J+1),10))}}if(N.type===6){let Q=u.g1();if(Q!==0)N.modelType=1,N.model=(Q-1<<8)+u.g1();let $=u.g1();if($!==0)N.activeModelType=1,N.activeModel=($-1<<8)+u.g1();if(N.anim=u.g1(),N.anim===0)N.anim=-1;else N.anim=(N.anim-1<<8)+u.g1();if(N.activeAnim=u.g1(),N.activeAnim===0)N.activeAnim=-1;else N.activeAnim=(N.activeAnim-1<<8)+u.g1();N.zoom=u.g2(),N.xan=u.g2(),N.yan=u.g2()}if(N.type===7){N.invSlotObjId=new Int32Array(N.width*N.height),N.invSlotObjCount=new Int32Array(N.width*N.height),N.center=u.g1()===1;let Q=u.g1();if(E)N.font=E[Q];N.shadowed=u.g1()===1,N.colour=u.g4(),N.marginX=u.g2b(),N.marginY=u.g2b(),N.interactable=u.g1()===1,N.iop=new C(5,null);for(let $=0;$<5;$++)if(N.iop[$]=u.gjstr(),N.iop[$].length===0)N.iop[$]=null}if(N.buttonType===2||N.type===2)N.targetVerb=u.gjstr(),N.targetText=u.gjstr(),N.targetMask=u.g2();if(N.buttonType===1||N.buttonType===4||N.buttonType===5||N.buttonType===6){if(N.option=u.gjstr(),N.option.length===0){if(N.buttonType===1)N.option="Ok";else if(N.buttonType===4)N.option="Select";else if(N.buttonType===5)N.option="Select";else if(N.buttonType===6)N.option="Continue"}}}this.imageCache=null}swapObj(_,R){if(!this.invSlotObjId||!this.invSlotObjCount)return;let E=this.invSlotObjId[_];this.invSlotObjId[_]=this.invSlotObjId[R],this.invSlotObjId[R]=E,E=this.invSlotObjCount[_],this.invSlotObjCount[_]=this.invSlotObjCount[R],this.invSlotObjCount[R]=E}getModel(_,R,E,u){let O=null;if(E)O=this.loadModel(this.activeModelType,this.activeModel,u);else O=this.loadModel(this.modelType,this.model,u);if(!O)return null;if(_===-1&&R===-1&&!O.faceColour)return O;let b=U.modelShareColored(O,!0,!0,!1);if(_!==-1||R!==-1)b.createLabelReferences();if(_!==-1)b.applyTransform(_);if(R!==-1)b.applyTransform(R);return b.calculateNormals(64,768,-50,-10,-50,!0),b}loadModel(_,R,E){let u=g.modelCache.get(BigInt((_<<16)+R));if(u)return u;if(_===1)u=U.tryGet(R);else if(_===2)u=A0.get(R).getHeadModel();else if(_===3){if(E)u=E.getHeadModel()}else if(_===4)u=x.get(R).getInvModel(50);else if(_===5)u=null;if(u)g.modelCache.put(BigInt((_<<16)+R),u);return u}static cacheModel(_,R,E){if(g.modelCache.clear(),_&&R!=4)g.modelCache.put(BigInt((R<<16)+E),_)}getAbsoluteX(){if(this.layer===this.id)return this.x;let _=g.types[this.layer];if(!_.children||!_.childX||!_.childY)return this.x;let R=_.children.indexOf(this.id);if(R===-1)return this.x;let E=_.childX[R];while(_.layer!==_.id){let u=g.types[_.layer];if(u.children&&u.childX&&u.childY){if(R=u.children.indexOf(_.id),R!==-1)E+=u.childX[R]}_=u}return E}static getImage(_,R,E){let u=c.hashCode(R)<<8n|BigInt(E);if(this.imageCache){let O=this.imageCache.get(u);if(O)return O}try{let O=E0.fromArchive(_,R,E);return this.imageCache?.put(u,O),O}catch(O){return null}}}class _0{static index=(_,R)=>_*104+R;startX;startZ;sizeX;sizeZ;flags;constructor(){this.startX=0,this.startZ=0,this.sizeX=104,this.sizeZ=104,this.flags=new Int32Array(this.sizeX*this.sizeZ),this.reset()}reset(){for(let _=0;_<this.sizeX;_++)for(let R=0;R<this.sizeZ;R++){let E=_0.index(_,R);if(_===0||R===0||_===this.sizeX-1||R===this.sizeZ-1)this.flags[E]=16777215;else this.flags[E]=0}}addFloor(_,R){this.flags[_0.index(_-this.startX,R-this.startZ)]|=2097152}removeFloor(_,R){this.flags[_0.index(_-this.startX,R-this.startZ)]&=~2097152}addLoc(_,R,E,u,O,b){let L=256;if(b)L|=131072;let N=_-this.startX,G=R-this.startZ;if(O===1||O===3){let H=E;E=u,u=H}for(let H=N;H<N+E;H++){if(!(H>=0&&H<this.sizeX))continue;for(let Q=G;Q<G+u;Q++){if(!(Q>=0&&Q<this.sizeZ))continue;this.add(H,Q,L)}}}removeLoc(_,R,E,u,O,b){let L=256;if(b)L|=131072;let N=_-this.startX,G=R-this.startZ;if(O===1||O===3){let H=E;E=u,u=H}for(let H=N;H<N+E;H++){if(!(H>=0&&H<this.sizeX))continue;for(let Q=G;Q<G+u;Q++){if(!(Q>=0&&Q<this.sizeZ))continue;this.remove(H,Q,L)}}}addWall(_,R,E,u,O){let b=_-this.startX,L=R-this.startZ,N=O?65536:128,G=O?4096:8,H=O?1024:2,Q=O?16384:32,$=O?512:1,J=O?8192:16,T=O?2048:4,m=O?32768:64;if(E===n.WALL_STRAIGHT.id){if(u===0)this.add(b,L,N),this.add(b-1,L,G);else if(u===1)this.add(b,L,H),this.add(b,L+1,Q);else if(u===2)this.add(b,L,G),this.add(b+1,L,N);else if(u===3)this.add(b,L,Q),this.add(b,L-1,H)}else if(E===n.WALL_DIAGONAL_CORNER.id||E===n.WALL_SQUARE_CORNER.id){if(u===0)this.add(b,L,$),this.add(b-1,L+1,J);else if(u===1)this.add(b,L,T),this.add(b+1,L+1,m);else if(u===2)this.add(b,L,J),this.add(b+1,L-1,$);else if(u===3)this.add(b,L,m),this.add(b-1,L-1,T)}else if(E===n.WALL_L.id){if(u===0)this.add(b,L,H|N),this.add(b-1,L,G),this.add(b,L+1,Q);else if(u===1)this.add(b,L,H|G),this.add(b,L+1,Q),this.add(b+1,L,N);else if(u===2)this.add(b,L,Q|G),this.add(b+1,L,N),this.add(b,L-1,H);else if(u===3)this.add(b,L,Q|N),this.add(b,L-1,H),this.add(b-1,L,G)}if(O)this.addWall(_,R,E,u,!1)}removeWall(_,R,E,u,O){let b=_-this.startX,L=R-this.startZ,N=O?65536:128,G=O?4096:8,H=O?1024:2,Q=O?16384:32,$=O?512:1,J=O?8192:16,T=O?2048:4,m=O?32768:64;if(E===n.WALL_STRAIGHT.id){if(u===0)this.remove(b,L,N),this.remove(b-1,L,G);else if(u===1)this.remove(b,L,H),this.remove(b,L+1,Q);else if(u===2)this.remove(b,L,G),this.remove(b+1,L,N);else if(u===3)this.remove(b,L,Q),this.remove(b,L-1,H)}else if(E===n.WALL_DIAGONAL_CORNER.id||E===n.WALL_SQUARE_CORNER.id){if(u===0)this.remove(b,L,$),this.remove(b-1,L+1,J);else if(u===1)this.remove(b,L,T),this.remove(b+1,L+1,m);else if(u===2)this.remove(b,L,J),this.remove(b+1,L-1,$);else if(u===3)this.remove(b,L,m),this.remove(b-1,L-1,T)}else if(E===n.WALL_L.id){if(u===0)this.remove(b,L,H|N),this.remove(b-1,L,G),this.remove(b,L+1,Q);else if(u===1)this.remove(b,L,H|G),this.remove(b,L+1,Q),this.remove(b+1,L,N);else if(u===2)this.remove(b,L,Q|G),this.remove(b+1,L,N),this.remove(b,L-1,H);else if(u===3)this.remove(b,L,Q|N),this.remove(b,L-1,H),this.remove(b-1,L,G)}if(O)this.removeWall(_,R,E,u,!1)}reachedWall(_,R,E,u,O,b){if(_===E&&R===u)return!0;let L=_-this.startX,N=R-this.startZ,G=E-this.startX,H=u-this.startZ,Q=_0.index(L,N);if(O===n.WALL_STRAIGHT.id){if(b===0){if(L===G-1&&N===H)return!0;else if(L===G&&N===H+1&&(this.flags[Q]&2621728)===0)return!0;else if(L===G&&N===H-1&&(this.flags[Q]&2621698)===0)return!0}else if(b===1){if(L===G&&N===H+1)return!0;else if(L===G-1&&N===H&&(this.flags[Q]&2621704)===0)return!0;else if(L===G+1&&N===H&&(this.flags[Q]&2621824)===0)return!0}else if(b===2){if(L===G+1&&N===H)return!0;else if(L===G&&N===H+1&&(this.flags[Q]&2621728)===0)return!0;else if(L===G&&N===H-1&&(this.flags[Q]&2621698)===0)return!0}else if(b===3){if(L===G&&N===H-1)return!0;else if(L===G-1&&N===H&&(this.flags[Q]&2621704)===0)return!0;else if(L===G+1&&N===H&&(this.flags[Q]&2621824)===0)return!0}}else if(O===n.WALL_L.id){if(b===0){if(L===G-1&&N===H)return!0;else if(L===G&&N===H+1)return!0;else if(L===G+1&&N===H&&(this.flags[Q]&2621824)===0)return!0;else if(L===G&&N===H-1&&(this.flags[Q]&2621698)===0)return!0}else if(b===1){if(L===G-1&&N===H&&(this.flags[Q]&2621704)===0)return!0;else if(L===G&&N===H+1)return!0;else if(L===G+1&&N===H)return!0;else if(L===G&&N===H-1&&(this.flags[Q]&2621698)===0)return!0}else if(b===2){if(L===G-1&&N===H&&(this.flags[Q]&2621704)===0)return!0;else if(L===G&&N===H+1&&(this.flags[Q]&2621728)===0)return!0;else if(L===G+1&&N===H)return!0;else if(L===G&&N===H-1)return!0}else if(b===3){if(L===G-1&&N===H)return!0;else if(L===G&&N===H+1&&(this.flags[Q]&2621728)===0)return!0;else if(L===G+1&&N===H&&(this.flags[Q]&2621824)===0)return!0;else if(L===G&&N===H-1)return!0}}else if(O===n.WALL_DIAGONAL.id){if(L===G&&N===H+1&&(this.flags[Q]&32)===0)return!0;else if(L===G&&N===H-1&&(this.flags[Q]&2)===0)return!0;else if(L===G-1&&N===H&&(this.flags[Q]&8)===0)return!0;else if(L===G+1&&N===H&&(this.flags[Q]&128)===0)return!0}return!1}reachedWallDecoration(_,R,E,u,O,b){if(_===E&&R===u)return!0;let L=_-this.startX,N=R-this.startZ,G=E-this.startX,H=u-this.startZ,Q=_0.index(L,N);if(O===n.WALLDECOR_DIAGONAL_OFFSET.id||O===n.WALLDECOR_DIAGONAL_NOOFFSET.id){if(O===n.WALLDECOR_DIAGONAL_NOOFFSET.id)b=b+2&3;if(b===0){if(L===G+1&&N===H&&(this.flags[Q]&128)===0)return!0;else if(L===G&&N===H-1&&(this.flags[Q]&2)===0)return!0}else if(b===1){if(L===G-1&&N===H&&(this.flags[Q]&8)===0)return!0;else if(L===G&&N===H-1&&(this.flags[Q]&2)===0)return!0}else if(b===2){if(L===G-1&&N===H&&(this.flags[Q]&8)===0)return!0;else if(L===G&&N===H+1&&(this.flags[Q]&32)===0)return!0}else if(b===3){if(L===G+1&&N===H&&(this.flags[Q]&128)===0)return!0;else if(L===G&&N===H+1&&(this.flags[Q]&32)===0)return!0}}else if(O===n.WALLDECOR_DIAGONAL_BOTH.id){if(L===G&&N===H+1&&(this.flags[Q]&32)===0)return!0;else if(L===G&&N===H-1&&(this.flags[Q]&2)===0)return!0;else if(L===G-1&&N===H&&(this.flags[Q]&8)===0)return!0;else if(L===G+1&&N===H&&(this.flags[Q]&128)===0)return!0}return!1}reachedLoc(_,R,E,u,O,b,L){let N=E+O-1,G=u+b-1,H=_0.index(_-this.startX,R-this.startZ);if(_>=E&&_<=N&&R>=u&&R<=G)return!0;else if(_===E-1&&R>=u&&R<=G&&(this.flags[H]&8)===0&&(L&8)===0)return!0;else if(_===N+1&&R>=u&&R<=G&&(this.flags[H]&128)===0&&(L&2)===0)return!0;else if(R===u-1&&_>=E&&_<=N&&(this.flags[H]&2)===0&&(L&4)===0)return!0;else if(R===G+1&&_>=E&&_<=N&&(this.flags[H]&32)===0&&(L&1)===0)return!0;return!1}add(_,R,E){this.flags[_0.index(_,R)]|=E}remove(_,R,E){this.flags[_0.index(_,R)]&=16777215-E}}class G1{minTileX;maxTileX;minTileZ;maxTileZ;type;minX;maxX;minZ;maxZ;minY;maxY;mode=0;minDeltaX=0;maxDeltaX=0;minDeltaZ=0;maxDeltaZ=0;minDeltaY=0;maxDeltaY=0;constructor(_,R,E,u,O,b,L,N,G,H,Q){this.minTileX=_,this.maxTileX=R,this.minTileZ=E,this.maxTileZ=u,this.type=O,this.minX=b,this.maxX=L,this.minZ=N,this.maxZ=G,this.minY=H,this.maxY=Q}}class H1{y;x;z;model;typecode;info;constructor(_,R,E,u,O,b){this.y=_,this.x=R,this.z=E,this.model=u,this.typecode=O,this.info=b}}class Q1{locLevel;y;x;z;model;yaw;minSceneTileX;maxSceneTileX;minSceneTileZ;maxSceneTileZ;typecode;info;distance=0;cycle=0;constructor(_,R,E,u,O,b,L,N,G,H,Q,$){this.locLevel=_,this.y=R,this.x=E,this.z=u,this.model=O,this.yaw=b,this.minSceneTileX=L,this.maxSceneTileX=N,this.minSceneTileZ=G,this.maxSceneTileZ=H,this.typecode=Q,this.info=$}}class $1{y;x;z;topObj;middleObj;bottomObj;typecode;offset;constructor(_,R,E,u,O,b,L,N){this.y=_,this.x=R,this.z=E,this.topObj=u,this.middleObj=O,this.bottomObj=b,this.typecode=L,this.offset=N}}class X0 extends M0{level;x;z;originalLevel;locs;primaryExtendDirections;quickGround=null;ground=null;wall=null;decor=null;groundDecor=null;groundObject=null;linkedSquare=null;primaryCount=0;combinedPrimaryExtendDirections=0;drawLevel=0;drawFront=!1;drawBack=!1;drawPrimaries=!1;cornerSides=0;sidesBeforeCorner=0;sidesAfterCorner=0;backWallTypes=0;constructor(_,R,E){super();this.originalLevel=this.level=_,this.x=R,this.z=E,this.locs=new C(5,null),this.primaryExtendDirections=new Int32Array(5)}}class y{static tmpScreenX=new Int32Array(6);static tmpScreenY=new Int32Array(6);static tmpViewspaceX=new Int32Array(6);static tmpViewspaceY=new Int32Array(6);static tmpViewspaceZ=new Int32Array(6);static SHAPE_POINTS=[Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,2,6),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,13,14)];static SHAPE_PATHS=[Int8Array.of(0,1,2,3,0,0,1,3),Int8Array.of(1,1,2,3,1,0,1,3),Int8Array.of(0,1,2,3,1,0,1,3),Int8Array.of(0,0,1,2,0,0,2,4,1,0,4,3),Int8Array.of(0,0,1,4,0,0,4,3,1,1,2,4),Int8Array.of(0,0,4,3,1,0,1,2,1,0,2,4),Int8Array.of(0,1,2,4,1,0,1,4,1,0,4,3),Int8Array.of(0,4,1,2,0,4,2,5,1,0,4,5,1,0,5,3),Int8Array.of(0,4,1,2,0,4,2,3,0,4,3,5,1,0,4,5),Int8Array.of(0,0,4,5,1,4,1,2,1,4,2,3,1,4,3,5),Int8Array.of(0,0,1,5,0,1,4,5,0,1,2,4,1,0,5,3,1,5,4,3,1,4,2,3),Int8Array.of(1,0,1,5,1,1,4,5,1,1,2,4,0,0,5,3,0,5,4,3,0,4,2,3),Int8Array.of(1,0,5,4,1,0,1,5,0,0,4,3,0,4,5,3,0,5,2,3,0,1,2,5)];static FULL_SQUARE=128;static HALF_SQUARE=this.FULL_SQUARE/2|0;static CORNER_SMALL=this.FULL_SQUARE/4|0;static CORNER_BIG=this.FULL_SQUARE*3/4|0;vertexX;vertexY;vertexZ;triangleColorA;triangleColorB;triangleColorC;triangleVertexA;triangleVertexB;triangleVertexC;triangleTextureIds;flat;shape;shapeAngle;backgroundRgb;foregroundRgb;constructor(_,R,E,u,O,b,L,N,G,H,Q,$,J,T,m,q,K,F,w){this.flat=!(K!==u||K!==T||K!==N),this.shape=R,this.shapeAngle=b,this.backgroundRgb=J,this.foregroundRgb=G;let k=y.SHAPE_POINTS[R],Y=k.length;this.vertexX=new Int32Array(Y),this.vertexY=new Int32Array(Y),this.vertexZ=new Int32Array(Y);let A=new Int32Array(Y),h=new Int32Array(Y),Z=_*y.FULL_SQUARE,f=F*y.FULL_SQUARE;for(let B=0;B<Y;B++){let M=k[B];if((M&1)===0&&M<=8)M=(M-b-b-1&7)+1;if(M>8&&M<=12)M=(M-b-9&3)+9;if(M>12&&M<=16)M=(M-b-13&3)+13;let v,p,D,a,t;if(M===1)v=Z,p=f,D=K,a=L,t=H;else if(M===2)v=Z+y.HALF_SQUARE,p=f,D=K+u>>1,a=L+w>>1,t=H+E>>1;else if(M===3)v=Z+y.FULL_SQUARE,p=f,D=u,a=w,t=E;else if(M===4)v=Z+y.FULL_SQUARE,p=f+y.HALF_SQUARE,D=u+T>>1,a=w+O>>1,t=E+m>>1;else if(M===5)v=Z+y.FULL_SQUARE,p=f+y.FULL_SQUARE,D=T,a=O,t=m;else if(M===6)v=Z+y.HALF_SQUARE,p=f+y.FULL_SQUARE,D=T+N>>1,a=O+q>>1,t=m+$>>1;else if(M===7)v=Z,p=f+y.FULL_SQUARE,D=N,a=q,t=$;else if(M===8)v=Z,p=f+y.HALF_SQUARE,D=N+K>>1,a=q+L>>1,t=$+H>>1;else if(M===9)v=Z+y.HALF_SQUARE,p=f+y.CORNER_SMALL,D=K+u>>1,a=L+w>>1,t=H+E>>1;else if(M===10)v=Z+y.CORNER_BIG,p=f+y.HALF_SQUARE,D=u+T>>1,a=w+O>>1,t=E+m>>1;else if(M===11)v=Z+y.HALF_SQUARE,p=f+y.CORNER_BIG,D=T+N>>1,a=O+q>>1,t=m+$>>1;else if(M===12)v=Z+y.CORNER_SMALL,p=f+y.HALF_SQUARE,D=N+K>>1,a=q+L>>1,t=$+H>>1;else if(M===13)v=Z+y.CORNER_SMALL,p=f+y.CORNER_SMALL,D=K,a=L,t=H;else if(M===14)v=Z+y.CORNER_BIG,p=f+y.CORNER_SMALL,D=u,a=w,t=E;else if(M===15)v=Z+y.CORNER_BIG,p=f+y.CORNER_BIG,D=T,a=O,t=m;else v=Z+y.CORNER_SMALL,p=f+y.CORNER_BIG,D=N,a=q,t=$;this.vertexX[B]=v,this.vertexY[B]=D,this.vertexZ[B]=p,A[B]=a,h[B]=t}let S=y.SHAPE_PATHS[R],j=S.length/4|0;if(this.triangleVertexA=new Int32Array(j),this.triangleVertexB=new Int32Array(j),this.triangleVertexC=new Int32Array(j),this.triangleColorA=new Int32Array(j),this.triangleColorB=new Int32Array(j),this.triangleColorC=new Int32Array(j),Q!==-1)this.triangleTextureIds=new Int32Array(j);else this.triangleTextureIds=null;let W=0;for(let B=0;B<j;B++){let M=S[W],v=S[W+1],p=S[W+2],D=S[W+3];if(W+=4,v<4)v=v-b&3;if(p<4)p=p-b&3;if(D<4)D=D-b&3;if(this.triangleVertexA[B]=v,this.triangleVertexB[B]=p,this.triangleVertexC[B]=D,M===0){if(this.triangleColorA[B]=A[v],this.triangleColorB[B]=A[p],this.triangleColorC[B]=A[D],this.triangleTextureIds)this.triangleTextureIds[B]=-1}else if(this.triangleColorA[B]=h[v],this.triangleColorB[B]=h[p],this.triangleColorC[B]=h[D],this.triangleTextureIds)this.triangleTextureIds[B]=Q}}}class l0{southwestColor;southeastColor;northeastColor;northwestColor;textureId;colour;flat;constructor(_,R,E,u,O,b,L){this.southwestColor=_,this.southeastColor=R,this.northeastColor=E,this.northwestColor=u,this.textureId=O,this.colour=b,this.flat=L}}class J1{y;x;z;angle1;angle2;model1;model2;typecode;typecode2;constructor(_,R,E,u,O,b,L,N,G){this.y=_,this.x=R,this.z=E,this.angle1=u,this.angle2=O,this.model1=b,this.model2=L,this.typecode=N,this.typecode2=G}}class m1{y;x;z;angle1;angle2;model;typecode;info;constructor(_,R,E,u,O,b,L,N){this.y=_,this.x=R,this.z=E,this.angle1=u,this.angle2=O,this.model=b,this.typecode=L,this.info=N}}class V{static visibilityMatrix=new E1(8,32,51,51,!1);static locBuffer=new C(100,null);static levelOccluderCount=new Int32Array(4);static levelOccluders=new S1(4,500,null);static activeOccluders=new C(500,null);static drawTileQueue=new K0;static cycle=0;static viewportLeft=0;static viewportTop=0;static viewportRight=0;static viewportBottom=0;static viewportCenterX=0;static viewportCenterY=0;static sinEyePitch=0;static cosEyePitch=0;static sinEyeYaw=0;static cosEyeYaw=0;static eyeX=0;static eyeY=0;static eyeZ=0;static eyeTileX=0;static eyeTileZ=0;static minDrawTileX=0;static maxDrawTileX=0;static minDrawTileZ=0;static maxDrawTileZ=0;static topLevel=0;static tilesRemaining=0;static takingInput=!1;static visibilityMap=null;static FRONT_WALL_TYPES=Uint8Array.of(19,55,38,155,255,110,137,205,76);static DIRECTION_ALLOW_WALL_CORNER_TYPE=Uint8Array.of(160,192,80,96,0,144,80,48,160);static BACK_WALL_TYPES=Uint8Array.of(76,8,137,4,0,1,38,2,19);static MIDDEP_16=Int8Array.of(0,0,2,0,0,2,1,1,0);static MIDDEP_32=Int8Array.of(2,0,0,2,0,0,0,4,4);static MIDDEP_64=Int8Array.of(0,4,4,8,0,0,8,0,0);static MIDDEP_128=Int8Array.of(1,1,0,0,0,8,0,0,8);static WALL_DECORATION_INSET_X=Int8Array.of(53,-53,-53,53);static WALL_DECORATION_INSET_Z=Int8Array.of(-53,-53,53,53);static WALL_DECORATION_OUTSET_X=Int8Array.of(-45,45,45,-45);static WALL_DECORATION_OUTSET_Z=Int8Array.of(45,45,-45,-45);static MINIMAP_TILE_MASK=[new Int8Array(16),Int8Array.of(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,0,0,0,1,1,0,0,1,1,1,0,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,1,1,0,0,1,1,0,0,0,1,0,0,0,1),Int8Array.of(0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0),Int8Array.of(0,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0),Int8Array.of(1,1,1,1,1,1,1,1,0,1,1,1,0,0,1,1),Int8Array.of(1,1,1,1,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,0,0,0,0,1,1,0,1,1,1,0,1,1,1),Int8Array.of(0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1)];static MINIMAP_TILE_ROTATION_MAP=[Int8Array.of(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15),Int8Array.of(12,8,4,0,13,9,5,1,14,10,6,2,15,11,7,3),Int8Array.of(15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0),Int8Array.of(3,7,11,15,2,6,10,14,1,5,9,13,0,4,8,12)];static TEXTURE_HSL=Int32Array.of(41,39248,41,4643,41,41,41,41,41,41,41,41,41,41,41,43086,41,41,41,41,41,41,41,8602,41,28992,41,41,41,41,41,5056,41,41,41,41,41,41,41,41,41,41,41,41,41,41,3131,41,41,41);static activeOccluderCount=0;static mouseX=0;static mouseY=0;static clickTileX=-1;static clickTileZ=-1;static lowMemory=!0;static init(_,R,E,u,O){this.viewportLeft=0,this.viewportTop=0,this.viewportRight=_,this.viewportBottom=R,this.viewportCenterX=_/2|0,this.viewportCenterY=R/2|0;let b=new E1(9,32,53,53,!1);for(let L=128;L<=384;L+=32)for(let N=0;N<2048;N+=64){this.sinEyePitch=X.sinTable[L],this.cosEyePitch=X.cosTable[L],this.sinEyeYaw=X.sinTable[N],this.cosEyeYaw=X.cosTable[N];let G=(L-128)/32|0,H=N/64|0;for(let Q=-26;Q<=26;Q++)for(let $=-26;$<=26;$++){let J=Q*128,T=$*128,m=!1;for(let q=-E;q<=u;q+=128)if(this.testPoint(J,T,O[G]+q)){m=!0;break}b[G][H][Q+25+1][$+25+1]=m}}for(let L=0;L<8;L++)for(let N=0;N<32;N++)for(let G=-25;G<25;G++)for(let H=-25;H<25;H++){let Q=!1;_:for(let $=-1;$<=1;$++)for(let J=-1;J<=1;J++){if(b[L][N][G+$+25+1][H+J+25+1]){Q=!0;break _}if(b[L][(N+1)%31][G+$+25+1][H+J+25+1]){Q=!0;break _}if(b[L+1][N][G+$+25+1][H+J+25+1]){Q=!0;break _}if(b[L+1][(N+1)%31][G+$+25+1][H+J+25+1]){Q=!0;break _}}this.visibilityMatrix[L][N][G+25][H+25]=Q}}static addOccluder(_,R,E,u,O,b,L,N){V.levelOccluders[_][V.levelOccluderCount[_]++]=new G1(E/128|0,b/128|0,O/128|0,N/128|0,R,E,b,O,N,u,L)}static testPoint(_,R,E){let u=R*this.sinEyeYaw+_*this.cosEyeYaw>>16,O=R*this.cosEyeYaw-_*this.sinEyeYaw>>16,b=E*this.sinEyePitch+O*this.cosEyePitch>>16,L=E*this.cosEyePitch-O*this.sinEyePitch>>16;if(b<50||b>3500)return!1;let N=this.viewportCenterX+((u<<9)/b|0),G=this.viewportCenterY+((L<<9)/b|0);return N>=this.viewportLeft&&N<=this.viewportRight&&G>=this.viewportTop&&G<=this.viewportBottom}maxLevel;maxTileX;maxTileZ;levelHeightmaps;levelTiles;changedLocs;levelTileOcclusionCycles;mergeIndexA;mergeIndexB;changedLocCount=0;minLevel=0;tmpMergeIndex=0;constructor(_,R,E,u){this.maxLevel=E,this.maxTileX=u,this.maxTileZ=R,this.levelTiles=new d0(E,u,R,null),this.levelTileOcclusionCycles=new C0(E,u+1,R+1),this.levelHeightmaps=_,this.changedLocs=new C(5000,null),this.mergeIndexA=new Int32Array(1e4),this.mergeIndexB=new Int32Array(1e4),this.reset()}reset(){for(let _=0;_<this.maxLevel;_++)for(let R=0;R<this.maxTileX;R++)for(let E=0;E<this.maxTileZ;E++)this.levelTiles[_][R][E]=null;for(let _=0;_<4;_++){for(let R=0;R<V.levelOccluderCount[_];R++)V.levelOccluders[_][R]=null;V.levelOccluderCount[_]=0}for(let _=0;_<this.changedLocCount;_++)this.changedLocs[_]=null;this.changedLocCount=0,V.locBuffer.fill(null)}setMinLevel(_){this.minLevel=_;for(let R=0;R<this.maxTileX;R++)for(let E=0;E<this.maxTileZ;E++)this.levelTiles[_][R][E]=new X0(_,R,E)}setLinkBelow(_,R){let E=this.levelTiles[0][_][R];for(let O=0;O<3;O++){this.levelTiles[O][_][R]=this.levelTiles[O+1][_][R];let b=this.levelTiles[O][_][R];if(b)b.level--}if(!this.levelTiles[0][_][R])this.levelTiles[0][_][R]=new X0(0,_,R);let u=this.levelTiles[0][_][R];if(u)u.linkedSquare=E;this.levelTiles[3][_][R]=null}setDrawLevel(_,R,E,u){let O=this.levelTiles[_][R][E];if(!O)return;O.drawLevel=u}setTile(_,R,E,u,O,b,L,N,G,H,Q,$,J,T,m,q,K,F,w,k){if(u===0){for(let A=_;A>=0;A--)if(!this.levelTiles[A][R][E])this.levelTiles[A][R][E]=new X0(A,R,E);let Y=this.levelTiles[_][R][E];if(Y)Y.quickGround=new l0(Q,$,J,T,-1,w,!1)}else if(u===1){for(let A=_;A>=0;A--)if(!this.levelTiles[A][R][E])this.levelTiles[A][R][E]=new X0(A,R,E);let Y=this.levelTiles[_][R][E];if(Y)Y.quickGround=new l0(m,q,K,F,b,k,L===N&&L===G&&L===H)}else{for(let A=_;A>=0;A--)if(!this.levelTiles[A][R][E])this.levelTiles[A][R][E]=new X0(A,R,E);let Y=this.levelTiles[_][R][E];if(Y)Y.ground=new y(R,u,q,N,J,O,Q,H,k,m,b,F,w,G,K,T,L,E,$)}}addGroundDecoration(_,R,E,u,O,b,L){if(!this.levelTiles[R][E][u])this.levelTiles[R][E][u]=new X0(R,E,u);let N=this.levelTiles[R][E][u];if(N)N.groundDecor=new H1(O,E*128+64,u*128+64,_,b,L)}removeGroundDecoration(_,R,E){let u=this.levelTiles[_][R][E];if(!u)return;u.groundDecor=null}addGroundObject(_,R,E,u,O,b,L,N){let G=0,H=this.levelTiles[u][_][R];if(H)for(let $=0;$<H.primaryCount;$++){let J=H.locs[$];if(!J||!J.model||!(J.model instanceof U))continue;let T=J.model.objRaise;if(T>G)G=T}else this.levelTiles[u][_][R]=new X0(u,_,R);let Q=this.levelTiles[u][_][R];if(Q)Q.groundObject=new $1(E,_*128+64,R*128+64,b,L,N,O,G)}removeGroundObject(_,R,E){let u=this.levelTiles[_][R][E];if(!u)return;u.groundObject=null}addWall(_,R,E,u,O,b,L,N,G,H){if(!L&&!N)return;for(let $=_;$>=0;$--)if(!this.levelTiles[$][R][E])this.levelTiles[$][R][E]=new X0($,R,E);let Q=this.levelTiles[_][R][E];if(Q)Q.wall=new J1(u,R*128+64,E*128+64,O,b,L,N,G,H)}removeWall(_,R,E,u){let O=this.levelTiles[_][R][E];if(u===1&&O)O.wall=null}setWallDecoration(_,R,E,u,O,b,L,N,G,H,Q){if(!N)return;for(let J=_;J>=0;J--)if(!this.levelTiles[J][R][E])this.levelTiles[J][R][E]=new X0(J,R,E);let $=this.levelTiles[_][R][E];if($)$.decor=new m1(u,R*128+O+64,E*128+b+64,Q,H,N,L,G)}removeWallDecoration(_,R,E){let u=this.levelTiles[_][R][E];if(!u)return;u.decor=null}setWallDecorationOffset(_,R,E,u){let O=this.levelTiles[_][R][E];if(!O)return;let b=O.decor;if(!b)return;let L=R*128+64,N=E*128+64;b.x=L+((b.x-L)*u/16|0),b.z=N+((b.z-N)*u/16|0)}setWallDecorationModel(_,R,E,u){if(!u)return;let O=this.levelTiles[_][R][E];if(!O)return;let b=O.decor;if(!b)return;b.model=u}setGroundDecorationModel(_,R,E,u){if(!u)return;let O=this.levelTiles[_][R][E];if(!O)return;let b=O.groundDecor;if(!b)return;b.model=u}setWallModel(_,R,E,u){if(!u)return;let O=this.levelTiles[_][R][E];if(!O)return;let b=O.wall;if(!b)return;b.model1=u}setWallModels(_,R,E,u,O){if(!u)return;let b=this.levelTiles[E][_][R];if(!b)return;let L=b.wall;if(!L)return;L.model1=u,L.model2=O}addLoc(_,R,E,u,O,b,L,N,G,H){if(!O)return!0;let Q=R*128+N*64,$=E*128+G*64;return this.addModel(Q,$,u,_,R,E,N,G,O,b,L,H,!1)}changeLoc(_,R,E,u,O,b,L,N,G){if(!O)return!0;let H=R-N,Q=u-N,$=R+N,J=u+N;if(G){if(L>640&&L<1408)J+=128;if(L>1152&&L<1920)$+=128;if(L>1664||L<384)Q-=128;if(L>128&&L<896)H-=128}return H=H/128|0,Q=Q/128|0,$=$/128|0,J=J/128|0,this.addModel(R,u,E,_,H,Q,$+1-H,J-Q+1,O,b,0,L,!0)}changeLoc2(_,R,E,u,O,b,L,N,G,H,Q){return!G||this.addModel(R,u,E,_,O,b,L+1-O,N-b+1,G,H,0,Q,!0)}removeLoc(_,R,E){let u=this.levelTiles[_][R][E];if(!u)return;for(let O=0;O<u.primaryCount;O++){let b=u.locs[O];if(b&&(b.typecode>>29&3)===2&&b.minSceneTileX===R&&b.minSceneTileZ===E){this.removeLoc2(b);return}}}clearLocChanges(){for(let _=0;_<this.changedLocCount;_++){let R=this.changedLocs[_];if(R)this.removeLoc2(R);this.changedLocs[_]=null}this.changedLocCount=0}getWallTypecode(_,R,E){let u=this.levelTiles[_][R][E];return!u||!u.wall?0:u.wall.typecode}getDecorTypecode(_,R,E){let u=this.levelTiles[_][E][R];return!u||!u.decor?0:u.decor.typecode}getLocTypecode(_,R,E){let u=this.levelTiles[_][R][E];if(!u)return 0;for(let O=0;O<u.primaryCount;O++){let b=u.locs[O];if(b&&(b.typecode>>29&3)===2&&b.minSceneTileX===R&&b.minSceneTileZ===E)return b.typecode}return 0}getGroundDecorTypecode(_,R,E){let u=this.levelTiles[_][R][E];return!u||!u.groundDecor?0:u.groundDecor.typecode}getWall(_,R,E){let u=this.levelTiles[_][R][E];return!u||!u.wall?null:u.wall}getDecor(_,R,E){let u=this.levelTiles[_][E][R];return!u||!u.decor?null:u.decor}getLoc(_,R,E){let u=this.levelTiles[_][R][E];if(!u)return null;for(let O=0;O<u.primaryCount;O++){let b=u.locs[O];if(b&&(b.typecode>>29&3)===2&&b.minSceneTileX===R&&b.minSceneTileZ===E)return b}return null}getGroundDecor(_,R,E){let u=this.levelTiles[_][R][E];return!u||!u.groundDecor?null:u.groundDecor}getInfo(_,R,E,u){let O=this.levelTiles[_][R][E];if(!O)return-1;else if(O.wall&&O.wall.typecode===u)return O.wall.typecode2&255;else if(O.decor&&O.decor.typecode===u)return O.decor.info&255;else if(O.groundDecor&&O.groundDecor.typecode===u)return O.groundDecor.info&255;else{for(let b=0;b<O.primaryCount;b++){let L=O.locs[b];if(L&&L.typecode===u)return L.info&255}return-1}}buildModels(_,R,E,u,O){let b=Math.sqrt(E*E+u*u+O*O)|0,L=R*b>>8;for(let N=0;N<this.maxLevel;N++)for(let G=0;G<this.maxTileX;G++)for(let H=0;H<this.maxTileZ;H++){let Q=this.levelTiles[N][G][H];if(!Q)continue;let $=Q.wall;if($&&$.model1&&$.model1.vertexNormal){if(this.mergeLocNormals(N,G,H,1,1,$.model1),$.model2&&$.model2.vertexNormal)this.mergeLocNormals(N,G,H,1,1,$.model2),this.mergeNormals($.model1,$.model2,0,0,0,!1),$.model2.applyLighting(_,L,E,u,O);$.model1.applyLighting(_,L,E,u,O)}for(let T=0;T<Q.primaryCount;T++){let m=Q.locs[T];if(m&&m.model&&m.model.vertexNormal)this.mergeLocNormals(N,G,H,m.maxSceneTileX+1-m.minSceneTileX,m.maxSceneTileZ-m.minSceneTileZ+1,m.model),m.model.applyLighting(_,L,E,u,O)}let J=Q.groundDecor;if(J&&J.model&&J.model.vertexNormal)this.mergeGroundDecorationNormals(N,G,H,J.model),J.model.applyLighting(_,L,E,u,O)}}mergeGroundDecorationNormals(_,R,E,u){if(R<this.maxTileX){let O=this.levelTiles[_][R+1][E];if(O&&O.groundDecor&&O.groundDecor.model&&O.groundDecor.model.vertexNormal)this.mergeNormals(u,O.groundDecor.model,128,0,0,!0)}if(E<this.maxTileX){let O=this.levelTiles[_][R][E+1];if(O&&O.groundDecor&&O.groundDecor.model&&O.groundDecor.model.vertexNormal)this.mergeNormals(u,O.groundDecor.model,0,0,128,!0)}if(R<this.maxTileX&&E<this.maxTileZ){let O=this.levelTiles[_][R+1][E+1];if(O&&O.groundDecor&&O.groundDecor.model&&O.groundDecor.model.vertexNormal)this.mergeNormals(u,O.groundDecor.model,128,0,128,!0)}if(R<this.maxTileX&&E>0){let O=this.levelTiles[_][R+1][E-1];if(O&&O.groundDecor&&O.groundDecor.model&&O.groundDecor.model.vertexNormal)this.mergeNormals(u,O.groundDecor.model,128,0,-128,!0)}}mergeLocNormals(_,R,E,u,O,b){let L=!0,N=R,G=R+u,H=E-1,Q=E+O;for(let $=_;$<=_+1;$++){if($===this.maxLevel)continue;for(let J=N;J<=G;J++){if(J<0||J>=this.maxTileX)continue;for(let T=H;T<=Q;T++){if(T<0||T>=this.maxTileZ||L&&J<G&&T<Q&&(T>=E||J===R))continue;let m=this.levelTiles[$][J][T];if(!m)continue;let q=(J-R)*128+(1-u)*64,K=(T-E)*128+(1-O)*64,F=((this.levelHeightmaps[$][J][T]+this.levelHeightmaps[$][J+1][T]+this.levelHeightmaps[$][J][T+1]+this.levelHeightmaps[$][J+1][T+1])/4|0)-((this.levelHeightmaps[_][R][E]+this.levelHeightmaps[_][R+1][E]+this.levelHeightmaps[_][R][E+1]+this.levelHeightmaps[_][R+1][E+1])/4|0),w=m.wall;if(w&&w.model1&&w.model1.vertexNormal)this.mergeNormals(b,w.model1,q,F,K,L);if(w&&w.model2&&w.model2.vertexNormal)this.mergeNormals(b,w.model2,q,F,K,L);for(let k=0;k<m.primaryCount;k++){let Y=m.locs[k];if(!Y||!Y.model||!Y.model.vertexNormal)continue;let A=Y.maxSceneTileX+1-Y.minSceneTileX,h=Y.maxSceneTileZ+1-Y.minSceneTileZ;this.mergeNormals(b,Y.model,(Y.minSceneTileX-R)*128+(A-u)*64,F,(Y.minSceneTileZ-E)*128+(h-O)*64,L)}}}N--,L=!1}}mergeNormals(_,R,E,u,O,b){this.tmpMergeIndex++;let L=0,N=R.vertexX,G=R.vertexCount;if(_.vertexNormal&&_.vertexNormalOriginal)for(let H=0;H<_.vertexCount;H++){let Q=_.vertexNormal[H],$=_.vertexNormalOriginal[H];if($&&$.w!==0){let J=_.vertexY[H]-u;if(J>R.maxY)continue;let T=_.vertexX[H]-E;if(T<R.minX||T>R.maxX)continue;let m=_.vertexZ[H]-O;if(m<R.minZ||m>R.maxZ)continue;if(R.vertexNormal&&R.vertexNormalOriginal)for(let q=0;q<G;q++){let K=R.vertexNormal[q],F=R.vertexNormalOriginal[q];if(T!==N[q]||m!==R.vertexZ[q]||J!==R.vertexY[q]||F&&F.w===0)continue;if(Q&&K&&F)Q.x+=F.x,Q.y+=F.y,Q.z+=F.z,Q.w+=F.w,K.x+=$.x,K.y+=$.y,K.z+=$.z,K.w+=$.w,L++;this.mergeIndexA[H]=this.tmpMergeIndex,this.mergeIndexB[q]=this.tmpMergeIndex}}}if(L<3||!b)return;if(_.faceInfo){for(let H=0;H<_.faceCount;H++)if(this.mergeIndexA[_.faceVertexA[H]]===this.tmpMergeIndex&&this.mergeIndexA[_.faceVertexB[H]]===this.tmpMergeIndex&&this.mergeIndexA[_.faceVertexC[H]]===this.tmpMergeIndex)_.faceInfo[H]=-1}if(R.faceInfo){for(let H=0;H<R.faceCount;H++)if(this.mergeIndexB[R.faceVertexA[H]]===this.tmpMergeIndex&&this.mergeIndexB[R.faceVertexB[H]]===this.tmpMergeIndex&&this.mergeIndexB[R.faceVertexC[H]]===this.tmpMergeIndex)R.faceInfo[H]=-1}}drawMinimapTile(_,R,E,u,O,b){let L=this.levelTiles[_][R][E];if(!L)return;let N=L.quickGround;if(N){let K=N.colour;if(K!==0)for(let F=0;F<4;F++)u[O]=K,u[O+1]=K,u[O+2]=K,u[O+3]=K,O+=b;return}let G=L.ground;if(!G)return;let{shape:H,shapeAngle:Q,backgroundRgb:$,foregroundRgb:J}=G,T=V.MINIMAP_TILE_MASK[H],m=V.MINIMAP_TILE_ROTATION_MAP[Q],q=0;if($!==0){for(let K=0;K<4;K++)u[O]=T[m[q++]]===0?$:J,u[O+1]=T[m[q++]]===0?$:J,u[O+2]=T[m[q++]]===0?$:J,u[O+3]=T[m[q++]]===0?$:J,O+=b;return}for(let K=0;K<4;K++){if(T[m[q++]]!==0)u[O]=J;if(T[m[q++]]!==0)u[O+1]=J;if(T[m[q++]]!==0)u[O+2]=J;if(T[m[q++]]!==0)u[O+3]=J;O+=b}}click(_,R){V.takingInput=!0,V.mouseX=_,V.mouseY=R,V.clickTileX=-1,V.clickTileZ=-1}draw(_,R,E,u,O,b,L){if(_<0)_=0;else if(_>=this.maxTileX*128)_=this.maxTileX*128-1;if(E<0)E=0;else if(E>=this.maxTileZ*128)E=this.maxTileZ*128-1;if(V.cycle++,V.sinEyePitch=X.sinTable[b],V.cosEyePitch=X.cosTable[b],V.sinEyeYaw=X.sinTable[O],V.cosEyeYaw=X.cosTable[O],V.visibilityMap=V.visibilityMatrix[(b-128)/32|0][O/64|0],V.eyeX=_,V.eyeY=R,V.eyeZ=E,V.eyeTileX=_/128|0,V.eyeTileZ=E/128|0,V.topLevel=u,V.minDrawTileX=V.eyeTileX-25,V.minDrawTileX<0)V.minDrawTileX=0;if(V.minDrawTileZ=V.eyeTileZ-25,V.minDrawTileZ<0)V.minDrawTileZ=0;if(V.maxDrawTileX=V.eyeTileX+25,V.maxDrawTileX>this.maxTileX)V.maxDrawTileX=this.maxTileX;if(V.maxDrawTileZ=V.eyeTileZ+25,V.maxDrawTileZ>this.maxTileZ)V.maxDrawTileZ=this.maxTileZ;this.updateActiveOccluders(),V.tilesRemaining=0;for(let N=this.minLevel;N<this.maxLevel;N++){let G=this.levelTiles[N];for(let H=V.minDrawTileX;H<V.maxDrawTileX;H++)for(let Q=V.minDrawTileZ;Q<V.maxDrawTileZ;Q++){let $=G[H][Q];if(!$)continue;if($.drawLevel<=u&&(V.visibilityMap[H+25-V.eyeTileX][Q+25-V.eyeTileZ]||this.levelHeightmaps[N][H][Q]-R>=2000))$.drawFront=!0,$.drawBack=!0,$.drawPrimaries=$.primaryCount>0,V.tilesRemaining++;else $.drawFront=!1,$.drawBack=!1,$.cornerSides=0}}for(let N=this.minLevel;N<this.maxLevel;N++){let G=this.levelTiles[N];for(let H=-25;H<=0;H++){let Q=V.eyeTileX+H,$=V.eyeTileX-H;if(Q<V.minDrawTileX&&$>=V.maxDrawTileX)continue;for(let J=-25;J<=0;J++){let T=V.eyeTileZ+J,m=V.eyeTileZ-J,q;if(Q>=V.minDrawTileX){if(T>=V.minDrawTileZ){if(q=G[Q][T],q&&q.drawFront)this.drawTile(q,!0,L)}if(m<V.maxDrawTileZ){if(q=G[Q][m],q&&q.drawFront)this.drawTile(q,!0,L)}}if($<V.maxDrawTileX){if(T>=V.minDrawTileZ){if(q=G[$][T],q&&q.drawFront)this.drawTile(q,!0,L)}if(m<V.maxDrawTileZ){if(q=G[$][m],q&&q.drawFront)this.drawTile(q,!0,L)}}if(V.tilesRemaining===0){V.takingInput=!1;return}}}}for(let N=this.minLevel;N<this.maxLevel;N++){let G=this.levelTiles[N];for(let H=-25;H<=0;H++){let Q=V.eyeTileX+H,$=V.eyeTileX-H;if(Q<V.minDrawTileX&&$>=V.maxDrawTileX)continue;for(let J=-25;J<=0;J++){let T=V.eyeTileZ+J,m=V.eyeTileZ-J,q;if(Q>=V.minDrawTileX){if(T>=V.minDrawTileZ){if(q=G[Q][T],q&&q.drawFront)this.drawTile(q,!1,L)}if(m<V.maxDrawTileZ){if(q=G[Q][m],q&&q.drawFront)this.drawTile(q,!1,L)}}if($<V.maxDrawTileX){if(T>=V.minDrawTileZ){if(q=G[$][T],q&&q.drawFront)this.drawTile(q,!1,L)}if(m<V.maxDrawTileZ){if(q=G[$][m],q&&q.drawFront)this.drawTile(q,!1,L)}}if(V.tilesRemaining===0){V.takingInput=!1;return}}}}}addModel(_,R,E,u,O,b,L,N,G,H,Q,$,J){if(!G)return!1;for(let m=O;m<O+L;m++)for(let q=b;q<b+N;q++){if(m<0||q<0||m>=this.maxTileX||q>=this.maxTileZ)return!1;let K=this.levelTiles[u][m][q];if(K&&K.primaryCount>=5)return!1}let T=new Q1(u,E,_,R,G,$,O,O+L-1,b,b+N-1,H,Q);for(let m=O;m<O+L;m++)for(let q=b;q<b+N;q++){let K=0;if(m>O)K|=1;if(m<O+L-1)K+=4;if(q>b)K+=8;if(q<b+N-1)K+=2;for(let w=u;w>=0;w--)if(!this.levelTiles[w][m][q])this.levelTiles[w][m][q]=new X0(w,m,q);let F=this.levelTiles[u][m][q];if(F)F.locs[F.primaryCount]=T,F.primaryExtendDirections[F.primaryCount]=K,F.combinedPrimaryExtendDirections|=K,F.primaryCount++}if(J)this.changedLocs[this.changedLocCount++]=T;return!0}removeLoc2(_){for(let R=_.minSceneTileX;R<=_.maxSceneTileX;R++)for(let E=_.minSceneTileZ;E<=_.maxSceneTileZ;E++){let u=this.levelTiles[_.locLevel][R][E];if(!u)continue;for(let O=0;O<u.primaryCount;O++)if(u.locs[O]===_){u.primaryCount--;for(let b=O;b<u.primaryCount;b++)u.locs[b]=u.locs[b+1],u.primaryExtendDirections[b]=u.primaryExtendDirections[b+1];u.locs[u.primaryCount]=null;break}u.combinedPrimaryExtendDirections=0;for(let O=0;O<u.primaryCount;O++)u.combinedPrimaryExtendDirections|=u.primaryExtendDirections[O]}}updateActiveOccluders(){let _=V.levelOccluderCount[V.topLevel],R=V.levelOccluders[V.topLevel];V.activeOccluderCount=0;for(let E=0;E<_;E++){let u=R[E];if(!u)continue;let O,b,L,N;if(u.type===1){if(O=u.minTileX+25-V.eyeTileX,O>=0&&O<=50){if(b=u.minTileZ+25-V.eyeTileZ,b<0)b=0;if(L=u.maxTileZ+25-V.eyeTileZ,L>50)L=50;let G=!1;while(b<=L)if(V.visibilityMap&&V.visibilityMap[O][b++]){G=!0;break}if(G){if(N=V.eyeX-u.minX,N>32)u.mode=1;else{if(N>=-32)continue;u.mode=2,N=-N}u.minDeltaZ=(u.minZ-V.eyeZ<<8)/N|0,u.maxDeltaZ=(u.maxZ-V.eyeZ<<8)/N|0,u.minDeltaY=(u.minY-V.eyeY<<8)/N|0,u.maxDeltaY=(u.maxY-V.eyeY<<8)/N|0,V.activeOccluders[V.activeOccluderCount++]=u}}}else if(u.type===2){if(O=u.minTileZ+25-V.eyeTileZ,O>=0&&O<=50){if(b=u.minTileX+25-V.eyeTileX,b<0)b=0;if(L=u.maxTileX+25-V.eyeTileX,L>50)L=50;let G=!1;while(b<=L)if(V.visibilityMap&&V.visibilityMap[b++][O]){G=!0;break}if(G){if(N=V.eyeZ-u.minZ,N>32)u.mode=3;else{if(N>=-32)continue;u.mode=4,N=-N}u.minDeltaX=(u.minX-V.eyeX<<8)/N|0,u.maxDeltaX=(u.maxX-V.eyeX<<8)/N|0,u.minDeltaY=(u.minY-V.eyeY<<8)/N|0,u.maxDeltaY=(u.maxY-V.eyeY<<8)/N|0,V.activeOccluders[V.activeOccluderCount++]=u}}}else if(u.type===4){if(O=u.minY-V.eyeY,O>128){if(b=u.minTileZ+25-V.eyeTileZ,b<0)b=0;if(L=u.maxTileZ+25-V.eyeTileZ,L>50)L=50;if(b<=L){let G=u.minTileX+25-V.eyeTileX;if(G<0)G=0;if(N=u.maxTileX+25-V.eyeTileX,N>50)N=50;let H=!1;_:for(let Q=G;Q<=N;Q++)for(let $=b;$<=L;$++)if(V.visibilityMap&&V.visibilityMap[Q][$]){H=!0;break _}if(H)u.mode=5,u.minDeltaX=(u.minX-V.eyeX<<8)/O|0,u.maxDeltaX=(u.maxX-V.eyeX<<8)/O|0,u.minDeltaZ=(u.minZ-V.eyeZ<<8)/O|0,u.maxDeltaZ=(u.maxZ-V.eyeZ<<8)/O|0,V.activeOccluders[V.activeOccluderCount++]=u}}}}}drawTile(_,R,E){V.drawTileQueue.push(_);while(!0){let u;do if(u=V.drawTileQueue.pop(),!u)return;while(!u.drawBack);let{x:O,z:b,level:L,originalLevel:N}=u,G=this.levelTiles[L];if(u.drawFront){if(R){if(L>0){let K=this.levelTiles[L-1][O][b];if(K&&K.drawBack)continue}if(O<=V.eyeTileX&&O>V.minDrawTileX){let K=G[O-1][b];if(K&&K.drawBack&&(K.drawFront||(u.combinedPrimaryExtendDirections&1)===0))continue}if(O>=V.eyeTileX&&O<V.maxDrawTileX-1){let K=G[O+1][b];if(K&&K.drawBack&&(K.drawFront||(u.combinedPrimaryExtendDirections&4)===0))continue}if(b<=V.eyeTileZ&&b>V.minDrawTileZ){let K=G[O][b-1];if(K&&K.drawBack&&(K.drawFront||(u.combinedPrimaryExtendDirections&8)===0))continue}if(b>=V.eyeTileZ&&b<V.maxDrawTileZ-1){let K=G[O][b+1];if(K&&K.drawBack&&(K.drawFront||(u.combinedPrimaryExtendDirections&2)===0))continue}}else R=!0;if(u.drawFront=!1,u.linkedSquare){let K=u.linkedSquare;if(!K.quickGround){if(K.ground&&!this.tileVisible(0,O,b))this.drawGround(O,b,K.ground,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw)}else if(!this.tileVisible(0,O,b))this.drawQuickGround(K.quickGround,0,O,b,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw);let F=K.wall;if(F)F.model1?.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,F.x-V.eyeX,F.y-V.eyeY,F.z-V.eyeZ,F.typecode);for(let w=0;w<K.primaryCount;w++){let k=K.locs[w];if(k)k.model?.draw(E,k.yaw,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,k.x-V.eyeX,k.y-V.eyeY,k.z-V.eyeZ,k.typecode)}}let Q=!1;if(!u.quickGround){if(u.ground&&!this.tileVisible(N,O,b))Q=!0,this.drawGround(O,b,u.ground,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw)}else if(!this.tileVisible(N,O,b))Q=!0,this.drawQuickGround(u.quickGround,N,O,b,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw);let $=0,J=0,T=u.wall,m=u.decor;if(T||m){if(V.eyeTileX===O)$+=1;else if(V.eyeTileX<O)$+=2;if(V.eyeTileZ===b)$+=3;else if(V.eyeTileZ>b)$+=6;J=V.FRONT_WALL_TYPES[$],u.backWallTypes=V.BACK_WALL_TYPES[$]}if(T){if((T.angle1&V.DIRECTION_ALLOW_WALL_CORNER_TYPE[$])===0)u.cornerSides=0;else if(T.angle1===16)u.cornerSides=3,u.sidesBeforeCorner=V.MIDDEP_16[$],u.sidesAfterCorner=3-u.sidesBeforeCorner;else if(T.angle1===32)u.cornerSides=6,u.sidesBeforeCorner=V.MIDDEP_32[$],u.sidesAfterCorner=6-u.sidesBeforeCorner;else if(T.angle1===64)u.cornerSides=12,u.sidesBeforeCorner=V.MIDDEP_64[$],u.sidesAfterCorner=12-u.sidesBeforeCorner;else u.cornerSides=9,u.sidesBeforeCorner=V.MIDDEP_128[$],u.sidesAfterCorner=9-u.sidesBeforeCorner;if((T.angle1&J)!==0&&!this.isTileSideOccluded(N,O,b,T.angle1))T.model1?.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,T.x-V.eyeX,T.y-V.eyeY,T.z-V.eyeZ,T.typecode);if((T.angle2&J)!==0&&!this.isTileSideOccluded(N,O,b,T.angle2))T.model2?.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,T.x-V.eyeX,T.y-V.eyeY,T.z-V.eyeZ,T.typecode)}if(m&&!this.isTileColumnOccluded(N,O,b,m.model.minY)){if((m.angle1&J)!==0)m.model.draw(E,m.angle2,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,m.x-V.eyeX,m.y-V.eyeY,m.z-V.eyeZ,m.typecode);else if((m.angle1&768)!==0){let K=m.x-V.eyeX,F=m.y-V.eyeY,w=m.z-V.eyeZ,k=m.angle2,Y;if(k===1||k===2)Y=-K;else Y=K;let A;if(k===2||k===3)A=-w;else A=w;if((m.angle1&256)!==0&&A<Y){let h=K+V.WALL_DECORATION_INSET_X[k],Z=w+V.WALL_DECORATION_INSET_Z[k];m.model.draw(E,k*512+256,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,h,F,Z,m.typecode)}if((m.angle1&512)!==0&&A>Y){let h=K+V.WALL_DECORATION_OUTSET_X[k],Z=w+V.WALL_DECORATION_OUTSET_Z[k];m.model.draw(E,k*512+1280&2047,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,h,F,Z,m.typecode)}}}if(Q){let K=u.groundDecor;if(K)K.model?.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,K.x-V.eyeX,K.y-V.eyeY,K.z-V.eyeZ,K.typecode);let F=u.groundObject;if(F&&F.offset===0){if(F.bottomObj)F.bottomObj.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,F.x-V.eyeX,F.y-V.eyeY,F.z-V.eyeZ,F.typecode);if(F.middleObj)F.middleObj.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,F.x-V.eyeX,F.y-V.eyeY,F.z-V.eyeZ,F.typecode);if(F.topObj)F.topObj.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,F.x-V.eyeX,F.y-V.eyeY,F.z-V.eyeZ,F.typecode)}}let q=u.combinedPrimaryExtendDirections;if(q!==0){if(O<V.eyeTileX&&(q&4)!==0){let K=G[O+1][b];if(K&&K.drawBack)V.drawTileQueue.push(K)}if(b<V.eyeTileZ&&(q&2)!==0){let K=G[O][b+1];if(K&&K.drawBack)V.drawTileQueue.push(K)}if(O>V.eyeTileX&&(q&1)!==0){let K=G[O-1][b];if(K&&K.drawBack)V.drawTileQueue.push(K)}if(b>V.eyeTileZ&&(q&8)!==0){let K=G[O][b-1];if(K&&K.drawBack)V.drawTileQueue.push(K)}}}if(u.cornerSides!==0){let Q=!0;for(let $=0;$<u.primaryCount;$++){let J=u.locs[$];if(!J)continue;if(J.cycle!==V.cycle&&(u.primaryExtendDirections[$]&u.cornerSides)===u.sidesBeforeCorner){Q=!1;break}}if(Q){let $=u.wall;if($&&!this.isTileSideOccluded(N,O,b,$.angle1))$.model1?.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,$.x-V.eyeX,$.y-V.eyeY,$.z-V.eyeZ,$.typecode);u.cornerSides=0}}if(u.drawPrimaries){let Q=u.primaryCount;u.drawPrimaries=!1;let $=0;_:for(let J=0;J<Q;J++){let T=u.locs[J];if(!T||T.cycle===V.cycle)continue;for(let w=T.minSceneTileX;w<=T.maxSceneTileX;w++)for(let k=T.minSceneTileZ;k<=T.maxSceneTileZ;k++){let Y=G[w][k];if(!Y)continue;if(Y.drawFront){u.drawPrimaries=!0;continue _}if(Y.cornerSides===0)continue;let A=0;if(w>T.minSceneTileX)A+=1;if(w<T.maxSceneTileX)A+=4;if(k>T.minSceneTileZ)A+=8;if(k<T.maxSceneTileZ)A+=2;if((A&Y.cornerSides)!==u.sidesAfterCorner)continue}V.locBuffer[$++]=T;let m=V.eyeTileX-T.minSceneTileX,q=T.maxSceneTileX-V.eyeTileX;if(q>m)m=q;let K=V.eyeTileZ-T.minSceneTileZ,F=T.maxSceneTileZ-V.eyeTileZ;if(F>K)T.distance=m+F;else T.distance=m+K}while($>0){let J=-50,T=-1;for(let q=0;q<$;q++){let K=V.locBuffer[q];if(!K)continue;if(K.distance>J&&K.cycle!==V.cycle)J=K.distance,T=q}if(T===-1)break;let m=V.locBuffer[T];if(m){if(m.cycle=V.cycle,!this.locVisible(N,m.minSceneTileX,m.maxSceneTileX,m.minSceneTileZ,m.maxSceneTileZ,m.model?.minY??0))m.model?.draw(E,m.yaw,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,m.x-V.eyeX,m.y-V.eyeY,m.z-V.eyeZ,m.typecode);for(let q=m.minSceneTileX;q<=m.maxSceneTileX;q++)for(let K=m.minSceneTileZ;K<=m.maxSceneTileZ;K++){let F=G[q][K];if(!F)continue;if(F.cornerSides!==0)V.drawTileQueue.push(F);else if((q!==O||K!==b)&&F.drawBack)V.drawTileQueue.push(F)}}}if(u.drawPrimaries)continue}if(!u.drawBack||u.cornerSides!==0)continue;if(O<=V.eyeTileX&&O>V.minDrawTileX){let Q=G[O-1][b];if(Q&&Q.drawBack)continue}if(O>=V.eyeTileX&&O<V.maxDrawTileX-1){let Q=G[O+1][b];if(Q&&Q.drawBack)continue}if(b<=V.eyeTileZ&&b>V.minDrawTileZ){let Q=G[O][b-1];if(Q&&Q.drawBack)continue}if(b>=V.eyeTileZ&&b<V.maxDrawTileZ-1){let Q=G[O][b+1];if(Q&&Q.drawBack)continue}u.drawBack=!1,V.tilesRemaining--;let H=u.groundObject;if(H&&H.offset!==0){if(H.bottomObj)H.bottomObj.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,H.x-V.eyeX,H.y-V.eyeY-H.offset,H.z-V.eyeZ,H.typecode);if(H.middleObj)H.middleObj.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,H.x-V.eyeX,H.y-V.eyeY-H.offset,H.z-V.eyeZ,H.typecode);if(H.topObj)H.topObj.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,H.x-V.eyeX,H.y-V.eyeY-H.offset,H.z-V.eyeZ,H.typecode)}if(u.backWallTypes!==0){let Q=u.decor;if(Q&&!this.isTileColumnOccluded(N,O,b,Q.model.minY)){if((Q.angle1&u.backWallTypes)!==0)Q.model.draw(E,Q.angle2,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,Q.x-V.eyeX,Q.y-V.eyeY,Q.z-V.eyeZ,Q.typecode);else if((Q.angle1&768)!==0){let J=Q.x-V.eyeX,T=Q.y-V.eyeY,m=Q.z-V.eyeZ,q=Q.angle2,K;if(q===1||q===2)K=-J;else K=J;let F;if(q===2||q===3)F=-m;else F=m;if((Q.angle1&256)!==0&&F>=K){let w=J+V.WALL_DECORATION_INSET_X[q],k=m+V.WALL_DECORATION_INSET_Z[q];Q.model.draw(E,q*512+256,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,w,T,k,Q.typecode)}if((Q.angle1&512)!==0&&F<=K){let w=J+V.WALL_DECORATION_OUTSET_X[q],k=m+V.WALL_DECORATION_OUTSET_Z[q];Q.model.draw(E,q*512+1280&2047,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,w,T,k,Q.typecode)}}}let $=u.wall;if($){if(($.angle2&u.backWallTypes)!==0&&!this.isTileSideOccluded(N,O,b,$.angle2))$.model2?.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,$.x-V.eyeX,$.y-V.eyeY,$.z-V.eyeZ,$.typecode);if(($.angle1&u.backWallTypes)!==0&&!this.isTileSideOccluded(N,O,b,$.angle1))$.model1?.draw(E,0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,$.x-V.eyeX,$.y-V.eyeY,$.z-V.eyeZ,$.typecode)}}if(L<this.maxLevel-1){let Q=this.levelTiles[L+1][O][b];if(Q&&Q.drawBack)V.drawTileQueue.push(Q)}if(O<V.eyeTileX){let Q=G[O+1][b];if(Q&&Q.drawBack)V.drawTileQueue.push(Q)}if(b<V.eyeTileZ){let Q=G[O][b+1];if(Q&&Q.drawBack)V.drawTileQueue.push(Q)}if(O>V.eyeTileX){let Q=G[O-1][b];if(Q&&Q.drawBack)V.drawTileQueue.push(Q)}if(b>V.eyeTileZ){let Q=G[O][b-1];if(Q&&Q.drawBack)V.drawTileQueue.push(Q)}}}drawQuickGround(_,R,E,u,O,b,L,N){let G,H=G=(E<<7)-V.eyeX,Q,$=Q=(u<<7)-V.eyeZ,J,T=J=H+128,m,q=m=$+128,K=this.levelHeightmaps[R][E][u]-V.eyeY,F=this.levelHeightmaps[R][E+1][u]-V.eyeY,w=this.levelHeightmaps[R][E+1][u+1]-V.eyeY,k=this.levelHeightmaps[R][E][u+1]-V.eyeY,Y=$*L+H*N>>16;if($=$*N-H*L>>16,H=Y,Y=K*b-$*O>>16,$=K*O+$*b>>16,K=Y,$<50)return;if(Y=Q*L+T*N>>16,Q=Q*N-T*L>>16,T=Y,Y=F*b-Q*O>>16,Q=F*O+Q*b>>16,F=Y,Q<50)return;if(Y=q*L+J*N>>16,q=q*N-J*L>>16,J=Y,Y=w*b-q*O>>16,q=w*O+q*b>>16,w=Y,q<50)return;if(Y=m*L+G*N>>16,m=m*N-G*L>>16,G=Y,Y=k*b-m*O>>16,m=k*O+m*b>>16,k=Y,m<50)return;let A=X.centerX+((H<<9)/$|0),h=X.centerY+((K<<9)/$|0),Z=X.centerX+((T<<9)/Q|0),f=X.centerY+((F<<9)/Q|0),S=X.centerX+((J<<9)/q|0),j=X.centerY+((w<<9)/q|0),W=X.centerX+((G<<9)/m|0),B=X.centerY+((k<<9)/m|0);if(X.alpha=0,(S-W)*(f-B)-(j-B)*(Z-W)>0){if(X.clipX=S<0||W<0||Z<0||S>I.boundX||W>I.boundX||Z>I.boundX,V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,j,B,f,S,W,Z))V.clickTileX=E,V.clickTileZ=u;if(_.textureId===-1){if(_.northeastColor!==12345678)X.gouraudTriangle(S,W,Z,j,B,f,_.northeastColor,_.northwestColor,_.southeastColor)}else if(V.lowMemory){let M=V.TEXTURE_HSL[_.textureId];X.gouraudTriangle(S,W,Z,j,B,f,this.mulLightness(M,_.northeastColor),this.mulLightness(M,_.northwestColor),this.mulLightness(M,_.southeastColor))}else if(_.flat)X.textureTriangle(S,W,Z,j,B,f,_.northeastColor,_.northwestColor,_.southeastColor,H,K,$,T,G,F,k,Q,m,_.textureId);else X.textureTriangle(S,W,Z,j,B,f,_.northeastColor,_.northwestColor,_.southeastColor,J,w,q,G,T,k,F,m,Q,_.textureId)}if((A-Z)*(B-f)-(h-f)*(W-Z)<=0)return;if(X.clipX=A<0||Z<0||W<0||A>I.boundX||Z>I.boundX||W>I.boundX,V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,h,f,B,A,Z,W))V.clickTileX=E,V.clickTileZ=u;if(_.textureId!==-1)if(!V.lowMemory)X.textureTriangle(A,Z,W,h,f,B,_.southwestColor,_.southeastColor,_.northwestColor,H,K,$,T,G,F,k,Q,m,_.textureId);else{let M=V.TEXTURE_HSL[_.textureId];X.gouraudTriangle(A,Z,W,h,f,B,this.mulLightness(M,_.southwestColor),this.mulLightness(M,_.southeastColor),this.mulLightness(M,_.northwestColor))}else if(_.southwestColor!==12345678)X.gouraudTriangle(A,Z,W,h,f,B,_.southwestColor,_.southeastColor,_.northwestColor)}drawGround(_,R,E,u,O,b,L){let N=E.vertexX.length;for(let G=0;G<N;G++){let H=E.vertexX[G]-V.eyeX,Q=E.vertexY[G]-V.eyeY,$=E.vertexZ[G]-V.eyeZ,J=$*b+H*L>>16;if($=$*L-H*b>>16,H=J,J=Q*O-$*u>>16,$=Q*u+$*O>>16,Q=J,$<50)return;if(E.triangleTextureIds)y.tmpViewspaceX[G]=H,y.tmpViewspaceY[G]=Q,y.tmpViewspaceZ[G]=$;y.tmpScreenX[G]=X.centerX+((H<<9)/$|0),y.tmpScreenY[G]=X.centerY+((Q<<9)/$|0)}X.alpha=0,N=E.triangleVertexA.length;for(let G=0;G<N;G++){let H=E.triangleVertexA[G],Q=E.triangleVertexB[G],$=E.triangleVertexC[G],J=y.tmpScreenX[H],T=y.tmpScreenX[Q],m=y.tmpScreenX[$],q=y.tmpScreenY[H],K=y.tmpScreenY[Q],F=y.tmpScreenY[$];if((J-T)*(F-K)-(q-K)*(m-T)>0){if(X.clipX=J<0||T<0||m<0||J>I.boundX||T>I.boundX||m>I.boundX,V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,q,K,F,J,T,m))V.clickTileX=_,V.clickTileZ=R;if(!E.triangleTextureIds||E.triangleTextureIds[G]===-1){if(E.triangleColorA[G]!==12345678)X.gouraudTriangle(J,T,m,q,K,F,E.triangleColorA[G],E.triangleColorB[G],E.triangleColorC[G])}else if(V.lowMemory){let w=V.TEXTURE_HSL[E.triangleTextureIds[G]];X.gouraudTriangle(J,T,m,q,K,F,this.mulLightness(w,E.triangleColorA[G]),this.mulLightness(w,E.triangleColorB[G]),this.mulLightness(w,E.triangleColorC[G]))}else if(E.flat)X.textureTriangle(J,T,m,q,K,F,E.triangleColorA[G],E.triangleColorB[G],E.triangleColorC[G],y.tmpViewspaceX[0],y.tmpViewspaceY[0],y.tmpViewspaceZ[0],y.tmpViewspaceX[1],y.tmpViewspaceX[3],y.tmpViewspaceY[1],y.tmpViewspaceY[3],y.tmpViewspaceZ[1],y.tmpViewspaceZ[3],E.triangleTextureIds[G]);else X.textureTriangle(J,T,m,q,K,F,E.triangleColorA[G],E.triangleColorB[G],E.triangleColorC[G],y.tmpViewspaceX[H],y.tmpViewspaceY[H],y.tmpViewspaceZ[H],y.tmpViewspaceX[Q],y.tmpViewspaceX[$],y.tmpViewspaceY[Q],y.tmpViewspaceY[$],y.tmpViewspaceZ[Q],y.tmpViewspaceZ[$],E.triangleTextureIds[G])}}}tileVisible(_,R,E){let u=this.levelTileOcclusionCycles[_][R][E];if(u===-V.cycle)return!1;else if(u===V.cycle)return!0;else{let O=R<<7,b=E<<7;if(this.occluded(O+1,this.levelHeightmaps[_][R][E],b+1)&&this.occluded(O+128-1,this.levelHeightmaps[_][R+1][E],b+1)&&this.occluded(O+128-1,this.levelHeightmaps[_][R+1][E+1],b+128-1)&&this.occluded(O+1,this.levelHeightmaps[_][R][E+1],b+128-1))return this.levelTileOcclusionCycles[_][R][E]=V.cycle,!0;else return this.levelTileOcclusionCycles[_][R][E]=-V.cycle,!1}}isTileSideOccluded(_,R,E,u){if(!this.tileVisible(_,R,E))return!1;let O=R<<7,b=E<<7,L=this.levelHeightmaps[_][R][E]-1,N=L-120,G=L-230,H=L-238;if(u<16){if(u===1){if(O>V.eyeX){if(!this.occluded(O,L,b))return!1;if(!this.occluded(O,L,b+128))return!1}if(_>0){if(!this.occluded(O,N,b))return!1;if(!this.occluded(O,N,b+128))return!1}if(!this.occluded(O,G,b))return!1;return this.occluded(O,G,b+128)}if(u===2){if(b<V.eyeZ){if(!this.occluded(O,L,b+128))return!1;if(!this.occluded(O+128,L,b+128))return!1}if(_>0){if(!this.occluded(O,N,b+128))return!1;if(!this.occluded(O+128,N,b+128))return!1}if(!this.occluded(O,G,b+128))return!1;return this.occluded(O+128,G,b+128)}if(u===4){if(O<V.eyeX){if(!this.occluded(O+128,L,b))return!1;if(!this.occluded(O+128,L,b+128))return!1}if(_>0){if(!this.occluded(O+128,N,b))return!1;if(!this.occluded(O+128,N,b+128))return!1}if(!this.occluded(O+128,G,b))return!1;return this.occluded(O+128,G,b+128)}if(u===8){if(b>V.eyeZ){if(!this.occluded(O,L,b))return!1;if(!this.occluded(O+128,L,b))return!1}if(_>0){if(!this.occluded(O,N,b))return!1;if(!this.occluded(O+128,N,b))return!1}if(!this.occluded(O,G,b))return!1;return this.occluded(O+128,G,b)}}if(!this.occluded(O+64,H,b+64))return!1;else if(u===16)return this.occluded(O,G,b+128);else if(u===32)return this.occluded(O+128,G,b+128);else if(u===64)return this.occluded(O+128,G,b);else if(u===128)return this.occluded(O,G,b);return!0}isTileColumnOccluded(_,R,E,u){if(this.tileVisible(_,R,E)){let O=R<<7,b=E<<7;return this.occluded(O+1,this.levelHeightmaps[_][R][E]-u,b+1)&&this.occluded(O+128-1,this.levelHeightmaps[_][R+1][E]-u,b+1)&&this.occluded(O+128-1,this.levelHeightmaps[_][R+1][E+1]-u,b+128-1)&&this.occluded(O+1,this.levelHeightmaps[_][R][E+1]-u,b+128-1)}return!1}locVisible(_,R,E,u,O,b){let L,N;if(R!==E||u!==O){for(L=R;L<=E;L++)for(N=u;N<=O;N++)if(this.levelTileOcclusionCycles[_][L][N]===-V.cycle)return!1;N=(R<<7)+1;let G=(u<<7)+2,H=this.levelHeightmaps[_][R][u]-b;if(!this.occluded(N,H,G))return!1;let Q=(E<<7)-1;if(!this.occluded(Q,H,G))return!1;let $=(O<<7)-1;if(!this.occluded(N,H,$))return!1;else return this.occluded(Q,H,$)}else if(this.tileVisible(_,R,u))return L=R<<7,N=u<<7,this.occluded(L+1,this.levelHeightmaps[_][R][u]-b,N+1)&&this.occluded(L+128-1,this.levelHeightmaps[_][R+1][u]-b,N+1)&&this.occluded(L+128-1,this.levelHeightmaps[_][R+1][u+1]-b,N+128-1)&&this.occluded(L+1,this.levelHeightmaps[_][R][u+1]-b,N+128-1);return!1}occluded(_,R,E){for(let u=0;u<V.activeOccluderCount;u++){let O=V.activeOccluders[u];if(!O)continue;if(O.mode===1){let b=O.minX-_;if(b>0){let L=O.minZ+(O.minDeltaZ*b>>8),N=O.maxZ+(O.maxDeltaZ*b>>8),G=O.minY+(O.minDeltaY*b>>8),H=O.maxY+(O.maxDeltaY*b>>8);if(E>=L&&E<=N&&R>=G&&R<=H)return!0}}else if(O.mode===2){let b=_-O.minX;if(b>0){let L=O.minZ+(O.minDeltaZ*b>>8),N=O.maxZ+(O.maxDeltaZ*b>>8),G=O.minY+(O.minDeltaY*b>>8),H=O.maxY+(O.maxDeltaY*b>>8);if(E>=L&&E<=N&&R>=G&&R<=H)return!0}}else if(O.mode===3){let b=O.minZ-E;if(b>0){let L=O.minX+(O.minDeltaX*b>>8),N=O.maxX+(O.maxDeltaX*b>>8),G=O.minY+(O.minDeltaY*b>>8),H=O.maxY+(O.maxDeltaY*b>>8);if(_>=L&&_<=N&&R>=G&&R<=H)return!0}}else if(O.mode===4){let b=E-O.minZ;if(b>0){let L=O.minX+(O.minDeltaX*b>>8),N=O.maxX+(O.maxDeltaX*b>>8),G=O.minY+(O.minDeltaY*b>>8),H=O.maxY+(O.maxDeltaY*b>>8);if(_>=L&&_<=N&&R>=G&&R<=H)return!0}}else if(O.mode===5){let b=R-O.minY;if(b>0){let L=O.minX+(O.minDeltaX*b>>8),N=O.maxX+(O.maxDeltaX*b>>8),G=O.minZ+(O.minDeltaZ*b>>8),H=O.maxZ+(O.maxDeltaZ*b>>8);if(_>=L&&_<=N&&E>=G&&E<=H)return!0}}}return!1}pointInsideTriangle(_,R,E,u,O,b,L,N){if(R<E&&R<u&&R<O)return!1;else if(R>E&&R>u&&R>O)return!1;else if(_<b&&_<L&&_<N)return!1;else if(_>b&&_>L&&_>N)return!1;let G=(R-E)*(L-b)-(_-b)*(u-E),H=(R-O)*(b-N)-(_-N)*(E-O),Q=(R-u)*(N-L)-(_-L)*(O-u);return G*Q>0&&Q*H>0}mulLightness(_,R){if(R=(127-R)*(_&127)/160|0,R<2)R=2;else if(R>126)R=126;return(_&65408)+R}}class R0 extends w0{index;shape;angle;heightmapSW;heightmapSE;heightmapNE;heightmapNW;seq;seqFrame;seqCycle;constructor(_,R,E,u,O,b,L,N,G,H){super();if(this.index=R,this.shape=E,this.angle=u,this.heightmapSW=O,this.heightmapSE=b,this.heightmapNE=L,this.heightmapNW=N,this.seq=e.types[G],this.seqFrame=0,this.seqCycle=_,H&&this.seq.loops!==-1)this.seqFrame=Math.random()*this.seq.frameCount|0,this.seqCycle-=Math.random()*this.seq.getFrameDuration(this.seqFrame)|0}getModel(_){if(this.seq){let u=_-this.seqCycle;if(u>100&&this.seq.loops>0)u=100;while(u>this.seq.getFrameDuration(this.seqFrame)){if(u-=this.seq.getFrameDuration(this.seqFrame),this.seqFrame++,this.seqFrame<this.seq.frameCount)continue;if(this.seqFrame-=this.seq.loops,this.seqFrame<0||this.seqFrame>=this.seq.frameCount){this.seq=null;break}}this.seqCycle=_-u}let R=-1;if(this.seq&&this.seq.frames&&typeof this.seq.frames[this.seqFrame]<"u")R=this.seq.frames[this.seqFrame];return o.get(this.index).getModel(this.shape,this.angle,this.heightmapSW,this.heightmapSE,this.heightmapNE,this.heightmapNW,R)}}class i{static ROTATION_WALL_TYPE=Int8Array.of(1,2,4,8);static ROTATION_WALL_CORNER_TYPE=Uint8Array.of(16,32,64,128);static WALL_DECORATION_ROTATION_FORWARD_X=Int8Array.of(1,0,-1,0);static WALL_DECORATION_ROTATION_FORWARD_Z=Int8Array.of(0,-1,0,1);static randomHueOffset=(Math.random()*17|0)-8;static randomLightnessOffset=(Math.random()*33|0)-16;static lowMemory=!0;static levelBuilt=0;static fullbright=!1;static perlin(_,R){let E=this.perlinScale(_+45365,R+91923,4)+(this.perlinScale(_+10294,R+37821,2)-128>>1)+(this.perlinScale(_,R,1)-128>>2)-128;if(E=(E*0.3|0)+35,E<10)E=10;else if(E>60)E=60;return E}static perlinScale(_,R,E){let u=_/E|0,O=_&E-1,b=R/E|0,L=R&E-1,N=this.smoothNoise(u,b),G=this.smoothNoise(u+1,b),H=this.smoothNoise(u,b+1),Q=this.smoothNoise(u+1,b+1),$=this.interpolate(N,G,O,E),J=this.interpolate(H,Q,O,E);return this.interpolate($,J,L,E)}static interpolate(_,R,E,u){let O=65536-X.cosTable[E*1024/u|0]>>1;return(_*(65536-O)>>16)+(R*O>>16)}static smoothNoise(_,R){let E=this.noise(_-1,R-1)+this.noise(_+1,R-1)+this.noise(_-1,R+1)+this.noise(_+1,R+1),u=this.noise(_-1,R)+this.noise(_+1,R)+this.noise(_,R-1)+this.noise(_,R+1),O=this.noise(_,R);return(E/16|0)+(u/8|0)+(O/4|0)}static noise(_,R){let E=_+R*57,u=BigInt(E<<13^E);return Number((u*(u*u*15731n+789221n)+1376312589n&0x7fffffffn)>>19n)&255}static isLocReady(_,R){let E=o.get(_);if(R==11)R=10;if(R>=5&&R<=8)R=4;return E.shapeModelsAreReady(R)}static addLoc(_,R,E,u,O,b,L,N,G,H,Q){let $=b[Q][E][u],J=b[Q][E+1][u],T=b[Q][E+1][u+1],m=b[Q][E][u+1],q=$+J+T+m>>2,K=o.get(N),F=E+(u<<7)+(N<<14)+1073741824|0;if(!K.active)F+=-2147483648;F|=0;let w=((H<<6)+G|0)<<24>>24;if(G===n.GROUND_DECOR.id){let k;if(K.anim===-1)k=K.getModel(22,H,$,J,m,T,-1);else k=new R0(_,N,22,G,$,J,m,T,K.anim,!0);if(O?.addGroundDecoration(k,R,E,u,q,F,w),K.blockwalk&&K.active&&L)L.addFloor(E,u)}else if(G===n.CENTREPIECE_STRAIGHT.id||G===n.CENTREPIECE_DIAGONAL.id){let k;if(K.anim===-1)k=K.getModel(10,H,$,J,m,T,-1);else k=new R0(_,N,10,H,$,J,m,T,K.anim,!0);if(k){let Y=0;if(G===n.CENTREPIECE_DIAGONAL.id)Y+=256;let A,h;if(H===1||H===3)A=K.length,h=K.width;else A=K.width,h=K.length;O?.addLoc(R,E,u,q,k,F,w,A,h,Y)}if(K.blockwalk&&L)L.addLoc(E,u,K.width,K.length,H,K.blockrange)}else if(G>=n.ROOF_STRAIGHT.id){let k;if(K.anim===-1)k=K.getModel(G,H,$,J,m,T,-1);else k=new R0(_,N,G,H,$,J,m,T,K.anim,!0);if(O?.addLoc(R,E,u,q,k,F,w,1,1,0),K.blockwalk&&L)L.addLoc(E,u,K.width,K.length,H,K.blockrange)}else if(G===n.WALL_STRAIGHT.id){let k;if(K.anim===-1)k=K.getModel(0,H,$,J,m,T,-1);else k=new R0(_,N,0,H,$,J,m,T,K.anim,!0);if(O?.addWall(R,E,u,q,i.ROTATION_WALL_TYPE[H],0,k,null,F,w),K.blockwalk&&L)L.addWall(E,u,G,H,K.blockrange)}else if(G===n.WALL_DIAGONAL_CORNER.id){let k;if(K.anim===-1)k=K.getModel(1,H,$,J,m,T,-1);else k=new R0(_,N,1,H,$,J,m,T,K.anim,!0);if(O?.addWall(R,E,u,q,i.ROTATION_WALL_CORNER_TYPE[H],0,k,null,F,w),K.blockwalk&&L)L.addWall(E,u,G,H,K.blockrange)}else if(G===n.WALL_L.id){let k=H+1&3,Y,A;if(K.anim===-1)Y=K.getModel(2,H+4,$,J,m,T,-1),A=K.getModel(2,k,$,J,m,T,-1);else Y=new R0(_,N,2,H+4,$,J,m,T,K.anim,!0),A=new R0(_,N,2,k,$,J,m,T,K.anim,!0);if(O?.addWall(R,E,u,q,i.ROTATION_WALL_TYPE[H],i.ROTATION_WALL_TYPE[k],Y,A,F,w),K.blockwalk&&L)L.addWall(E,u,G,H,K.blockrange)}else if(G===n.WALL_SQUARE_CORNER.id){let k;if(K.anim===-1)k=K.getModel(3,H,$,J,m,T,-1);else k=new R0(_,N,3,H,$,J,m,T,K.anim,!0);if(O?.addWall(R,E,u,q,i.ROTATION_WALL_CORNER_TYPE[H],0,k,null,F,w),K.blockwalk&&L)L.addWall(E,u,G,H,K.blockrange)}else if(G===n.WALL_DIAGONAL.id){let k;if(K.anim===-1)k=K.getModel(G,H,$,J,m,T,-1);else k=new R0(_,N,G,H,$,J,m,T,K.anim,!0);if(O?.addLoc(R,E,u,q,k,F,w,1,1,0),K.blockwalk&&L)L.addLoc(E,u,K.width,K.length,H,K.blockrange)}else if(G===n.WALLDECOR_STRAIGHT_NOOFFSET.id){let k;if(K.anim===-1)k=K.getModel(4,0,$,J,m,T,-1);else k=new R0(_,N,4,0,$,J,m,T,K.anim,!0);O?.setWallDecoration(R,E,u,q,0,0,F,k,w,H*512,i.ROTATION_WALL_TYPE[H])}else if(G===n.WALLDECOR_STRAIGHT_OFFSET.id){let k=16;if(O){let A=O.getWallTypecode(R,E,u);if(A>0)k=o.get(A>>14&32767).wallwidth}let Y;if(K.anim===-1)Y=K.getModel(4,0,$,J,m,T,-1);else Y=new R0(_,N,4,0,$,J,m,T,K.anim,!0);O?.setWallDecoration(R,E,u,q,i.WALL_DECORATION_ROTATION_FORWARD_X[H]*k,i.WALL_DECORATION_ROTATION_FORWARD_Z[H]*k,F,Y,w,H*512,i.ROTATION_WALL_TYPE[H])}else if(G===n.WALLDECOR_DIAGONAL_OFFSET.id){let k;if(K.anim===-1)k=K.getModel(4,0,$,J,m,T,-1);else k=new R0(_,N,4,0,$,J,m,T,K.anim,!0);O?.setWallDecoration(R,E,u,q,0,0,F,k,w,H,256)}else if(G===n.WALLDECOR_DIAGONAL_NOOFFSET.id){let k;if(K.anim===-1)k=K.getModel(4,0,$,J,m,T,-1);else k=new R0(_,N,4,0,$,J,m,T,K.anim,!0);O?.setWallDecoration(R,E,u,q,0,0,F,k,w,H,512)}else if(G===n.WALLDECOR_DIAGONAL_BOTH.id){let k;if(K.anim===-1)k=K.getModel(4,0,$,J,m,T,-1);else k=new R0(_,N,4,0,$,J,m,T,K.anim,!0);O?.setWallDecoration(R,E,u,q,0,0,F,k,w,H,768)}}maxTileX;maxTileZ;heightmap;flags;underlayType;overlayType;overlayShape;overlayAngle;shadow;lightness;blendChroma;blendSaturation;blendLightness;blendLuminance;blendMagnitude;occlusion;constructor(_,R,E,u){this.maxTileX=_,this.maxTileZ=R,this.heightmap=E,this.flags=u,this.underlayType=new W0(4,_,R),this.overlayType=new W0(4,_,R),this.overlayShape=new W0(4,_,R),this.overlayAngle=new W0(4,_,R),this.occlusion=new C0(4,_+1,R+1),this.shadow=new W0(4,_+1,R+1),this.lightness=new h0(_+1,R+1),this.blendChroma=new Int32Array(R),this.blendSaturation=new Int32Array(R),this.blendLightness=new Int32Array(R),this.blendLuminance=new Int32Array(R),this.blendMagnitude=new Int32Array(R)}build(_,R){for(let E=0;E<4;E++)for(let u=0;u<104;u++)for(let O=0;O<104;O++)if((this.flags[E][u][O]&1)===1){let b=E;if((this.flags[1][u][O]&2)===2)b--;if(b>=0)R[b]?.addFloor(u,O)}if(i.randomHueOffset+=(Math.random()*5|0)-2,i.randomHueOffset<-8)i.randomHueOffset=-8;else if(i.randomHueOffset>8)i.randomHueOffset=8;if(i.randomLightnessOffset+=(Math.random()*5|0)-2,i.randomLightnessOffset<-16)i.randomLightnessOffset=-16;else if(i.randomLightnessOffset>16)i.randomLightnessOffset=16;for(let E=0;E<4;E++){let u=this.shadow[E],O=96,b=768,L=-50,N=-10,G=-50,Q=768*(Math.sqrt(5100)|0)>>8;for(let $=1;$<this.maxTileZ-1;$++)for(let J=1;J<this.maxTileX-1;J++){let T=this.heightmap[E][J+1][$]-this.heightmap[E][J-1][$],m=this.heightmap[E][J][$+1]-this.heightmap[E][J][$-1],q=Math.sqrt(T*T+65536+m*m)|0,K=(T<<8)/q|0,F=65536/q|0,w=(m<<8)/q|0,k=96+((-50*K+-10*F+-50*w)/Q|0),Y=(u[J-1][$]>>2)+(u[J+1][$]>>3)+(u[J][$-1]>>2)+(u[J][$+1]>>3)+(u[J][$]>>1);this.lightness[J][$]=k-Y}for(let $=0;$<this.maxTileZ;$++)this.blendChroma[$]=0,this.blendSaturation[$]=0,this.blendLightness[$]=0,this.blendLuminance[$]=0,this.blendMagnitude[$]=0;for(let $=-5;$<this.maxTileX+5;$++){for(let J=0;J<this.maxTileZ;J++){let T=$+5;if(T>=0&&T<this.maxTileX){let q=this.underlayType[E][T][J]&255;if(q>0){let K=B0.types[q-1];this.blendChroma[J]+=K.chroma,this.blendSaturation[J]+=K.saturation,this.blendLightness[J]+=K.lightness,this.blendLuminance[J]+=K.luminance,this.blendMagnitude[J]++}}let m=$-5;if(m>=0&&m<this.maxTileX){let q=this.underlayType[E][m][J]&255;if(q>0){let K=B0.types[q-1];this.blendChroma[J]-=K.chroma,this.blendSaturation[J]-=K.saturation,this.blendLightness[J]-=K.lightness,this.blendLuminance[J]-=K.luminance,this.blendMagnitude[J]--}}}if($>=1&&$<this.maxTileX-1){let J=0,T=0,m=0,q=0,K=0;for(let F=-5;F<this.maxTileZ+5;F++){let w=F+5;if(w>=0&&w<this.maxTileZ)J+=this.blendChroma[w],T+=this.blendSaturation[w],m+=this.blendLightness[w],q+=this.blendLuminance[w],K+=this.blendMagnitude[w];let k=F-5;if(k>=0&&k<this.maxTileZ)J-=this.blendChroma[k],T-=this.blendSaturation[k],m-=this.blendLightness[k],q-=this.blendLuminance[k],K-=this.blendMagnitude[k];if(F>=1&&F<this.maxTileZ-1&&(!i.lowMemory||(this.flags[E][$][F]&16)===0&&this.getDrawLevel(E,$,F)===i.levelBuilt)){let Y=this.underlayType[E][$][F]&255,A=this.overlayType[E][$][F]&255;if(Y>0||A>0){let h=this.heightmap[E][$][F],Z=this.heightmap[E][$+1][F],f=this.heightmap[E][$+1][F+1],S=this.heightmap[E][$][F+1],j=this.lightness[$][F],W=this.lightness[$+1][F],B=this.lightness[$+1][F+1],M=this.lightness[$][F+1],v=-1,p=-1;if(Y>0){let a=J*256/q|0,t=T/K|0,d=m/K|0;v=this.hsl24to16(a,t,d);let N0=a+i.randomHueOffset&255;if(d+=i.randomLightnessOffset,d<0)d=0;else if(d>255)d=255;p=this.hsl24to16(N0,t,d)}if(E>0){let a=Y!==0||this.overlayShape[E][$][F]===0;if(A>0&&!B0.types[A-1].occlude)a=!1;if(a&&h===Z&&h===f&&h===S)this.occlusion[E][$][F]|=2340}let D=0;if(v!==-1)D=X.colourTable[i.mulHSL(p,96)];if(A===0)_?.setTile(E,$,F,0,0,-1,h,Z,f,S,i.mulHSL(v,j),i.mulHSL(v,W),i.mulHSL(v,B),i.mulHSL(v,M),0,0,0,0,D,0);else{let a=this.overlayShape[E][$][F]+1,t=this.overlayAngle[E][$][F],d=B0.types[A-1],N0=d.texture,u0,$0;if(N0>=0)$0=X.getAverageTextureRgb(N0),u0=-1;else if(d.rgb===16711935)$0=0,u0=-2,N0=-1;else u0=this.hsl24to16(d.hue,d.saturation,d.lightness),$0=X.colourTable[this.adjustLightness(d.hsl,96)];_?.setTile(E,$,F,a,t,N0,h,Z,f,S,i.mulHSL(v,j),i.mulHSL(v,W),i.mulHSL(v,B),i.mulHSL(v,M),this.adjustLightness(u0,j),this.adjustLightness(u0,W),this.adjustLightness(u0,B),this.adjustLightness(u0,M),D,$0)}}}}}}for(let $=1;$<this.maxTileZ-1;$++)for(let J=1;J<this.maxTileX-1;J++)_?.setDrawLevel(E,J,$,this.getDrawLevel(E,J,$))}if(!i.fullbright)_?.buildModels(64,768,-50,-10,-50);for(let E=0;E<this.maxTileX;E++)for(let u=0;u<this.maxTileZ;u++)if((this.flags[1][E][u]&2)===2)_?.setLinkBelow(E,u);if(!i.fullbright){let E=1,u=2,O=4;for(let b=0;b<4;b++){if(b>0)E<<=3,u<<=3,O<<=3;for(let L=0;L<=b;L++)for(let N=0;N<=this.maxTileZ;N++)for(let G=0;G<=this.maxTileX;G++){if((this.occlusion[L][G][N]&E)!==0){let H=N,Q=N,$=L,J=L;while(H>0&&(this.occlusion[L][G][H-1]&E)!==0)H--;while(Q<this.maxTileZ&&(this.occlusion[L][G][Q+1]&E)!==0)Q++;_:while($>0){for(let m=H;m<=Q;m++)if((this.occlusion[$-1][G][m]&E)===0)break _;$--}_:while(J<b){for(let m=H;m<=Q;m++)if((this.occlusion[J+1][G][m]&E)===0)break _;J++}if((J+1-$)*(Q+1-H)>=8){let m=this.heightmap[J][G][H]-240,q=this.heightmap[$][G][H];V.addOccluder(b,1,G*128,m,H*128,G*128,q,Q*128+128);for(let K=$;K<=J;K++)for(let F=H;F<=Q;F++)this.occlusion[K][G][F]&=~E}}if((this.occlusion[L][G][N]&u)!==0){let H=G,Q=G,$=L,J=L;while(H>0&&(this.occlusion[L][H-1][N]&u)!==0)H--;while(Q<this.maxTileX&&(this.occlusion[L][Q+1][N]&u)!==0)Q++;_:while($>0){for(let m=H;m<=Q;m++)if((this.occlusion[$-1][m][N]&u)===0)break _;$--}_:while(J<b){for(let m=H;m<=Q;m++)if((this.occlusion[J+1][m][N]&u)===0)break _;J++}if((J+1-$)*(Q+1-H)>=8){let m=this.heightmap[J][H][N]-240,q=this.heightmap[$][H][N];V.addOccluder(b,2,H*128,m,N*128,Q*128+128,q,N*128);for(let K=$;K<=J;K++)for(let F=H;F<=Q;F++)this.occlusion[K][F][N]&=~u}}if((this.occlusion[L][G][N]&O)!==0){let H=G,Q=G,$=N,J=N;while($>0&&(this.occlusion[L][G][$-1]&O)!==0)$--;while(J<this.maxTileZ&&(this.occlusion[L][G][J+1]&O)!==0)J++;_:while(H>0){for(let T=$;T<=J;T++)if((this.occlusion[L][H-1][T]&O)===0)break _;H--}_:while(Q<this.maxTileX){for(let T=$;T<=J;T++)if((this.occlusion[L][Q+1][T]&O)===0)break _;Q++}if((Q+1-H)*(J+1-$)>=4){let T=this.heightmap[L][H][$];V.addOccluder(b,4,H*128,T,$*128,Q*128+128,T,J*128+128);for(let m=H;m<=Q;m++)for(let q=$;q<=J;q++)this.occlusion[L][m][q]&=~O}}}}}}spreadHeight(_,R,E,u){for(let O=_;O<=_+E;O++)for(let b=R;b<=R+u;b++)if(b>=0&&b<this.maxTileX&&O>=0&&O<this.maxTileZ){if(this.shadow[0][b][O]=127,R==b&&b>0)this.heightmap[0][b][O]=this.heightmap[0][b-1][O];if(R+u==b&&b<this.maxTileX-1)this.heightmap[0][b][O]=this.heightmap[0][b+1][O];if(_==O&&O>0)this.heightmap[0][b][O]=this.heightmap[0][b][O-1];if(_+E==O&&O<this.maxTileZ-1)this.heightmap[0][b][O]=this.heightmap[0][b][O+1]}}loadGround(_,R,E,u,O){let b=new P(O);for(let L=0;L<4;L++)for(let N=0;N<64;N++)for(let G=0;G<64;G++){let H=N+E,Q=G+u,$;if(H>=0&&H<104&&Q>=0&&Q<104){this.flags[L][H][Q]=0;while(!0){if($=b.g1(),$===0){if(L===0)this.heightmap[0][H][Q]=-i.perlin(H+_+932731,Q+556238+R)*8;else this.heightmap[L][H][Q]=this.heightmap[L-1][H][Q]-240;break}if($===1){let J=b.g1();if(J===1)J=0;if(L===0)this.heightmap[0][H][Q]=-J*8;else this.heightmap[L][H][Q]=this.heightmap[L-1][H][Q]-J*8;break}if($<=49)this.overlayType[L][H][Q]=b.g1b(),this.overlayShape[L][H][Q]=(($-2)/4|0)<<24>>24,this.overlayAngle[L][H][Q]=($-2&3)<<24>>24;else if($<=81)this.flags[L][H][Q]=$-49<<24>>24;else this.underlayType[L][H][Q]=$-81<<24>>24}}else while(!0){if($=b.g1(),$===0)break;if($===1){b.g1();break}if($<=49)b.g1()}}}static locsAreReady(_,R,E){let u=!0,O=new P(_),b=-1;while(!0){let L=O.gsmarts();if(L==0)break;b+=L;let N=0,G=!1;while(!0)if(G){if(O.gsmarts()==0)break;O.g1()}else{let H=O.gsmarts();if(H==0)break;N+=H-1;let Q=N&63,$=N>>6&63,J=O.g1()>>2,T=R+$,m=E+Q;if(T>0&&m>0&&T<103&&m<103){let q=o.get(b);if(J!=22||!i.lowMemory||q.active||q.forcedecor){if(!q.modelsAreReady())u=!1;G=!0}}}}return u}static prefetchLocs(_,R){let E=-1;while(!0){let u=_.gsmarts();if(u==0)return;E+=u,o.get(E).prefetch(R);while(!0){if(_.gsmarts()==0)break;_.g1()}}}loadLocations(_,R,E,u,O,b){let L=new P(u),N=-1;while(!0){let G=L.gsmarts();if(G===0)return;N+=G;let H=0;while(!0){let Q=L.gsmarts();if(Q===0)break;H+=Q-1;let $=H&63,J=H>>6&63,T=H>>12,m=L.g1(),q=m>>2,K=m&3,F=J+O,w=$+b;if(F>0&&w>0&&F<104-1&&w<104-1){let k=T;if((this.flags[1][F][w]&2)===2)k=T-1;let Y=null;if(k>=0)Y=E[k];this.addLoc(_,T,F,w,R,Y,N,q,K)}}}}addLoc(_,R,E,u,O,b,L,N,G){if(i.lowMemory){if((this.flags[R][E][u]&16)!==0)return;if(this.getDrawLevel(R,E,u)!==i.levelBuilt)return}let H=this.heightmap[R][E][u],Q=this.heightmap[R][E+1][u],$=this.heightmap[R][E+1][u+1],J=this.heightmap[R][E][u+1],T=H+Q+$+J>>2,m=o.get(L),q=E+(u<<7)+(L<<14)+1073741824|0;if(!m.active)q+=-2147483648;q|=0;let K=((G<<6)+N|0)<<24>>24;if(N===n.GROUND_DECOR.id){if(!i.lowMemory||m.active||m.forcedecor){let F;if(m.anim===-1)F=m.getModel(22,G,H,Q,$,J,-1);else F=new R0(_,L,22,N,H,Q,$,J,m.anim,!0);if(O?.addGroundDecoration(F,R,E,u,T,q,K),m.blockwalk&&m.active&&b)b.addFloor(E,u)}}else if(N===n.CENTREPIECE_STRAIGHT.id||N===n.CENTREPIECE_DIAGONAL.id){let F;if(m.anim===-1)F=m.getModel(10,G,H,Q,$,J,-1);else F=new R0(_,L,10,G,H,Q,$,J,m.anim,!0);if(F){let w=0;if(N===n.CENTREPIECE_DIAGONAL.id)w+=256;let k,Y;if(G===1||G===3)k=m.length,Y=m.width;else k=m.width,Y=m.length;if(O?.addLoc(R,E,u,T,F,q,K,k,Y,w)&&m.shadow){let A;if(F instanceof U)A=F;else A=m.getModel(10,G,H,Q,$,J,-1);if(A)for(let h=0;h<=k;h++)for(let Z=0;Z<=Y;Z++){let f=A.radius/4|0;if(f>30)f=30;if(f>this.shadow[R][E+h][u+Z])this.shadow[R][E+h][u+Z]=f<<24>>24}}}if(m.blockwalk&&b)b.addLoc(E,u,m.width,m.length,G,m.blockrange)}else if(N>=n.ROOF_STRAIGHT.id){let F;if(m.anim===-1)F=m.getModel(N,G,H,Q,$,J,-1);else F=new R0(_,L,N,G,H,Q,$,J,m.anim,!0);if(O?.addLoc(R,E,u,T,F,q,K,1,1,0),N>=n.ROOF_STRAIGHT.id&&N<=n.ROOF_FLAT.id&&N!==n.ROOF_DIAGONAL_WITH_ROOFEDGE.id&&R>0)this.occlusion[R][E][u]|=2340;if(m.blockwalk&&b)b.addLoc(E,u,m.width,m.length,G,m.blockrange)}else if(N===n.WALL_STRAIGHT.id){let F;if(m.anim===-1)F=m.getModel(0,G,H,Q,$,J,-1);else F=new R0(_,L,0,G,H,Q,$,J,m.anim,!0);if(O?.addWall(R,E,u,T,i.ROTATION_WALL_TYPE[G],0,F,null,q,K),G===0){if(m.shadow)this.shadow[R][E][u]=50,this.shadow[R][E][u+1]=50;if(m.occlude)this.occlusion[R][E][u]|=585}else if(G===1){if(m.shadow)this.shadow[R][E][u+1]=50,this.shadow[R][E+1][u+1]=50;if(m.occlude)this.occlusion[R][E][u+1]|=1170}else if(G===2){if(m.shadow)this.shadow[R][E+1][u]=50,this.shadow[R][E+1][u+1]=50;if(m.occlude)this.occlusion[R][E+1][u]|=585}else if(G===3){if(m.shadow)this.shadow[R][E][u]=50,this.shadow[R][E+1][u]=50;if(m.occlude)this.occlusion[R][E][u]|=1170}if(m.blockwalk&&b)b.addWall(E,u,N,G,m.blockrange);if(m.wallwidth!==16)O?.setWallDecorationOffset(R,E,u,m.wallwidth)}else if(N===n.WALL_DIAGONAL_CORNER.id){let F;if(m.anim===-1)F=m.getModel(1,G,H,Q,$,J,-1);else F=new R0(_,L,1,G,H,Q,$,J,m.anim,!0);if(O?.addWall(R,E,u,T,i.ROTATION_WALL_CORNER_TYPE[G],0,F,null,q,K),m.shadow){if(G===0)this.shadow[R][E][u+1]=50;else if(G===1)this.shadow[R][E+1][u+1]=50;else if(G===2)this.shadow[R][E+1][u]=50;else if(G===3)this.shadow[R][E][u]=50}if(m.blockwalk&&b)b.addWall(E,u,N,G,m.blockrange)}else if(N===n.WALL_L.id){let F=G+1&3,w,k;if(m.anim===-1)w=m.getModel(2,G+4,H,Q,$,J,-1),k=m.getModel(2,F,H,Q,$,J,-1);else w=new R0(_,L,2,G+4,H,Q,$,J,m.anim,!0),k=new R0(_,L,2,F,H,Q,$,J,m.anim,!0);if(O?.addWall(R,E,u,T,i.ROTATION_WALL_TYPE[G],i.ROTATION_WALL_TYPE[F],w,k,q,K),m.occlude){if(G===0)this.occlusion[R][E][u]|=265,this.occlusion[R][E][u+1]|=1170;else if(G===1)this.occlusion[R][E][u+1]|=1170,this.occlusion[R][E+1][u]|=585;else if(G===2)this.occlusion[R][E+1][u]|=585,this.occlusion[R][E][u]|=1170;else if(G===3)this.occlusion[R][E][u]|=1170,this.occlusion[R][E][u]|=585}if(m.blockwalk&&b)b.addWall(E,u,N,G,m.blockrange);if(m.wallwidth!==16)O?.setWallDecorationOffset(R,E,u,m.wallwidth)}else if(N===n.WALL_SQUARE_CORNER.id){let F;if(m.anim===-1)F=m.getModel(3,G,H,Q,$,J,-1);else F=new R0(_,L,3,G,H,Q,$,J,m.anim,!0);if(O?.addWall(R,E,u,T,i.ROTATION_WALL_CORNER_TYPE[G],0,F,null,q,K),m.shadow){if(G===0)this.shadow[R][E][u+1]=50;else if(G===1)this.shadow[R][E+1][u+1]=50;else if(G===2)this.shadow[R][E+1][u]=50;else if(G===3)this.shadow[R][E][u]=50}if(m.blockwalk&&b)b.addWall(E,u,N,G,m.blockrange)}else if(N===n.WALL_DIAGONAL.id){let F;if(m.anim===-1)F=m.getModel(N,G,H,Q,$,J,-1);else F=new R0(_,L,N,G,H,Q,$,J,m.anim,!0);if(O?.addLoc(R,E,u,T,F,q,K,1,1,0),m.blockwalk&&b)b.addLoc(E,u,m.width,m.length,G,m.blockrange)}else if(N===n.WALLDECOR_STRAIGHT_NOOFFSET.id){let F;if(m.anim===-1)F=m.getModel(4,0,H,Q,$,J,-1);else F=new R0(_,L,4,0,H,Q,$,J,m.anim,!0);O?.setWallDecoration(R,E,u,T,0,0,q,F,K,G*512,i.ROTATION_WALL_TYPE[G])}else if(N===n.WALLDECOR_STRAIGHT_OFFSET.id){let F=16;if(O){let k=O.getWallTypecode(R,E,u);if(k>0)F=o.get(k>>14&32767).wallwidth}let w;if(m.anim===-1)w=m.getModel(4,0,H,Q,$,J,-1);else w=new R0(_,L,4,0,H,Q,$,J,m.anim,!0);O?.setWallDecoration(R,E,u,T,i.WALL_DECORATION_ROTATION_FORWARD_X[G]*F,i.WALL_DECORATION_ROTATION_FORWARD_Z[G]*F,q,w,K,G*512,i.ROTATION_WALL_TYPE[G])}else if(N===n.WALLDECOR_DIAGONAL_OFFSET.id){let F;if(m.anim===-1)F=m.getModel(4,0,H,Q,$,J,-1);else F=new R0(_,L,4,0,H,Q,$,J,m.anim,!0);O?.setWallDecoration(R,E,u,T,0,0,q,F,K,G,256)}else if(N===n.WALLDECOR_DIAGONAL_NOOFFSET.id){let F;if(m.anim===-1)F=m.getModel(4,0,H,Q,$,J,-1);else F=new R0(_,L,4,0,H,Q,$,J,m.anim,!0);O?.setWallDecoration(R,E,u,T,0,0,q,F,K,G,512)}else if(N===n.WALLDECOR_DIAGONAL_BOTH.id){let F;if(m.anim===-1)F=m.getModel(4,0,H,Q,$,J,-1);else F=new R0(_,L,4,0,H,Q,$,J,m.anim,!0);O?.setWallDecoration(R,E,u,T,0,0,q,F,K,G,768)}}getDrawLevel(_,R,E){if((this.flags[_][R][E]&8)===0)return _<=0||(this.flags[1][R][E]&2)===0?_:_-1;return 0}hsl24to16(_,R,E){if(E>179)R=R/2|0;if(E>192)R=R/2|0;if(E>217)R=R/2|0;if(E>243)R=R/2|0;return((_/4|0)<<10)+((R/32|0)<<7)+(E/2|0)}static mulHSL(_,R){if(_===-1)return 12345678;if(R=R*(_&127)/128|0,R<2)R=2;else if(R>126)R=126;return(_&65408)+R}adjustLightness(_,R){if(_===-2)return 12345678;if(_===-1){if(R<0)R=0;else if(R>127)R=127;return 127-R}else{if(R=R*(_&127)/128|0,R<2)R=2;else if(R>126)R=126;return(_&65408)+R}}}class x0 extends w0{x=0;z=0;yaw=0;needsForwardDrawPadding=!1;size=1;readyanim=-1;turnanim=-1;walkanim=-1;walkanim_b=-1;walkanim_l=-1;walkanim_r=-1;runanim=-1;chatMessage=null;chatTimer=100;chatColour=0;chatEffect=0;combatCycle=-1000;damageValues=new Int32Array(4);damageTypes=new Int32Array(4);damageCycles=new Int32Array(4);health=0;totalHealth=0;targetId=-1;targetTileX=0;targetTileZ=0;secondarySeqId=-1;secondarySeqFrame=0;secondarySeqCycle=0;primarySeqId=-1;primarySeqFrame=0;primarySeqCycle=0;primarySeqDelay=0;primarySeqLoop=0;spotanimId=-1;spotanimFrame=0;spotanimCycle=0;spotanimLastCycle=0;spotanimHeight=0;forceMoveStartSceneTileX=0;forceMoveEndSceneTileX=0;forceMoveStartSceneTileZ=0;forceMoveEndSceneTileZ=0;forceMoveEndCycle=0;forceMoveStartCycle=0;forceMoveFaceDirection=0;cycle=0;height=0;dstYaw=0;routeLength=0;routeTileX=new Int32Array(10);routeTileZ=new Int32Array(10);routeRun=new C(10,!1);seqDelayMove=0;preanimRouteLength=0;move(_,R,E){if(this.primarySeqId!==-1&&e.types[this.primarySeqId].postanim_move===1)this.primarySeqId=-1;if(!_){let u=R-this.routeTileX[0],O=E-this.routeTileZ[0];if(u>=-8&&u<=8&&O>=-8&&O<=8){if(this.routeLength<9)this.routeLength++;for(let b=this.routeLength;b>0;b--)this.routeTileX[b]=this.routeTileX[b-1],this.routeTileZ[b]=this.routeTileZ[b-1],this.routeRun[b]=this.routeRun[b-1];this.routeTileX[0]=R,this.routeTileZ[0]=E,this.routeRun[0]=!1;return}}this.routeLength=0,this.preanimRouteLength=0,this.seqDelayMove=0,this.routeTileX[0]=R,this.routeTileZ[0]=E,this.x=this.routeTileX[0]*128+this.size*64,this.z=this.routeTileZ[0]*128+this.size*64}step(_,R){let E=this.routeTileX[0],u=this.routeTileZ[0];if(R===0)E--,u++;else if(R===1)u++;else if(R===2)E++,u++;else if(R===3)E--;else if(R===4)E++;else if(R===5)E--,u--;else if(R===6)u--;else if(R===7)E++,u--;if(this.primarySeqId!==-1&&e.types[this.primarySeqId].postanim_move===1)this.primarySeqId=-1;if(this.routeLength<9)this.routeLength++;for(let O=this.routeLength;O>0;O--)this.routeTileX[O]=this.routeTileX[O-1],this.routeTileZ[O]=this.routeTileZ[O-1],this.routeRun[O]=this.routeRun[O-1];this.routeTileX[0]=E,this.routeTileZ[0]=u,this.routeRun[0]=_}clearRoute(){this.routeLength=0,this.preanimRouteLength=0}hit(_,R,E){for(let u=0;u<4;u++)if(this.damageCycles[u]<=_){this.damageValues[u]=E,this.damageTypes[u]=R,this.damageCycles[u]=_+70;return}}}class T1 extends x0{type=null;getModel(){if(this.type==null)return null;let _=this.getAnimatedModel();if(_==null)return null;if(this.height=_.minY,this.spotanimId!=-1&&this.spotanimFrame!=-1){let R=q0.types[this.spotanimId],E=R.getModel();if(E!=null){let u=U.modelShareColored(E,!0,!R.animHasAlpha,!1);if(u.translate(-this.spotanimHeight,0,0),u.createLabelReferences(),R.seq&&R.seq.frames)u.applyTransform(R.seq.frames[this.spotanimFrame]);if(u.labelFaces=null,u.labelVertices=null,R.resizeh!=128||R.resizev!=128)u.scale(R.resizev,R.resizeh,R.resizeh);u.calculateNormals(R.ambient+64,R.contrast+850,-30,-50,-30,!0);let O=[_,u];_=U.modelFromModelsBounds(O,2)}}if(this.type.size==1)_.picking=!0;return _}getAnimatedModel(){if(!this.type)return null;if(this.primarySeqId<0||this.primarySeqDelay!=0){let _=e.types[this.secondarySeqId],R=-1;if(this.secondarySeqId>=0&&_.frames)R=_.frames[this.secondarySeqFrame];return this.type.getModel(R,-1,null)}else{let _=e.types[this.primarySeqId],R=-1;if(_.frames)R=_.frames[this.primarySeqFrame];let E=e.types[this.secondarySeqId],u=-1;if(this.secondarySeqId>=0&&this.secondarySeqId!=this.readyanim&&E.frames)u=E.frames[this.secondarySeqFrame];return this.type.getModel(R,u,_.walkmerge)}}isVisible(){return this.type!==null}}class J0 extends x0{static TORSO_RECOLORS=[9104,10275,7595,3610,7975,8526,918,38802,24466,10145,58654,5027,1457,16565,34991,25486];static DESIGN_IDK_COLORS=[[6798,107,10283,16,4797,7744,5799,4634,33697,22433,2983,54193],[8741,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003,25239],[25238,8742,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003],[4626,11146,6439,12,4758,10270],[4550,4537,5681,5673,5790,6806,8076,4574]];name=null;visible=!1;gender=0;headicons=0;appearance=new Uint16Array(12);colour=new Uint16Array(5);combatLevel=0;hash=0n;lowMemory=!1;modelCacheKey=-1n;static modelCache=new V0(200);y=0;locStartCycle=0;locStopCycle=0;locOffsetX=0;locOffsetY=0;locOffsetZ=0;locModel=null;minTileX=0;minTileZ=0;maxTileX=0;maxTileZ=0;read(_){_.pos=0,this.gender=_.g1(),this.headicons=_.g1();for(let R=0;R<12;R++){let E=_.g1();if(E===0)this.appearance[R]=0;else this.appearance[R]=(E<<8)+_.g1()}for(let R=0;R<5;R++){let E=_.g1();if(E<0||E>=J0.DESIGN_IDK_COLORS[R].length)E=0;this.colour[R]=E}if(this.readyanim=_.g2(),this.readyanim===65535)this.readyanim=-1;if(this.turnanim=_.g2(),this.turnanim===65535)this.turnanim=-1;if(this.walkanim=_.g2(),this.walkanim===65535)this.walkanim=-1;if(this.walkanim_b=_.g2(),this.walkanim_b===65535)this.walkanim_b=-1;if(this.walkanim_l=_.g2(),this.walkanim_l===65535)this.walkanim_l=-1;if(this.walkanim_r=_.g2(),this.walkanim_r===65535)this.walkanim_r=-1;if(this.runanim=_.g2(),this.runanim===65535)this.runanim=-1;this.name=c.formatName(c.fromBase37(_.g8())),this.combatLevel=_.g1(),this.visible=!0,this.hash=0n;for(let R=0;R<12;R++)if(this.hash<<=0x4n,this.appearance[R]>=256)this.hash+=BigInt(this.appearance[R])-256n;if(this.appearance[0]>=256)this.hash+=BigInt(this.appearance[0])-256n>>4n;if(this.appearance[1]>=256)this.hash+=BigInt(this.appearance[1])-256n>>8n;for(let R=0;R<5;R++)this.hash<<=0x3n,this.hash+=BigInt(this.colour[R]);this.hash<<=0x1n,this.hash+=BigInt(this.gender)}getModel(_){if(!this.visible)return null;let R=this.getAnimatedModel();if(R==null)return null;if(this.height=R.minY,R.picking=!0,this.lowMemory)return R;if(this.spotanimId!=-1&&this.spotanimFrame!=-1){let E=q0.types[this.spotanimId],u=E.getModel();if(u!=null){let O=U.modelShareColored(u,!0,!E.animHasAlpha,!1);if(O.translate(-this.spotanimHeight,0,0),O.createLabelReferences(),E.seq&&E.seq.frames)O.applyTransform(E.seq.frames[this.spotanimFrame]);if(O.labelFaces=null,O.labelVertices=null,E.resizeh!=128||E.resizev!=128)O.scale(E.resizev,E.resizeh,E.resizeh);O.calculateNormals(E.ambient+64,E.contrast+850,-30,-50,-30,!0);let b=[R,O];R=U.modelFromModelsBounds(b,2)}}if(this.locModel!=null){if(_>=this.locStopCycle)this.locModel=null;if(_>=this.locStartCycle&&_<this.locStopCycle){let E=this.locModel;if(E){if(E.translate(this.locOffsetY-this.y,this.locOffsetX-this.x,this.locOffsetZ-this.z),this.dstYaw==512)E.rotateY90(),E.rotateY90(),E.rotateY90();else if(this.dstYaw==1024)E.rotateY90(),E.rotateY90();else if(this.dstYaw==1536)E.rotateY90();let u=[R,E];if(R=U.modelFromModelsBounds(u,2),this.dstYaw==512)E.rotateY90();else if(this.dstYaw==1024)E.rotateY90(),E.rotateY90();else if(this.dstYaw==1536)E.rotateY90(),E.rotateY90(),E.rotateY90();E.translate(this.y-this.locOffsetY,this.x-this.locOffsetX,this.z-this.locOffsetZ)}}}return R.picking=!0,R}getAnimatedModel(){let _=this.hash,R=-1,E=-1,u=-1,O=-1;if(this.primarySeqId>=0&&this.primarySeqDelay===0){let N=e.types[this.primarySeqId];if(N.frames)R=N.frames[this.primarySeqFrame];if(this.secondarySeqId>=0&&this.secondarySeqId!==this.readyanim){let G=e.types[this.secondarySeqId].frames;if(G)E=G[this.secondarySeqFrame]}if(N.replaceheldleft>=0)u=N.replaceheldleft,_+=BigInt(u-this.appearance[5])<<40n;if(N.replaceheldright>=0)O=N.replaceheldright,_+=BigInt(O-this.appearance[3])<<48n}else if(this.secondarySeqId>=0){let N=e.types[this.secondarySeqId].frames;if(N)R=N[this.secondarySeqFrame]}let b=J0.modelCache?.get(_);if(!b){let N=!1;for(let G=0;G<12;G++){let H=this.appearance[G];if(O>=0&&G==3)H=O;if(u>=0&&G==5)H=u;if(H>=256&&H<512&&!U0.types[H-256].modelIsReady())N=!0;if(H>=512&&!x.get(H-512).wornModelIsReady(this.gender))N=!0}if(N){if(this.modelCacheKey!==-1n&&J0.modelCache)b=J0.modelCache.get(this.hash);if(b==null)return null}}if(!b){let N=new C(12,null),G=0;for(let H=0;H<12;H++){let Q=this.appearance[H];if(O>=0&&H===3)Q=O;if(u>=0&&H===5)Q=u;if(Q>=256&&Q<512){let $=U0.types[Q-256].getModel();if($)N[G++]=$}if(Q>=512){let J=x.get(Q-512).getWornModel(this.gender);if(J)N[G++]=J}}b=U.modelFromModels(N,G);for(let H=0;H<5;H++){if(this.colour[H]===0)continue;if(b.recolour(J0.DESIGN_IDK_COLORS[H][0],J0.DESIGN_IDK_COLORS[H][this.colour[H]]),H===1)b.recolour(J0.TORSO_RECOLORS[0],J0.TORSO_RECOLORS[this.colour[H]])}b.createLabelReferences(),b.calculateNormals(64,850,-30,-50,-30,!0),J0.modelCache?.put(_,b),this.modelCacheKey=_}if(this.lowMemory)return b;let L=U.empty;if(L.set(b,!0),R!==-1&&E!==-1)L.applyTransforms(R,E,e.types[this.primarySeqId].walkmerge);else if(R!==-1)L.applyTransform(R);return L.calculateBoundsCylinder(),L.labelFaces=null,L.labelVertices=null,L}getHeadModel(){if(!this.visible)return null;let _=!1;for(let O=0;O<12;O++){let b=this.appearance[O];if(b>=256&&b<512&&!U0.types[b-256].headModelIsReady())_=!0;if(b>=512&&!x.get(b-512).headModelIsReady(this.gender))_=!0}if(_)return null;let R=new C(12,null),E=0;for(let O=0;O<12;O++){let b=this.appearance[O];if(b>=256&&b<512){let L=U0.types[b-256].getHeadModel();if(L)R[E++]=L}if(b>=512){let L=x.get(b-512).getHeadModel(this.gender);if(L)R[E++]=L}}let u=U.modelFromModels(R,E);for(let O=0;O<5;O++){if(this.colour[O]===0)continue;if(u.recolour(J0.DESIGN_IDK_COLORS[O][0],J0.DESIGN_IDK_COLORS[O][this.colour[O]]),O===1)u.recolour(J0.TORSO_RECOLORS[0],J0.TORSO_RECOLORS[this.colour[O]])}return u}isVisible(){return this.visible}}class U1 extends M0{endTime=-1;newType=0;newAngle=0;newShape=0;level=0;layer=0;x=0;z=0;oldType=0;oldAngle=0;oldShape=0;startTime=0}class o0 extends w0{index;count;constructor(_,R){super();this.index=_,this.count=R}getModel(){return x.get(this.index).getModel(this.count)}}class K1 extends w0{spotanim;projLevel;srcX;srcZ;srcY;projOffsetY;startCycle;lastCycle;peakPitch;projArc;projTarget;mobile=!1;x=0;z=0;y=0;projVelocityX=0;projVelocityZ=0;projVelocity=0;projVelocityY=0;accelerationY=0;yaw=0;pitch=0;seqFrame=0;seqCycle=0;constructor(_,R,E,u,O,b,L,N,G,H,Q){super();this.spotanim=q0.types[_],this.projLevel=R,this.srcX=E,this.srcZ=O,this.srcY=u,this.startCycle=b,this.lastCycle=L,this.peakPitch=N,this.projArc=G,this.projTarget=H,this.projOffsetY=Q}updateVelocity(_,R,E,u){if(!this.mobile){let b=_-this.srcX,L=E-this.srcZ,N=Math.sqrt(b*b+L*L);this.x=this.srcX+b*this.projArc/N,this.z=this.srcZ+L*this.projArc/N,this.y=this.srcY}let O=this.lastCycle+1-u;if(this.projVelocityX=(_-this.x)/O,this.projVelocityZ=(E-this.z)/O,this.projVelocity=Math.sqrt(this.projVelocityX*this.projVelocityX+this.projVelocityZ*this.projVelocityZ),!this.mobile)this.projVelocityY=-this.projVelocity*Math.tan(this.peakPitch*0.02454369);this.accelerationY=(R-this.y-this.projVelocityY*O)*2/(O*O)}update(_){if(this.mobile=!0,this.x+=this.projVelocityX*_,this.z+=this.projVelocityZ*_,this.y+=this.projVelocityY*_+this.accelerationY*0.5*_*_,this.projVelocityY+=this.accelerationY*_,this.yaw=(Math.atan2(this.projVelocityX,this.projVelocityZ)*325.949+1024|0)&2047,this.pitch=(Math.atan2(this.projVelocityY,this.projVelocity)*325.949|0)&2047,!this.spotanim.seq)return;this.seqCycle+=_;while(this.seqCycle>this.spotanim.seq.getFrameDuration(this.seqFrame))if(this.seqCycle-=this.spotanim.seq.getFrameDuration(this.seqFrame)+1,this.seqFrame++,this.seqFrame>=this.spotanim.seq.frameCount)this.seqFrame=0}getModel(){let _=this.spotanim.getModel();if(!_)return null;let R=U.modelShareColored(_,!0,!this.spotanim.animHasAlpha,!1);if(this.spotanim.seq&&this.spotanim.seq.frames)R.createLabelReferences(),R.applyTransform(this.spotanim.seq.frames[this.seqFrame]),R.labelFaces=null,R.labelVertices=null;if(this.spotanim.resizeh!==128||this.spotanim.resizev!==128)R.scale(this.spotanim.resizeh,this.spotanim.resizev,this.spotanim.resizeh);return R.rotateX(this.pitch),R.calculateNormals(64+this.spotanim.ambient,850+this.spotanim.contrast,-30,-50,-30,!0),R}}class F1 extends w0{spotType;spotLevel;x;z;y;startCycle;seqComplete=!1;seqFrame=0;seqCycle=0;constructor(_,R,E,u,O,b,L){super();this.spotType=q0.types[_],this.spotLevel=R,this.x=E,this.z=u,this.y=O,this.startCycle=b+L}update(_){if(!this.spotType.seq)return;for(this.seqCycle+=_;this.seqCycle>this.spotType.seq.getFrameDuration(this.seqFrame);)if(this.seqCycle-=this.spotType.seq.getFrameDuration(this.seqFrame)+1,this.seqFrame++,this.seqFrame>=this.spotType.seq.frameCount)this.seqFrame=0,this.seqComplete=!0}getModel(){let _=this.spotType.getModel();if(!_)return null;let R=U.modelShareColored(_,!0,!this.spotType.animHasAlpha,!1);if(!this.seqComplete&&this.spotType.seq&&this.spotType.seq.frames)R.createLabelReferences(),R.applyTransform(this.spotType.seq.frames[this.seqFrame]),R.labelFaces=null,R.labelVertices=null;if(this.spotType.resizeh!==128||this.spotType.resizev!==128)R.scale(this.spotType.resizeh,this.spotType.resizev,this.spotType.resizeh);if(this.spotType.angle!==0){if(this.spotType.angle===90)R.rotateY90();else if(this.spotType.angle===180)R.rotateY90(),R.rotateY90();else if(this.spotType.angle===270)R.rotateY90(),R.rotateY90(),R.rotateY90()}return R.calculateNormals(64+this.spotType.ambient,850+this.spotType.contrast,-30,-50,-30,!0),R}}class q1{seed;constructor(_){this.seed=(_^0x5deece66dn)&(1n<<48n)-1n}setSeed(_){this.seed=(_^0x5deece66dn)&(1n<<48n)-1n}nextInt(){return this.next(32)}next(_){return this.seed=this.seed*0x5deece66dn+0xbn&(1n<<48n)-1n,Number(this.seed)>>>48-_}}class k0 extends Y0{static CHARSET=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!"£$%^&*()-_=+[{]};:'@#~,<.>/?\\| `;static CHARCODESET=[];charMask=[];charMaskWidth=new Int32Array(94);charMaskHeight=new Int32Array(94);charOffsetX=new Int32Array(94);charOffsetY=new Int32Array(94);charAdvance=new Int32Array(95);drawWidth=new Int32Array(256);random=new q1(BigInt(Date.now()));height2d=0;static{let _=navigator.userAgent.includes("Capacitor");for(let R=0;R<256;R++){let E=k0.CHARSET.indexOf(String.fromCharCode(R));if(_){if(E>=63)E--}if(E===-1)E=74;k0.CHARCODESET[R]=E}}static fromArchive(_,R){let E=new P(_.read(R+".dat")),u=new P(_.read("index.dat"));u.pos=E.g2()+4;let O=u.g1();if(O>0)u.pos+=(O-1)*3;let b=new k0;for(let L=0;L<94;L++){b.charOffsetX[L]=u.g1(),b.charOffsetY[L]=u.g1();let N=b.charMaskWidth[L]=u.g2(),G=b.charMaskHeight[L]=u.g2(),H=u.g1(),Q=N*G;if(b.charMask[L]=new Int8Array(Q),H===0)for(let $=0;$<N*G;$++)b.charMask[L][$]=E.g1b();else if(H===1)for(let $=0;$<N;$++)for(let J=0;J<G;J++)b.charMask[L][$+J*N]=E.g1b();if(G>b.height2d)b.height2d=G;b.charOffsetX[L]=1,b.charAdvance[L]=N+2;{let $=0;for(let J=G/7|0;J<G;J++)$+=b.charMask[L][J*N];if($<=(G/7|0))b.charAdvance[L]--,b.charOffsetX[L]=0}{let $=0;for(let J=G/7|0;J<G;J++)$+=b.charMask[L][N+J*N-1];if($<=(G/7|0))b.charAdvance[L]--}}b.charAdvance[94]=b.charAdvance[8];for(let L=0;L<256;L++)b.drawWidth[L]=b.charAdvance[k0.CHARCODESET[L]];return b}drawString(_,R,E,u){if(!E)return;_|=0,R|=0;let O=E.length;R-=this.height2d;for(let b=0;b<O;b++){let L=k0.CHARCODESET[E.charCodeAt(b)];if(L!==94)this.drawChar(this.charMask[L],_+this.charOffsetX[L],R+this.charOffsetY[L],this.charMaskWidth[L],this.charMaskHeight[L],u);_+=this.charAdvance[L]}}drawStringTaggable(_,R,E,u,O){_|=0,R|=0;let b=E.length;R-=this.height2d;for(let L=0;L<b;L++)if(E.charAt(L)==="@"&&L+4<b&&E.charAt(L+4)==="@")u=this.evaluateTag(E.substring(L+1,L+4)),L+=4;else{let N=k0.CHARCODESET[E.charCodeAt(L)];if(N!==94){if(O)this.drawChar(this.charMask[N],_+this.charOffsetX[N]+1,R+this.charOffsetY[N]+1,this.charMaskWidth[N],this.charMaskHeight[N],0);this.drawChar(this.charMask[N],_+this.charOffsetX[N],R+this.charOffsetY[N],this.charMaskWidth[N],this.charMaskHeight[N],u)}_+=this.charAdvance[N]}}stringWidth(_){if(!_)return 0;let R=_.length,E=0;for(let u=0;u<R;u++)if(_.charAt(u)==="@"&&u+4<R&&_.charAt(u+4)==="@")u+=4;else E+=this.drawWidth[_.charCodeAt(u)];return E}drawStringTaggableCenter(_,R,E,u,O){_|=0,R|=0,this.drawStringTaggable(_-(this.stringWidth(E)/2|0),R,E,u,O)}drawStringCenter(_,R,E,u){if(!E)return;_|=0,R|=0,this.drawString(_-(this.stringWidth(E)/2|0),R,E,u)}drawStringTooltip(_,R,E,u,O,b){_|=0,R|=0,this.random.setSeed(BigInt(b));let L=(this.random.nextInt()&31)+192,N=R-this.height2d;for(let G=0;G<E.length;G++)if(E.charAt(G)==="@"&&G+4<E.length&&E.charAt(G+4)==="@")u=this.evaluateTag(E.substring(G+1,G+4)),G+=4;else{let H=k0.CHARCODESET[E.charCodeAt(G)];if(H!==94){if(O)this.drawCharAlpha(_+this.charOffsetX[H]+1,N+this.charOffsetY[H]+1,this.charMaskWidth[H],this.charMaskHeight[H],0,192,this.charMask[H]);this.drawCharAlpha(_+this.charOffsetX[H],N+this.charOffsetY[H],this.charMaskWidth[H],this.charMaskHeight[H],u,L,this.charMask[H])}if(_+=this.charAdvance[H],(this.random.nextInt()&3)===0)_++}}drawStringRight(_,R,E,u,O=!0){if(_|=0,R|=0,O)this.drawString(_-this.stringWidth(E)+1,R+1,E,0);this.drawString(_-this.stringWidth(E),R,E,u)}drawCenteredWave(_,R,E,u,O){if(!E)return;_|=0,R|=0,_-=this.stringWidth(E)/2|0;let b=R-this.height2d;for(let L=0;L<E.length;L++){let N=k0.CHARCODESET[E.charCodeAt(L)];if(N!=94)this.drawChar(this.charMask[N],_+this.charOffsetX[N],b+this.charOffsetY[N]+(Math.sin(L/2+O/5)*5|0),this.charMaskWidth[N],this.charMaskHeight[N],u);_+=this.charAdvance[N]}}drawChar(_,R,E,u,O,b){R|=0,E|=0,u|=0,O|=0;let L=R+E*I.width2d,N=I.width2d-u,G=0,H=0;if(E<I.top){let Q=I.top-E;O-=Q,E=I.top,H+=Q*u,L+=Q*I.width2d}if(E+O>=I.bottom)O-=E+O+1-I.bottom;if(R<I.left){let Q=I.left-R;u-=Q,R=I.left,H+=Q,L+=Q,G+=Q,N+=Q}if(R+u>=I.right){let Q=R+u+1-I.right;u-=Q,G+=Q,N+=Q}if(u>0&&O>0)this.drawMask(u,O,_,H,G,I.pixels,L,N,b)}drawCharAlpha(_,R,E,u,O,b,L){_|=0,R|=0,E|=0,u|=0;let N=_+R*I.width2d,G=I.width2d-E,H=0,Q=0;if(R<I.top){let $=I.top-R;u-=$,R=I.top,Q+=$*E,N+=$*I.width2d}if(R+u>=I.bottom)u-=R+u+1-I.bottom;if(_<I.left){let $=I.left-_;E-=$,_=I.left,Q+=$,N+=$,H+=$,G+=$}if(_+E>=I.right){let $=_+E+1-I.right;E-=$,H+=$,G+=$}if(E>0&&u>0)this.drawMaskAlpha(E,u,I.pixels,N,G,L,Q,H,O,b)}drawMask(_,R,E,u,O,b,L,N,G){_|=0,R|=0;let H=-(_>>2);_=-(_&3);for(let Q=-R;Q<0;Q++){for(let $=H;$<0;$++){if(E[u++]===0)L++;else b[L++]=G;if(E[u++]===0)L++;else b[L++]=G;if(E[u++]===0)L++;else b[L++]=G;if(E[u++]===0)L++;else b[L++]=G}for(let $=_;$<0;$++)if(E[u++]===0)L++;else b[L++]=G;L+=N,u+=O}}drawMaskAlpha(_,R,E,u,O,b,L,N,G,H){_|=0,R|=0;let Q=((G&16711935)*H&4278255360)+((G&65280)*H&16711680)>>8,$=256-H;for(let J=-R;J<0;J++){for(let T=-_;T<0;T++)if(b[L++]===0)u++;else{let m=E[u];E[u++]=(((m&16711935)*$&4278255360)+((m&65280)*$&16711680)>>8)+Q}u+=O,L+=N}}evaluateTag(_){if(_==="red")return 16711680;else if(_==="gre")return 65280;else if(_==="blu")return 255;else if(_==="yel")return 16776960;else if(_==="cya")return 65535;else if(_==="mag")return 16711935;else if(_==="whi")return 16777215;else if(_==="bla")return 0;else if(_==="lre")return 16748608;else if(_==="dre")return 8388608;else if(_==="dbl")return 128;else if(_==="or1")return 16756736;else if(_==="or2")return 16740352;else if(_==="or3")return 16723968;else if(_==="gr1")return 12648192;else if(_==="gr2")return 8453888;else if(_==="gr3")return 4259584;else return 0}split(_,R){if(_.length===0)return[_];let E=[];while(_.length>0){if(this.stringWidth(_)<=R&&_.indexOf("|")===-1){E.push(_);break}let O=_.length;for(let b=0;b<_.length;b++)if(_[b]===" "){if(this.stringWidth(_.substring(0,b))>R)break;O=b}else if(_[b]==="|"){O=b;break}E.push(_.substring(0,O)),_=_.substring(O+1)}return E}}class P0{socket;wsin;wsout;closed=!1;ioerror=!1;static async openSocket(_,R){return await new Promise((E,u)=>{let b=new WebSocket(`${R?"wss":"ws"}://${_}`,"binary");b.addEventListener("open",()=>{E(b)}),b.addEventListener("error",()=>{u(b)})})}constructor(_){_.onclose=this.onclose,_.onerror=this.onerror,this.wsin=new R_(_,5000),this.wsout=new e1(_,5000),this.socket=_}get host(){return this.socket.url.split("/")[2]}get port(){return parseInt(this.socket.url.split(":")[2],10)}get available(){return this.closed?0:this.wsin.available}write(_,R){if(!this.closed)this.wsout.write(_,R)}async read(){return this.closed?0:await this.wsin.read()}async readBytes(_,R,E){if(this.closed)return;await this.wsin.readBytes(_,R,E)}close(){this.closed=!0,this.socket.close(),this.wsin.close(),this.wsout.close()}onclose=(_)=>{if(this.closed)return;this.close()};onerror=(_)=>{if(this.closed)return;this.ioerror=!0,this.close()}}class e1{socket;limit;closed=!1;ioerror=!1;constructor(_,R){this.socket=_,this.limit=R}write(_,R){if(this.closed)return;if(this.ioerror)throw this.ioerror=!1,Error();if(R>this.limit||_.length>this.limit)throw Error();try{this.socket.send(_.slice(0,R))}catch(E){this.ioerror=!0}}close(){this.closed=!0}}class __{bytes;position;constructor(_){this.bytes=_,this.position=0}get available(){return this.bytes.length-this.position}get read(){return this.bytes[this.position++]}get len(){return this.bytes.length}}class R_{limit;queue=[];event=null;callback=null;closed=!1;total=0;constructor(_,R){this.limit=R,_.binaryType="arraybuffer",_.onmessage=this.onmessage}get available(){return this.total}onmessage=(_)=>{if(this.closed)throw Error();let R=new __(new Uint8Array(_.data));if(this.total+=R.available,this.callback){let E=this.callback;this.callback=null,E(R)}else this.queue.push(R)};async read(){if(this.closed)throw Error();return await Promise.race([new Promise((_)=>{if(!this.event||this.event.available===0)this.event=this.queue.shift()??null;if(this.event&&this.event.available>0)_(this.event.read),this.total--;else this.callback=(R)=>{this.event=R,this.total--,_(R.read)}}),new Promise((_,R)=>{setTimeout(()=>{if(this.closed)R(Error());else R(Error())},20000)})])}async readBytes(_,R,E){if(this.closed)throw Error();for(let u=0;u<E;u++)_[R+u]=await this.read();return _}close(){this.closed=!0,this.callback=null,this.event=null,this.queue=[]}}class e0{db;constructor(_){_.onerror=this.onerror,_.onclose=this.onclose,this.db=_}static async openDatabase(){return await new Promise((_,R)=>{let E=indexedDB.open("lostcity",1);E.onsuccess=(u)=>{let O=u.target;_(O.result)},E.onupgradeneeded=(u)=>{u.target.result.createObjectStore("cache")},E.onerror=(u)=>{let O=u.target;R(O.result)}})}async read(_,R){return await new Promise((E)=>{let b=this.db.transaction("cache","readonly").objectStore("cache").get(`${_}.${R}`);b.onsuccess=()=>{if(b.result)E(new Uint8Array(b.result));else E(void 0)},b.onerror=()=>{E(void 0)}})}async cacheload(_){return await new Promise((R)=>{let O=this.db.transaction("cache","readonly").objectStore("cache").get(_);O.onsuccess=()=>{if(O.result)R(new Uint8Array(O.result));else R(void 0)},O.onerror=()=>{R(void 0)}})}async write(_,R,E){if(E===null)return;return await new Promise((u,O)=>{let N=this.db.transaction("cache","readwrite").objectStore("cache").put(E,`${_}.${R}`);N.onsuccess=()=>{u()},N.onerror=()=>{u()}})}async cachesave(_,R){if(R===null)return;return await new Promise((E,u)=>{let L=this.db.transaction("cache","readwrite").objectStore("cache").put(R,_);L.onsuccess=()=>{E()},L.onerror=()=>{E()}})}onclose=(_)=>{};onerror=(_)=>{}}class _1{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(_){for(let R=0;R<_.length;R++)this.rsl[R]=_[R];this.init()}get nextInt(){if(this.count--===0)this.isaac(),this.count=255;return this.rsl[this.count]}init(){let _=2654435769,R=2654435769,E=2654435769,u=2654435769,O=2654435769,b=2654435769,L=2654435769,N=2654435769;for(let G=0;G<4;G++)_^=R<<11,u+=_,R+=E,R^=E>>>2,O+=R,E+=u,E^=u<<8,b+=E,u+=O,u^=O>>>16,L+=u,O+=b,O^=b<<10,N+=O,b+=L,b^=L>>>4,_+=b,L+=N,L^=N<<8,R+=L,N+=_,N^=_>>>9,E+=N,_+=R;for(let G=0;G<256;G+=8)_+=this.rsl[G],R+=this.rsl[G+1],E+=this.rsl[G+2],u+=this.rsl[G+3],O+=this.rsl[G+4],b+=this.rsl[G+5],L+=this.rsl[G+6],N+=this.rsl[G+7],_^=R<<11,u+=_,R+=E,R^=E>>>2,O+=R,E+=u,E^=u<<8,b+=E,u+=O,u^=O>>>16,L+=u,O+=b,O^=b<<10,N+=O,b+=L,b^=L>>>4,_+=b,L+=N,L^=N<<8,R+=L,N+=_,N^=_>>>9,E+=N,_+=R,this.mem[G]=_,this.mem[G+1]=R,this.mem[G+2]=E,this.mem[G+3]=u,this.mem[G+4]=O,this.mem[G+5]=b,this.mem[G+6]=L,this.mem[G+7]=N;for(let G=0;G<256;G+=8)_+=this.mem[G],R+=this.mem[G+1],E+=this.mem[G+2],u+=this.mem[G+3],O+=this.mem[G+4],b+=this.mem[G+5],L+=this.mem[G+6],N+=this.mem[G+7],_^=R<<11,u+=_,R+=E,R^=E>>>2,O+=R,E+=u,E^=u<<8,b+=E,u+=O,u^=O>>>16,L+=u,O+=b,O^=b<<10,N+=O,b+=L,b^=L>>>4,_+=b,L+=N,L^=N<<8,R+=L,N+=_,N^=_>>>9,E+=N,_+=R,this.mem[G]=_,this.mem[G+1]=R,this.mem[G+2]=E,this.mem[G+3]=u,this.mem[G+4]=O,this.mem[G+5]=b,this.mem[G+6]=L,this.mem[G+7]=N;this.isaac(),this.count=256}isaac(){this.c++,this.b+=this.c;for(let _=0;_<256;_++){let R=this.mem[_],E=_&3;if(E===0)this.a^=this.a<<13;else if(E===1)this.a^=this.a>>>6;else if(E===2)this.a^=this.a<<2;else if(E===3)this.a^=this.a>>>16;this.a+=this.mem[_+128&255];let u;this.mem[_]=u=this.mem[R>>>2&255]+this.a+this.b,this.rsl[_]=this.b=this.mem[u>>>8>>>2&255]+R}}}import{BZip2 as u_}from"./deps.js";class a0{static genHash(_){let R=0;_=_.toUpperCase();for(let E=0;E<_.length;E++)R=R*61+_.charCodeAt(E)-32|0;return R}jagSrc;compressedWhole;fileCount;fileHash;fileUnpackedSize;filePackedSize;fileOffset;fileUnpacked=[];constructor(_){let R=new P(new Uint8Array(_)),E=R.g3(),u=R.g3();if(E===u)this.jagSrc=_,this.compressedWhole=!1;else this.jagSrc=u_.decompress(_.subarray(6),E,!0),R=new P(new Uint8Array(this.jagSrc)),this.compressedWhole=!0;this.fileCount=R.g2(),this.fileHash=[],this.fileUnpackedSize=[],this.filePackedSize=[],this.fileOffset=[];let O=R.pos+this.fileCount*10;for(let b=0;b<this.fileCount;b++)this.fileHash.push(R.g4()),this.fileUnpackedSize.push(R.g3()),this.filePackedSize.push(R.g3()),this.fileOffset.push(O),O+=this.filePackedSize[b]}read(_){let R=a0.genHash(_),E=this.fileHash.indexOf(R);if(E===-1)return null;return this.readIndex(E)}readIndex(_){if(_<0||_>=this.fileCount)return null;if(this.fileUnpacked[_])return this.fileUnpacked[_];let R=this.fileOffset[_],E=this.filePackedSize[_],u=new Uint8Array(this.jagSrc.subarray(R,R+E));if(this.compressedWhole)return this.fileUnpacked[_]=u,u;else{let O=u_.decompress(u,this.fileUnpackedSize[_],!0);return this.fileUnpacked[_]=O,O}}}var E_=[0,0,3,0,0,0,0,2,1,0,0,0,0,3,0,-2,0,0,0,0,0,0,0,0,0,0,2,0,0,3,0,0,-2,0,0,1,0,0,0,4,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,4,0,0,4,2,4,0,0,0,6,4,0,0,0,0,0,0,2,0,0,6,0,0,0,0,0,0,0,5,-2,2,0,0,0,0,0,0,4,0,-2,0,0,0,9,6,0,0,0,0,0,0,0,0,4,0,0,0,6,0,0,0,0,0,0,0,0,1,0,0,4,0,0,0,0,2,6,0,2,0,0,0,0,0,0,0,7,2,6,0,0,-2,0,0,0,0,-2,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,2,0,0,0,-2,0,0,0,0,0,15,14,0,7,0,3,0,0,0,0,0,2,0,0,0,0,2,0,0,0,-1,1,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,4,0,0,4,6,0,0,0,0,0,2,0,10,0,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0];class z0{static PERIOD=new Uint16Array(["d","o","t"].join("").split("").map((_)=>_.charCodeAt(0)));static AMPERSAT=new Uint16Array(["(","a",")"].join("").split("").map((_)=>_.charCodeAt(0)));static SLASH=new Uint16Array(["s","l","a","s","h"].join("").split("").map((_)=>_.charCodeAt(0)));static whitelist=["cook","cook's","cooks","seeks","sheet"];static tlds=[];static tldTypes=[];static bads=[];static badCombinations=[];static domains=[];static fragments=[];static unpack(_){let R=new P(_.read("fragmentsenc.txt")),E=new P(_.read("badenc.txt")),u=new P(_.read("domainenc.txt")),O=new P(_.read("tldlist.txt"));this.read(E,u,R,O)}static filter(_){let R=[..._];this.format(R);let E=R.join("").trim(),u=E.toLowerCase(),O=[...u];this.filterTlds(O),this.filterBadWords(O),this.filterDomains(O),this.filterFragments(O);for(let b=0;b<this.whitelist.length;b++){let L=-1;while((L=u.indexOf(this.whitelist[b],L+1))!==-1){let N=[...this.whitelist[b]];for(let G=0;G<N.length;G++)O[G+L]=N[G]}}return this.replaceUppercases(O,[...E]),this.formatUppercases(O),O.join("").trim()}static read(_,R,E,u){this.readBadWords(_),this.readDomains(R),this.readFragments(E),this.readTld(u)}static readTld(_){let R=_.g4();for(let E=0;E<R;E++)this.tldTypes[E]=_.g1(),this.tlds[E]=new Uint16Array(_.g1()).map(()=>_.g1())}static readBadWords(_){let R=_.g4();for(let E=0;E<R;E++){this.bads[E]=new Uint16Array(_.g1()).map(()=>_.g1());let u=Array(_.g1()).fill([]).map(()=>[_.g1b(),_.g1b()]);if(u.length>0)this.badCombinations[E]=u}}static readDomains(_){let R=_.g4();for(let E=0;E<R;E++)this.domains[E]=new Uint16Array(_.g1()).map(()=>_.g1())}static readFragments(_){let R=_.g4();for(let E=0;E<R;E++)this.fragments[E]=_.g2()}static filterTlds(_){let R=[..._],E=[..._];this.filterBadCombinations(null,R,this.PERIOD),this.filterBadCombinations(null,E,this.SLASH);for(let u=0;u<this.tlds.length;u++)this.filterTld(E,this.tldTypes[u],_,this.tlds[u],R)}static filterBadWords(_){for(let R=0;R<2;R++)for(let E=this.bads.length-1;E>=0;E--)this.filterBadCombinations(this.badCombinations[E],_,this.bads[E])}static filterDomains(_){let R=[..._],E=[..._];this.filterBadCombinations(null,R,this.AMPERSAT),this.filterBadCombinations(null,E,this.PERIOD);for(let u=this.domains.length-1;u>=0;u--)this.filterDomain(E,R,this.domains[u],_)}static filterFragments(_){for(let R=0;R<_.length;){let E=this.indexOfNumber(_,R);if(E===-1)return;let u=!1;for(let L=R;L>=0&&L<E&&!u;L++)if(!this.isSymbol(_[L])&&!this.isNotLowercaseAlpha(_[L]))u=!0;let O=0;if(u)O=0;if(O===0)O=1,R=E;let b=0;for(let L=E;L<_.length&&L<R;L++)b=b*10+_[L].charCodeAt(0)-48;if(b<=255&&R-E<=8)O++;else O=0;if(O===4)this.maskChars(E,R,_),O=0;R=this.indexOfNonNumber(R,_)}}static isBadFragment(_){if(this.isNumericalChars(_))return!0;let R=this.getInteger(_),E=this.fragments,u=E.length;if(R===E[0]||R===E[u-1])return!0;let O=0,b=u-1;while(O<=b){let L=(O+b)/2|0;if(R===E[L])return!0;else if(R<E[L])b=L-1;else O=L+1}return!1}static getInteger(_){if(_.length>6)return 0;let R=0;for(let E=0;E<_.length;E++){let u=_[_.length-E-1];if(this.isLowercaseAlpha(u))R=R*38+u.charCodeAt(0)+1-97;else if(u==="'")R=R*38+27;else if(this.isNumerical(u))R=R*38+u.charCodeAt(0)+28-48;else if(u!=="\x00")return 0}return R}static indexOfNumber(_,R){for(let E=R;E<_.length&&E>=0;E++)if(this.isNumerical(_[E]))return E;return-1}static indexOfNonNumber(_,R){for(let E=_;E<R.length&&E>=0;E++)if(!this.isNumerical(R[E]))return E;return R.length}static getEmulatedDomainCharLen(_,R,E){if(R===E)return 1;else if(R==="o"&&E==="0")return 1;else if(R==="o"&&E==="("&&_===")")return 2;else if(R==="c"&&(E==="("||E==="<"||E==="["))return 1;else if(R==="e"&&E==="€")return 1;else if(R==="s"&&E==="$")return 1;else if(R==="l"&&E==="i")return 1;return 0}static filterDomain(_,R,E,u){let O=E.length,b=u.length;for(let L=0;L<=b-O;L++){let{matched:N,currentIndex:G}=this.findMatchingDomain(L,E,u);if(!N)continue;let H=this.prefixSymbolStatus(L,u,3,R,["@"]),Q=this.suffixSymbolStatus(G-1,u,3,_,[".",","]);if(!(H>2||Q>2))continue;this.maskChars(L,G,u)}}static findMatchingDomain(_,R,E){let u=R.length,O=_,b=0;while(O<E.length&&b<u){let L=E[O],N=O+1<E.length?E[O+1]:"\x00",G=this.getEmulatedDomainCharLen(N,String.fromCharCode(R[b]),L);if(G>0)O+=G,b++;else{if(b===0)break;let H=this.getEmulatedDomainCharLen(N,String.fromCharCode(R[b-1]),L);if(H>0){if(O+=H,b===1)_++}else{if(b>=u||!this.isSymbol(L))break;O++}}}return{matched:b>=u,currentIndex:O}}static filterBadCombinations(_,R,E){if(E.length>R.length)return;for(let u=0;u<=R.length-E.length;u++){let O=u,{currentIndex:b,badIndex:L,hasSymbol:N,hasNumber:G,hasDigit:H}=this.processBadCharacters(R,E,O);O=b;let Q=R[O],$=O+1<R.length?R[O+1]:"\x00";if(!(L>=E.length&&(!G||!H)))continue;let J=!0,T;if(N){let K=!1,F=!1;if(u-1<0||this.isSymbol(R[u-1])&&R[u-1]!=="'")K=!0;if(O>=R.length||this.isSymbol(R[O])&&R[O]!=="'")F=!0;if(!K||!F){let w=!1;if(T=u-2,K)T=u;while(!w&&T<O){if(T>=0&&(!this.isSymbol(R[T])||R[T]==="'")){let k=[],Y;for(Y=0;Y<3&&T+Y<R.length&&(!this.isSymbol(R[T+Y])||R[T+Y]==="'");Y++)k[Y]=R[T+Y];let A=!0;if(Y===0)A=!1;if(Y<3&&T-1>=0&&(!this.isSymbol(R[T-1])||R[T-1]==="'"))A=!1;if(A&&!this.isBadFragment(k))w=!0}T++}if(!w)J=!1}}else{if(Q=" ",u-1>=0)Q=R[u-1];if($=" ",O<R.length)$=R[O];let K=this.getIndex(Q),F=this.getIndex($);if(_&&this.comboMatches(K,_,F))J=!1}if(!J)continue;let m=0,q=0;for(let K=u;K<O;K++)if(this.isNumerical(R[K]))m++;else if(this.isAlpha(R[K]))q++;if(m<=q)this.maskChars(u,O,R)}}static processBadCharacters(_,R,E){let u=E,O=0,b=0,L=!1,N=!1,G=!1;for(;u<_.length&&!(N&&G);){if(u>=_.length||N&&G)break;let H=_[u],Q=u+1<_.length?_[u+1]:"\x00",$;if(O<R.length&&($=this.getEmulatedBadCharLen(Q,String.fromCharCode(R[O]),H))>0){if($===1&&this.isNumerical(H))N=!0;if($===2&&(this.isNumerical(H)||this.isNumerical(Q)))N=!0;u+=$,O++}else{if(O===0)break;let J;if((J=this.getEmulatedBadCharLen(Q,String.fromCharCode(R[O-1]),H))>0)u+=J;else{if(O>=R.length||!this.isNotLowercaseAlpha(H))break;if(this.isSymbol(H)&&H!=="'")L=!0;if(this.isNumerical(H))G=!0;if(u++,b++,(b*100/(u-E)|0)>90)break}}}return{currentIndex:u,badIndex:O,hasSymbol:L,hasNumber:N,hasDigit:G}}static getEmulatedBadCharLen(_,R,E){if(R===E)return 1;if(R>="a"&&R<="m"){if(R==="a"){if(E!=="4"&&E!=="@"&&E!=="^"){if(E==="/"&&_==="\\")return 2;return 0}return 1}if(R==="b"){if(E!=="6"&&E!=="8"){if(E==="1"&&_==="3")return 2;return 0}return 1}if(R==="c"){if(E!=="("&&E!=="<"&&E!=="{"&&E!=="[")return 0;return 1}if(R==="d"){if(E==="["&&_===")")return 2;return 0}if(R==="e"){if(E!=="3"&&E!=="€")return 0;return 1}if(R==="f"){if(E==="p"&&_==="h")return 2;if(E==="£")return 1;return 0}if(R==="g"){if(E!=="9"&&E!=="6")return 0;return 1}if(R==="h"){if(E==="#")return 1;return 0}if(R==="i"){if(E!=="y"&&E!=="l"&&E!=="j"&&E!=="1"&&E!=="!"&&E!==":"&&E!==";"&&E!=="|")return 0;return 1}if(R==="j")return 0;if(R==="k")return 0;if(R==="l"){if(E!=="1"&&E!=="|"&&E!=="i")return 0;return 1}if(R==="m")return 0}if(R>="n"&&R<="z"){if(R==="n")return 0;if(R==="o"){if(E!=="0"&&E!=="*"){if((E!=="("||_!==")")&&(E!=="["||_!=="]")&&(E!=="{"||_!=="}")&&(E!=="<"||_!==">"))return 0;return 2}return 1}if(R==="p")return 0;if(R==="q")return 0;if(R==="r")return 0;if(R==="s"){if(E!=="5"&&E!=="z"&&E!=="$"&&E!=="2")return 0;return 1}if(R==="t"){if(E!=="7"&&E!=="+")return 0;return 1}if(R==="u"){if(E==="v")return 1;if((E!=="\\"||_!=="/")&&(E!=="\\"||_!=="|")&&(E!=="|"||_!=="/"))return 0;return 2}if(R==="v"){if((E!=="\\"||_!=="/")&&(E!=="\\"||_!=="|")&&(E!=="|"||_!=="/"))return 0;return 2}if(R==="w"){if(E==="v"&&_==="v")return 2;return 0}if(R==="x"){if((E!==")"||_!=="(")&&(E!=="}"||_!=="{")&&(E!=="]"||_!=="[")&&(E!==">"||_!=="<"))return 0;return 2}if(R==="y")return 0;if(R==="z")return 0}if(R>="0"&&R<="9")if(R==="0")if(E==="o"||E==="O")return 1;else if((E!=="("||_!==")")&&(E!=="{"||_!=="}")&&(E!=="["||_!=="]"))return 0;else return 2;else if(R==="1")return E==="l"?1:0;else return 0;else if(R===",")return E==="."?1:0;else if(R===".")return E===","?1:0;else if(R==="!")return E==="i"?1:0;return 0}static comboMatches(_,R,E){let u=0,O=R.length-1;while(u<=O){let b=(u+O)/2|0;if(R[b][0]===_&&R[b][1]===E)return!0;else if(_<R[b][0]||_===R[b][0]&&E<R[b][1])O=b-1;else u=b+1}return!1}static getIndex(_){if(this.isLowercaseAlpha(_))return _.charCodeAt(0)+1-97;else if(_==="'")return 28;else if(this.isNumerical(_))return _.charCodeAt(0)+29-48;return 27}static filterTld(_,R,E,u,O){if(u.length>E.length)return;for(let b=0;b<=E.length-u.length;b++){let{currentIndex:L,tldIndex:N}=this.processTlds(E,u,b);if(N<u.length)continue;let G=!1,H=this.prefixSymbolStatus(b,E,3,O,[",","."]),Q=this.suffixSymbolStatus(L-1,E,5,_,["\\","/"]);if(R===1&&H>0&&Q>0)G=!0;if(R===2&&(H>2&&Q>0||H>0&&Q>2))G=!0;if(R===3&&H>0&&Q>2)G=!0;if(!G)continue;let $=b,J=L-1,T=!1,m;if(H>2){if(H===4){T=!1;for(m=b-1;m>=0;m--)if(T){if(O[m]!=="*")break;$=m}else if(O[m]==="*")$=m,T=!0}T=!1;for(m=$-1;m>=0;m--)if(T){if(this.isSymbol(E[m]))break;$=m}else if(!this.isSymbol(E[m]))T=!0,$=m}if(Q>2){if(Q===4){T=!1;for(m=J+1;m<E.length;m++)if(T){if(_[m]!=="*")break;J=m}else if(_[m]==="*")J=m,T=!0}T=!1;for(m=J+1;m<E.length;m++)if(T){if(this.isSymbol(E[m]))break;J=m}else if(!this.isSymbol(E[m]))T=!0,J=m}this.maskChars($,J+1,E)}}static processTlds(_,R,E){let u=0;while(E<_.length&&u<R.length){let O=_[E],b=E+1<_.length?_[E+1]:"\x00",L;if((L=this.getEmulatedDomainCharLen(b,String.fromCharCode(R[u]),O))>0)E+=L,u++;else{if(u===0)break;let N;if((N=this.getEmulatedDomainCharLen(b,String.fromCharCode(R[u-1]),O))>0)E+=N;else{if(!this.isSymbol(O))break;E++}}}return{currentIndex:E,tldIndex:u}}static isSymbol(_){return!this.isAlpha(_)&&!this.isNumerical(_)}static isNotLowercaseAlpha(_){return this.isLowercaseAlpha(_)?_==="v"||_==="x"||_==="j"||_==="q"||_==="z":!0}static isAlpha(_){return this.isLowercaseAlpha(_)||this.isUppercaseAlpha(_)}static isNumerical(_){return _>="0"&&_<="9"}static isLowercaseAlpha(_){return _>="a"&&_<="z"}static isUppercaseAlpha(_){return _>="A"&&_<="Z"}static isNumericalChars(_){for(let R=0;R<_.length;R++)if(!this.isNumerical(_[R])&&_[R]!=="\x00")return!1;return!0}static maskChars(_,R,E){for(let u=_;u<R;u++)E[u]="*"}static maskedCountBackwards(_,R){let E=0;for(let u=R-1;u>=0&&this.isSymbol(_[u]);u--)if(_[u]==="*")E++;return E}static maskedCountForwards(_,R){let E=0;for(let u=R+1;u<_.length&&this.isSymbol(_[u]);u++)if(_[u]==="*")E++;return E}static maskedCharsStatus(_,R,E,u,O){if((O?this.maskedCountBackwards(R,E):this.maskedCountForwards(R,E))>=u)return 4;else if(this.isSymbol(O?_[E-1]:_[E+1]))return 1;return 0}static prefixSymbolStatus(_,R,E,u,O){if(_===0)return 2;for(let b=_-1;b>=0&&this.isSymbol(R[b]);b--)if(O.includes(R[b]))return 3;return this.maskedCharsStatus(R,u,_,E,!0)}static suffixSymbolStatus(_,R,E,u,O){if(_+1===R.length)return 2;for(let b=_+1;b<R.length&&this.isSymbol(R[b]);b++)if(O.includes(R[b]))return 3;return this.maskedCharsStatus(R,u,_,E,!1)}static format(_){let R=0;for(let E=0;E<_.length;E++){if(this.isCharacterAllowed(_[E]))_[R]=_[E];else _[R]=" ";if(R===0||_[R]!==" "||_[R-1]!==" ")R++}for(let E=R;E<_.length;E++)_[E]=" "}static isCharacterAllowed(_){return _>=" "&&_<=""||_===" "||_===`
`||_==="\t"||_==="£"||_==="€"}static replaceUppercases(_,R){for(let E=0;E<R.length;E++)if(_[E]!=="*"&&this.isUppercaseAlpha(R[E]))_[E]=R[E]}static formatUppercases(_){let R=!0;for(let E=0;E<_.length;E++){let u=_[E];if(!this.isAlpha(u))R=!0;else if(R){if(this.isLowercaseAlpha(u))R=!1}else if(this.isUppercaseAlpha(u))_[E]=String.fromCharCode(u.charCodeAt(0)+97-65)}}}class g0{static TABLE=[" ","e","t","a","o","i","h","n","s","r","d","l","u","m","w","c","y","f","g","p","b","v","k","x","j","q","z","0","1","2","3","4","5","6","7","8","9"," ","!","?",".",",",":",";","(",")","-","&","*","\\","'","@","#","+","=","£","$","%",'"',"[","]"];static charBuffer=[];static unpack(_,R){let E=0,u=-1,O;for(let L=0;L<R&&E<100;L++){let N=_.g1();if(O=N>>4&15,u!==-1)this.charBuffer[E++]=this.TABLE[(u<<4)+O-195],u=-1;else if(O<13)this.charBuffer[E++]=this.TABLE[O];else u=O;if(O=N&15,u!==-1)this.charBuffer[E++]=this.TABLE[(u<<4)+O-195],u=-1;else if(O<13)this.charBuffer[E++]=this.TABLE[O];else u=O}let b=!0;for(let L=0;L<E;L++){let N=this.charBuffer[L];if(b&&N>="a"&&N<="z")this.charBuffer[L]=N.toUpperCase(),b=!1;if(N==="."||N==="!")b=!0}return this.charBuffer.slice(0,E).join("")}static pack(_,R){if(R.length>80)R=R.substring(0,80);R=R.toLowerCase();let E=-1;for(let u=0;u<R.length;u++){let O=R.charAt(u),b=0;for(let L=0;L<this.TABLE.length;L++)if(O===this.TABLE[L]){b=L;break}if(b>12)b+=195;if(E===-1)if(b<13)E=b;else _.p1(b);else if(b<13)_.p1((E<<4)+b),E=-1;else _.p1((E<<4)+(b>>4)),E=b&15}if(E!==-1)_.p1(E<<4)}}class S0{length=0;shapeDelta=null;shapePeak=null;start=0;end=0;form=0;threshold=0;position=0;delta=0;amplitude=0;ticks=0;unpack(_){this.form=_.g1(),this.start=_.g4(),this.end=_.g4(),this.length=_.g1(),this.shapeDelta=new Int32Array(this.length),this.shapePeak=new Int32Array(this.length);for(let R=0;R<this.length;R++)this.shapeDelta[R]=_.g2(),this.shapePeak[R]=_.g2()}reset(){this.threshold=0,this.position=0,this.delta=0,this.amplitude=0,this.ticks=0}evaluate(_){if(this.ticks>=this.threshold&&this.shapePeak&&this.shapeDelta){if(this.amplitude=this.shapePeak[this.position++]<<15,this.position>=this.length)this.position=this.length-1;if(this.threshold=this.shapeDelta[this.position]/65536*_|0,this.threshold>this.ticks)this.delta=((this.shapePeak[this.position]<<15)-this.amplitude)/(this.threshold-this.ticks)|0}return this.amplitude+=this.delta,this.ticks++,this.amplitude-this.delta>>15}}class L0{frequencyBase=null;amplitudeBase=null;frequencyModRate=null;frequencyModRange=null;amplitudeModRate=null;amplitudeModRange=null;release=null;attack=null;harmonicVolume=new Int32Array(5);harmonicSemitone=new Int32Array(5);harmonicDelay=new Int32Array(5);reverbDelay=0;reverbVolume=100;start=0;length=500;static buffer=null;static noise=null;static sin=null;static tmpPhases=new Int32Array(5);static tmpDelays=new Int32Array(5);static tmpVolumes=new Int32Array(5);static tmpSemitones=new Int32Array(5);static tmpStarts=new Int32Array(5);static init(){this.noise=new Int32Array(32768);for(let _=0;_<32768;_++)if(Math.random()>0.5)this.noise[_]=1;else this.noise[_]=-1;this.sin=new Int32Array(32768);for(let _=0;_<32768;_++)this.sin[_]=Math.sin(_/5215.1903)*16384|0;this.buffer=new Int32Array(220500)}generate(_,R){if(!this.frequencyBase||!this.amplitudeBase)return L0.buffer;for(let H=0;H<_;H++)L0.buffer[H]=0;if(R<10)return L0.buffer;let E=_/R|0;this.frequencyBase.reset(),this.amplitudeBase.reset();let u=0,O=0,b=0;if(this.frequencyModRate&&this.frequencyModRange)this.frequencyModRate.reset(),this.frequencyModRange.reset(),u=(this.frequencyModRate.end-this.frequencyModRate.start)*32.768/E|0,O=this.frequencyModRate.start*32.768/E|0;let L=0,N=0,G=0;if(this.amplitudeModRate&&this.amplitudeModRange)this.amplitudeModRate.reset(),this.amplitudeModRange.reset(),L=(this.amplitudeModRate.end-this.amplitudeModRate.start)*32.768/E|0,N=this.amplitudeModRate.start*32.768/E|0;for(let H=0;H<5;H++)if(this.frequencyBase&&this.harmonicVolume[H]!==0)L0.tmpPhases[H]=0,L0.tmpDelays[H]=this.harmonicDelay[H]*E,L0.tmpVolumes[H]=(this.harmonicVolume[H]<<14)/100|0,L0.tmpSemitones[H]=(this.frequencyBase.end-this.frequencyBase.start)*32.768*Math.pow(1.0057929410678534,this.harmonicSemitone[H])/E|0,L0.tmpStarts[H]=this.frequencyBase.start*32.768/E|0;for(let H=0;H<_;H++){let Q=this.frequencyBase.evaluate(_),$=this.amplitudeBase.evaluate(_);if(this.frequencyModRate&&this.frequencyModRange){let J=this.frequencyModRate.evaluate(_),T=this.frequencyModRange.evaluate(_);Q+=this.generate2(T,b,this.frequencyModRate.form)>>1,b+=(J*u>>16)+O}if(this.amplitudeModRate&&this.amplitudeModRange){let J=this.amplitudeModRate.evaluate(_),T=this.amplitudeModRange.evaluate(_);$=$*((this.generate2(T,G,this.amplitudeModRate.form)>>1)+32768)>>15,G+=(J*L>>16)+N}for(let J=0;J<5;J++)if(this.harmonicVolume[J]!==0){let T=H+L0.tmpDelays[J];if(T<_)L0.buffer[T]+=this.generate2($*L0.tmpVolumes[J]>>15,L0.tmpPhases[J],this.frequencyBase.form),L0.tmpPhases[J]+=(Q*L0.tmpSemitones[J]>>16)+L0.tmpStarts[J]}}if(this.release&&this.attack){this.release.reset(),this.attack.reset();let H=0,Q=!0;for(let $=0;$<_;$++){let J=this.release.evaluate(_),T=this.attack.evaluate(_),m;if(Q)m=this.release.start+((this.release.end-this.release.start)*J>>8);else m=this.release.start+((this.release.end-this.release.start)*T>>8);if(H+=256,H>=m)H=0,Q=!Q;if(Q)L0.buffer[$]=0}}if(this.reverbDelay>0&&this.reverbVolume>0){let H=this.reverbDelay*E;for(let Q=H;Q<_;Q++)L0.buffer[Q]+=L0.buffer[Q-H]*this.reverbVolume/100|0,L0.buffer[Q]|=0}for(let H=0;H<_;H++){if(L0.buffer[H]<-32768)L0.buffer[H]=-32768;if(L0.buffer[H]>32767)L0.buffer[H]=32767}return L0.buffer}generate2(_,R,E){if(E===1)return(R&32767)<16384?_:-_;else if(E===2)return L0.sin[R&32767]*_>>14;else if(E===3)return((R&32767)*_>>14)-_;else if(E===4)return L0.noise[(R/2607|0)&32767]*_;else return 0}unpack(_){if(this.frequencyBase=new S0,this.frequencyBase.unpack(_),this.amplitudeBase=new S0,this.amplitudeBase.unpack(_),_.g1()!==0)_.pos--,this.frequencyModRate=new S0,this.frequencyModRate.unpack(_),this.frequencyModRange=new S0,this.frequencyModRange.unpack(_);if(_.g1()!==0)_.pos--,this.amplitudeModRate=new S0,this.amplitudeModRate.unpack(_),this.amplitudeModRange=new S0,this.amplitudeModRange.unpack(_);if(_.g1()!==0)_.pos--,this.release=new S0,this.release.unpack(_),this.attack=new S0,this.attack.unpack(_);for(let R=0;R<10;R++){let E=_.gsmarts();if(E===0)break;this.harmonicVolume[R]=E,this.harmonicSemitone[R]=_.gsmart(),this.harmonicDelay[R]=_.gsmarts()}this.reverbDelay=_.gsmarts(),this.reverbVolume=_.gsmarts(),this.length=_.g2(),this.start=_.g2()}}class O0{static tracks=new C(1000,null);static delays=new Int32Array(1000);static waveBytes=new Uint8Array(441000);static waveBuffer=null;tones=new C(10,null);loopBegin=0;loopEnd=0;static unpack(_){let R=new P(_.read("sounds.dat"));this.waveBytes=new Uint8Array(441000),this.waveBuffer=new P(this.waveBytes),L0.init();while(!0){let E=R.g2();if(E===65535)break;this.tracks[E]=new O0,this.tracks[E].read(R),this.delays[E]=this.tracks[E].trim()}}static generate(_,R){if(!this.tracks[_])return null;return this.tracks[_]?.getWave(R)??null}read(_){for(let R=0;R<10;R++)if(_.g1()!==0)_.pos--,this.tones[R]=new L0,this.tones[R]?.unpack(_);this.loopBegin=_.g2(),this.loopEnd=_.g2()}trim(){let _=9999999;for(let R=0;R<10;R++)if(this.tones[R]&&(this.tones[R].start/20|0)<_)_=this.tones[R].start/20|0;if(this.loopBegin<this.loopEnd&&(this.loopBegin/20|0)<_)_=this.loopBegin/20|0;if(_===9999999||_===0)return 0;for(let R=0;R<10;R++)if(this.tones[R])this.tones[R].start-=_*20;if(this.loopBegin<this.loopEnd)this.loopBegin-=_*20,this.loopEnd-=_*20;return _}getWave(_){if(!O0.waveBuffer)return null;let R=this.generate(_);return O0.waveBuffer.pos=0,O0.waveBuffer.p4(1380533830),O0.waveBuffer.ip4(R+36),O0.waveBuffer.p4(1463899717),O0.waveBuffer.p4(1718449184),O0.waveBuffer.ip4(16),O0.waveBuffer.ip2(1),O0.waveBuffer.ip2(1),O0.waveBuffer.ip4(22050),O0.waveBuffer.ip4(22050),O0.waveBuffer.ip2(1),O0.waveBuffer.ip2(8),O0.waveBuffer.p4(1684108385),O0.waveBuffer.ip4(R),O0.waveBuffer.pos+=R,O0.waveBuffer}generate(_){let R=0;for(let L=0;L<10;L++)if(this.tones[L]&&this.tones[L].length+this.tones[L].start>R)R=this.tones[L].length+this.tones[L].start;if(R===0)return 0;let E=R*22050/1000|0,u=this.loopBegin*22050/1000|0,O=this.loopEnd*22050/1000|0;if(u<0||O<0||O>E||u>=O)_=0;let b=E+(O-u)*(_-1);for(let L=44;L<b+44;L++)if(O0.waveBytes)O0.waveBytes[L]=-128;for(let L=0;L<10;L++)if(this.tones[L]){let N=this.tones[L].length*22050/1000|0,G=this.tones[L].start*22050/1000|0,H=this.tones[L].generate(N,this.tones[L].length);for(let Q=0;Q<N;Q++)if(O0.waveBytes)O0.waveBytes[Q+G+44]+=H[Q]>>8<<24>>24}if(_>1){u+=44,O+=44,E+=44,b+=44;let L=b-E;for(let N=E-1;N>=O;N--)if(O0.waveBytes)O0.waveBytes[N+L]=O0.waveBytes[N];for(let N=1;N<_;N++){let G=(O-u)*N;for(let H=u;H<O;H++)if(O0.waveBytes)O0.waveBytes[H+G]=O0.waveBytes[H]}b-=44}return b}}class I1{requestModel(_){}}class t0 extends Y0{archive=0;file=0;data=null;cycle=0;urgent=!0}import{gunzipSync as I_,unzipSync as O_}from"./deps.js";class V1 extends I1{modernized=!0;zip=null;versions=[];crcs=[];priorities=[];topPriority=0;models=[];mapIndex=[];mapLand=[];mapLoc=[];mapMembers=[];animIndex=[];midiIndex=[];running=!0;app;active=!1;importantCount=0;requestCount=0;requests=new y0;queue=new K0;missing=new K0;pending=new K0;completed=new K0;prefetches=new K0;message="";buf=new Uint8Array(500);data=new Uint8Array(65000);loadedPrefetchFiles=0;totalPrefetchFiles=0;partOffset=0;partAvailable=0;waitCycles=0;heartbeatCycle=0;cycle=0;socketOpenTime=0;current=null;stream=null;constructor(_,R){super();let E=["model_version","anim_version","midi_version","map_version"];for(let b=0;b<4;b++){let L=_.read(E[b]);if(!L)throw Error();let N=L.length/2,G=new P(L);this.versions[b]=Array(N),this.priorities[b]=Array(N);for(let H=0;H<N;H++)this.versions[b][H]=G.g2()}let u=["model_crc","anim_crc","midi_crc","map_crc"];for(let b=0;b<4;b++){let L=_.read(u[b]);if(!L)throw Error();let N=L.length/4,G=new P(L);this.crcs[b]=Array(N);for(let H=0;H<N;H++)this.crcs[b][H]=G.g4()}let O=_.read("model_index");if(O){let b=this.versions[0].length;this.models=Array(b);for(let L=0;L<b;L++)if(L<O.length)this.models[L]=O[L];else this.models[L]=0}if(O=_.read("map_index"),O){let b=O.length/7,L=new P(O);this.mapIndex=Array(b),this.mapLand=Array(b),this.mapLoc=Array(b),this.mapMembers=Array(b);for(let N=0;N<b;N++)this.mapIndex[N]=L.g2(),this.mapLand[N]=L.g2(),this.mapLoc[N]=L.g2(),this.mapMembers[N]=L.g1()}if(O=_.read("anim_index"),O){let b=O.length/2,L=new P(O);this.animIndex=Array(b);for(let N=0;N<b;N++)this.animIndex[N]=L.g2()}if(O=_.read("midi_index"),O){let b=O.length,L=new P(O);this.midiIndex=Array(b);for(let N=0;N<b;N++)this.midiIndex[N]=L.g1()}this.app=R,this.running=!0}stop(){this.running=!1}getFileCount(_){return this.versions[_].length}getAnimCount(){return this.animIndex.length}getMapFile(_,R,E){let u=(_<<8)+R;for(let O=0;O<this.mapIndex.length;O++)if(this.mapIndex[O]===u)if(E===0)return this.mapLand[O];else return this.mapLoc[O];return-1}async prefetchMaps(_){let R=this.mapIndex.length;for(let E=0;E<R;E++)if(_||this.mapMembers[E]!=0)await this.prefetchPriority(3,this.mapLoc[E],2),await this.prefetchPriority(3,this.mapLand[E],2)}hasMapLocFile(_){for(let R=0;R<this.mapIndex.length;R++)if(this.mapLoc[R]===_)return!0;return!1}getModelFlags(_){return this.models[_]&255}shouldPrefetchMidi(_){return this.midiIndex[_]===1}requestModel(_){this.request(0,_)}request(_,R){if(_<0||_>this.versions.length||R<0||R>this.versions[_].length||this.versions[_][R]==0)return;for(let u=this.requests.head();u!==null;u=this.requests.next())if(u.archive==_&&u.file==R)return;let E=new t0;E.archive=_,E.file=R,E.urgent=!0,this.queue.push(E),this.requests.push(E)}remaining(){return this.requests.size()}loop(){let _=this.completed.pop();if(_===null)return null;if(_.unlink2(),_.data===null)return _;return _.data=I_(_.data.slice(0,_.data.length-2)),_}async prefetchPriority(_,R,E){if(!this.app.db||this.versions[_][R]===0)return;let u=await this.app.db.read(_+1,R);if(this.validate(u,this.crcs[_][R],this.versions[_][R]))return;if(this.priorities[_][R]=E,E>this.topPriority)this.topPriority=E;this.totalPrefetchFiles++}clearPrefetches(){this.prefetches.clear()}prefetch(_,R){if(!this.app.db||this.versions[_][R]===0||this.priorities[_][R]===0||this.topPriority===0)return;let E=new t0;E.archive=_,E.file=R,E.urgent=!1,this.prefetches.push(E)}async run(){if(!this.running)return;this.cycle++,this.active=!0;for(let R=0;R<100&&this.active;R++){if(this.active=!1,await this.handleQueue(),await this.handlePending(),this.importantCount===0&&R>=5)break;await this.handleExtras(),await this.read()}let _=!1;for(let R=this.pending.head();R!==null;R=this.pending.next())if(R.urgent){if(_=!0,R.cycle++,R.cycle>50)R.cycle=0,this.send(R)}if(!_){for(let R=this.pending.head();R!==null;R=this.pending.next())if(_=!0,R.cycle++,R.cycle>50)R.cycle=0,this.send(R)}if(_){if(this.waitCycles++,this.waitCycles>750){if(this.stream)this.stream.close(),this.stream=null;this.partAvailable=0}}else this.waitCycles=0,this.message="";if(this.app.ingame&&this.stream&&(this.topPriority>0||!this.app.db)){if(this.heartbeatCycle++,this.heartbeatCycle>500)this.heartbeatCycle=0,this.buf[0]=0,this.buf[1]=0,this.buf[2]=0,this.buf[3]=10,this.stream.write(this.buf,4)}}async handleQueue(){let _=this.queue.pop();while(_!==null){this.active=!0;let R;if(this.app.db)R=await this.app.db.read(_.archive+1,_.file);if(!this.validate(R,this.crcs[_.archive][_.file],this.versions[_.archive][_.file]))R=void 0;if(!R)this.missing.push(_);else _.data=R,this.completed.push(_);_=this.queue.pop()}}async handlePending(){this.importantCount=0,this.requestCount=0;for(let _=this.pending.head();_!==null;_=this.pending.next())if(_.urgent)this.importantCount++;else this.requestCount++;while(this.importantCount<10){let _=this.missing.pop();if(_===null)break;if(this.priorities[_.archive][_.file]!==0)this.loadedPrefetchFiles++;this.priorities[_.archive][_.file]=0,this.pending.push(_),this.importantCount++,await this.send(_),this.active=!0}}async handleExtras(){while(this.importantCount===0&&this.requestCount<10){if(this.topPriority===0)return;let _=this.prefetches.pop();while(_!==null){if(this.priorities[_.archive][_.file]!=0){if(this.priorities[_.archive][_.file]=0,this.pending.push(_),await this.send(_),this.active=!0,this.loadedPrefetchFiles<this.totalPrefetchFiles)this.loadedPrefetchFiles++;if(this.message="Loading extra files - "+(this.loadedPrefetchFiles*100/this.totalPrefetchFiles|0)+"%",this.requestCount++,this.requestCount==10)return}_=this.prefetches.pop()}for(let R=0;R<4;R++){let E=this.priorities[R],u=E.length;for(let O=0;O<u;O++)if(E[O]==this.topPriority){E[O]=0;let b=new t0;if(b.archive=R,b.file=O,b.urgent=!1,this.pending.push(b),await this.send(b),this.active=!0,this.loadedPrefetchFiles<this.totalPrefetchFiles)this.loadedPrefetchFiles++;if(this.message="Loading extra files - "+(this.loadedPrefetchFiles*100/this.totalPrefetchFiles|0)+"%",this.requestCount++,this.requestCount==10)return}}this.topPriority--}}async read(){if(this.modernized){for(let _=this.pending.head();_!==null;_=this.pending.next()){this.current=_;break}if(this.current){if(await this.downloadZip(),!this.zip)return;if(this.current.data=this.zip[`${this.current.archive+1}.${this.current.file}`],!this.current.data){this.current.unlink(),this.current=null;return}if(this.app.db)await this.app.db.write(this.current.archive+1,this.current.file,this.current.data);if(!this.current.urgent&&this.current.archive===3)this.current.urgent=!0,this.current.archive=93;if(this.current.urgent)this.completed.push(this.current);else this.current.unlink();this.current=null}}else{if(!this.stream)return;try{let _=this.stream.available;if(this.partAvailable===0&&_>=6){this.active=!0,await this.stream.readBytes(this.buf,0,6);let R=this.buf[0]&255,E=((this.buf[1]&255)<<8)+(this.buf[2]&255),u=((this.buf[3]&255)<<8)+(this.buf[4]&255),O=this.buf[5]&255;this.current=null;for(let b=this.pending.head();b!==null;b=this.pending.next()){if(b.archive==R&&b.file==E)this.current=b;if(this.current!=null)b.cycle=0}if(this.current)if(this.waitCycles=0,u===0){if(this.current.data=null,this.current.urgent)this.completed.push(this.current);else this.current.unlink();this.current=null}else{if(this.current.data===null&&O===0)this.current.data=new Uint8Array(u);if(this.current.data===null&&O!=0)throw Error()}if(this.partOffset=O*500,this.partAvailable=500,this.partAvailable>u-O*500)this.partAvailable=u-O*500}if(this.partAvailable>0&&_>=this.partAvailable){this.active=!0;let R=this.buf,E=0;if(this.current&&this.current.data)R=this.current.data,E=this.partOffset;if(await this.stream.readBytes(R,E,this.partAvailable),this.partAvailable+this.partOffset>=R.length&&this.current){if(this.app.db)this.app.db.write(this.current.archive+1,this.current.file,R);if(!this.current.urgent&&this.current.archive===3)this.current.urgent=!0,this.current.archive=93;if(this.current.urgent)this.completed.push(this.current);else this.current.unlink()}this.partAvailable=0}}catch(_){if(this.stream)this.stream.close();this.stream=null,this.partAvailable=0}}}validate(_,R,E){if(typeof _>"u"||_.length<2)return!1;let u=_.length-2,O=((_[u]&255)<<8)+(_[u+1]&255),b=P.getcrc(_,0,_.length-2);return O===E&&b===R}async send(_){if(this.modernized)return;try{if(this.stream===null){let R=performance.now();if(R-this.socketOpenTime<5000)return;this.socketOpenTime=R,this.stream=new P0(await P0.openSocket(window.location.host,window.location.protocol==="https:")),this.buf[0]=15,this.stream.write(this.buf,1);for(let E=0;E<8;E++)await this.stream.read();this.waitCycles=0}if(this.buf[0]=_.archive,this.buf[1]=_.file>>8,this.buf[2]=_.file,_.urgent)this.buf[3]=2;else if(this.app.ingame)this.buf[3]=0;else this.buf[3]=1;this.stream.write(this.buf,4),this.heartbeatCycle=0}catch(R){this.stream=null,this.partAvailable=0}}async downloadZip(){while(!this.zip)try{this.zip=O_(await v0("/ondemand.zip"));break}catch(_){await j0(1000)}}async prefetchAll(){let _=!1;for(let R=0;R<3&&!_;R++){if(!this.app.db)return;let E=await v0("/build"),u=await this.app.db.cacheload("build");if(typeof u<"u"&&u[0]===E[0]&&u[1]===E[1]&&u[2]===E[2]&&u[3]===E[3])break;await this.app.db.cachesave("build",E);try{let O=O_(await v0("/ondemand.zip")),b=performance.now();for(let L=0;L<4;L++){let N=this.versions[L].length;for(let G=0;G<N;G++){let H=O[`${L+1}.${G}`];if(typeof H>"u")continue;let Q=await this.app.db.read(L+1,G);if(!Q||!this.validate(Q,this.crcs[L][G],this.versions[L][G]))await this.app.db.write(L+1,G,H);if(G%100===0&&performance.now()-b>15000){this.app.db=null;return}}}_=!0}catch(O){}}}}var k1=["Attack","Defence","Strength","Hitpoints","Ranged","Prayer","Magic","Cooking","Woodcutting","Fletching","Fishing","Firemaking","Crafting","Smithing","Mining","Herblore","Agility","Thieving","Stat18","Stat19","Runecraft"],D1=3214,Y1=1688;var P1=3823;var g1=3900;class p0{client;combatEvents=[];lastPlayerDamageCycles=new Int32Array(4);lastNpcDamageCycles=new Map;static MAX_EVENTS=50;static EVENT_EXPIRY_TICKS=50;constructor(_){this.client=_}collectState(){let _=this.client,R=_.loopCycle||0;return this.collectCombatEvents(R),{tick:R,player:this.collectPlayerState(),skills:this.collectSkills(),inventory:this.collectInventory(D1),equipment:this.collectInventory(Y1),combatStyle:this.collectCombatStyle(),nearbyNpcs:this.collectNearbyNpcs(),nearbyPlayers:this.collectNearbyPlayers(),nearbyLocs:this.scanNearbyLocs(),groundItems:this.scanGroundItems(),gameMessages:this.collectGameMessages(),recentDialogs:this.collectRecentDialogs(),menuActions:this.collectMenuActions(),shop:this.collectShopState(),bank:this.collectBankState(),inGame:_.ingame||!1,combatEvents:[...this.combatEvents],dialog:this.collectDialogState(),interface:this.collectInterfaceState(),modalOpen:(_.viewportInterfaceId??-1)!==-1,modalInterface:_.viewportInterfaceId??-1}}collectDialogState(){let _=this.client,R=_.chatInterfaceId!==-1,E=_.pressedContinueOption||!1;if(R&&typeof this.client.captureDialogToHistory==="function")this.client.captureDialogToHistory();let u=[];if(R&&typeof this.client.getDialogOptions==="function")u=this.client.getDialogOptions().map((b)=>({index:b.index,text:b.text}));return{isOpen:R,options:u,isWaiting:E}}collectRecentDialogs(){if(typeof this.client.getDialogHistory==="function")return this.client.getDialogHistory();return[]}collectInterfaceState(){let R=this.client.viewportInterfaceId??-1,E=R!==-1,u=[];if(E&&typeof this.client.getInterfaceOptions==="function")u=this.client.getInterfaceOptions().map((b)=>({index:b.index,text:b.text,componentId:b.componentId}));return{isOpen:E,interfaceId:R,options:u}}collectCombatEvents(_){let R=this.client,E=R.localPlayer;if(this.combatEvents=this.combatEvents.filter((N)=>_-N.tick<p0.EVENT_EXPIRY_TICKS),E?.damageCycles&&E?.damageValues)for(let N=0;N<4;N++){let G=E.damageCycles[N]||0,H=this.lastPlayerDamageCycles[N]||0;if(G>H&&G>0){let Q=E.damageValues[N]||0;this.combatEvents.push({tick:_,type:"damage_taken",damage:Q,sourceType:"npc",sourceIndex:E.targetId??-1,targetType:"player",targetIndex:-1})}this.lastPlayerDamageCycles[N]=G}let u=R.npcs||[],O=R.npcIds||[],b=R.npcCount||0;for(let N=0;N<b;N++){let G=O[N],H=u[G];if(!H?.damageCycles||!H?.damageValues)continue;let Q=this.lastNpcDamageCycles.get(G);if(!Q)Q=new Int32Array(4),this.lastNpcDamageCycles.set(G,Q);for(let $=0;$<4;$++){let J=H.damageCycles[$]||0,T=Q[$]||0;if(J>T&&J>0){let m=H.damageValues[$]||0,K=(E?.targetId??-1)===G;this.combatEvents.push({tick:_,type:K?"damage_dealt":"damage_taken",damage:m,sourceType:K?"player":"other_player",sourceIndex:K?-1:-1,targetType:"npc",targetIndex:G})}Q[$]=J}}let L=new Set;for(let N=0;N<b;N++)L.add(O[N]);for(let N of this.lastNpcDamageCycles.keys())if(!L.has(N))this.lastNpcDamageCycles.delete(N);if(this.combatEvents.length>p0.MAX_EVENTS)this.combatEvents=this.combatEvents.slice(-p0.MAX_EVENTS)}collectPlayerState(){let _=this.client,R=_.localPlayer,E=_.loopCycle||0;if(!R)return null;let u=R.targetId??-1,O=R.combatCycle??-1000,b=u!==-1||O>E,L=-1,N=R.damageCycles;if(N){for(let G=0;G<N.length;G++)if(N[G]>L)L=N[G]}return{name:R.name||"Unknown",combatLevel:R.combatLevel||0,x:R.x||0,z:R.z||0,worldX:(_.sceneBaseTileX||0)+((R.x||0)>>7),worldZ:(_.sceneBaseTileZ||0)+((R.z||0)>>7),level:_.currentLevel||0,runEnergy:_.runenergy||0,runWeight:_.runweight||0,animId:R.primarySeqId??-1,spotanimId:R.spotanimId??-1,combat:{inCombat:b,targetIndex:u,lastDamageTick:L}}}collectSkills(){let _=this.client,R=[],E=_.skillLevel||[],u=_.skillBaseLevel||[],O=_.skillExperience||[];for(let b=0;b<k1.length;b++)R.push({name:k1[b],level:E[b]||0,baseLevel:u[b]||0,experience:O[b]||0});return R}static VARP_COM_MODE=43;collectCombatStyle(){let _=this.client,R={currentStyle:0,weaponName:"Unarmed",styles:[]};try{let E=0,u=_.varps||[];for(let G of[43,11,12,13,42,44]){let H=u[G];if(H!==void 0&&H>=0&&H<=3){E=H;break}}let b=this.collectInventory(Y1).find((G)=>G.slot===3),L=b?.name||"Unarmed",N=[];if(!b||L==="Unarmed")N=[{index:0,name:"Punch",type:"Accurate",trainedSkill:"Attack"},{index:1,name:"Kick",type:"Aggressive",trainedSkill:"Strength"},{index:2,name:"Block",type:"Defensive",trainedSkill:"Defence"}];else{let G=L.toLowerCase();if(G.includes("bow")||G.includes("crossbow"))N=[{index:0,name:"Accurate",type:"Accurate",trainedSkill:"Ranged"},{index:1,name:"Rapid",type:"Rapid",trainedSkill:"Ranged"},{index:2,name:"Longrange",type:"Longrange",trainedSkill:"Defence"}];else if(G.includes("staff")||G.includes("wand"))N=[{index:0,name:"Bash",type:"Accurate",trainedSkill:"Attack"},{index:1,name:"Pound",type:"Aggressive",trainedSkill:"Strength"},{index:2,name:"Focus",type:"Defensive",trainedSkill:"Defence"}];else if(G.includes("scimitar")||G.includes("sword")||G.includes("dagger")||G.includes("longsword"))N=[{index:0,name:"Chop",type:"Accurate",trainedSkill:"Attack"},{index:1,name:"Slash",type:"Aggressive",trainedSkill:"Strength"},{index:2,name:"Lunge",type:"Controlled",trainedSkill:"Shared"},{index:3,name:"Block",type:"Defensive",trainedSkill:"Defence"}];else if(G.includes("mace")||G.includes("hammer")||G.includes("maul"))N=[{index:0,name:"Pound",type:"Accurate",trainedSkill:"Attack"},{index:1,name:"Pummel",type:"Aggressive",trainedSkill:"Strength"},{index:2,name:"Block",type:"Defensive",trainedSkill:"Defence"}];else if(G.includes("2h")||G.includes("godsword")||G.includes("battleaxe"))N=[{index:0,name:"Chop",type:"Accurate",trainedSkill:"Attack"},{index:1,name:"Slash",type:"Aggressive",trainedSkill:"Strength"},{index:2,name:"Smash",type:"Aggressive",trainedSkill:"Strength"},{index:3,name:"Block",type:"Defensive",trainedSkill:"Defence"}];else N=[{index:0,name:"Stab",type:"Accurate",trainedSkill:"Attack"},{index:1,name:"Lunge",type:"Aggressive",trainedSkill:"Strength"},{index:2,name:"Slash",type:"Controlled",trainedSkill:"Shared"},{index:3,name:"Block",type:"Defensive",trainedSkill:"Defence"}]}if(E>=N.length)E=0;return{currentStyle:E,weaponName:L,styles:N}}catch{return R}}collectInventory(_){let R=[];try{let E=g.types[_];if(!E||!E.invSlotObjId||!E.invSlotObjCount)return R;for(let u=0;u<E.invSlotObjId.length;u++){let O=E.invSlotObjId[u],b=E.invSlotObjCount[u];if(O>0){let L="Unknown",N=[];try{let G=x.get(O-1);if(L=G.name||"Unknown",G.iop)for(let H=0;H<G.iop.length;H++){let Q=G.iop[H];if(Q)N.push({text:Q,opIndex:H+1})}}catch{}R.push({slot:u,id:O-1,name:L,count:b,optionsWithIndex:N})}}}catch{}return R}collectNearbyNpcs(){let _=this.client,R=[],E=_.localPlayer;if(!E)return R;let u=_.npcs||[],O=_.npcIds||[],b=_.npcCount||0,L=_.sceneBaseTileX||0,N=_.sceneBaseTileZ||0;for(let G=0;G<b;G++){let H=O[G],Q=u[H];if(!Q||!Q.type)continue;let $=13312,J=Q.x||0,T=Q.z||0;if(J<0||J>$||T<0||T>$)continue;let m=Q.type,q=J-(E.x||0),K=T-(E.z||0),F=Math.max(Math.abs(q),Math.abs(K))>>7,w=[];if(m.op)for(let B=0;B<m.op.length;B++){let M=m.op[B];if(M)w.push({text:M,opIndex:B+1})}let k=Q.health||0,Y=Q.totalHealth||0,A=Y>0?Math.round(k/Y*100):null,h=Q.targetId??-1,Z=Q.combatCycle??-1000,f=_.loopCycle||0,S=h!==-1||Z>f,j=L+(J>>7),W=N+(T>>7);R.push({index:H,name:m.name||"Unknown",combatLevel:m.vislevel||0,x:j,z:W,distance:F,hp:k,maxHp:Y,healthPercent:A,targetIndex:h,inCombat:S,combatCycle:Z,animId:Q.primarySeqId??-1,spotanimId:Q.spotanimId??-1,optionsWithIndex:w,options:w.map((B)=>B.text)})}return R.sort((G,H)=>G.distance-H.distance),R}collectNearbyPlayers(){let _=this.client,R=[],E=_.localPlayer;if(!E)return R;let u=_.players||[],O=_.playerIds||[],b=_.playerCount||0,L=_.sceneBaseTileX||0,N=_.sceneBaseTileZ||0;for(let G=0;G<b;G++){let H=O[G],Q=u[H];if(!Q||Q===E||!Q.name)continue;let $=(Q.x||0)-(E.x||0),J=(Q.z||0)-(E.z||0),T=Math.max(Math.abs($),Math.abs(J))>>7,m=L+((Q.x||0)>>7),q=N+((Q.z||0)>>7);R.push({index:H,name:Q.name,combatLevel:Q.combatLevel||0,x:m,z:q,distance:T})}return R.sort((G,H)=>G.distance-H.distance),R}scanNearbyLocs(_){let R=this.client,E=[],u=R.localPlayer,O=R.scene;if(!u||!O)return E;let b=R.currentLevel||0,L=(u.x||0)>>7,N=(u.z||0)>>7,G=R.sceneBaseTileX||0,H=R.sceneBaseTileZ||0,Q=new Set,$=_??15;for(let J=-$;J<=$;J++)for(let T=-$;T<=$;T++){let m=L+J,q=N+T;if(m<0||m>=104||q<0||q>=104)continue;let K=Math.max(Math.abs(J),Math.abs(T)),F=O.getLocTypecode(b,m,q);if(F!==0){let A=F>>14&32767,h=`${A}_${m}_${q}`;if(!Q.has(h)){Q.add(h);try{let Z=o.get(A);if(Z.name){let f=[];if(Z.op)for(let S=0;S<Z.op.length;S++){let j=Z.op[S];if(j)f.push({text:j,opIndex:S+1})}E.push({id:A,name:Z.name,x:G+m,z:H+q,distance:K,optionsWithIndex:f,options:f.map((S)=>S.text)})}}catch{}}}let w=O.getWallTypecode(b,m,q);if(w!==0){let A=w>>14&32767,h=`wall_${A}_${m}_${q}`;if(!Q.has(h)){Q.add(h);try{let Z=o.get(A);if(Z.name){let f=[];if(Z.op)for(let S=0;S<Z.op.length;S++){let j=Z.op[S];if(j)f.push({text:j,opIndex:S+1})}E.push({id:A,name:Z.name,x:G+m,z:H+q,distance:K,optionsWithIndex:f,options:f.map((S)=>S.text)})}}catch{}}}let k=O.getDecorTypecode(b,q,m);if(k!==0){let A=k>>14&32767,h=`decor_${A}_${m}_${q}`;if(!Q.has(h)){Q.add(h);try{let Z=o.get(A);if(Z.name){let f=[];if(Z.op)for(let S=0;S<Z.op.length;S++){let j=Z.op[S];if(j)f.push({text:j,opIndex:S+1})}E.push({id:A,name:Z.name,x:G+m,z:H+q,distance:K,optionsWithIndex:f,options:f.map((S)=>S.text)})}}catch{}}}let Y=O.getGroundDecorTypecode(b,m,q);if(Y!==0){let A=Y>>14&32767,h=`gdecor_${A}_${m}_${q}`;if(!Q.has(h)){Q.add(h);try{let Z=o.get(A);if(Z.name){let f=[];if(Z.op)for(let S=0;S<Z.op.length;S++){let j=Z.op[S];if(j)f.push({text:j,opIndex:S+1})}E.push({id:A,name:Z.name,x:G+m,z:H+q,distance:K,optionsWithIndex:f,options:f.map((S)=>S.text)})}}catch{}}}}return E.sort((J,T)=>J.distance-T.distance),E}scanGroundItems(_){let R=this.client,E=[],u=R.localPlayer;if(!u)return E;let O=R.objStacks;if(!O)return E;let b=R.currentLevel||0,L=(u.x||0)>>7,N=(u.z||0)>>7,G=R.sceneBaseTileX||0,H=R.sceneBaseTileZ||0,Q=_??15;for(let $=-Q;$<=Q;$++)for(let J=-Q;J<=Q;J++){let T=L+$,m=N+J;if(T<0||T>=104||m<0||m>=104)continue;let q=O[b]?.[T]?.[m];if(!q)continue;let K=q.head();while(K){let F=K;if(F.index!==void 0){let w="Unknown";try{w=x.get(F.index).name||"Unknown"}catch{}let k=Math.max(Math.abs($),Math.abs(J));E.push({id:F.index,name:w,count:F.count||1,x:G+T,z:H+m,distance:k})}K=q.next()}}return E.sort(($,J)=>$.distance-J.distance),E}collectGameMessages(){let _=this.client,R=[],E=_.messageText||[],u=_.messageSender||[],O=_.messageType||[],b=_.messageTick||[];for(let L=0;L<10;L++){let N=E[L],G=O[L]||0;if(N)R.push({type:G,text:N,sender:u[L]||"",tick:b[L]||0});if(R.length>=5)break}return R}collectMenuActions(){let _=this.client,R=[],E=_.menuOption||[],u=_.menuAction||[],O=_.menuParamA||[],b=_.menuParamB||[],L=_.menuParamC||[],N=_.menuSize||0;for(let G=0;G<N;G++)R.push({option:E[G]||"",actionCode:u[G]||0,paramA:O[G]||0,paramB:b[G]||0,paramC:L[G]||0});return R}collectShopState(){let _=this.client,R={isOpen:!1,title:"",shopItems:[],playerItems:[]};if(typeof _.isShopOpen==="function"?_.isShopOpen():!1){R.isOpen=!0;try{let b=g.types[3901];if(b&&b.text)R.title=b.text}catch{}let u=_.varps||[],O={buyMultiplier:u[127]||60,sellMultiplier:u[128]||100,haggle:u[129]||10};R.shopConfig=O,R.shopItems=this.collectInventoryItems(g1,O),R.playerItems=this.collectInventoryItems(P1,O)}return R}collectBankState(){let _=this.client,R={isOpen:!1,items:[]};if(typeof _.isBankOpen==="function"?_.isBankOpen():!1){if(R.isOpen=!0,typeof _.getBankItems==="function"){let u=_.getBankItems();R.items=u.map((O)=>({slot:O.slot,id:O.id,name:O.name,count:O.count}))}}return R}calcShopValue(_,R,E,u){let O=Math.min(1000,Math.max(-5000,u*R)),b=Math.max(100,E-O);return Math.floor(_*b/1000)}collectInventoryItems(_,R){let E=[];try{let u=g.types[_];if(!u||!u.invSlotObjId||!u.invSlotObjCount)return E;for(let O=0;O<u.invSlotObjId.length;O++){let b=u.invSlotObjId[O],L=u.invSlotObjCount[O];if(b>0){let N="Unknown",G=1;try{let $=x.get(b-1);N=$.name||"Unknown",G=$.cost||1}catch{}let H=G,Q=G;if(R){if(H=this.calcShopValue(G,R.haggle,R.sellMultiplier,0),Q=this.calcShopValue(G,R.haggle,R.buyMultiplier,0),H<1)H=1}E.push({slot:O,id:b-1,name:N,count:L,baseCost:G,buyPrice:H,sellPrice:Q})}}}catch{}return E}}function v1(_){let R=[];if(R.push("=== BOT SDK STATE ==="),R.push(`Tick: ${_.tick}  In Game: ${_.inGame}`),R.push(""),_.player){let u=_.player;R.push("--- PLAYER ---"),R.push(`${u.name} (Combat ${u.combatLevel})`),R.push(`Pos: (${u.worldX}, ${u.worldZ})  Level: ${u.level}`),R.push(`Run: ${u.runEnergy}%  Weight: ${u.runWeight}kg`),R.push("")}R.push("--- KEY STATS ---");let E=["Hitpoints","Attack","Strength","Defence","Magic","Ranged","Prayer"];for(let u of E){let O=_.skills.find((b)=>b.name===u);if(O){let b=O.experience.toLocaleString().padStart(10);R.push(`${u.padEnd(10)} ${String(O.level).padStart(2)}/${String(O.baseLevel).padEnd(2)} ${b} xp`)}}if(R.push(""),R.push("--- INVENTORY ---"),_.inventory.length===0)R.push("Empty");else{let u=new Map;for(let O of _.inventory){let b=O.name;u.set(b,(u.get(b)||0)+O.count)}for(let[O,b]of u)R.push(`${O.padEnd(20)} x${b}`)}if(R.push(""),R.push("--- NEARBY NPCS ---"),_.nearbyNpcs.length===0)R.push("None");else{for(let u=0;u<Math.min(5,_.nearbyNpcs.length);u++){let O=_.nearbyNpcs[u],b=O.name.padEnd(16),L=O.combatLevel>0?`Lv${String(O.combatLevel).padStart(2)}`:"    ",N=O.maxHp>0?`${String(O.hp).padStart(2)}/${String(O.maxHp).padEnd(2)}`:"     ",G=`${O.distance}t`.padStart(3),H=O.optionsWithIndex.map(($)=>$.text),Q=H.length>0?`[${H.join(",")}]`:"";R.push(`${b} ${L} ${N} ${G} ${Q}`)}if(_.nearbyNpcs.length>5)R.push(`... +${_.nearbyNpcs.length-5} more`)}if(R.push(""),R.push("--- NEARBY PLAYERS ---"),_.nearbyPlayers.length===0)R.push("None");else{for(let u=0;u<Math.min(5,_.nearbyPlayers.length);u++){let O=_.nearbyPlayers[u];R.push(`${O.name.padEnd(12)} Cb${String(O.combatLevel).padStart(3)} ${O.distance}t`)}if(_.nearbyPlayers.length>5)R.push(`... +${_.nearbyPlayers.length-5} more`)}if(R.push(""),R.push("--- NEARBY OBJECTS ---"),_.nearbyLocs.length===0)R.push("None");else{for(let u=0;u<Math.min(8,_.nearbyLocs.length);u++){let O=_.nearbyLocs[u],b=O.name.padEnd(16),L=`(${O.x},${O.z})`.padEnd(12),N=`${O.distance}t`.padStart(3),G=O.options.length>0?`[${O.options.join(",")}]`:"";R.push(`${b} ${L} ${N} ${G}`)}if(_.nearbyLocs.length>8)R.push(`... +${_.nearbyLocs.length-8} more`)}if(R.push(""),R.push("--- GROUND ITEMS ---"),_.groundItems.length===0)R.push("None");else{for(let u=0;u<Math.min(5,_.groundItems.length);u++){let O=_.groundItems[u];R.push(`${O.name.padEnd(20)} x${String(O.count).padEnd(4)} ${O.distance}t`)}if(_.groundItems.length>5)R.push(`... +${_.groundItems.length-5} more`)}if(R.push(""),R.push("--- RECENT MESSAGES ---"),_.gameMessages.length===0)R.push("None");else for(let u of _.gameMessages){let O=u.text.replace(/@\w+@/g,"");if(u.sender)R.push(`${u.sender}: ${O}`);else R.push(O)}if(R.push(""),R.push("--- RECENT DIALOGS ---"),!_.recentDialogs||_.recentDialogs.length===0)R.push("None");else for(let u of _.recentDialogs.slice(0,5)){let O=u.text.join(" | ").substring(0,80);R.push(`[tick ${u.tick}] ${O}${u.text.join(" | ").length>80?"...":""}`)}if(R.push(""),_.menuActions.length>1){R.push("--- AVAILABLE ACTIONS ---");for(let u=0;u<Math.min(8,_.menuActions.length);u++){let b=_.menuActions[u].option.replace(/@\w+@/g,"");R.push(`${u+1}. ${b}`)}if(_.menuActions.length>8)R.push(`... and ${_.menuActions.length-8} more`)}if(_.shop&&_.shop.isOpen){if(R.push(""),R.push("--- SHOP OPEN ---"),R.push(`Title: ${_.shop.title}`),R.push(""),R.push("Shop Items (Buy):"),_.shop.shopItems.length===0)R.push("  None");else{for(let u of _.shop.shopItems.slice(0,10)){let O=`[${u.slot}]`.padEnd(4);R.push(`  ${O} ${u.name.padEnd(18)} x${u.count}`)}if(_.shop.shopItems.length>10)R.push(`  ... +${_.shop.shopItems.length-10} more`)}if(R.push(""),R.push("Your Items (Sell):"),_.shop.playerItems.length===0)R.push("  None");else{for(let u of _.shop.playerItems.slice(0,10)){let O=`[${u.slot}]`.padEnd(4);R.push(`  ${O} ${u.name.padEnd(18)} x${u.count}`)}if(_.shop.playerItems.length>10)R.push(`  ... +${_.shop.playerItems.length-10} more`)}}return R.join(`
`)}function n1(_,R){let E=[];if(E.push(`## Current Goal: ${R}`),E.push(`Tick: ${_.tick}`),_.player)E.push(""),E.push("### Player"),E.push(`Name: ${_.player.name}, Combat Level: ${_.player.combatLevel}`),E.push(`Position: (${_.player.worldX}, ${_.player.worldZ}), Level: ${_.player.level}`),E.push(`Run Energy: ${_.player.runEnergy}%`);if(_.modalOpen){if(E.push(""),E.push(`### Modal Interface Open: ${_.modalInterface}`),_.modalInterface===269)E.push("(This is the character design screen - use acceptCharacterDesign to continue)")}if(_.dialog.isOpen)if(E.push(""),E.push("### Dialog Open"),_.dialog.isWaiting)E.push("(Waiting for server response...)");else if(_.dialog.options.length>0){E.push("Options:");for(let u of _.dialog.options)E.push(`  ${u.index}. ${u.text}`)}else E.push("(Click to continue available - use optionIndex: 0)");if(_.interface&&_.interface.isOpen)if(E.push(""),E.push(`### Interface Open (id: ${_.interface.interfaceId})`),_.interface.options.length>0){E.push('Options (use "rsbot action interface <N>" to select):');for(let u of _.interface.options)E.push(`  ${u.index}. ${u.text}`)}else E.push("(No selectable options detected)");if(_.shop&&_.shop.isOpen){if(E.push(""),E.push("### Shop Open"),E.push(`Title: ${_.shop.title}`),E.push(""),E.push("**Shop Items (to buy):**"),_.shop.shopItems.length===0)E.push("  (Empty)");else for(let u of _.shop.shopItems)E.push(`  - [slot ${u.slot}] ${u.name} x${u.count} (id: ${u.id})`);if(E.push(""),E.push("**Your Items (to sell):**"),_.shop.playerItems.length===0)E.push("  (Empty)");else for(let u of _.shop.playerItems)E.push(`  - [slot ${u.slot}] ${u.name} x${u.count} (id: ${u.id})`);E.push(""),E.push("Actions: Use shopBuy(slot, amount) or shopSell(slot, amount)")}if(_.nearbyNpcs.length>0){E.push(""),E.push("### Nearby NPCs");for(let u of _.nearbyNpcs.slice(0,8)){let O=u.combatLevel>0?` (Lvl ${u.combatLevel})`:"",b=u.maxHp>0?` HP: ${u.hp}/${u.maxHp}`:"",L=u.options.length>0?` [${u.options.join(", ")}]`:"";E.push(`- ${u.name}${O}${b} - ${u.distance} tiles away, index: ${u.index}${L}`)}}if(_.nearbyLocs&&_.nearbyLocs.length>0){E.push(""),E.push("### Nearby Objects");for(let u of _.nearbyLocs.slice(0,10)){let O=u.options.length>0?` [${u.options.join(", ")}]`:"";E.push(`- ${u.name} at (${u.x}, ${u.z}) - ${u.distance} tiles, id: ${u.id}${O}`)}}if(_.inventory.length>0){E.push(""),E.push("### Inventory");let u=new Map;for(let O of _.inventory)u.set(O.name,(u.get(O.name)||0)+O.count);for(let[O,b]of u)E.push(`  ${O} x${b}`)}if(_.groundItems.length>0){E.push(""),E.push("### Ground Items Nearby");for(let u of _.groundItems.slice(0,5))E.push(`- ${u.name} x${u.count} at (${u.x}, ${u.z}), ${u.distance} tiles`)}if(_.gameMessages&&_.gameMessages.length>0){E.push(""),E.push("### Recent Messages");for(let u of _.gameMessages){let O=u.text.replace(/@\w+@/g,"");if(u.sender)E.push(`- ${u.sender}: ${O}`);else E.push(`- ${O}`)}}if(_.recentDialogs&&_.recentDialogs.length>0){E.push(""),E.push("### Recent Dialogs");for(let u of _.recentDialogs.slice(0,5))E.push(`- [tick ${u.tick}] ${u.text.join(" | ")}`)}return E.join(`
`)}class j1{client;scanProvider=null;constructor(_){this.client=_}setScanProvider(_){this.scanProvider=_}execute(_){try{switch(_.type){case"none":return{success:!0,message:"No action"};case"wait":return{success:!0,message:`Waiting ${_.ticks||1} ticks`};case"walkTo":return this.wrapBool(this.client.walkTo(_.x,_.z,_.running??!0),`Walking to (${_.x}, ${_.z})`,"Failed to walk");case"talkToNpc":return this.wrapBool(this.client.talkToNpc(_.npcIndex),`Talking to NPC #${_.npcIndex}`,"Failed to talk to NPC");case"interactNpc":return this.wrapBool(this.client.interactNpc(_.npcIndex,_.optionIndex),`Interacting with NPC #${_.npcIndex}`,"Failed to interact with NPC");case"interactLoc":return this.wrapBool(this.client.interactLoc(_.x,_.z,_.locId,_.optionIndex),`Interacting with loc ${_.locId}`,"Failed to interact with location");case"useInventoryItem":return this.wrapBool(this.client.useInventoryItem(_.slot,_.optionIndex),`Using inventory slot ${_.slot}`,"Failed to use inventory item");case"dropItem":return this.wrapBool(this.client.dropInventoryItem(_.slot),`Dropping item at slot ${_.slot}`,"Failed to drop item");case"pickupItem":return this.wrapBool(this.client.pickupGroundItem(_.x,_.z,_.itemId),`Picking up item ${_.itemId}`,"Failed to pickup item");case"clickDialogOption":return this.wrapBool(this.client.clickDialogOption(_.optionIndex),`Clicked dialog option ${_.optionIndex}`,"Failed to click dialog option");case"clickComponent":return this.wrapBool(this.client.clickComponent(_.componentId),`Clicked component ${_.componentId}`,"Failed to click component");case"clickComponentWithOption":return this.wrapBool(this.client.clickInterfaceIop(_.componentId,_.optionIndex,_.slot??0),`Clicked component ${_.componentId} option ${_.optionIndex} slot ${_.slot??0}`,"Failed to click component with option");case"useItemOnItem":return this.wrapBool(this.client.useItemOnItem(_.sourceSlot,_.targetSlot),`Using slot ${_.sourceSlot} on ${_.targetSlot}`,"Failed to use item on item");case"useItemOnLoc":return this.wrapBool(this.client.useItemOnLoc(_.itemSlot,_.x,_.z,_.locId),"Using item on location","Failed to use item on location");case"useItemOnNpc":return this.wrapBool(this.client.useItemOnNpc(_.itemSlot,_.npcIndex),`Using item on NPC #${_.npcIndex}`,"Failed to use item on NPC");case"useEquipmentItem":return this.wrapBool(this.client.clickEquipmentSlot(_.slot,_.optionIndex),`Using equipment slot ${_.slot}`,"Failed to use equipment item");case"shopBuy":return this.wrapBool(this.client.shopBuy(_.slot,_.amount),`Buying from slot ${_.slot}`,"Failed to buy from shop");case"shopSell":return this.wrapBool(this.client.shopSell(_.slot,_.amount),`Selling from slot ${_.slot}`,"Failed to sell to shop");case"closeShop":return this.wrapBool(this.client.closeShop(),"Closed shop","Failed to close shop");case"closeModal":return this.wrapBool(this.client.closeModal(),"Closed modal","Failed to close modal");case"setCombatStyle":return this.wrapBool(this.client.setCombatStyle(_.style),`Set combat style to ${_.style}`,"Failed to set combat style");case"spellOnNpc":return this.wrapBool(this.client.spellOnNpc(_.npcIndex,_.spellComponent),`Casting spell on NPC #${_.npcIndex}`,"Failed to cast spell on NPC");case"spellOnItem":return this.wrapBool(this.client.spellOnItem(_.slot,_.spellComponent),`Casting spell on item slot ${_.slot}`,"Failed to cast spell on item");case"setTab":return this.wrapBool(this.client.setTab(_.tabIndex),`Switched to tab ${_.tabIndex}`,"Failed to switch tab");case"bankDeposit":return this.wrapBool(this.client.bankDeposit(_.slot,_.amount),`Depositing from slot ${_.slot}`,"Failed to deposit");case"bankWithdraw":return this.wrapBool(this.client.bankWithdraw(_.slot,_.amount),`Withdrawing from slot ${_.slot}`,"Failed to withdraw");case"acceptCharacterDesign":return this.wrapBool(this.client.acceptCharacterDesign(),"Character design accepted","Failed to accept character design");case"randomizeCharacterDesign":return this.wrapBool(this.client.randomizeCharacterDesign(),"Character design randomized","Failed to randomize character design");case"interactGroundItem":return this.wrapBool(this.client.interactGroundItem(_.x,_.z,_.itemId,_.optionIndex),`Interacting with ground item ${_.itemId}`,"Failed to interact with ground item");case"say":return this.wrapBool(this.client.say(_.message),`Said: ${_.message}`,"Failed to send message");case"scanNearbyLocs":if(!this.scanProvider)return{success:!1,message:"No scan provider available"};return{success:!0,message:"Scanned nearby locations",data:this.scanProvider.scanNearbyLocs(_.radius)};case"scanGroundItems":if(!this.scanProvider)return{success:!1,message:"No scan provider available"};return{success:!0,message:"Scanned ground items",data:this.scanProvider.scanGroundItems(_.radius)};default:return{success:!1,message:`Unknown action type: ${_.type}`}}}catch(R){return{success:!1,message:`Error: ${R}`}}}wrapBool(_,R,E){return _?{success:!0,message:R}:{success:!1,message:E}}}function s1(_){switch(_.type){case"walkTo":return`Walk to (${_.x}, ${_.z})`;case"interactNpc":return`Interact NPC #${_.npcIndex} opt ${_.optionIndex}`;case"talkToNpc":return`Talk to NPC #${_.npcIndex}`;case"interactLoc":return`Interact loc ${_.locId} at (${_.x}, ${_.z})`;case"useInventoryItem":return`Use inv slot ${_.slot} opt ${_.optionIndex}`;case"dropItem":return`Drop slot ${_.slot}`;case"pickupItem":return`Pickup item ${_.itemId} at (${_.x}, ${_.z})`;case"interactGroundItem":return`Interact ground item ${_.itemId} at (${_.x}, ${_.z})`;case"clickDialogOption":return`Dialog option ${_.optionIndex}`;case"clickComponent":return`Click component ${_.componentId}`;case"clickComponentWithOption":return`Click component ${_.componentId} option ${_.optionIndex}`;case"useItemOnItem":return`Use slot ${_.sourceSlot} on ${_.targetSlot}`;case"useItemOnNpc":return`Use slot ${_.itemSlot} on NPC #${_.npcIndex}`;case"shopBuy":return`Buy slot ${_.slot} x${_.amount}`;case"shopSell":return`Sell slot ${_.slot} x${_.amount}`;case"wait":return`Wait ${_.ticks||1} ticks`;case"acceptCharacterDesign":return"Accept character design";case"randomizeCharacterDesign":return"Randomize character design";case"say":return`Say: ${_.message}`;default:return _.type}}function b_(){if(typeof window>"u")return null;return new URLSearchParams(window.location.search)}function w1(){return b_()?.get("bot")||"default"}function C1(){return b_()?.get("password")||null}class A1{ws=null;reconnectTimer=null;connected=!1;handler;botUsername;preventReconnect=!1;constructor(_){this.handler=_,this.botUsername=w1()}connect(){if(this.ws)return;let _=window.location.protocol==="https:"?"wss:":"ws:",R=window.location.host,E=`${_}//${R}/gateway`;try{this.ws=new WebSocket(E),this.ws.onopen=()=>{this.connected=!0,this.send({type:"connected",username:this.botUsername,clientId:`${this.botUsername}-${Date.now()}`}),this.handler.onConnected()},this.ws.onmessage=(u)=>{try{let O=JSON.parse(u.data);this.handleMessage(O)}catch(O){}},this.ws.onclose=()=>{if(this.connected=!1,this.ws=null,this.handler.onDisconnected(),!this.preventReconnect){if(this.reconnectTimer)clearTimeout(this.reconnectTimer);this.reconnectTimer=window.setTimeout(()=>this.connect(),3000)}},this.ws.onerror=()=>{}}catch(u){}}disconnect(){if(this.reconnectTimer)clearTimeout(this.reconnectTimer),this.reconnectTimer=null;if(this.ws)this.ws.close(),this.ws=null;this.connected=!1}isConnected(){return this.connected}send(_){if(this.ws?.readyState===WebSocket.OPEN)this.ws.send(JSON.stringify(_))}sendState(_,R){if(!this.connected)return;this.send({type:"state",state:_,formattedState:R})}sendActionResult(_,R){this.send({type:"actionResult",actionId:_,result:R})}sendScreenshot(_,R){this.send({type:"screenshot_response",dataUrl:_,screenshotId:R})}handleMessage(_){if(_.type==="action")this.handler.onAction(_.action,_.actionId||null);else if(_.type==="status");else if(_.type==="screenshot_request")this.handler.onScreenshotRequest(_.screenshotId);else if(_.type==="save_and_disconnect")this.preventReconnect=!0,this.handler.onSaveAndDisconnect(_.reason||"Session being replaced")}}class R1{container;content;actionLog;packetLogContainer;packetLogContent;visible=!0;minimized=!1;packetLogVisible=!1;packetLogEnabled=!1;actionLogEntries=[];static MAX_LOG_ENTRIES=50;client;callbacks;panelsContainer=null;injectScrollbarStyles(){if(document.getElementById("bot-sdk-scrollbar-styles"))return;let _=document.createElement("style");_.id="bot-sdk-scrollbar-styles",_.textContent=`
            .dark-scrollbar {
                scrollbar-width: thin;
                scrollbar-color: #04A800 rgba(0, 0, 0, 0.3);
            }
            .dark-scrollbar::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            .dark-scrollbar::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.3);
                border-radius: 4px;
            }
            .dark-scrollbar::-webkit-scrollbar-thumb {
                background: #04A800;
                border-radius: 4px;
            }
            .dark-scrollbar::-webkit-scrollbar-thumb:hover {
                background: #05C900;
            }
            .dark-scrollbar::-webkit-scrollbar-corner {
                background: rgba(0, 0, 0, 0.3);
            }
        `,document.head.appendChild(_)}constructor(_,R){this.client=_,this.callbacks=R,this.injectScrollbarStyles(),this.container=document.createElement("div"),this.container.id="bot-sdk-overlay",this.container.style.cssText=`
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.85);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            color: #04A800;
            overflow: hidden;
            margin-top: 10px;
        `;let E=document.createElement("div");E.style.cssText=`
            display: flex;
            flex-direction: row;
            flex: 1;
            min-height: 0;
        `;let u=document.createElement("div");u.style.cssText=`
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            border-right: 1px solid rgba(4, 168, 0, 0.3);
        `;let O=document.createElement("div");O.style.cssText=`
            padding: 4px 10px;
            background: rgba(4, 168, 0, 0.15);
            font-weight: bold;
            font-size: 10px;
        `,O.textContent="WORLD STATE",this.content=document.createElement("pre"),this.content.id="bot-sdk-content",this.content.className="dark-scrollbar",this.content.style.cssText=`
            margin: 0;
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 350px;
            white-space: pre-wrap;
            word-break: break-word;
            tab-size: 4;
            flex: 1;
        `,u.appendChild(O),u.appendChild(this.content);let b=document.createElement("div");b.style.cssText=`
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        `;let L=document.createElement("div");L.style.cssText=`
            padding: 4px 10px;
            background: rgba(255, 215, 0, 0.15);
            font-weight: bold;
            font-size: 10px;
            color: #FFD700;
            position: relative;
        `,L.innerHTML=`
            SDK ACTIONS
            <button id="bot-packets" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: 1px solid #04A800; color: #04A800; cursor: pointer; padding: 2px 8px; font-size: 10px;">PKT</button>
        `,this.actionLog=document.createElement("pre"),this.actionLog.id="bot-sdk-actions",this.actionLog.className="dark-scrollbar",this.actionLog.style.cssText=`
            margin: 0;
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 350px;
            white-space: pre-wrap;
            word-break: break-word;
            color: #FFD700;
            font-size: 10px;
            flex: 1;
            text-align: left;
        `,this.actionLog.textContent=`Download the SDK to get started:
github.com/MaxBittker/rs-sdk

(waiting for SDK actions...)`,b.appendChild(L),b.appendChild(this.actionLog),E.appendChild(u),E.appendChild(b),this.container.appendChild(E),this.panelsContainer=E;let N=document.getElementById("sdk-panel-container");if(N)N.appendChild(this.container);else document.body.appendChild(this.container);this.packetLogContainer=this.createPacketLogPanel(),document.body.appendChild(this.packetLogContainer),this.setupEventHandlers()}createPacketLogPanel(){let _=document.createElement("div");_.id="bot-packet-log",_.style.cssText=`
            position: fixed;
            top: 10px;
            left: 10px;
            width: 450px;
            max-height: 500px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #FF6600;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 10px;
            color: #FF6600;
            z-index: 10001;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: none;
        `;let R=document.createElement("div");return R.style.cssText=`
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: rgba(255, 102, 0, 0.2);
            border-bottom: 1px solid #FF6600;
            cursor: move;
        `,R.innerHTML=`
            <span style="font-weight: bold;">PACKET LOG</span>
            <div>
                <button id="pkt-toggle" style="background: #333; border: 1px solid #FF6600; color: #FF6600; cursor: pointer; padding: 2px 8px; margin-right: 4px; font-size: 10px;">OFF</button>
                <button id="pkt-clear" style="background: none; border: 1px solid #FF6600; color: #FF6600; cursor: pointer; padding: 2px 8px; margin-right: 4px; font-size: 10px;">Clear</button>
                <button id="pkt-copy" style="background: none; border: 1px solid #FF6600; color: #FF6600; cursor: pointer; padding: 2px 8px; margin-right: 4px; font-size: 10px;">Copy</button>
                <button id="pkt-close" style="background: none; border: 1px solid #FF6600; color: #FF6600; cursor: pointer; padding: 2px 8px;">X</button>
            </div>
        `,this.packetLogContent=document.createElement("pre"),this.packetLogContent.id="bot-packet-content",this.packetLogContent.style.cssText=`
            margin: 0;
            padding: 10px;
            overflow-y: auto;
            max-height: 430px;
            white-space: pre;
            word-wrap: normal;
            overflow-x: auto;
        `,this.packetLogContent.textContent=`Packet logging disabled. Click "OFF" button to enable.

Usage:
1. Click "OFF" to toggle logging ON
2. Perform actions in-game
3. Click "Copy" to copy log to clipboard
4. Click "Clear" to clear the log`,_.appendChild(R),_.appendChild(this.packetLogContent),this.makeDraggable(R,_),_}setupEventHandlers(){let _=document.getElementById("bot-packets"),R=document.getElementById("pkt-toggle"),E=document.getElementById("pkt-clear"),u=document.getElementById("pkt-copy"),O=document.getElementById("pkt-close");_?.addEventListener("click",()=>this.togglePacketLog()),R?.addEventListener("click",()=>this.togglePacketLogging()),E?.addEventListener("click",()=>this.clearPacketLog()),u?.addEventListener("click",()=>this.copyPacketLog()),O?.addEventListener("click",()=>this.togglePacketLog())}makeDraggable(_,R){let E=!1,u=0,O=0,b=0,L=0;_.addEventListener("mousedown",(N)=>{if(E=!0,u=N.clientX,O=N.clientY,R.style.left)b=parseInt(R.style.left)||10;else b=window.innerWidth-R.offsetWidth-(parseInt(R.style.right)||10);L=parseInt(R.style.top)||10,N.preventDefault()}),document.addEventListener("mousemove",(N)=>{if(!E)return;let G=N.clientX-u,H=N.clientY-O;R.style.left=`${b+G}px`,R.style.right="auto",R.style.top=`${L+H}px`}),document.addEventListener("mouseup",()=>{E=!1})}togglePacketLog(){if(this.packetLogVisible=!this.packetLogVisible,this.packetLogContainer.style.display=this.packetLogVisible?"block":"none",this.packetLogVisible&&!this.packetLogEnabled)this.setPacketLogging(!0);else if(!this.packetLogVisible&&this.packetLogEnabled)this.setPacketLogging(!1)}togglePacketLogging(){this.setPacketLogging(!this.packetLogEnabled)}setPacketLogging(_){this.packetLogEnabled=_,this.client.setPacketLogging(_);let R=document.getElementById("pkt-toggle");if(R)R.textContent=_?"ON":"OFF",R.style.background=_?"#FF6600":"#333",R.style.color=_?"#000":"#FF6600";if(_)this.client.setPacketLogCallback((E)=>this.addPacketLogEntry(E)),this.packetLogContent.textContent=`--- Packet logging started ---
`;else this.client.setPacketLogCallback(null),this.packetLogContent.textContent+=`
--- Packet logging stopped ---
`}addPacketLogEntry(_){let E=`[${new Date(_.timestamp).toLocaleTimeString("en-US",{hour12:!1})}] ${_.name.padEnd(20)} | size: ${_.size.toString().padStart(3)} | ${_.data}
`;this.packetLogContent.textContent+=E,this.packetLogContent.scrollTop=this.packetLogContent.scrollHeight}clearPacketLog(){this.client.clearPacketLog(),this.packetLogContent.textContent=this.packetLogEnabled?`--- Log cleared ---
`:`Packet logging disabled. Click "OFF" button to enable.
`}copyPacketLog(){let _=this.packetLogContent.textContent||"";navigator.clipboard.writeText(_).then(()=>{let R=document.getElementById("pkt-copy");if(R){let E=R.textContent;R.textContent="Copied!",R.style.background="#FF6600",R.style.color="#000",setTimeout(()=>{R.textContent=E,R.style.background="none",R.style.color="#FF6600"},1000)}}).catch((R)=>{})}isPacketLoggingEnabled(){return this.packetLogEnabled}toggleMinimize(){this.minimized=!this.minimized;let _=this.minimized?"none":"flex";if(this.panelsContainer)this.panelsContainer.style.display=_;this.container.style.maxHeight=this.minimized?"auto":"600px"}toggle(){this.visible=!this.visible,this.container.style.display=this.visible?"block":"none"}show(){this.visible=!0,this.container.style.display="block"}hide(){this.visible=!1,this.container.style.display="none"}isVisible(){return this.visible}isMinimized(){return this.minimized}updateContent(_){this.content.textContent=_}logAction(_,R){let u=`[${new Date().toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})}] ${_}: ${R}`;if(this.actionLogEntries.unshift(u),this.actionLogEntries.length>R1.MAX_LOG_ENTRIES)this.actionLogEntries.pop();this.actionLog.textContent=this.actionLogEntries.join(`
`)}destroy(){this.container.remove(),this.packetLogContainer.remove()}}var L_=null;class Z1{client;collector;executor;gateway;ui;pendingAction=null;currentActionId=null;waitTicks=0;serverTick=0;lastActionTime=0;activityCheckInterval=null;constructor(_){this.client=_,this.collector=new p0(_),this.executor=new j1(_),this.gateway=new A1(this),this.ui=new R1(_,{onPacketLogToggle:()=>{}}),this.executor.setScanProvider(this.collector),this.gateway.connect(),this.client.setOnGameTickCallback(this.onGameTick.bind(this)),this.activityCheckInterval=setInterval(()=>this.checkActivity(),500),L_=this}checkActivity(){let R=Date.now()-this.lastActionTime<8000;if(typeof window.setFaviconActive==="function")window.setFaviconActive(R)}onGameTick(){this.serverTick++,this.sendState()}onAction(_,R){this.pendingAction=_,this.currentActionId=R,this.lastActionTime=Date.now(),this.client.idleCycles=performance.now(),this.ui.logAction(_.type,s1(_))}onScreenshotRequest(_){this.captureAndSendScreenshot(_)}onConnected(){if(this.ui.logAction("connected","Connected to SDK gateway"),this.pendingAction);this.pendingAction=null,this.waitTicks=0}onDisconnected(){this.ui.logAction("disconnected","Disconnected from SDK gateway")}onSaveAndDisconnect(_){this.ui.logAction("disconnecting",`Save and disconnect: ${_}`);let R=this.client;if(R&&typeof R.logout==="function")R.logout().catch((E)=>{});else this.gateway.disconnect()}tick(){if(this.waitTicks>0){if(this.waitTicks--,this.waitTicks===0&&this.currentActionId)this.sendActionResult({success:!0,message:"Wait complete"});return}if(this.pendingAction){let _=this.pendingAction;this.pendingAction=null;let R=this.executor.execute(_);if(R instanceof Promise){R.then((u)=>{this.sendActionResult(u),this.sendState()}).catch((u)=>{this.sendActionResult({success:!1,message:`Error: ${u}`})});return}let E=R;if(_.type==="wait"&&E.success){this.waitTicks=_.ticks||1;return}this.sendActionResult(E),this.sendState();return}}collectWorldState(){if(!this.collector||!this.client)return null;let _=this.collector.collectState(),R=this.client,E=[],u=[];if(R.chatInterfaceId!==-1){let b=this.client.getDialogOptions();for(let L of b)E.push({index:L.index,text:L.text,componentId:L.componentId,buttonType:L.buttonType});if(typeof this.client.debugDialogComponents==="function"){let L=this.client.debugDialogComponents();for(let N of L)u.push(N)}}let O=[];if(this.client.isViewportInterfaceOpen()){let b=this.client.getInterfaceOptions();for(let L of b)O.push({index:L.index,text:L.text,componentId:L.componentId})}return{..._,tick:this.serverTick,dialog:{isOpen:this.client.isDialogOpen(),options:E,isWaiting:this.client.isWaitingForDialog(),allComponents:u},interface:{isOpen:this.client.isViewportInterfaceOpen(),interfaceId:this.client.getViewportInterface(),options:O,debugInfo:this.client.isViewportInterfaceOpen()?this.client.getInterfaceDebugInfo(this.client.getViewportInterface()):[]},modalOpen:this.client.isModalOpen(),modalInterface:this.client.getModalInterface()}}sendState(){if(!this.gateway.isConnected())return;let _=this.collectWorldState();if(!_)return;let R=n1(_,"SDK Control");this.gateway.sendState(_,R)}sendActionResult(_){if(this.currentActionId)this.gateway.sendActionResult(this.currentActionId,_),this.ui.logAction(_.success?"success":"failed",_.message),this.currentActionId=null}captureAndSendScreenshot(_){let R=window.gameCanvas||document.querySelector("canvas");if(!R)return;try{let E=R.toDataURL("image/png");this.gateway.sendScreenshot(E,_)}catch(E){}}update(){if(!this.ui.isVisible()||this.ui.isMinimized())return;let _=this.collector.collectState();_.tick=this.serverTick,this.ui.updateContent(v1(_))}getState(){return this.collector.collectState()}toggle(){this.ui.toggle()}show(){this.ui.show()}hide(){this.ui.hide()}isVisible(){return this.ui.isVisible()}toggleMinimize(){this.ui.toggleMinimize()}togglePacketLog(){this.ui.togglePacketLog()}destroy(){if(this.gateway.disconnect(),this.client.setOnGameTickCallback(null),this.ui.isPacketLoggingEnabled())this.client.setPacketLogCallback(null);if(this.activityCheckInterval)clearInterval(this.activityCheckInterval),this.activityCheckInterval=null;this.ui.destroy(),L_=null}}var p1=!1,G_=p1?Z1:null;class s extends O1{static nodeId=10;static membersWorld=!0;static lowMemory=!1;static cyclelogic1=0;static cyclelogic2=0;static cyclelogic3=0;static cyclelogic4=0;static cyclelogic5=0;static cyclelogic6=0;static oplogic1=0;static oplogic2=0;static oplogic3=0;static oplogic4=0;static oplogic5=0;static oplogic6=0;static oplogic7=0;static oplogic8=0;static oplogic9=0;alreadyStarted=!1;errorStarted=!1;errorLoading=!1;errorHost=!1;errorMessage=null;db=null;loopCycle=0;jagChecksum=[];stream=null;in=P.alloc(1);out=P.alloc(1);loginout=P.alloc(1);serverSeed=0n;idleNetCycles=0;idleTimeout=0;systemUpdateTimer=0;randomIn=null;ptype=0;psize=0;ptype0=0;ptype1=0;ptype2=0;jagTitle=null;redrawFrame=!0;titleScreenState=0;titleLoginField=0;imageTitle2=null;imageTitle3=null;imageTitle4=null;imageTitle0=null;imageTitle1=null;imageTitle5=null;imageTitle6=null;imageTitle7=null;imageTitle8=null;imageTitlebox=null;imageTitlebutton=null;loginMessage0="";loginMessage1="";username="";password="";fontPlain11=null;fontPlain12=null;fontBold12=null;fontQuill8=null;imageRunes=[];flameActive=!1;imageFlamesLeft=null;imageFlamesRight=null;flameBuffer1=null;flameBuffer0=null;flameBuffer3=null;flameBuffer2=null;flameGradient=null;flameGradient0=null;flameGradient1=null;flameGradient2=null;flameLineOffset=new Int32Array(256);flameCycle0=0;flameGradientCycle0=0;flameGradientCycle1=0;flamesInterval=null;areaSidebar=null;areaMapback=null;areaViewport=null;areaChatback=null;areaBackbase1=null;areaBackbase2=null;areaBackhmid1=null;areaBackleft1=null;areaBackleft2=null;areaBackright1=null;areaBackright2=null;areaBacktop1=null;areaBackvmid1=null;areaBackvmid2=null;areaBackvmid3=null;areaBackhmid2=null;areaChatbackOffsets=null;areaSidebarOffsets=null;areaViewportOffsets=null;compassMaskLineOffsets=new Int32Array(33);compassMaskLineLengths=new Int32Array(33);minimapMaskLineOffsets=new Int32Array(151);minimapMaskLineLengths=new Int32Array(151);imageInvback=null;imageChatback=null;imageMapback=null;imageBackbase1=null;imageBackbase2=null;imageBackhmid1=null;imageSideicons=new C(13,null);imageMinimap=null;imageCompass=null;imageMapedge=null;imageMapscene=new C(50,null);imageMapfunction=new C(50,null);imageHitmarks=new C(20,null);imageHeadicon=new C(20,null);imageMapmarker0=null;imageMapmarker1=null;imageCrosses=new C(8,null);imageMapdot0=null;imageMapdot1=null;imageMapdot2=null;imageMapdot3=null;imageScrollbar0=null;imageScrollbar1=null;imageRedstone1=null;imageRedstone2=null;imageRedstone3=null;imageRedstone1h=null;imageRedstone2h=null;imageRedstone1v=null;imageRedstone2v=null;imageRedstone3v=null;imageRedstone1hv=null;imageRedstone2hv=null;genderButtonImage0=null;genderButtonImage1=null;activeMapFunctions=new C(1000,null);redrawSidebar=!1;redrawChatback=!1;redrawSideicons=!1;redrawPrivacySettings=!1;viewportInterfaceId=-1;dragCycles=0;crossMode=0;crossCycle=0;crossX=0;crossY=0;overrideChat=0;menuVisible=!1;menuArea=0;menuX=0;menuY=0;menuWidth=0;menuHeight=0;menuSize=0;menuOption=[];sidebarInterfaceId=-1;chatInterfaceId=-1;chatInterface=new g;dialogHistory=[];dialogHistoryMax=10;lastCapturedDialogId=-1;chatScrollHeight=78;chatScrollOffset=0;ignoreCount=0;ignoreName37=[];hintType=0;hintNpc=0;hintOffsetX=0;hintOffsetZ=0;hintPlayer=0;hintTileX=0;hintTileZ=0;hintHeight=0;skillExperience=[];skillLevel=[];skillBaseLevel=[];levelExperience=[];modalMessage=null;flashingTab=-1;selectedTab=3;tabInterfaceId=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];chatPublicMode=0;chatPrivateMode=0;chatTradeMode=0;scrollGrabbed=!1;scrollInputPadding=0;showSocialInput=!1;socialMessage="";socialInput="";socialInputType=0;chatbackInput="";chatbackInputOpen=!1;stickyChatInterfaceId=-1;messageText=new C(100,null);messageSender=new C(100,null);messageType=new Int32Array(100);messageTick=new Int32Array(100);messageTextIds=new Int32Array(100);privateMessageCount=0;splitPrivateChat=0;chatEffects=0;chatTyped="";viewportHoveredInterfaceIndex=0;sidebarHoveredInterfaceIndex=0;chatHoveredInterfaceIndex=0;objDragInterfaceId=0;objDragSlot=0;objDragArea=0;objGrabX=0;objGrabY=0;objDragCycles=0;objGrabThreshold=!1;objSelected=0;objSelectedSlot=0;objSelectedInterface=0;objInterface=0;objSelectedName=null;selectedArea=0;selectedItem=0;selectedInterface=0;selectedCycle=0;pressedContinueOption=!1;varps=[];varCache=[];spellSelected=0;activeSpellId=0;activeSpellFlags=0;spellCaption=null;oneMouseButton=0;menuAction=new Int32Array(500);menuParamA=new Int32Array(500);menuParamB=new Int32Array(500);menuParamC=new Int32Array(500);hoveredSlotParentId=0;hoveredSlot=0;lastHoveredInterfaceId=0;reportAbuseInput="";reportAbuseMuteOption=!1;reportAbuseInterfaceId=-1;lastAddress=0;daysSinceLastLogin=0;daysSinceRecoveriesChanged=0;unreadMessages=0;activeMapFunctionCount=0;activeMapFunctionX=new Int32Array(1000);activeMapFunctionZ=new Int32Array(1000);scene=null;sceneState=0;sceneDelta=0;sceneCycle=0;flagSceneTileX=0;flagSceneTileZ=0;cutscene=!1;macroCameraCycle=0;macroCameraX=0;macroCameraZ=0;macroCameraAngle=0;macroCameraXModifier=2;macroCameraZModifier=2;macroCameraAngleModifier=1;cameraModifierCycle=new Int32Array(5);cameraModifierEnabled=new C(5,!1);cameraModifierJitter=new Int32Array(5);cameraModifierWobbleScale=new Int32Array(5);cameraModifierWobbleSpeed=new Int32Array(5);cameraX=0;cameraY=0;cameraZ=0;cameraPitch=0;cameraYaw=0;cameraPitchClamp=0;macroMinimapCycle=0;macroMinimapAngle=0;macroMinimapZoom=0;macroMinimapZoomModifier=1;macroMinimapAngleModifier=2;minimapLevel=-1;baseX=0;baseZ=0;sceneCenterZoneX=0;sceneCenterZoneZ=0;sceneBaseTileX=0;sceneBaseTileZ=0;sceneMapLandData=null;sceneMapLandFile=[];sceneMapLocData=null;sceneMapLocFile=[];sceneMapIndex=null;withinTutorialIsland=!1;awaitingSync=!1;scenePrevBaseTileX=0;scenePrevBaseTileZ=0;textureBuffer=new Int8Array(16384);levelCollisionMap=new C(4,null);currentLevel=0;orbitCameraPitch=128;orbitCameraYaw=0;orbitCameraYawVelocity=0;orbitCameraPitchVelocity=0;orbitCameraX=0;orbitCameraZ=0;levelHeightmap=null;levelTileFlags=null;tileLastOccupiedCycle=new h0(104,104);projectX=0;projectY=0;cutsceneDstLocalTileX=0;cutsceneDstLocalTileZ=0;cutsceneDstHeight=0;cutsceneRotateSpeed=0;cutsceneRotateAcceleration=0;cutsceneSrcLocalTileX=0;cutsceneSrcLocalTileZ=0;cutsceneSrcHeight=0;cutsceneMoveSpeed=0;cutsceneMoveAcceleration=0;players=new C(2048,null);playerCount=0;playerIds=new Int32Array(2048);entityUpdateCount=0;entityRemovalCount=0;entityUpdateIds=new Int32Array(2048);entityRemovalIds=new Int32Array(1000);playerAppearanceBuffer=new C(2048,null);npcs=new C(8192,null);npcCount=0;npcIds=new Int32Array(8192);projectiles=new K0;spotanims=new K0;objStacks=new d0(4,104,104,null);locChanges=new K0;bfsStepX=new Int32Array(4000);bfsStepZ=new Int32Array(4000);bfsDirection=new Int32Array(104*104);bfsCost=new Int32Array(104*104);tryMoveNearest=0;localPlayer=null;runenergy=0;inMultizone=0;localPid=-1;runweight=0;noTimeoutCycle=0;wildernessLevel=0;worldLocationState=0;staffmodlevel=0;designGender=!0;updateDesignModel=!1;designKits=new Int32Array(7);designColours=new Int32Array(5);static CHAT_COLORS=Int32Array.of(16776960,16711680,65280,65535,16711935,16777215);friendCount=0;chatCount=0;chatX=new Int32Array(50);chatY=new Int32Array(50);chatHeight=new Int32Array(50);chatWidth=new Int32Array(50);chatColors=new Int32Array(50);chatEffect=new Int32Array(50);chatTimers=new Int32Array(50);chats=new C(50,null);friendName=new C(200,null);friendName37=new BigInt64Array(200);friendWorld=new Int32Array(200);socialName37=null;waveCount=0;waveEnabled=!0;waveIds=new Int32Array(50);waveLoops=new Int32Array(50);waveDelay=new Int32Array(50);waveVolume=64;lastWaveId=-1;lastWaveLoops=-1;lastWaveLength=0;lastWaveStartTime=0;nextMusicDelay=0;midiActive=!0;midiVolume=64;midiSong=-1;midiFading=!1;nextMidiSong=-1;displayFps=!1;botOverlay=null;botAutoLoginAttempted=!1;onGameTickCallback=null;onDemand=null;ingame=!1;imageModIcons=[];lastProgressPercent=0;lastProgressMessage="";drawCycle=0;sceneLoadStartTime=0;viewportOverlayInterfaceId=-1;bankArrangeMode=0;field1264=0;warnMembersInNonMembers=0;membersAccount=0;flameCycle=0;initializeLevelExperience(){let _=0;for(let R=0;R<99;R++){let E=R+1,u=E+Math.pow(2,E/12)*300|0;_+=u,this.levelExperience[R]=_/4|0}}constructor(_,R,E){super();if(typeof _>"u"||typeof R>"u"||typeof E>"u")return;if(s.nodeId=_,s.membersWorld=E,R)s.setLowMemory();else s.setHighMemory();this.run()}packetLog=[];packetLogEnabled=!1;packetLogCallback=null;static PACKET_NAMES={206:"NO_TIMEOUT",102:"IDLE_TIMER",19:"EVENT_TRACKING",113:"OPOBJ1",238:"OPOBJ2",55:"OPOBJ3",17:"OPOBJ4",247:"OPOBJ5",122:"OPOBJT",143:"OPOBJU",180:"OPNPC1",252:"OPNPC2",196:"OPNPC3",107:"OPNPC4",43:"OPNPC5",141:"OPNPCT",14:"OPNPCU",1:"OPLOC1",219:"OPLOC2",226:"OPLOC3",204:"OPLOC4",86:"OPLOC5",208:"OPLOCT",147:"OPLOCU",135:"OPPLAYER1",165:"OPPLAYER2",172:"OPPLAYER3",54:"OPPLAYER4",52:"OPPLAYERT",210:"OPPLAYERU",104:"OPHELD1",193:"OPHELD2",115:"OPHELD3",194:"OPHELD4",9:"OPHELD5",188:"OPHELDT",126:"OPHELDU",13:"INV_BUTTON1",58:"INV_BUTTON2",48:"INV_BUTTON3",183:"INV_BUTTON4",242:"INV_BUTTON5",177:"IF_BUTTON",239:"RESUME_PAUSEBUTTON",245:"CLOSE_MODAL",241:"RESUME_P_COUNTDIALOG",243:"TUTORIAL_CLICKSIDE",216:"MOVE_OPCLICK",205:"REPORT_ABUSE",198:"MOVE_MINIMAPCLICK",7:"INV_BUTTOND",4:"IGNORELIST_DEL",20:"IGNORELIST_ADD",150:"IF_PLAYERDESIGN",8:"CHAT_SETMODE",99:"MESSAGE_PRIVATE",61:"FRIENDLIST_DEL",116:"FRIENDLIST_ADD",11:"CLIENT_CHEAT",78:"MESSAGE_PUBLIC",182:"MOVE_GAMECLICK"};setPacketLogging(_){this.packetLogEnabled=_}isPacketLoggingEnabled(){return this.packetLogEnabled}getPacketLog(){return[...this.packetLog]}clearPacketLog(){this.packetLog=[]}setPacketLogCallback(_){this.packetLogCallback=_}setOnGameTickCallback(_){this.onGameTickCallback=_}logPacket(_,R){if(!this.packetLogEnabled)return;let E=s.PACKET_NAMES[_]||`UNKNOWN_${_}`,u=R.map((b)=>b.toString(16).padStart(2,"0")).join(" "),O={timestamp:Date.now(),opcode:_,name:E,size:R.length,data:u};if(this.packetLog.push(O),this.packetLog.length>500)this.packetLog=this.packetLog.slice(-250);if(this.packetLogCallback)this.packetLogCallback(O)}currentPacketOpcode=-1;currentPacketStart=0;writePacketOpcode(_){this.currentPacketOpcode=_,this.currentPacketStart=this.out.pos,this.out.p1isaac(_)}setCredentials(_,R){this.username=_,this.password=R}getCredentials(){return{username:this.username,password:this.password}}async triggerLogin(){if(this.username&&this.password&&!this.ingame)await this.login(this.username,this.password,!1)}isInGame(){return this.ingame}getTitleState(){return this.titleScreenState}goToLoginScreen(){if(this.titleScreenState===0)return this.titleScreenState=2,this.titleLoginField=0,!0;return!1}async autoLogin(_,R){if(this.username=_,this.password=R,this.ingame)return;while(this.lastProgressPercent<100)await j0(100);if(this.titleScreenState===0)this.titleScreenState=2,this.titleLoginField=0;if(this.titleScreenState===2)await this.login(this.username,this.password,!1)}acceptCharacterDesign(){if(!this.ingame||!this.out)return!1;this.writePacketOpcode(150),this.out.p1(this.designGender?0:1);for(let _=0;_<7;_++)this.out.p1(this.designKits[_]);for(let _=0;_<5;_++)this.out.p1(this.designColours[_]);return!0}setCharacterDesign(_,R,E){if(this.designGender=_,this.validateCharacterDesign(),R&&R.length===7)for(let u=0;u<7;u++)this.designKits[u]=R[u];if(E&&E.length===5)for(let u=0;u<5;u++)this.designColours[u]=E[u];return this.updateDesignModel=!0,!0}randomizeCharacterDesign(_){this.designGender=_??Math.random()<0.5,this.validateCharacterDesign();for(let E=0;E<7;E++){let u=[];for(let O=0;O<U0.count;O++)if(!U0.types[O].disable&&U0.types[O].type===E+(this.designGender?0:7))u.push(O);if(u.length>0)this.designKits[E]=u[Math.floor(Math.random()*u.length)]}let R=[12,16,16,6,8];for(let E=0;E<5;E++)this.designColours[E]=Math.floor(Math.random()*R[E]);return this.updateDesignModel=!0,!0}findNpcByName(_){let R=_.toLowerCase();for(let E=0;E<this.npcCount;E++){let u=this.npcIds[E],O=this.npcs[u];if(O&&O.type&&O.type.name){if(O.type.name.toLowerCase().includes(R))return u}}return-1}getNearbyNpcs(){let _=[];for(let R=0;R<this.npcCount;R++){let E=this.npcIds[R],u=this.npcs[E];if(u&&u.type){let O=[];if(u.type.op){for(let b of u.type.op)if(b)O.push(b)}_.push({index:E,name:u.type.name||"Unknown",options:O})}}return _}talkToNpc(_){if(!this.ingame||!this.out||_<0)return!1;if(!this.npcs[_])return!1;return this.writePacketOpcode(180),this.out.p2(_),!0}interactNpc(_,R){if(!this.ingame||!this.out||_<0||R<1||R>5)return!1;if(!this.npcs[_])return!1;let u=[180,252,196,107,43];return this.writePacketOpcode(u[R-1]),this.out.p2(_),!0}spellOnNpc(_,R){if(!this.ingame||!this.out||!this.localPlayer||_<0)return!1;let E=this.npcs[_];if(!E)return!1;return this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.writePacketOpcode(141),this.out.p2(_),this.out.p2(R),!0}spellOnItem(_,R,E=3214){if(!this.ingame||!this.out||_<0||_>27)return!1;let u=g.types[E];if(!u||!u.invSlotObjId)return!1;let O=u.invSlotObjId[_];if(!O||O===0)return!1;let L=x.get(O-1).id;return this.writePacketOpcode(188),this.out.p2(L),this.out.p2(_),this.out.p2(E),this.out.p2(R),!0}pickupGroundItem(_,R,E){if(!this.ingame||!this.out||!this.localPlayer)return!1;let u=_-this.sceneBaseTileX,O=R-this.sceneBaseTileZ;if(u<0||u>=104||O<0||O>=104)return!1;return this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],u,O,2,0,0,0,0,0,!1),this.writePacketOpcode(55),this.out.p2(_),this.out.p2(R),this.out.p2(E),!0}interactGroundItem(_,R,E,u){if(!this.ingame||!this.out||!this.localPlayer||u<1||u>5)return!1;let O=_-this.sceneBaseTileX,b=R-this.sceneBaseTileZ;if(O<0||O>=104||b<0||b>=104)return!1;this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],O,b,2,0,0,0,0,0,!1);let L=[113,238,55,17,247];return this.writePacketOpcode(L[u-1]),this.out.p2(_),this.out.p2(R),this.out.p2(E),!0}useInventoryItem(_,R,E=3214){if(!this.ingame||!this.out||R<1||R>5)return!1;let u=g.types[E];if(!u||!u.invSlotObjId)return!1;let O=u.invSlotObjId[_];if(!O||O<=0)return!1;let L=x.get(O-1).id,G=[104,193,115,194,9][R-1];return this.writePacketOpcode(G),this.out.p2(L),this.out.p2(_),this.out.p2(E),!0}dropInventoryItem(_){return this.useInventoryItem(_,5)}clickEquipmentSlot(_,R=1){if(!this.ingame||!this.out||R<1||R>5)return!1;let E=1688,u=g.types[E];if(!u||!u.invSlotObjId)return!1;let O=u.invSlotObjId[_];if(!O||O<=0)return!1;let L=x.get(O-1).id,N=[13,58,48,183,242];return this.writePacketOpcode(N[R-1]),this.out.p2(L),this.out.p2(_),this.out.p2(E),!0}isShopOpen(){return this.viewportInterfaceId===3824&&this.sidebarInterfaceId===3822}getShopState(){if(!this.isShopOpen())return{isOpen:!1,title:""};let _="";try{let R=g.types[3901];if(R&&R.text)_=R.text}catch{}return{isOpen:!0,title:_}}shopBuy(_,R=1){if(!this.ingame||!this.out||!this.isShopOpen())return!1;let E=3900,u=g.types[E];if(!u||!u.invSlotObjId)return!1;let O=u.invSlotObjId[_];if(!O||O<=0)return!1;let L=x.get(O-1).id,N=2;if(R===5)N=3;else if(R===10)N=4;let G=[13,58,48,183,242];return this.writePacketOpcode(G[N-1]),this.out.p2(L),this.out.p2(_),this.out.p2(E),!0}shopSell(_,R=1){if(!this.ingame||!this.out||!this.isShopOpen())return!1;let E=3823,u=g.types[E];if(!u||!u.invSlotObjId)return!1;let O=u.invSlotObjId[_];if(!O||O<=0)return!1;let L=x.get(O-1).id,N=2;if(R===5)N=3;else if(R===10)N=4;let G=[13,58,48,183,242];return this.writePacketOpcode(G[N-1]),this.out.p2(L),this.out.p2(_),this.out.p2(E),!0}closeShop(){if(!this.ingame||!this.out||!this.isShopOpen())return!1;if(this.out.p1isaac(245),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;return this.viewportInterfaceId=-1,this.pressedContinueOption=!1,!0}closeModal(){if(!this.ingame||!this.out)return!1;if(this.viewportInterfaceId===-1&&this.sidebarInterfaceId===-1)return!0;if(this.out.p1isaac(245),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;return this.viewportInterfaceId=-1,this.pressedContinueOption=!1,!0}isBankOpen(){if(this.viewportInterfaceId===5292)return!0;let E=g.types[2006];if(E&&E.invSlotObjId){for(let u=0;u<E.invSlotObjId.length;u++)if(E.invSlotObjId[u]>0)return!0}return!1}bankDeposit(_,R=1){if(!this.ingame||!this.out)return!1;let E=2006,u=g.types[E];if(!u||!u.invSlotObjId)return!1;let O=u.invSlotObjId[_];if(!O||O<=0)return!1;let L=x.get(O-1).id,N=1;if(R===5)N=2;else if(R===10)N=3;else if(R===-1||R>=2147483647)N=4;let G=[13,58,48,183,242];return this.writePacketOpcode(G[N-1]),this.out.p2(L),this.out.p2(_),this.out.p2(E),!0}bankWithdraw(_,R=1){if(!this.ingame||!this.out)return!1;let E=5382,u=g.types[E];if(!u||!u.invSlotObjId)return!1;let O=u.invSlotObjId[_];if(!O||O<=0)return!1;let L=x.get(O-1).id,N=1;if(R===5)N=2;else if(R===10)N=3;else if(R===-1||R>=2147483647)N=4;let G=[13,58,48,183,242];return this.writePacketOpcode(G[N-1]),this.out.p2(L),this.out.p2(_),this.out.p2(E),!0}getBankItems(){let R=g.types[5382],E=[];if(!R||!R.invSlotObjId||!R.invSlotObjCount)return E;for(let u=0;u<R.invSlotObjId.length;u++){let O=R.invSlotObjId[u];if(O&&O>0){let b=x.get(O-1);E.push({slot:u,id:b.id,name:b.name||`Unknown(${b.id})`,count:R.invSlotObjCount[u]||1})}}return E}findBankItemSlot(_){let R=typeof _==="string"?new RegExp(_,"i"):_,u=this.getBankItems().find((O)=>R.test(O.name));return u?u.slot:-1}setCombatStyle(_){if(!this.ingame||!this.out)return!1;let R=this.tabInterfaceId[0];if(R===-1)return!1;let E=g.types[R];if(!E||!E.children)return!1;for(let u of E.children){let O=g.types[u];if(!O)continue;if(O.buttonType===5){if(O.scriptOperand&&O.scriptOperand[0]===_)return this.writePacketOpcode(177),this.out.p2(u),!0}if(O.children)for(let b of O.children){let L=g.types[b];if(!L)continue;if(L.buttonType===5&&L.scriptOperand&&L.scriptOperand[0]===_)return this.writePacketOpcode(177),this.out.p2(b),!0}}return!1}getCombatStyle(){for(let _ of[43,11,12,13,42,44]){let R=this.varps[_];if(R!==void 0&&R>=0&&R<=3)return R}return 0}say(_){if(!this.ingame||!this.out||!this.localPlayer)return!1;let R=_.substring(0,80);this.out.p1isaac(78),this.out.p1(0);let E=this.out.pos;if(this.out.p1(0),this.out.p1(0),g0.pack(this.out,R),this.out.psize1(this.out.pos-E),R=c.toSentenceCase(R),R=z0.filter(R),this.localPlayer)this.localPlayer.chatMessage=R,this.localPlayer.chatColour=0,this.localPlayer.chatEffect=0,this.localPlayer.chatTimer=150,this.addMessage(2,this.localPlayer.chatMessage,this.localPlayer.name??"");return!0}useItemOnItem(_,R,E=3214){if(!this.ingame||!this.out)return!1;let u=g.types[E];if(!u||!u.invSlotObjId)return!1;let O=u.invSlotObjId[_];if(!O||O===0)return!1;let L=x.get(O-1).id,N=u.invSlotObjId[R];if(!N||N===0)return!1;let H=x.get(N-1).id;return this.writePacketOpcode(126),this.out.p2(H),this.out.p2(R),this.out.p2(E),this.out.p2(L),this.out.p2(_),this.out.p2(E),!0}useItemOnNpc(_,R,E=3214){if(!this.ingame||!this.out||!this.localPlayer)return!1;let u=g.types[E];if(!u||!u.invSlotObjId)return!1;let O=u.invSlotObjId[_];if(!O||O===0)return!1;let L=x.get(O-1).id,N=this.npcs[R];if(!N)return!1;return this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],N.routeTileX[0],N.routeTileZ[0],2,1,1,0,0,0,!1),this.writePacketOpcode(14),this.out.p2(R),this.out.p2(L),this.out.p2(_),this.out.p2(E),!0}useItemOnLoc(_,R,E,u,O=3214){if(!this.ingame||!this.out||!this.localPlayer)return!1;let b=g.types[O];if(!b||!b.invSlotObjId)return!1;let L=b.invSlotObjId[_];if(!L||L===0)return!1;let G=x.get(L-1).id,H=R-this.sceneBaseTileX,Q=E-this.sceneBaseTileZ;if(H<0||H>103||Q<0||Q>103)return!1;let $=o.get(u);if($){let{width:J,length:T}=$;this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],H,Q,2,J,T,0,0,0,!1)}return this.writePacketOpcode(147),this.out.p2(R),this.out.p2(E),this.out.p2(u),this.out.p2(G),this.out.p2(_),this.out.p2(O),!0}walkTo(_,R,E=!1){if(!this.ingame||!this.out||!this.localPlayer)return!1;let u=_-this.sceneBaseTileX,O=R-this.sceneBaseTileZ,b=1,L=102,N=u<b||u>L||O<b||O>L;u=Math.max(b,Math.min(L,u)),O=Math.max(b,Math.min(L,O));let G=this.actionKey[5];this.actionKey[5]=E?1:0;let H=this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],u,O,0,0,0,0,0,0,!0);if(this.actionKey[5]=G,H)this.crossX=256,this.crossY=166,this.crossMode=1,this.crossCycle=0;return H}walkRelative(_,R,E=!1){if(!this.ingame||!this.localPlayer)return!1;let u=this.localPlayer.x>>7,O=this.localPlayer.z>>7,b=this.sceneBaseTileX+u+_,L=this.sceneBaseTileZ+O+R;return this.walkTo(b,L,E)}getPlayerPosition(){if(!this.ingame||!this.localPlayer)return null;let _=this.localPlayer.x>>7,R=this.localPlayer.z>>7;return{worldX:this.sceneBaseTileX+_,worldZ:this.sceneBaseTileZ+R,tileX:_,tileZ:R}}interactLoc(_,R,E,u){if(!this.ingame||!this.out||u<1||u>5)return!1;let O=[1,219,226,204,86];return this.writePacketOpcode(O[u-1]),this.out.p2(_),this.out.p2(R),this.out.p2(E),!0}clickDialogOption(_=0){if(!this.ingame||!this.out)return!1;if(_===0){if(!this.pressedContinueOption&&this.chatInterfaceId!==-1)return this.writePacketOpcode(239),this.out.p2(this.chatInterfaceId),this.pressedContinueOption=!0,!0;return!1}if(this.chatInterfaceId!==-1){let R=this.getDialogOptions();if(_>0&&_<=R.length){let E=R[_-1];if(E.buttonType===6){if(!this.pressedContinueOption)return this.writePacketOpcode(239),this.out.p2(E.componentId),this.pressedContinueOption=!0,!0;return!1}else return this.writePacketOpcode(177),this.out.p2(E.componentId),!0}}return!1}getDialogOptions(){let _=[];if(this.chatInterfaceId===-1)return _;let R=(E)=>{let u=g.types[E];if(!u)return;if((u.buttonType===1||u.buttonType===6)&&u.option){let O=u.text||u.option;_.push({index:_.length+1,text:O,componentId:E,buttonType:u.buttonType})}if(u.children)for(let O of u.children)R(O)};return R(this.chatInterfaceId),_}debugDialogComponents(){let _=[];if(this.chatInterfaceId===-1)return _;let R=(E,u=0)=>{if(u>5)return;let O=g.types[E];if(!O)return;if(_.push({id:E,type:O.type,buttonType:O.buttonType,option:O.option||"",text:(O.text||"").substring(0,50),scripts:O.scripts?JSON.stringify(O.scripts):void 0,scriptOperand:O.scriptOperand?JSON.stringify(O.scriptOperand):void 0,clientCode:O.clientCode||void 0}),O.children)for(let b of O.children)R(b,u+1)};return R(this.chatInterfaceId),_}getDialogText(){let _=[];if(this.chatInterfaceId===-1)return _;let R=(E,u=0)=>{if(u>10)return;let O=g.types[E];if(!O)return;if(O.type===4&&O.text){let b=O.text;if(b.indexOf("%")!==-1)for(let N=0;N<5;N++){let G=`%${N+1}`;while(b.indexOf(G)!==-1){let H=b.indexOf(G),Q=this.executeClientScript(O,N),$=Q<999999999?String(Q):"*";b=b.substring(0,H)+$+b.substring(H+2)}}let L=b.trim();if(L&&L!=="Please wait..."&&L!=="Click here to continue"&&!L.startsWith("Select an Option")){let N=L.replace(/@\w{3}@/g,"");if(N)_.push(N)}}if(O.children)for(let b of O.children)R(b,u+1)};return R(this.chatInterfaceId),_}captureDialogToHistory(){if(this.chatInterfaceId===-1)return;if(this.chatInterfaceId===this.lastCapturedDialogId)return;let _=this.getDialogText();if(_.length===0)return;if(this.dialogHistory.unshift({text:_,tick:this.loopCycle,interfaceId:this.chatInterfaceId}),this.dialogHistory.length>this.dialogHistoryMax)this.dialogHistory.pop();this.lastCapturedDialogId=this.chatInterfaceId}getDialogHistory(){return this.dialogHistory}isModalOpen(){return this.viewportInterfaceId!==-1}isDialogOpen(){return this.chatInterfaceId!==-1}getModalInterface(){return this.viewportInterfaceId}getChatInterface(){return this.chatInterfaceId}isWaitingForDialog(){return this.pressedContinueOption}isViewportInterfaceOpen(){return this.viewportInterfaceId!==-1}getViewportInterface(){return this.viewportInterfaceId}getInterfaceOptions(){let _=[];if(this.viewportInterfaceId===-1)return _;let R=(E,u=0)=>{if(u>10)return;let O=g.types[E];if(!O){if(u===0)for(let L=0;L<50;L++){let N=this.viewportInterfaceId*1000+L,G=g.types[N];if(G&&G.buttonType&&G.buttonType>0);}return}if((O.buttonType===1||O.buttonType===2||O.buttonType===5)&&(O.option||O.text))_.push({index:_.length+1,text:O.option||O.text||`Option ${_.length+1}`,componentId:E});if(O.children)for(let L of O.children)R(L,u+1)};return R(this.viewportInterfaceId),_}clickInterfaceOption(_){if(!this.ingame||!this.out)return!1;if(this.viewportInterfaceId===-1)return!1;let R=this.getInterfaceOptions();if(_>0&&_<=R.length){let E=R[_-1];return this.writePacketOpcode(177),this.out.p2(E.componentId),!0}return!1}clickComponent(_){if(!this.ingame||!this.out)return!1;return this.writePacketOpcode(177),this.out.p2(_),!0}setTab(_){if(!this.ingame||_<0||_>13)return!1;if(this.tabInterfaceId[_]===-1)return!1;return this.selectedTab=_,this.redrawSidebar=!0,this.redrawSideicons=!0,!0}clickInterfaceIop(_,R=1,E=0){if(!this.ingame||!this.out)return!1;let u=g.types[_];if(!u)return!1;let O=0;if(u.invSlotObjId&&u.invSlotObjId[E]){let N=u.invSlotObjId[E];O=x.get(N-1).id}let b=[13,58,48,183,242],L=b[Math.min(R-1,b.length-1)];return this.writePacketOpcode(L),this.out.p2(O),this.out.p2(E),this.out.p2(_),!0}getInterfaceDebugInfo(_){let R=[],E=g.types[_];if(!E)return R.push(`Interface ${_}: Component not found`),R;R.push(`Interface ${_}: ${E.children?.length||0} children`);let u=(O,b)=>{if(b>3)return;let L=g.types[O];if(!L)return;let N="  ".repeat(b),G=L.buttonType&&L.buttonType>0,H=L.iop&&L.iop.some(($)=>$),Q=L.option;if(G||H||Q){let $=`${N}${O}:`;if(G)$+=` buttonType=${L.buttonType}`;if(Q)$+=` option="${L.option}"`;if(H&&L.iop){let J=L.iop.filter((T)=>T).join(", ");$+=` iop=[${J}]`}if(L.text)$+=` text="${L.text}"`;R.push($)}if(L.children)for(let $ of L.children)u($,b+1)};return u(_,0),R}enableAgentMode(){}toggleAgentMode(){}isAgentModeEnabled(){return!1}static setLowMemory(){V.lowMemory=!0,X.lowMemory=!0,s.lowMemory=!0,i.lowMemory=!0}static setHighMemory(){V.lowMemory=!1,X.lowMemory=!1,s.lowMemory=!1,i.lowMemory=!1}saveMidi(_,R){Y_(R,this.midiVolume,_)}async load(){if(this.isMobile&&s.lowMemory)this.setTargetedFramerate(30);if(this.alreadyStarted){this.errorStarted=!0;return}this.alreadyStarted=!0;try{this.db=new e0(await e0.openDatabase())}catch(_){this.db=null}try{await this.drawProgress(10,"Connecting to web server");let _=new P(await v0("/crc"));for(let j=0;j<9;j++)this.jagChecksum[j]=_.g4();this.jagTitle=await this.getJagFile("title","title screen",1,25),this.fontPlain11=k0.fromArchive(this.jagTitle,"p11"),this.fontPlain12=k0.fromArchive(this.jagTitle,"p12"),this.fontBold12=k0.fromArchive(this.jagTitle,"b12"),this.fontQuill8=k0.fromArchive(this.jagTitle,"q8"),await this.loadTitleBackground(),this.loadTitleImages();let R=await this.getJagFile("config","config",2,30),E=await this.getJagFile("interface","interface",3,35),u=await this.getJagFile("media","2d graphics",4,40),O=await this.getJagFile("textures","textures",6,45),b=await this.getJagFile("wordenc","chat system",7,50),L=await this.getJagFile("sounds","sound effects",8,55);this.levelTileFlags=new W0(4,104,104),this.levelHeightmap=new C0(4,104+1,104+1),this.scene=new V(this.levelHeightmap,104,4,104);for(let j=0;j<4;j++)this.levelCollisionMap[j]=new _0;this.imageMinimap=new E0(512,512);let N=await this.getJagFile("versionlist","update list",5,60);if(await this.drawProgress(60,"Connecting to update server"),this.onDemand=new V1(N,this),Z0.init(this.onDemand.getAnimCount()),U.init(this.onDemand.getFileCount(0),this.onDemand),await this.drawProgress(62,"Preloading cache"),await this.onDemand.prefetchAll(),!s.lowMemory){this.midiSong=0,this.midiFading=!1,this.onDemand.request(2,this.midiSong);while(this.onDemand.remaining()>0)await this.updateOnDemand(),await j0(100)}await this.drawProgress(65,"Requesting animations");let G=this.onDemand.getFileCount(1);for(let j=0;j<G;j++)this.onDemand.request(1,j);while(this.onDemand.remaining()>0){let j=G-this.onDemand.remaining();if(j>0)await this.drawProgress(65,"Loading animations - "+(j*100/G|0)+"%");await this.updateOnDemand(),await j0(100)}await this.drawProgress(70,"Requesting models");let H=this.onDemand.getFileCount(0);for(let j=0;j<H;j++)if((this.onDemand.getModelFlags(j)&1)!=0)this.onDemand.request(0,j);let Q=this.onDemand.remaining();while(this.onDemand.remaining()>0){let j=Q-this.onDemand.remaining();if(j>0)await this.drawProgress(70,"Loading models - "+(j*100/Q|0)+"%");await this.updateOnDemand(),await j0(100)}if(this.db){await this.drawProgress(75,"Requesting maps"),this.onDemand.request(3,this.onDemand.getMapFile(47,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(47,48,1)),this.onDemand.request(3,this.onDemand.getMapFile(48,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(48,48,1)),this.onDemand.request(3,this.onDemand.getMapFile(49,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(49,48,1)),this.onDemand.request(3,this.onDemand.getMapFile(47,47,0)),this.onDemand.request(3,this.onDemand.getMapFile(47,47,1)),this.onDemand.request(3,this.onDemand.getMapFile(48,47,0)),this.onDemand.request(3,this.onDemand.getMapFile(48,47,1)),this.onDemand.request(3,this.onDemand.getMapFile(148,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(148,48,1));let j=this.onDemand.remaining();while(this.onDemand.remaining()>0){let W=j-this.onDemand.remaining();if(W>0)await this.drawProgress(75,"Loading maps - "+(W*100/j|0)+"%");await this.updateOnDemand(),await j0(100)}}let $=this.onDemand.getFileCount(0);for(let j=0;j<$;j++){let W=this.onDemand.getModelFlags(j),B=0;if((W&8)!=0)B=10;else if((W&32)!=0)B=9;else if((W&16)!=0)B=8;else if((W&64)!=0)B=7;else if((W&128)!=0)B=6;else if((W&2)!=0)B=5;else if((W&4)!=0)B=4;if((W&1)!=0)B=3;if(B!=0)await this.onDemand.prefetchPriority(0,j,B)}if(await this.onDemand.prefetchMaps(s.membersWorld),!s.lowMemory){let j=this.onDemand.getFileCount(2);for(let W=0;W<j;W++)if(this.onDemand.shouldPrefetchMidi(W))this.onDemand.prefetchPriority(2,W,1)}await this.drawProgress(80,"Unpacking media"),this.imageInvback=G0.fromArchive(u,"invback",0),this.imageChatback=G0.fromArchive(u,"chatback",0),this.imageMapback=G0.fromArchive(u,"mapback",0),this.imageBackbase1=G0.fromArchive(u,"backbase1",0),this.imageBackbase2=G0.fromArchive(u,"backbase2",0),this.imageBackhmid1=G0.fromArchive(u,"backhmid1",0);for(let j=0;j<13;j++)this.imageSideicons[j]=G0.fromArchive(u,"sideicons",j);this.imageCompass=E0.fromArchive(u,"compass",0),this.imageMapedge=E0.fromArchive(u,"mapedge",0),this.imageMapedge.crop();try{for(let j=0;j<50;j++)this.imageMapscene[j]=G0.fromArchive(u,"mapscene",j)}catch(j){}try{for(let j=0;j<50;j++)this.imageMapfunction[j]=E0.fromArchive(u,"mapfunction",j)}catch(j){}try{for(let j=0;j<20;j++)this.imageHitmarks[j]=E0.fromArchive(u,"hitmarks",j)}catch(j){}try{for(let j=0;j<20;j++)this.imageHeadicon[j]=E0.fromArchive(u,"headicons",j)}catch(j){}this.imageMapmarker0=E0.fromArchive(u,"mapmarker",0),this.imageMapmarker1=E0.fromArchive(u,"mapmarker",1);for(let j=0;j<8;j++)this.imageCrosses[j]=E0.fromArchive(u,"cross",j);this.imageMapdot0=E0.fromArchive(u,"mapdots",0),this.imageMapdot1=E0.fromArchive(u,"mapdots",1),this.imageMapdot2=E0.fromArchive(u,"mapdots",2),this.imageMapdot3=E0.fromArchive(u,"mapdots",3),this.imageScrollbar0=G0.fromArchive(u,"scrollbar",0),this.imageScrollbar1=G0.fromArchive(u,"scrollbar",1),this.imageRedstone1=G0.fromArchive(u,"redstone1",0),this.imageRedstone2=G0.fromArchive(u,"redstone2",0),this.imageRedstone3=G0.fromArchive(u,"redstone3",0),this.imageRedstone1h=G0.fromArchive(u,"redstone1",0),this.imageRedstone1h?.flipHorizontally(),this.imageRedstone2h=G0.fromArchive(u,"redstone2",0),this.imageRedstone2h?.flipHorizontally(),this.imageRedstone1v=G0.fromArchive(u,"redstone1",0),this.imageRedstone1v?.flipVertically(),this.imageRedstone2v=G0.fromArchive(u,"redstone2",0),this.imageRedstone2v?.flipVertically(),this.imageRedstone3v=G0.fromArchive(u,"redstone3",0),this.imageRedstone3v?.flipVertically(),this.imageRedstone1hv=G0.fromArchive(u,"redstone1",0),this.imageRedstone1hv?.flipHorizontally(),this.imageRedstone1hv?.flipVertically(),this.imageRedstone2hv=G0.fromArchive(u,"redstone2",0),this.imageRedstone2hv?.flipHorizontally(),this.imageRedstone2hv?.flipVertically();for(let j=0;j<2;j++)this.imageModIcons[j]=G0.fromArchive(u,"mod_icons",j);let J=E0.fromArchive(u,"backleft1",0);this.areaBackleft1=new H0(J.cropRight,J.cropBottom),J.blitOpaque(0,0);let T=E0.fromArchive(u,"backleft2",0);this.areaBackleft2=new H0(T.cropRight,T.cropBottom),T.blitOpaque(0,0);let m=E0.fromArchive(u,"backright1",0);this.areaBackright1=new H0(m.cropRight,m.cropBottom),m.blitOpaque(0,0);let q=E0.fromArchive(u,"backright2",0);this.areaBackright2=new H0(q.cropRight,q.cropBottom),q.blitOpaque(0,0);let K=E0.fromArchive(u,"backtop1",0);this.areaBacktop1=new H0(K.cropRight,K.cropBottom),K.blitOpaque(0,0);let F=E0.fromArchive(u,"backvmid1",0);this.areaBackvmid1=new H0(F.cropRight,F.cropBottom),F.blitOpaque(0,0);let w=E0.fromArchive(u,"backvmid2",0);this.areaBackvmid2=new H0(w.cropRight,w.cropBottom),w.blitOpaque(0,0);let k=E0.fromArchive(u,"backvmid3",0);this.areaBackvmid3=new H0(k.cropRight,k.cropBottom),k.blitOpaque(0,0);let Y=E0.fromArchive(u,"backhmid2",0);this.areaBackhmid2=new H0(Y.cropRight,Y.cropBottom),Y.blitOpaque(0,0);let A=(Math.random()*21|0)-10,h=(Math.random()*21|0)-10,Z=(Math.random()*21|0)-10,f=(Math.random()*41|0)-20;for(let j=0;j<50;j++){if(this.imageMapfunction[j])this.imageMapfunction[j]?.translate2d(A+f,h+f,Z+f);if(this.imageMapscene[j])this.imageMapscene[j]?.translate2d(A+f,h+f,Z+f)}if(await this.drawProgress(83,"Unpacking textures"),X.unpackTextures(O),X.initColourTable(0.8),X.initPool(20),await this.drawProgress(86,"Unpacking config"),e.unpack(R),o.unpack(R),B0.unpack(R),x.unpack(R,s.membersWorld),A0.unpack(R),U0.unpack(R),q0.unpack(R),D0.unpack(R),!s.lowMemory)await this.drawProgress(90,"Unpacking sounds"),O0.unpack(L);await this.drawProgress(95,"Unpacking interfaces"),g.unpack(E,u,[this.fontPlain11,this.fontPlain12,this.fontBold12,this.fontQuill8]),await this.drawProgress(100,"Preparing game engine");for(let j=0;j<33;j++){let W=999,B=0;for(let M=0;M<34;M++)if(this.imageMapback.pixels[M+j*this.imageMapback.width2d]===0){if(W===999)W=M}else if(W!==999){B=M;break}this.compassMaskLineOffsets[j]=W,this.compassMaskLineLengths[j]=B-W}for(let j=5;j<156;j++){let W=999,B=0;for(let M=25;M<172;M++)if(this.imageMapback.pixels[M+j*this.imageMapback.width2d]===0&&(M>34||j>34)){if(W===999)W=M}else if(W!==999){B=M;break}this.minimapMaskLineOffsets[j-5]=W-25,this.minimapMaskLineLengths[j-5]=B-W}X.init3D(479,96),this.areaChatbackOffsets=X.lineOffset,X.init3D(190,261),this.areaSidebarOffsets=X.lineOffset,X.init3D(512,334),this.areaViewportOffsets=X.lineOffset;let S=new Int32Array(9);for(let j=0;j<9;j++){let W=j*32+128+15,B=W*3+600,M=X.sinTable[W];S[j]=B*M>>16}V.init(512,334,500,800,S),z0.unpack(b),this.initializeLevelExperience()}catch(_){if(_ instanceof Error)this.errorMessage=`loaderror - ${this.lastProgressMessage} ${this.lastProgressPercent}%: ${_.message}`;this.errorLoading=!0}}async update(){if(this.errorStarted||this.errorLoading||this.errorHost)return;if(this.loopCycle++,this.ingame)await this.updateGame();else await this.updateTitle();await this.updateOnDemand()}async draw(){if(this.errorStarted||this.errorLoading||this.errorHost){this.drawError();return}if(this.drawCycle++,this.ingame)this.drawGame();else await this.drawTitle();this.dragCycles=0}refresh(){this.redrawFrame=!0}async drawProgress(_,R){if(this.lastProgressPercent=_,this.lastProgressMessage=R,await this.loadTitle(),!this.jagTitle){await super.drawProgress(_,R);return}this.imageTitle4?.bind();let E=360,u=200,O=20;this.fontBold12?.drawStringCenter(E/2|0,(u/2|0)-O-26,"RuneScape is loading - please wait...",16777215);let b=(u/2|0)-18-O;if(I.drawRect((E/2|0)-152,b,304,34,9179409),I.drawRect((E/2|0)-151,b+1,302,32,0),I.fillRect2d((E/2|0)-150,b+2,_*3,30,9179409),I.fillRect2d((E/2|0)-150+_*3,b+2,300-_*3,30,0),this.fontBold12?.drawStringCenter(E/2|0,(u/2|0)+5-O,R,16777215),this.imageTitle4?.draw(202,171),this.redrawFrame){if(this.redrawFrame=!1,!this.flameActive)this.imageTitle0?.draw(0,0),this.imageTitle1?.draw(637,0);this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(202,371),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(562,265),this.imageTitle7?.draw(128,171),this.imageTitle8?.draw(562,171)}await j0(5)}drawError(){r.fillStyle="black",r.fillRect(0,0,this.width,this.height),this.setFramerate(1),this.flameActive=!1;let _=0;if(this.errorLoading)r.font="bold 16px helvetica, sans-serif",r.textAlign="left",r.fillStyle="yellow",_=35,r.fillText("Sorry, an error has occured whilst loading RuneScape",30,_),_+=50,r.fillStyle="white",r.fillText("To fix this try the following (in order):",30,_),_+=50,r.font="bold 12px helvetica, sans-serif",r.fillText("1: Try closing ALL open web-browser windows, and reloading",30,_),_+=30,r.fillText("2: Try clearing your web-browsers cache",30,_),_+=30,r.fillText("3: Try using a different game-world",30,_),_+=30,r.fillText("4: Try rebooting your computer",30,_),_+=30,r.fillText("5: Try selecting a different method from the play-game menu",30,_);else if(this.errorHost)r.font="bold 20px helvetica, sans-serif",r.textAlign="left",r.fillStyle="white",_=50,r.fillText("Error - unable to load game!",50,_),_+=50,r.fillText("To play RuneScape make sure you play from",50,_),_+=50,r.fillText("An approved domain",50,_);else if(this.errorStarted)r.font="bold 13px helvetica, sans-serif",r.textAlign="left",r.fillStyle="yellow",_=35,r.fillText("Error a copy of RuneScape already appears to be loaded",30,_),_+=50,r.fillStyle="white",r.fillText("To fix this try the following (in order):",30,_),_+=50,r.font="bold 12px helvetica, sans-serif",r.fillText("1: Try closing ALL open web-browser windows, and reloading",30,_),_+=30,r.fillText("2: Try rebooting your computer, and reloading",30,_);if(this.errorMessage)_+=50,r.fillStyle="red",r.fillText(this.errorMessage,30,_)}async getJagFile(_,R,E,u){let O=this.jagChecksum[E],b,L=5;try{if(this.db)b=await this.db.read(0,E)}catch(G){}if(b&&P.getcrc(b,0,b.length)!==O)b=void 0;if(b)return new a0(b);let N=0;while(!b){await this.drawProgress(u,`Requesting ${R}`);try{b=await v0(`/${_}${O}`);let G=P.getcrc(b,0,b.length);if(O===G)try{if(this.db)await this.db.write(0,E,b)}catch(H){}else b=void 0,N++}catch(G){b=void 0}if(!b){for(let G=L;G>0;G--){if(N>=3)await this.drawProgress(u,"Game updated - please reload page"),G=10;else await this.drawProgress(u,`Error loading - Will retry in ${G} secs.`);await j0(1000)}if(L*=2,L>60)L=60}}return new a0(b)}async updateOnDemand(){if(!this.onDemand)return;await this.onDemand.run();while(!0){let _=this.onDemand.loop();if(_===null)return;if(!_.data)continue;if(_.archive===0){if(U.unpack(_.file,_.data),(this.onDemand.getModelFlags(_.file)&98)!=0){if(this.redrawSidebar=!0,this.chatInterfaceId!==-1)this.redrawChatback=!0}}else if(_.archive===1)Z0.unpack(_.data);else if(_.archive===2){if(this.midiSong===_.file)this.saveMidi(this.midiFading,_.data)}else if(_.archive===3){if(this.sceneMapLandData&&this.sceneMapLocData&&this.sceneState===1)for(let R=0;R<this.sceneMapLandData.length;R++){if(this.sceneMapLandFile[R]==_.file){if(this.sceneMapLandData[R]=_.data,_.data==null)this.sceneMapLandFile[R]=-1;break}if(this.sceneMapLocFile[R]==_.file){if(this.sceneMapLocData[R]=_.data,_.data==null)this.sceneMapLocFile[R]=-1;break}}}else if(_.archive===93){if(this.onDemand.hasMapLocFile(_.file))i.prefetchLocs(new P(_.data),this.onDemand)}}}async updateTitle(){if(this.titleScreenState===0){let _=(this.width/2|0)-80,R=(this.height/2|0)+20;if(R+=20,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20)this.titleScreenState=3,this.titleLoginField=0;if(_=(this.width/2|0)+80,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20)this.loginMessage0="",this.loginMessage1="Enter your username & password.",this.titleScreenState=2,this.titleLoginField=0}else if(this.titleScreenState===2){let _=(this.height/2|0)-40;if(_+=30,_+=25,this.mouseClickButton===1&&this.mouseClickY>=_-15&&this.mouseClickY<_)this.titleLoginField=0;if(_+=15,this.mouseClickButton===1&&this.mouseClickY>=_-15&&this.mouseClickY<_)this.titleLoginField=1;let R=(this.width/2|0)-80;if(_=(this.height/2|0)+50,_+=20,this.mouseClickButton===1&&this.mouseClickX>=R-75&&this.mouseClickX<=R+75&&this.mouseClickY>=_-20&&this.mouseClickY<=_+20){if(await this.login(this.username,this.password,!1),this.ingame)return}if(R=(this.width/2|0)+80,this.mouseClickButton===1&&this.mouseClickX>=R-75&&this.mouseClickX<=R+75&&this.mouseClickY>=_-20&&this.mouseClickY<=_+20)this.titleScreenState=0,this.username="",this.password="";while(!0){let E=this.pollKey();if(E===-1)return;let u=!1;for(let O=0;O<k0.CHARSET.length;O++)if(String.fromCharCode(E)===k0.CHARSET.charAt(O)){u=!0;break}if(this.titleLoginField===0){if(E===8&&this.username.length>0)this.username=this.username.substring(0,this.username.length-1);if(E===9||E===10||E===13)this.titleLoginField=1;if(u)this.username=this.username+String.fromCharCode(E);if(this.username.length>12)this.username=this.username.substring(0,12)}else if(this.titleLoginField===1){if(E===8&&this.password.length>0)this.password=this.password.substring(0,this.password.length-1);if(E===9||E===10||E===13)this.titleLoginField=0;if(u)this.password=this.password+String.fromCharCode(E);if(this.password.length>20)this.password=this.password.substring(0,20)}}}else if(this.titleScreenState===3){let _=this.width/2|0,R=(this.height/2|0)+50;if(R+=20,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20)this.titleScreenState=0}}async login(_,R,E){try{if(!E){if(_.length<1||_.length>12){this.loginMessage0="",this.loginMessage1="Username must be 1-12 characters.";return}if(R.length<1||R.length>20){this.loginMessage0="",this.loginMessage1="Password must be 1-20 characters.";return}this.loginMessage0="",this.loginMessage1="Connecting to server...",await this.drawTitle()}this.stream=new P0(await P0.openSocket(window.location.host,window.location.protocol==="https:"));let u=c.toBase37(_),O=Number(u>>16n)&31;this.out.pos=0,this.out.p1(14),this.out.p1(O),this.stream.write(this.out.data,2);for(let L=0;L<8;L++)await this.stream.read();let b=await this.stream.read();if(b===0){await this.stream.readBytes(this.in.data,0,8),this.in.pos=0,this.serverSeed=this.in.g8();let L=new Int32Array([Math.floor(Math.random()*99999999),Math.floor(Math.random()*99999999),Number(this.serverSeed>>32n),Number(this.serverSeed&BigInt(4294967295))]);if(this.out.pos=0,this.out.p1(10),this.out.p4(L[0]),this.out.p4(L[1]),this.out.p4(L[2]),this.out.p4(L[3]),this.out.p4(1337),this.out.pjstr(_),this.out.pjstr(R),this.out.rsaenc(BigInt("7162900525229798032761816791230527296329313291232324290237849263501208207972894053929065636522363163621000728841182238772712427862772219676577293600221789"),BigInt("58778699976184461502525193738213253649000149147835990136706041084440742975821")),this.loginout.pos=0,E)this.loginout.p1(18);else this.loginout.p1(16);this.loginout.p1(this.out.pos+36+1+1),this.loginout.p1(245),this.loginout.p1(s.lowMemory?1:0);for(let N=0;N<9;N++)this.loginout.p4(this.jagChecksum[N]);this.loginout.pdata(this.out.data,this.out.pos,0),this.out.random=new _1(L);for(let N=0;N<4;N++)L[N]+=50;this.randomIn=new _1(L),this.stream?.write(this.loginout.data,this.loginout.pos),b=await this.stream.read()}if(b===1)await j0(2000),await this.login(_,R,E);else if(b===2||b===18||b===19){if(this.staffmodlevel=0,b===18)this.staffmodlevel=1;else if(b===19)this.staffmodlevel=2;b0.setDisabled(),this.hasFocus=!0,this.ingame=!0,this.out.pos=0,this.in.pos=0,this.ptype=-1,this.ptype0=-1,this.ptype1=-1,this.ptype2=-1,this.psize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.idleTimeout=0,this.hintType=0,this.field1264=0,this.menuSize=0,this.menuVisible=!1,this.idleCycles=performance.now();for(let L=0;L<100;L++)this.messageText[L]=null;this.objSelected=0,this.spellSelected=0,this.sceneState=0,this.waveCount=0,this.macroCameraX=(Math.random()*100|0)-50,this.macroCameraZ=(Math.random()*110|0)-55,this.macroCameraAngle=(Math.random()*80|0)-40,this.macroMinimapAngle=(Math.random()*120|0)-60,this.macroMinimapZoom=(Math.random()*30|0)-20,this.orbitCameraYaw=(Math.random()*20|0)-10&2047,this.orbitCameraPitch=383,this.minimapLevel=-1,this.flagSceneTileX=0,this.flagSceneTileZ=0,this.playerCount=0,this.npcCount=0;for(let L=0;L<2048;L++)this.players[L]=null,this.playerAppearanceBuffer[L]=null;for(let L=0;L<8192;L++)this.npcs[L]=null;this.localPlayer=this.players[2047]=new J0,this.projectiles.clear(),this.spotanims.clear();for(let L=0;L<4;L++)for(let N=0;N<104;N++)for(let G=0;G<104;G++)this.objStacks[L][N][G]=null;this.locChanges=new K0,this.friendCount=0,this.stickyChatInterfaceId=-1,this.chatInterfaceId=-1,this.viewportInterfaceId=-1,this.sidebarInterfaceId=-1,this.viewportOverlayInterfaceId=-1,this.pressedContinueOption=!1,this.selectedTab=3,this.chatbackInputOpen=!1,this.menuVisible=!1,this.showSocialInput=!1,this.modalMessage=null,this.inMultizone=0,this.flashingTab=-1,this.designGender=!0,this.validateCharacterDesign();for(let L=0;L<5;L++)this.designColours[L]=0;if(s.oplogic1=0,s.oplogic2=0,s.oplogic3=0,s.oplogic4=0,s.oplogic5=0,s.oplogic6=0,s.oplogic7=0,s.oplogic8=0,s.oplogic9=0,p1&&G_&&!this.botOverlay)this.botOverlay=new G_(this);this.prepareGame()}else if(b===3)this.loginMessage0="",this.loginMessage1="Invalid username or password.";else if(b===4)this.loginMessage0="Your account has been disabled.",this.loginMessage1="Please check your message-centre for details.";else if(b===5)this.loginMessage0="Your account is already logged in.",this.loginMessage1="Try again in 60 secs...";else if(b===6)this.loginMessage0="RuneScape has been updated!",this.loginMessage1="Please reload this page.";else if(b===7)this.loginMessage0="This world is full.",this.loginMessage1="Please use a different world.";else if(b===8)this.loginMessage0="Unable to connect.",this.loginMessage1="Login server offline.";else if(b===9)this.loginMessage0="Login limit exceeded.",this.loginMessage1="Too many connections from your address.";else if(b===10)this.loginMessage0="Unable to connect.",this.loginMessage1="Bad session id.";else if(b===11)this.loginMessage1="Login server rejected session.",this.loginMessage1="Please try again.";else if(b===12)this.loginMessage0="You need a members account to login to this world.",this.loginMessage1="Please subscribe, or use a different world.";else if(b===13)this.loginMessage0="Could not complete login.",this.loginMessage1="Please try using a different world.";else if(b===14)this.loginMessage0="The server is being updated.",this.loginMessage1="Please wait 1 minute and try again.";else if(b===15){if(this.ingame=!0,this.out.pos=0,this.in.pos=0,this.ptype=-1,this.ptype0=-1,this.ptype1=-1,this.ptype2=-1,this.psize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.menuSize=0,this.menuVisible=!1,this.sceneLoadStartTime=performance.now(),this.botOverlay)this.botOverlay.show()}else if(b===16)this.loginMessage0="Login attempts exceeded.",this.loginMessage1="Please wait 1 minute and try again.";else if(b===17)this.loginMessage0="You are standing in a members-only area.",this.loginMessage1="To play on this world move to a free area first";else if(b===20)this.loginMessage0="Invalid loginserver requested",this.loginMessage1="Please try using a different world.";else this.loginMessage0="Unexpected server response",this.loginMessage1="Please try using a different world."}catch(u){this.loginMessage0="",this.loginMessage1="Error connecting to server."}}async logout(){if(this.stream)this.stream.close();if(this.stream=null,this.ingame=!1,this.titleScreenState=0,this.username="",this.password="",this.botOverlay)this.botOverlay.hide();b0.setDisabled(),this.clearCache(),this.scene?.reset();for(let _=0;_<4;_++)this.levelCollisionMap[_]?.reset();N_(!1),this.nextMidiSong=-1,this.midiSong=-1,this.nextMusicDelay=0}clearCache(){o.modelCacheStatic?.clear(),o.modelCacheDynamic?.clear(),A0.modelCache?.clear(),x.modelCache?.clear(),x.iconCache?.clear(),J0.modelCache?.clear(),q0.modelCache?.clear()}prepareGame(){if(this.areaChatback)return;this.unloadTitle(),this.drawArea=null,this.imageTitle2=null,this.imageTitle3=null,this.imageTitle4=null,this.imageTitle0=null,this.imageTitle1=null,this.imageTitle5=null,this.imageTitle6=null,this.imageTitle7=null,this.imageTitle8=null,this.areaChatback=new H0(479,96),this.areaMapback=new H0(172,156),I.clear(),this.imageMapback?.draw(0,0),this.areaSidebar=new H0(190,261),this.areaViewport=new H0(512,334),I.clear(),this.areaBackbase1=new H0(496,50),this.areaBackbase2=new H0(269,37),this.areaBackhmid1=new H0(249,45),this.redrawFrame=!0}async updateGame(){if(this.players===null)return;if(this.systemUpdateTimer>1)this.systemUpdateTimer--;if(this.idleTimeout>0)this.idleTimeout--;if(this.field1264>0)this.field1264-=2;for(let _=0;_<5&&await this.readPacket();_++);if(this.ingame){this.updateSceneState(),this.updateLocChanges(),await this.updateAudio();let _=b0.flush();if(_)this.out.p1isaac(19),this.out.p2(_.pos),this.out.pdata(_.data,_.pos,0),_.release();if(this.idleNetCycles++,this.idleNetCycles>250)await this.tryReconnect();if(this.updatePlayers(),this.updateNpcs(),this.updateEntityChats(),this.sceneDelta++,this.crossMode!==0){if(this.crossCycle+=20,this.crossCycle>=400)this.crossMode=0}if(this.selectedArea!==0){if(this.selectedCycle++,this.selectedCycle>=15){if(this.selectedArea===2)this.redrawSidebar=!0;else if(this.selectedArea===3)this.redrawChatback=!0;this.selectedArea=0}}if(this.objDragArea!==0){if(this.objDragCycles++,this.mouseX>this.objGrabX+5||this.mouseX<this.objGrabX-5||this.mouseY>this.objGrabY+5||this.mouseY<this.objGrabY-5)this.objGrabThreshold=!0;if(this.mouseButton===0){if(this.objDragArea===2)this.redrawSidebar=!0;else if(this.objDragArea===3)this.redrawChatback=!0;if(this.objDragArea=0,this.objGrabThreshold&&this.objDragCycles>=5){if(this.hoveredSlotParentId=-1,this.handleInput(),this.hoveredSlotParentId===this.objDragInterfaceId&&this.hoveredSlot!==this.objDragSlot){let E=g.types[this.objDragInterfaceId],u=0;if(this.bankArrangeMode==1&&E.clientCode==206)u=1;if(E.invSlotObjId&&E.invSlotObjId[this.hoveredSlot]<=0)u=0;if(E.swappable&&E.invSlotObjId&&E.invSlotObjCount){let O=this.objDragSlot,b=this.hoveredSlot;E.invSlotObjId[b]=E.invSlotObjId[O],E.invSlotObjCount[b]=E.invSlotObjCount[O],E.invSlotObjId[O]=-1,E.invSlotObjCount[O]=0}else if(u==1){let O=this.objDragSlot,b=this.hoveredSlot;while(O!=b)if(O>b)E.swapObj(O,O-1),O--;else if(O<b)E.swapObj(O,O+1),O++}else E.swapObj(this.objDragSlot,this.hoveredSlot);this.out.p1isaac(7),this.out.p2(this.objDragInterfaceId),this.out.p2(this.objDragSlot),this.out.p2(this.hoveredSlot),this.out.p1(u)}}else if((this.oneMouseButton===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)this.showContextMenu();else if(this.menuSize>0)this.useMenuOption(this.menuSize-1);this.selectedCycle=10,this.mouseClickButton=0}}if(s.cyclelogic3++,s.cyclelogic3>127)s.cyclelogic3=0,this.out.p1isaac(181),this.out.p3(4991788);if(V.clickTileX!==-1){if(this.localPlayer){let E=V.clickTileX,u=V.clickTileZ,O=this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E,u,0,0,0,0,0,0,!0);if(V.clickTileX=-1,O)this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=1,this.crossCycle=0}}if(this.mouseClickButton===1&&this.modalMessage)this.modalMessage=null,this.redrawChatback=!0,this.mouseClickButton=0;if(!this.isMobile||this.isMobile&&!F0.isWithinCanvasKeyboard(this.mouseClickX,this.mouseClickY))this.handleMouseInput(),this.handleMinimapInput(),this.handleTabInput(),this.handleChatModeInput();if(this.mouseButton===1||this.mouseClickButton===1)this.dragCycles++;if(this.sceneState===2)this.updateOrbitCamera();if(this.sceneState===2&&this.cutscene)this.applyCutscene();for(let E=0;E<5;E++)this.cameraModifierCycle[E]++;if(await this.handleInputKey(),performance.now()-this.idleCycles>600000)this.idleTimeout=250,this.idleCycles=performance.now()-1e4,this.out.p1isaac(102);if(this.macroCameraCycle++,this.macroCameraCycle>500){this.macroCameraCycle=0;let E=Math.random()*8|0;if((E&1)===1)this.macroCameraX+=this.macroCameraXModifier;if((E&2)===2)this.macroCameraZ+=this.macroCameraZModifier;if((E&4)===4)this.macroCameraAngle+=this.macroCameraAngleModifier}if(this.macroCameraX<-50)this.macroCameraXModifier=2;else if(this.macroCameraX>50)this.macroCameraXModifier=-2;if(this.macroCameraZ<-55)this.macroCameraZModifier=2;else if(this.macroCameraZ>55)this.macroCameraZModifier=-2;if(this.macroCameraAngle<-40)this.macroCameraAngleModifier=1;else if(this.macroCameraAngle>40)this.macroCameraAngleModifier=-1;if(this.macroMinimapCycle++,this.macroMinimapCycle>500){this.macroMinimapCycle=0;let E=Math.random()*8|0;if((E&1)===1)this.macroMinimapAngle+=this.macroMinimapAngleModifier;if((E&2)===2)this.macroMinimapZoom+=this.macroMinimapZoomModifier}if(this.macroMinimapAngle<-60)this.macroMinimapAngleModifier=2;else if(this.macroMinimapAngle>60)this.macroMinimapAngleModifier=-2;if(this.macroMinimapZoom<-20)this.macroMinimapZoomModifier=1;else if(this.macroMinimapZoom>10)this.macroMinimapZoomModifier=-1;if(s.cyclelogic4++,s.cyclelogic4>110)s.cyclelogic4=0,this.out.p1isaac(94),this.out.p4(0);if(this.noTimeoutCycle++,this.noTimeoutCycle>50)this.out.p1isaac(206);try{if(this.stream&&this.out.pos>0){if(this.packetLogEnabled){let E=Array.from(this.out.data.slice(0,this.out.pos));this.logPacket(this.currentPacketOpcode,E)}this.stream.write(this.out.data,this.out.pos),this.out.pos=0,this.noTimeoutCycle=0}}catch(E){await this.tryReconnect()}}}async tryReconnect(){if(this.idleTimeout>0){await this.logout();return}if(this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,144,"Connection lost",0),this.fontPlain12?.drawStringCenter(256,143,"Connection lost",16777215),this.fontPlain12?.drawStringCenter(257,159,"Please wait - attempting to reestablish",0),this.fontPlain12?.drawStringCenter(256,158,"Please wait - attempting to reestablish",16777215),this.areaViewport?.draw(4,4),this.flagSceneTileX=0,this.stream?.close(),this.ingame=!1,await this.login(this.username,this.password,!0),!this.ingame)await this.logout()}updateSceneState(){if(s.lowMemory&&this.sceneState===2&&i.levelBuilt!==this.currentLevel)this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(4,4),this.sceneState=1;if(this.sceneState===1){if(this.checkScene()!=0&&performance.now()-this.sceneLoadStartTime>360000)this.sceneLoadStartTime=performance.now()}if(this.sceneState===2&&this.currentLevel!==this.minimapLevel)this.minimapLevel=this.currentLevel,this.createMinimap(this.currentLevel)}checkScene(){if(!this.sceneMapIndex||!this.sceneMapLandData||!this.sceneMapLocData)return-1000;for(let R=0;R<this.sceneMapLandData.length;R++){if(this.sceneMapLandData[R]==null&&this.sceneMapLandFile[R]!==-1)return-1;if(this.sceneMapLocData[R]==null&&this.sceneMapLocFile[R]!==-1)return-2}let _=!0;for(let R=0;R<this.sceneMapLandData.length;R++){let E=this.sceneMapLocData[R];if(E!=null){let u=(this.sceneMapIndex[R]>>8)*64-this.sceneBaseTileX,O=(this.sceneMapIndex[R]&255)*64-this.sceneBaseTileZ;_&&=i.locsAreReady(E,u,O)}}if(!_)return-3;else if(this.awaitingSync)return-4;return this.sceneState=2,i.levelBuilt=this.currentLevel,this.buildScene(),0}buildScene(){try{this.minimapLevel=-1,this.spotanims.clear(),this.projectiles.clear(),X.clearTexels(),this.clearCache(),this.scene?.reset();for(let L=0;L<4;L++)this.levelCollisionMap[L]?.reset();let O=new i(104,104,this.levelHeightmap,this.levelTileFlags);i.lowMemory=V.lowMemory;let b=this.sceneMapLandData?.length??0;if(this.sceneMapIndex)for(let L=0;L<b;L++){let N=this.sceneMapIndex[L]>>8,G=this.sceneMapIndex[L]&255;if(N===33&&G>=71&&G<=73){i.lowMemory=!1;break}}if(s.lowMemory)this.scene?.setMinLevel(this.currentLevel);else this.scene?.setMinLevel(0);if(this.sceneMapIndex&&this.sceneMapLandData){this.out.p1isaac(206);for(let L=0;L<b;L++){let N=(this.sceneMapIndex[L]>>8)*64-this.sceneBaseTileX,G=(this.sceneMapIndex[L]&255)*64-this.sceneBaseTileZ,H=this.sceneMapLandData[L];if(H)O.loadGround((this.sceneCenterZoneX-6)*8,(this.sceneCenterZoneZ-6)*8,N,G,H)}for(let L=0;L<b;L++){let N=(this.sceneMapIndex[L]>>8)*64-this.sceneBaseTileX,G=(this.sceneMapIndex[L]&255)*64-this.sceneBaseTileZ;if(!this.sceneMapLandData[L]&&this.sceneCenterZoneZ<800)O.spreadHeight(G,N,64,64)}}if(this.sceneMapIndex&&this.sceneMapLocData){this.out.p1isaac(206);for(let L=0;L<b;L++){let N=this.sceneMapLocData[L];if(N){let G=(this.sceneMapIndex[L]>>8)*64-this.sceneBaseTileX,H=(this.sceneMapIndex[L]&255)*64-this.sceneBaseTileZ;O.loadLocations(this.loopCycle,this.scene,this.levelCollisionMap,N,G,H)}}}this.out.p1isaac(206),O.build(this.scene,this.levelCollisionMap),this.areaViewport?.bind(),this.out.p1isaac(206);for(let L=0;L<104;L++)for(let N=0;N<104;N++)this.sortObjStacks(L,N);this.clearLocChanges()}catch(O){}if(o.modelCacheStatic?.clear(),s.lowMemory&&this.db){let O=this.onDemand?.getFileCount(0)??0;for(let b=0;b<O;b++)if(((this.onDemand?.getModelFlags(b)??0)&121)==0)U.unload(b)}X.initPool(20),this.onDemand?.clearPrefetches();let _=(this.sceneCenterZoneX-6)/8-1,R=(this.sceneCenterZoneX+6)/8+1,E=(this.sceneCenterZoneZ-6)/8-1,u=(this.sceneCenterZoneZ+6)/8+1;if(this.withinTutorialIsland)_=49,R=50,E=49,u=50;for(let O=_;O<=R;O++)for(let b=E;b<=u;b++)if(_==O||R==O||E==b||u==b){let L=this.onDemand?.getMapFile(b,O,0)??-1;if(L!=-1)this.onDemand?.prefetch(3,L);let N=this.onDemand?.getMapFile(b,O,1)??-1;if(N!=-1)this.onDemand?.prefetch(3,N)}}clearLocChanges(){for(let _=this.locChanges.head();_;_=this.locChanges.next())if(_.endTime===-1)_.startTime=0,this.storeLoc(_);else _.unlink()}createMinimap(_){if(!this.imageMinimap)return;let R=this.imageMinimap.pixels,E=R.length;for(let b=0;b<E;b++)R[b]=0;for(let b=1;b<104-1;b++){let L=(104-1-b)*512*4+24628;for(let N=1;N<104-1;N++){if(this.levelTileFlags&&(this.levelTileFlags[_][N][b]&24)===0)this.scene?.drawMinimapTile(_,N,b,R,L,512);if(_<3&&this.levelTileFlags&&(this.levelTileFlags[_+1][N][b]&8)!==0)this.scene?.drawMinimapTile(_+1,N,b,R,L,512);L+=4}}let u=((Math.random()*20|0)+238-10<<16)+((Math.random()*20|0)+238-10<<8)+(Math.random()*20|0)+238-10,O=(Math.random()*20|0)+238-10<<16;this.imageMinimap.bind();for(let b=1;b<104-1;b++)for(let L=1;L<104-1;L++){if(this.levelTileFlags&&(this.levelTileFlags[_][L][b]&24)===0)this.drawMinimapLoc(L,b,_,u,O);if(_<3&&this.levelTileFlags&&(this.levelTileFlags[_+1][L][b]&8)!==0)this.drawMinimapLoc(L,b,_+1,u,O)}this.areaViewport?.bind(),this.activeMapFunctionCount=0;for(let b=0;b<104;b++)for(let L=0;L<104;L++){let N=this.scene?.getGroundDecorTypecode(this.currentLevel,b,L)??0;if(N===0)continue;let G=N>>14&32767,H=o.get(G).mapfunction;if(H<0)continue;let Q=b,$=L;if(H!==22&&H!==29&&H!==34&&H!==36&&H!==46&&H!==47&&H!==48){let J=104,T=104,m=this.levelCollisionMap[this.currentLevel];if(m){let q=m.flags;for(let K=0;K<10;K++){let F=Math.random()*4|0;if(F===0&&Q>0&&Q>b-3&&(q[_0.index(Q-1,$)]&2621704)===0)Q--;if(F===1&&Q<J-1&&Q<b+3&&(q[_0.index(Q+1,$)]&2621824)===0)Q++;if(F===2&&$>0&&$>L-3&&(q[_0.index(Q,$-1)]&2621698)===0)$--;if(F===3&&$<T-1&&$<L+3&&(q[_0.index(Q,$+1)]&2621728)===0)$++}}}this.activeMapFunctions[this.activeMapFunctionCount]=this.imageMapfunction[H],this.activeMapFunctionX[this.activeMapFunctionCount]=Q,this.activeMapFunctionZ[this.activeMapFunctionCount]=$,this.activeMapFunctionCount++}}updateLocChanges(){if(this.sceneState!==2)return;for(let _=this.locChanges.head();_;_=this.locChanges.next()){if(_.endTime>0)_.endTime--;if(_.endTime!=0){if(_.startTime>0)_.startTime--;if(_.startTime===0&&_.x>=1&&_.z>=1&&_.x<=102&&_.z<=102&&(_.newType<0||i.isLocReady(_.newType,_.newShape))){if(this.addLoc(_.level,_.x,_.z,_.newType,_.newAngle,_.newShape,_.layer),_.startTime=-1,_.oldType===_.newType&&_.oldType===-1)_.unlink();else if(_.oldType===_.newType&&_.oldAngle===_.newAngle&&_.oldShape===_.newShape)_.unlink()}}else if(_.oldType<0||i.isLocReady(_.oldType,_.oldShape))this.addLoc(_.level,_.x,_.z,_.oldType,_.oldAngle,_.oldShape,_.layer),_.unlink()}if(s.cyclelogic5++,s.cyclelogic5>85)s.cyclelogic5=0,this.out.p1isaac(63)}async updateAudio(){for(let _=0;_<this.waveCount;_++)if(this.waveDelay[_]<=0){try{let R=O0.generate(this.waveIds[_],this.waveLoops[_]);if(!R)throw Error();if(performance.now()+(R.pos/22|0)>this.lastWaveStartTime+(this.lastWaveLength/22|0))this.lastWaveLength=R.pos,this.lastWaveStartTime=performance.now(),this.lastWaveId=this.waveIds[_],this.lastWaveLoops=this.waveLoops[_],await k_(R.data.slice(0,R.pos))}catch(R){}this.waveCount--;for(let R=_;R<this.waveCount;R++)this.waveIds[R]=this.waveIds[R+1],this.waveLoops[R]=this.waveLoops[R+1],this.waveDelay[R]=this.waveDelay[R+1];_--}else this.waveDelay[_]--;if(this.nextMusicDelay>0){if(this.nextMusicDelay-=20,this.nextMusicDelay<0)this.nextMusicDelay=0;if(this.nextMusicDelay===0&&this.midiActive&&!s.lowMemory)this.midiSong=this.nextMidiSong,this.midiFading=!1,this.onDemand?.request(2,this.midiSong)}}handleInput(){if(this.objDragArea!==0)return;if(this.menuOption[0]="Cancel",this.menuAction[0]=1252,this.menuSize=1,this.handlePrivateChatInput(),this.lastHoveredInterfaceId=0,this.mouseX>4&&this.mouseY>4&&this.mouseX<516&&this.mouseY<338)if(this.viewportInterfaceId===-1)this.handleViewportOptions();else this.handleInterfaceInput(g.types[this.viewportInterfaceId],this.mouseX,this.mouseY,4,4,0);if(this.lastHoveredInterfaceId!==this.viewportHoveredInterfaceIndex)this.viewportHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>553&&this.mouseY>205&&this.mouseX<743&&this.mouseY<466){if(this.sidebarInterfaceId!==-1)this.handleInterfaceInput(g.types[this.sidebarInterfaceId],this.mouseX,this.mouseY,553,205,0);else if(this.tabInterfaceId[this.selectedTab]!==-1)this.handleInterfaceInput(g.types[this.tabInterfaceId[this.selectedTab]],this.mouseX,this.mouseY,553,205,0)}if(this.lastHoveredInterfaceId!==this.sidebarHoveredInterfaceIndex)this.redrawSidebar=!0,this.sidebarHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>17&&this.mouseY>357&&this.mouseX<426&&this.mouseY<453){if(this.chatInterfaceId!==-1)this.handleInterfaceInput(g.types[this.chatInterfaceId],this.mouseX,this.mouseY,17,357,0);else if(this.mouseY<434)this.handleChatMouseInput(this.mouseX-17,this.mouseY-357)}if(this.chatInterfaceId!==-1&&this.lastHoveredInterfaceId!==this.chatHoveredInterfaceIndex)this.redrawChatback=!0,this.chatHoveredInterfaceIndex=this.lastHoveredInterfaceId;let _=!1;while(!_){_=!0;for(let R=0;R<this.menuSize-1;R++)if(this.menuAction[R]<1000&&this.menuAction[R+1]>1000){let E=this.menuOption[R];this.menuOption[R]=this.menuOption[R+1],this.menuOption[R+1]=E;let u=this.menuAction[R];this.menuAction[R]=this.menuAction[R+1],this.menuAction[R+1]=u;let O=this.menuParamB[R];this.menuParamB[R]=this.menuParamB[R+1],this.menuParamB[R+1]=O;let b=this.menuParamC[R];this.menuParamC[R]=this.menuParamC[R+1],this.menuParamC[R+1]=b;let L=this.menuParamA[R];this.menuParamA[R]=this.menuParamA[R+1],this.menuParamA[R+1]=L,_=!1}}}handlePrivateChatInput(){if(this.splitPrivateChat===0)return;let _=0;if(this.systemUpdateTimer!==0)_=1;for(let R=0;R<100;R++)if(this.messageText[R]!==null){let E=this.messageType[R],u=this.messageSender[R],O=!1;if(u&&u.startsWith("@cr1@"))u=u.substring(5),O=!0;else if(u&&u.startsWith("@cr2@"))u=u.substring(5),O=!0;if((E===3||E===7)&&(E===7||this.chatPrivateMode===0||this.chatPrivateMode===1&&this.isFriend(u))){let b=329-_*13;if(this.mouseX>4&&this.mouseX<516&&this.mouseY-4>b-10&&this.mouseY-4<=b+3){if(this.staffmodlevel)this.menuOption[this.menuSize]="Report abuse @whi@"+u,this.menuAction[this.menuSize]=2034,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+u,this.menuAction[this.menuSize]=2436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+u,this.menuAction[this.menuSize]=2406,this.menuSize++}if(_++,_>=5)return}else if((E===5||E===6)&&this.chatPrivateMode<2){if(_++,_>=5)return}}}handleChatMouseInput(_,R){let E=0;for(let u=0;u<100;u++){if(!this.messageText[u])continue;let O=this.messageType[u],b=this.chatScrollOffset+70+4-E*14;if(b<-20)break;let L=this.messageSender[u],N=!1;if(L&&L.startsWith("@cr1@"))L=L.substring(5),N=!0;else if(L&&L.startsWith("@cr2@"))L=L.substring(5),N=!0;if(O===0)E++;else if((O==1||O==2)&&(O==1||this.chatPublicMode==0||this.chatPublicMode==1&&this.isFriend(L))){if(R>b-14&&R<=b&&this.localPlayer&&L!==this.localPlayer.name){if(this.staffmodlevel>=1)this.menuOption[this.menuSize]="Report abuse @whi@"+L,this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+L,this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+L,this.menuAction[this.menuSize]=406,this.menuSize++}E++}else if((O===3||O===7)&&this.splitPrivateChat===0&&(O===7||this.chatPrivateMode===0||this.chatPrivateMode===1&&this.isFriend(L))){if(R>b-14&&R<=b){if(this.staffmodlevel>=1)this.menuOption[this.menuSize]="Report abuse @whi@"+L,this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+L,this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+L,this.menuAction[this.menuSize]=406,this.menuSize++}E++}else if(O===4&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(L))){if(R>b-14&&R<=b)this.menuOption[this.menuSize]="Accept trade @whi@"+L,this.menuAction[this.menuSize]=903,this.menuSize++;E++}else if((O===5||O===6)&&this.splitPrivateChat===0&&this.chatPrivateMode<2)E++;else if(O===8&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(L))){if(R>b-14&&R<=b)this.menuOption[this.menuSize]="Accept duel @whi@"+L,this.menuAction[this.menuSize]=363,this.menuSize++;E++}}}handleViewportOptions(){if(this.objSelected===0&&this.spellSelected===0)this.menuOption[this.menuSize]="Walk here",this.menuAction[this.menuSize]=660,this.menuParamB[this.menuSize]=this.mouseX,this.menuParamC[this.menuSize]=this.mouseY,this.menuSize++;let _=-1;for(let R=0;R<U.pickedCount;R++){let E=U.pickedBitsets[R],u=E&127,O=E>>7&127,b=E>>29&3,L=E>>14&32767;if(E===_)continue;if(_=E,b===2&&this.scene&&this.scene.getInfo(this.currentLevel,u,O,E)>=0){let N=o.get(L);if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @cya@"+N.name,this.menuAction[this.menuSize]=450,this.menuParamA[this.menuSize]=E,this.menuParamB[this.menuSize]=u,this.menuParamC[this.menuSize]=O,this.menuSize++;else if(this.spellSelected!==1){if(N.op){for(let G=4;G>=0;G--)if(N.op[G]){if(this.menuOption[this.menuSize]=N.op[G]+" @cya@"+N.name,G===0)this.menuAction[this.menuSize]=285;else if(G===1)this.menuAction[this.menuSize]=504;else if(G===2)this.menuAction[this.menuSize]=364;else if(G===3)this.menuAction[this.menuSize]=581;else if(G===4)this.menuAction[this.menuSize]=1501;this.menuParamA[this.menuSize]=E,this.menuParamB[this.menuSize]=u,this.menuParamC[this.menuSize]=O,this.menuSize++}}this.menuOption[this.menuSize]="Examine @cya@"+N.name,this.menuAction[this.menuSize]=1175,this.menuParamA[this.menuSize]=E,this.menuParamB[this.menuSize]=u,this.menuParamC[this.menuSize]=O,this.menuSize++}else if((this.activeSpellFlags&4)===4)this.menuOption[this.menuSize]=this.spellCaption+" @cya@"+N.name,this.menuAction[this.menuSize]=55,this.menuParamA[this.menuSize]=E,this.menuParamB[this.menuSize]=u,this.menuParamC[this.menuSize]=O,this.menuSize++}else if(b===1){let N=this.npcs[L];if(N&&N.type&&N.type.size===1&&(N.x&127)===64&&(N.z&127)===64)for(let G=0;G<this.npcCount;G++){let H=this.npcs[this.npcIds[G]];if(H&&H!==N&&H.type&&H.type.size===1&&H.x===N.x&&H.z===N.z)this.addNpcOptions(H.type,this.npcIds[G],u,O)}if(N&&N.type)this.addNpcOptions(N.type,L,u,O)}else if(b===0){let N=this.players[L];if(N&&(N.x&127)===64&&(N.z&127)===64){for(let G=0;G<this.npcCount;G++){let H=this.npcs[this.npcIds[G]];if(H&&H.type&&H.type.size===1&&H.x===N.x&&H.z===N.z)this.addNpcOptions(H.type,this.npcIds[G],u,O)}for(let G=0;G<this.playerCount;G++){let H=this.players[this.playerIds[G]];if(H&&H!==N&&H.x===N.x&&H.z===N.z)this.addPlayerOptions(H,this.playerIds[G],u,O)}}if(N)this.addPlayerOptions(N,L,u,O)}else if(b===3){let N=this.objStacks[this.currentLevel][u][O];if(!N)continue;for(let G=N.tail();G;G=N.prev()){let H=x.get(G.index);if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+H.name,this.menuAction[this.menuSize]=217,this.menuParamA[this.menuSize]=G.index,this.menuParamB[this.menuSize]=u,this.menuParamC[this.menuSize]=O,this.menuSize++;else if(this.spellSelected!==1){for(let Q=4;Q>=0;Q--)if(H.op&&H.op[Q]){if(this.menuOption[this.menuSize]=H.op[Q]+" @lre@"+H.name,Q===0)this.menuAction[this.menuSize]=224;else if(Q===1)this.menuAction[this.menuSize]=993;else if(Q===2)this.menuAction[this.menuSize]=99;else if(Q===3)this.menuAction[this.menuSize]=746;else if(Q===4)this.menuAction[this.menuSize]=877;this.menuParamA[this.menuSize]=G.index,this.menuParamB[this.menuSize]=u,this.menuParamC[this.menuSize]=O,this.menuSize++}else if(Q===2)this.menuOption[this.menuSize]="Take @lre@"+H.name,this.menuAction[this.menuSize]=99,this.menuParamA[this.menuSize]=G.index,this.menuParamB[this.menuSize]=u,this.menuParamC[this.menuSize]=O,this.menuSize++;this.menuOption[this.menuSize]="Examine @lre@"+H.name,this.menuAction[this.menuSize]=1102,this.menuParamA[this.menuSize]=G.index,this.menuParamB[this.menuSize]=u,this.menuParamC[this.menuSize]=O,this.menuSize++}else if((this.activeSpellFlags&1)===1)this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+H.name,this.menuAction[this.menuSize]=965,this.menuParamA[this.menuSize]=G.index,this.menuParamB[this.menuSize]=u,this.menuParamC[this.menuSize]=O,this.menuSize++}}}}handleMouseInput(){if(this.objDragArea!==0)return;if(this.isMobile&&this.chatbackInputOpen&&this.insideChatPopupArea())return;let _=this.mouseClickButton;if(this.spellSelected===1&&this.mouseClickX>=516&&this.mouseClickY>=160&&this.mouseClickX<=765&&this.mouseClickY<=205)_=0;if(!this.menuVisible){if(_===1&&this.menuSize>0){let R=this.menuAction[this.menuSize-1];if(R==602||R==596||R==22||R==892||R==415||R==405||R==38||R==422||R==478||R==347||R==188){let E=this.menuParamB[this.menuSize-1],u=this.menuParamC[this.menuSize-1],O=g.types[u];if(O.draggable||O.swappable){if(this.objGrabThreshold=!1,this.objDragCycles=0,this.objDragInterfaceId=u,this.objDragSlot=E,this.objDragArea=2,this.objGrabX=this.mouseClickX,this.objGrabY=this.mouseClickY,g.types[u].layer===this.viewportInterfaceId)this.objDragArea=1;if(g.types[u].layer===this.chatInterfaceId)this.objDragArea=3;return}}}if(_===1&&(this.oneMouseButton===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)_=2;if(_===1&&this.menuSize>0)this.useMenuOption(this.menuSize-1);else if(_==2&&this.menuSize>0)this.showContextMenu();return}if(_===1){let R=this.menuX,E=this.menuY,u=this.menuWidth,O=this.mouseClickX,b=this.mouseClickY;if(this.menuArea===0)O-=4,b-=4;else if(this.menuArea===1)O-=553,b-=205;else if(this.menuArea===2)O-=17,b-=357;let L=-1;for(let N=0;N<this.menuSize;N++){let G=E+(this.menuSize-1-N)*15+31;if(O>R&&O<R+u&&b>G-13&&b<G+3)L=N}if(L!==-1)this.useMenuOption(L);if(this.menuVisible=!1,this.menuArea===1)this.redrawSidebar=!0;else if(this.menuArea===2)this.redrawChatback=!0}else{let R=this.mouseX,E=this.mouseY;if(this.menuArea===0)R-=4,E-=4;else if(this.menuArea===1)R-=553,E-=205;else if(this.menuArea===2)R-=17,E-=357;if(R<this.menuX-10||R>this.menuX+this.menuWidth+10||E<this.menuY-10||E>this.menuY+this.menuHeight+10){if(this.menuVisible=!1,this.menuArea===1)this.redrawSidebar=!0;if(this.menuArea===2)this.redrawChatback=!0}}}handleMinimapInput(){if(this.mouseClickButton!==1||!this.localPlayer)return;let _=this.mouseClickX-25-550,R=this.mouseClickY-4-4;if(_<0||R<0||_>=146||R>=151)return;_-=73,R-=75;let E=this.orbitCameraYaw+this.macroMinimapAngle&2047,u=X.sinTable[E],O=X.cosTable[E];u=u*(this.macroMinimapZoom+256)>>8,O=O*(this.macroMinimapZoom+256)>>8;let b=R*u+_*O>>11,L=R*O-_*u>>11,N=this.localPlayer.x+b>>7,G=this.localPlayer.z-L>>7;if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],N,G,1,0,0,0,0,0,!0))this.out.p1(_),this.out.p1(R),this.out.p2(this.orbitCameraYaw),this.out.p1(57),this.out.p1(this.macroMinimapAngle),this.out.p1(this.macroMinimapZoom),this.out.p1(89),this.out.p2(this.localPlayer.x),this.out.p2(this.localPlayer.z),this.out.p1(this.tryMoveNearest),this.out.p1(63)}handleTabInput(){if(this.mouseClickButton!==1)return;if(this.mouseClickX>=539&&this.mouseClickX<=573&&this.mouseClickY>=169&&this.mouseClickY<205&&this.tabInterfaceId[0]!=-1)this.redrawSidebar=!0,this.selectedTab=0,this.redrawSideicons=!0;else if(this.mouseClickX>=569&&this.mouseClickX<=599&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[1]!=-1)this.redrawSidebar=!0,this.selectedTab=1,this.redrawSideicons=!0;else if(this.mouseClickX>=597&&this.mouseClickX<=627&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[2]!=-1)this.redrawSidebar=!0,this.selectedTab=2,this.redrawSideicons=!0;else if(this.mouseClickX>=625&&this.mouseClickX<=669&&this.mouseClickY>=168&&this.mouseClickY<203&&this.tabInterfaceId[3]!=-1)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;else if(this.mouseClickX>=666&&this.mouseClickX<=696&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[4]!=-1)this.redrawSidebar=!0,this.selectedTab=4,this.redrawSideicons=!0;else if(this.mouseClickX>=694&&this.mouseClickX<=724&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[5]!=-1)this.redrawSidebar=!0,this.selectedTab=5,this.redrawSideicons=!0;else if(this.mouseClickX>=722&&this.mouseClickX<=756&&this.mouseClickY>=169&&this.mouseClickY<205&&this.tabInterfaceId[6]!=-1)this.redrawSidebar=!0,this.selectedTab=6,this.redrawSideicons=!0;else if(this.mouseClickX>=540&&this.mouseClickX<=574&&this.mouseClickY>=466&&this.mouseClickY<502&&this.tabInterfaceId[7]!=-1)this.redrawSidebar=!0,this.selectedTab=7,this.redrawSideicons=!0;else if(this.mouseClickX>=572&&this.mouseClickX<=602&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[8]!=-1)this.redrawSidebar=!0,this.selectedTab=8,this.redrawSideicons=!0;else if(this.mouseClickX>=599&&this.mouseClickX<=629&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[9]!=-1)this.redrawSidebar=!0,this.selectedTab=9,this.redrawSideicons=!0;else if(this.mouseClickX>=627&&this.mouseClickX<=671&&this.mouseClickY>=467&&this.mouseClickY<502&&this.tabInterfaceId[10]!=-1)this.redrawSidebar=!0,this.selectedTab=10,this.redrawSideicons=!0;else if(this.mouseClickX>=669&&this.mouseClickX<=699&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[11]!=-1)this.redrawSidebar=!0,this.selectedTab=11,this.redrawSideicons=!0;else if(this.mouseClickX>=696&&this.mouseClickX<=726&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[12]!=-1)this.redrawSidebar=!0,this.selectedTab=12,this.redrawSideicons=!0;else if(this.mouseClickX>=724&&this.mouseClickX<=758&&this.mouseClickY>=466&&this.mouseClickY<502&&this.tabInterfaceId[13]!=-1)this.redrawSidebar=!0,this.selectedTab=13,this.redrawSideicons=!0;if(s.cyclelogic1++,s.cyclelogic1>150)s.cyclelogic1=0,this.out.p1isaac(136),this.out.p1(43)}handleChatModeInput(){if(this.mouseClickButton!==1)return;if(this.mouseClickX>=6&&this.mouseClickX<=106&&this.mouseClickY>=467&&this.mouseClickY<=499)this.chatPublicMode=(this.chatPublicMode+1)%4,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(8),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode);else if(this.mouseClickX>=135&&this.mouseClickX<=235&&this.mouseClickY>=467&&this.mouseClickY<=499)this.chatPrivateMode=(this.chatPrivateMode+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(8),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode);else if(this.mouseClickX>=273&&this.mouseClickX<=373&&this.mouseClickY>=467&&this.mouseClickY<=499)this.chatTradeMode=(this.chatTradeMode+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(8),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode);else if(this.mouseClickX>=412&&this.mouseClickX<=512&&this.mouseClickY>=467&&this.mouseClickY<=499){this.closeInterfaces(),this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let _=0;_<g.types.length;_++)if(g.types[_]&&g.types[_].clientCode===600){this.reportAbuseInterfaceId=this.viewportInterfaceId=g.types[_].layer;break}if(this.isMobile)F0.show()}}closeInterfaces(){if(this.out.p1isaac(245),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.pressedContinueOption=!1,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0,this.pressedContinueOption=!1;this.viewportInterfaceId=-1}updateEntityChats(){for(let _=-1;_<this.playerCount;_++){let R;if(_===-1)R=2047;else R=this.playerIds[_];let E=this.players[R];if(E&&E.chatTimer>0){if(E.chatTimer--,E.chatTimer===0)E.chatMessage=null}}for(let _=0;_<this.npcCount;_++){let R=this.npcIds[_],E=this.npcs[R];if(E&&E.chatTimer>0){if(E.chatTimer--,E.chatTimer===0)E.chatMessage=null}}}updateOrbitCamera(){if(!this.localPlayer)return;let _=this.localPlayer.x+this.macroCameraX,R=this.localPlayer.z+this.macroCameraZ;if(this.orbitCameraX-_<-500||this.orbitCameraX-_>500||this.orbitCameraZ-R<-500||this.orbitCameraZ-R>500)this.orbitCameraX=_,this.orbitCameraZ=R;if(this.orbitCameraX!==_)this.orbitCameraX+=(_-this.orbitCameraX)/16|0;if(this.orbitCameraZ!==R)this.orbitCameraZ+=(R-this.orbitCameraZ)/16|0;if(this.actionKey[1]===1)this.orbitCameraYawVelocity+=(-this.orbitCameraYawVelocity-24)/2|0;else if(this.actionKey[2]===1)this.orbitCameraYawVelocity+=(24-this.orbitCameraYawVelocity)/2|0;else this.orbitCameraYawVelocity=this.orbitCameraYawVelocity/2|0;if(this.actionKey[3]===1)this.orbitCameraPitchVelocity+=(12-this.orbitCameraPitchVelocity)/2|0;else if(this.actionKey[4]===1)this.orbitCameraPitchVelocity+=(-this.orbitCameraPitchVelocity-12)/2|0;else this.orbitCameraPitchVelocity=this.orbitCameraPitchVelocity/2|0;if(this.orbitCameraYaw=(this.orbitCameraYaw+this.orbitCameraYawVelocity/2|0)&2047,this.orbitCameraPitch+=this.orbitCameraPitchVelocity/2|0,this.orbitCameraPitch<128)this.orbitCameraPitch=128;else if(this.orbitCameraPitch>383)this.orbitCameraPitch=383;let E=this.orbitCameraX>>7,u=this.orbitCameraZ>>7,O=this.getHeightmapY(this.currentLevel,this.orbitCameraX,this.orbitCameraZ),b=0;if(this.levelHeightmap){if(E>3&&u>3&&E<100&&u<100)for(let N=E-4;N<=E+4;N++)for(let G=u-4;G<=u+4;G++){let H=this.currentLevel;if(H<3&&this.levelTileFlags&&(this.levelTileFlags[1][N][G]&2)===2)H++;let Q=O-this.levelHeightmap[H][N][G];if(Q>b)b=Q}}let L=b*192;if(L>98048)L=98048;else if(L<32768)L=32768;if(L>this.cameraPitchClamp)this.cameraPitchClamp+=(L-this.cameraPitchClamp)/24|0;else if(L<this.cameraPitchClamp)this.cameraPitchClamp+=(L-this.cameraPitchClamp)/80|0}applyCutscene(){let _=this.cutsceneSrcLocalTileX*128+64,R=this.cutsceneSrcLocalTileZ*128+64,E=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;if(this.cameraX<_){if(this.cameraX+=this.cutsceneMoveSpeed+((_-this.cameraX)*this.cutsceneMoveAcceleration/1000|0),this.cameraX>_)this.cameraX=_}if(this.cameraX>_){if(this.cameraX-=this.cutsceneMoveSpeed+((this.cameraX-_)*this.cutsceneMoveAcceleration/1000|0),this.cameraX<_)this.cameraX=_}if(this.cameraY<E){if(this.cameraY+=this.cutsceneMoveSpeed+((E-this.cameraY)*this.cutsceneMoveAcceleration/1000|0),this.cameraY>E)this.cameraY=E}if(this.cameraY>E){if(this.cameraY-=this.cutsceneMoveSpeed+((this.cameraY-E)*this.cutsceneMoveAcceleration/1000|0),this.cameraY<E)this.cameraY=E}if(this.cameraZ<R){if(this.cameraZ+=this.cutsceneMoveSpeed+((R-this.cameraZ)*this.cutsceneMoveAcceleration/1000|0),this.cameraZ>R)this.cameraZ=R}if(this.cameraZ>R){if(this.cameraZ-=this.cutsceneMoveSpeed+((this.cameraZ-R)*this.cutsceneMoveAcceleration/1000|0),this.cameraZ<R)this.cameraZ=R}_=this.cutsceneDstLocalTileX*128+64,R=this.cutsceneDstLocalTileZ*128+64,E=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight;let u=_-this.cameraX,O=E-this.cameraY,b=R-this.cameraZ,L=Math.sqrt(u*u+b*b)|0,N=(Math.atan2(O,L)*325.949|0)&2047,G=(Math.atan2(u,b)*-325.949|0)&2047;if(N<128)N=128;else if(N>383)N=383;if(this.cameraPitch<N){if(this.cameraPitch+=this.cutsceneRotateSpeed+((N-this.cameraPitch)*this.cutsceneRotateAcceleration/1000|0),this.cameraPitch>N)this.cameraPitch=N}if(this.cameraPitch>N){if(this.cameraPitch-=this.cutsceneRotateSpeed+((this.cameraPitch-N)*this.cutsceneRotateAcceleration/1000|0),this.cameraPitch<N)this.cameraPitch=N}let H=G-this.cameraYaw;if(H>1024)H-=2048;else if(H<-1024)H+=2048;if(H>0)this.cameraYaw+=this.cutsceneRotateSpeed+(H*this.cutsceneRotateAcceleration/1000|0),this.cameraYaw&=2047;if(H<0)this.cameraYaw-=this.cutsceneRotateSpeed+(-H*this.cutsceneRotateAcceleration/1000|0),this.cameraYaw&=2047;let Q=G-this.cameraYaw;if(Q>1024)Q-=2048;else if(Q<-1024)Q+=2048;if(Q<0&&H>0||Q>0&&H<0)this.cameraYaw=G}async handleInputKey(){while(!0){let _;do while(!0){if(_=this.pollKey(),_===-1)return;if(this.viewportInterfaceId!==-1&&this.viewportInterfaceId===this.reportAbuseInterfaceId){if(_===8&&this.reportAbuseInput.length>0)this.reportAbuseInput=this.reportAbuseInput.substring(0,this.reportAbuseInput.length-1);break}if(this.showSocialInput){if(_>=32&&_<=122&&this.socialInput.length<80)this.socialInput=this.socialInput+String.fromCharCode(_),this.redrawChatback=!0;if(_===8&&this.socialInput.length>0)this.socialInput=this.socialInput.substring(0,this.socialInput.length-1),this.redrawChatback=!0;if(_===13||_===10){this.showSocialInput=!1,this.redrawChatback=!0;let R;if(this.socialInputType===1)R=c.toBase37(this.socialInput),this.addFriend(R);if(this.socialInputType===2&&this.friendCount>0)R=c.toBase37(this.socialInput),this.removeFriend(R);if(this.socialInputType===3&&this.socialInput.length>0&&this.socialName37){this.out.p1isaac(99),this.out.p1(0);let E=this.out.pos;if(this.out.p8(this.socialName37),g0.pack(this.out,this.socialInput),this.out.psize1(this.out.pos-E),this.socialInput=c.toSentenceCase(this.socialInput),this.socialInput=z0.filter(this.socialInput),this.addMessage(6,this.socialInput,c.formatName(c.fromBase37(this.socialName37))),this.chatPrivateMode===2)this.chatPrivateMode=1,this.redrawPrivacySettings=!0,this.out.p1isaac(8),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode)}if(this.socialInputType===4&&this.ignoreCount<100)R=c.toBase37(this.socialInput),this.addIgnore(R);if(this.socialInputType===5&&this.ignoreCount>0)R=c.toBase37(this.socialInput),this.removeIgnore(R)}}else if(this.chatbackInputOpen){if(_>=48&&_<=57&&this.chatbackInput.length<10)this.chatbackInput=this.chatbackInput+String.fromCharCode(_),this.redrawChatback=!0;if(_===8&&this.chatbackInput.length>0)this.chatbackInput=this.chatbackInput.substring(0,this.chatbackInput.length-1),this.redrawChatback=!0;if(_===13||_===10){if(this.chatbackInput.length>0){let R=0;try{R=parseInt(this.chatbackInput,10)}catch(E){}this.out.p1isaac(241),this.out.p4(R)}this.chatbackInputOpen=!1,this.redrawChatback=!0}}else if(this.chatInterfaceId===-1){if(_>=32&&(_<=122||this.chatTyped.startsWith("::")&&_<=126)&&this.chatTyped.length<80)this.chatTyped=this.chatTyped+String.fromCharCode(_),this.redrawChatback=!0;if(_===8&&this.chatTyped.length>0)this.chatTyped=this.chatTyped.substring(0,this.chatTyped.length-1),this.redrawChatback=!0;if((_===13||_===10)&&this.chatTyped.length>0){if(this.staffmodlevel===2){if(this.chatTyped==="::clientdrop")await this.tryReconnect();else if(this.chatTyped==="::prefetchmusic"){if(this.onDemand)for(let R=0;R<this.onDemand.getFileCount(2);R++)this.onDemand.prefetchPriority(2,R,1)}else if(this.chatTyped==="::lag")this.lag()}if(this.chatTyped==="::fpson")this.displayFps=!0;else if(this.chatTyped==="::fpsoff")this.displayFps=!1;else if(this.chatTyped.startsWith("::fps "))try{let R=parseInt(this.chatTyped.substring(6))||50;this.setTargetedFramerate(R)}catch(R){}else if(this.chatTyped.startsWith("::"))this.out.p1isaac(11),this.out.p1(this.chatTyped.length-1),this.out.pjstr(this.chatTyped.substring(2));else{let R=0;if(this.chatTyped.startsWith("yellow:"))R=0,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("red:"))R=1,this.chatTyped=this.chatTyped.substring(4);else if(this.chatTyped.startsWith("green:"))R=2,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("cyan:"))R=3,this.chatTyped=this.chatTyped.substring(5);else if(this.chatTyped.startsWith("purple:"))R=4,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("white:"))R=5,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("flash1:"))R=6,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash2:"))R=7,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash3:"))R=8,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("glow1:"))R=9,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow2:"))R=10,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow3:"))R=11,this.chatTyped=this.chatTyped.substring(6);let E=0;if(this.chatTyped.startsWith("wave:"))E=1,this.chatTyped=this.chatTyped.substring(5);if(this.chatTyped.startsWith("scroll:"))E=2,this.chatTyped=this.chatTyped.substring(7);this.out.p1isaac(78),this.out.p1(0);let u=this.out.pos;if(this.out.p1(R),this.out.p1(E),g0.pack(this.out,this.chatTyped),this.out.psize1(this.out.pos-u),this.chatTyped=c.toSentenceCase(this.chatTyped),this.chatTyped=z0.filter(this.chatTyped),this.localPlayer&&this.localPlayer.name)if(this.localPlayer.chatMessage=this.chatTyped,this.localPlayer.chatColour=R,this.localPlayer.chatEffect=E,this.localPlayer.chatTimer=150,this.staffmodlevel===2)this.addMessage(2,this.localPlayer.chatMessage,"@cr2@"+this.localPlayer.name);else if(this.staffmodlevel===1)this.addMessage(2,this.localPlayer.chatMessage,"@cr1@"+this.localPlayer.name);else this.addMessage(2,this.localPlayer.chatMessage,this.localPlayer.name);if(this.chatPublicMode===2)this.chatPublicMode=3,this.redrawPrivacySettings=!0,this.out.p1isaac(8),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode)}this.chatTyped="",this.redrawChatback=!0}}}while((_<97||_>122)&&(_<65||_>90)&&(_<48||_>57)&&_!==32);if(this.reportAbuseInput.length<12)this.reportAbuseInput=this.reportAbuseInput+String.fromCharCode(_)}}lag(){if(this.onDemand);}updatePlayers(){for(let _=-1;_<this.playerCount;_++){let R;if(_===-1)R=2047;else R=this.playerIds[_];let E=this.players[R];if(E)this.updateEntity(E)}if(s.cyclelogic6++,s.cyclelogic6>1406){s.cyclelogic6=0,this.out.p1isaac(112),this.out.p1(0);let _=this.out.pos;if(this.out.p1(162),this.out.p1(22),(Math.random()*2|0)===0)this.out.p1(84);if(this.out.p2(31824),this.out.p2(13490),(Math.random()*2|0)===0)this.out.p1(123);if((Math.random()*2|0)===0)this.out.p1(134);this.out.p1(100),this.out.p1(94),this.out.p2(35521),this.out.psize1(this.out.pos-_)}}updateNpcs(){for(let _=0;_<this.npcCount;_++){let R=this.npcIds[_],E=this.npcs[R];if(E&&E.type)this.updateEntity(E)}}updateEntity(_){if(_.x<128||_.z<128||_.x>=13184||_.z>=13184)_.primarySeqId=-1,_.spotanimId=-1,_.forceMoveEndCycle=0,_.forceMoveStartCycle=0,_.x=_.routeTileX[0]*128+_.size*64,_.z=_.routeTileZ[0]*128+_.size*64,_.clearRoute();if(_===this.localPlayer&&(_.x<1536||_.z<1536||_.x>=11776||_.z>=11776))_.primarySeqId=-1,_.spotanimId=-1,_.forceMoveEndCycle=0,_.forceMoveStartCycle=0,_.x=_.routeTileX[0]*128+_.size*64,_.z=_.routeTileZ[0]*128+_.size*64,_.clearRoute();if(_.forceMoveEndCycle>this.loopCycle)this.updateForceMovement(_);else if(_.forceMoveStartCycle>=this.loopCycle)this.startForceMovement(_);else this.updateMovement(_);this.updateFacingDirection(_),this.updateSequences(_)}updateForceMovement(_){let R=_.forceMoveEndCycle-this.loopCycle,E=_.forceMoveStartSceneTileX*128+_.size*64,u=_.forceMoveStartSceneTileZ*128+_.size*64;if(_.x+=(E-_.x)/R|0,_.z+=(u-_.z)/R|0,_.seqDelayMove=0,_.forceMoveFaceDirection===0)_.dstYaw=1024;else if(_.forceMoveFaceDirection===1)_.dstYaw=1536;else if(_.forceMoveFaceDirection===2)_.dstYaw=0;else if(_.forceMoveFaceDirection===3)_.dstYaw=512}startForceMovement(_){if(_.forceMoveStartCycle===this.loopCycle||_.primarySeqId===-1||_.primarySeqDelay!==0||_.primarySeqCycle+1>e.types[_.primarySeqId].getFrameDuration(_.primarySeqFrame)){let R=_.forceMoveStartCycle-_.forceMoveEndCycle,E=this.loopCycle-_.forceMoveEndCycle,u=_.forceMoveStartSceneTileX*128+_.size*64,O=_.forceMoveStartSceneTileZ*128+_.size*64,b=_.forceMoveEndSceneTileX*128+_.size*64,L=_.forceMoveEndSceneTileZ*128+_.size*64;_.x=(u*(R-E)+b*E)/R|0,_.z=(O*(R-E)+L*E)/R|0}if(_.seqDelayMove=0,_.forceMoveFaceDirection===0)_.dstYaw=1024;else if(_.forceMoveFaceDirection===1)_.dstYaw=1536;else if(_.forceMoveFaceDirection===2)_.dstYaw=0;else if(_.forceMoveFaceDirection===3)_.dstYaw=512;_.yaw=_.dstYaw}updateMovement(_){if(_.secondarySeqId=_.readyanim,_.routeLength===0){_.seqDelayMove=0;return}if(_.primarySeqId!==-1&&_.primarySeqDelay===0){let G=e.types[_.primarySeqId];if(_.preanimRouteLength>0&&G.preanim_move===0){_.seqDelayMove++;return}if(_.preanimRouteLength<=0&&G.postanim_move===0){_.seqDelayMove++;return}}let{x:R,z:E}=_,u=_.routeTileX[_.routeLength-1]*128+_.size*64,O=_.routeTileZ[_.routeLength-1]*128+_.size*64;if(u-R>256||u-R<-256||O-E>256||O-E<-256){_.x=u,_.z=O;return}if(R<u)if(E<O)_.dstYaw=1280;else if(E>O)_.dstYaw=1792;else _.dstYaw=1536;else if(R>u)if(E<O)_.dstYaw=768;else if(E>O)_.dstYaw=256;else _.dstYaw=512;else if(E<O)_.dstYaw=1024;else _.dstYaw=0;let b=_.dstYaw-_.yaw&2047;if(b>1024)b-=2048;let L=_.walkanim_b;if(b>=-256&&b<=256)L=_.walkanim;else if(b>=256&&b<768)L=_.walkanim_r;else if(b>=-768&&b<=-256)L=_.walkanim_l;if(L===-1)L=_.walkanim;_.secondarySeqId=L;let N=4;if(_.yaw!==_.dstYaw&&_.targetId===-1)N=2;if(_.routeLength>2)N=6;if(_.routeLength>3)N=8;if(_.seqDelayMove>0&&_.routeLength>1)N=8,_.seqDelayMove--;if(_.routeRun[_.routeLength-1])N<<=1;if(N>=8&&_.secondarySeqId===_.walkanim&&_.runanim!==-1)_.secondarySeqId=_.runanim;if(R<u){if(_.x+=N,_.x>u)_.x=u}else if(R>u){if(_.x-=N,_.x<u)_.x=u}if(E<O){if(_.z+=N,_.z>O)_.z=O}else if(E>O){if(_.z-=N,_.z<O)_.z=O}if(_.x===u&&_.z===O){if(_.routeLength--,_.preanimRouteLength>0)_.preanimRouteLength--}}updateFacingDirection(_){if(_.targetId!==-1&&_.targetId<32768){let E=this.npcs[_.targetId];if(E){let u=_.x-E.x,O=_.z-E.z;if(u!==0||O!==0)_.dstYaw=(Math.atan2(u,O)*325.949|0)&2047}}if(_.targetId>=32768){let E=_.targetId-32768;if(E===this.localPid)E=2047;let u=this.players[E];if(u){let O=_.x-u.x,b=_.z-u.z;if(O!==0||b!==0)_.dstYaw=(Math.atan2(O,b)*325.949|0)&2047}}if((_.targetTileX!==0||_.targetTileZ!==0)&&(_.routeLength===0||_.seqDelayMove>0)){let E=_.x-(_.targetTileX-this.sceneBaseTileX-this.sceneBaseTileX)*64,u=_.z-(_.targetTileZ-this.sceneBaseTileZ-this.sceneBaseTileZ)*64;if(E!==0||u!==0)_.dstYaw=(Math.atan2(E,u)*325.949|0)&2047;_.targetTileX=0,_.targetTileZ=0}let R=_.dstYaw-_.yaw&2047;if(R!==0){if(R<32||R>2016)_.yaw=_.dstYaw;else if(R>1024)_.yaw-=32;else _.yaw+=32;if(_.yaw&=2047,_.secondarySeqId===_.readyanim&&_.yaw!==_.dstYaw)if(_.turnanim!=-1)_.secondarySeqId=_.turnanim;else _.secondarySeqId=_.walkanim}}updateSequences(_){_.needsForwardDrawPadding=!1;let R;if(_.secondarySeqId!==-1){if(R=e.types[_.secondarySeqId],_.secondarySeqCycle++,_.secondarySeqFrame<R.frameCount&&_.secondarySeqCycle>R.getFrameDuration(_.secondarySeqFrame))_.secondarySeqCycle=0,_.secondarySeqFrame++;if(_.secondarySeqFrame>=R.frameCount)_.secondarySeqCycle=0,_.secondarySeqFrame=0}if(_.spotanimId!==-1&&this.loopCycle>=_.spotanimLastCycle){if(_.spotanimFrame<0)_.spotanimFrame=0;R=q0.types[_.spotanimId].seq,_.spotanimCycle++;while(R&&_.spotanimFrame<R.frameCount&&_.spotanimCycle>R.getFrameDuration(_.spotanimFrame))_.spotanimCycle-=R.getFrameDuration(_.spotanimFrame),_.spotanimFrame++;if(R&&_.spotanimFrame>=R.frameCount){if(_.spotanimFrame<0||_.spotanimFrame>=R.frameCount)_.spotanimId=-1}}if(_.primarySeqId!=-1&&_.primarySeqDelay<=1){if(R=e.types[_.primarySeqId],R.preanim_move===1&&_.preanimRouteLength>0&&this.loopCycle>=_.forceMoveStartCycle&&this.loopCycle>_.forceMoveEndCycle){_.primarySeqDelay=1;return}}if(_.primarySeqId!==-1&&_.primarySeqDelay===0){R=e.types[_.primarySeqId],_.primarySeqCycle++;while(_.primarySeqFrame<R.frameCount&&_.primarySeqCycle>R.getFrameDuration(_.primarySeqFrame))_.primarySeqCycle-=R.getFrameDuration(_.primarySeqFrame),_.primarySeqFrame++;if(_.primarySeqFrame>=R.frameCount){if(_.primarySeqFrame-=R.loops,_.primarySeqLoop++,_.primarySeqLoop>=R.maxloops)_.primarySeqId=-1;if(_.primarySeqFrame<0||_.primarySeqFrame>=R.frameCount)_.primarySeqId=-1}_.needsForwardDrawPadding=R.stretches}if(_.primarySeqDelay>0)_.primarySeqDelay--}async loadTitle(){if(this.imageTitle2)return;if(this.drawArea=null,this.areaChatback=null,this.areaMapback=null,this.areaSidebar=null,this.areaViewport=null,this.areaBackbase1=null,this.areaBackbase2=null,this.areaBackhmid1=null,this.imageTitle0=new H0(128,265),I.clear(),this.imageTitle1=new H0(128,265),I.clear(),this.imageTitle2=new H0(509,171),I.clear(),this.imageTitle3=new H0(360,132),I.clear(),this.imageTitle4=new H0(360,200),I.clear(),this.imageTitle5=new H0(202,238),I.clear(),this.imageTitle6=new H0(203,238),I.clear(),this.imageTitle7=new H0(74,94),I.clear(),this.imageTitle8=new H0(75,94),I.clear(),this.jagTitle)await this.loadTitleBackground(),this.loadTitleImages();this.redrawFrame=!0}async loadTitleBackground(){if(!this.jagTitle)return;let _=await E0.fromJpeg(this.jagTitle,"title");this.imageTitle0?.bind(),_.blitOpaque(0,0),this.imageTitle1?.bind(),_.blitOpaque(-637,0),this.imageTitle2?.bind(),_.blitOpaque(-128,0),this.imageTitle3?.bind(),_.blitOpaque(-202,-371),this.imageTitle4?.bind(),_.blitOpaque(-202,-171),this.imageTitle5?.bind(),_.blitOpaque(0,-265),this.imageTitle6?.bind(),_.blitOpaque(-562,-265),this.imageTitle7?.bind(),_.blitOpaque(-128,-171),this.imageTitle8?.bind(),_.blitOpaque(-562,-171),_.flipHorizontally(),this.imageTitle0?.bind(),_.blitOpaque(382,0),this.imageTitle1?.bind(),_.blitOpaque(-255,0),this.imageTitle2?.bind(),_.blitOpaque(254,0),this.imageTitle3?.bind(),_.blitOpaque(180,-371),this.imageTitle4?.bind(),_.blitOpaque(180,-171),this.imageTitle5?.bind(),_.blitOpaque(382,-265),this.imageTitle6?.bind(),_.blitOpaque(-180,-265),this.imageTitle7?.bind(),_.blitOpaque(254,-171),this.imageTitle8?.bind(),_.blitOpaque(-180,-171);let R=E0.fromArchive(this.jagTitle,"logo");this.imageTitle2?.bind(),R.draw((this.width/2|0)-(R.cropRight/2|0)-128,18)}loadTitleImages(){if(!this.jagTitle)return;this.imageTitlebox=G0.fromArchive(this.jagTitle,"titlebox"),this.imageTitlebutton=G0.fromArchive(this.jagTitle,"titlebutton");for(let _=0;_<12;_++)this.imageRunes[_]=G0.fromArchive(this.jagTitle,"runes",_);if(this.imageFlamesLeft=new E0(128,265),this.imageFlamesRight=new E0(128,265),this.imageTitle0)f1(this.imageTitle0.pixels,0,this.imageFlamesLeft.pixels,0,33920);if(this.imageTitle1)f1(this.imageTitle1.pixels,0,this.imageFlamesRight.pixels,0,33920);this.flameGradient0=new Int32Array(256);for(let _=0;_<64;_++)this.flameGradient0[_]=_*262144;for(let _=0;_<64;_++)this.flameGradient0[_+64]=_*1024+16711680;for(let _=0;_<64;_++)this.flameGradient0[_+128]=_*4+16776960;for(let _=0;_<64;_++)this.flameGradient0[_+192]=16777215;this.flameGradient1=new Int32Array(256);for(let _=0;_<64;_++)this.flameGradient1[_]=_*1024;for(let _=0;_<64;_++)this.flameGradient1[_+64]=_*4+65280;for(let _=0;_<64;_++)this.flameGradient1[_+128]=_*262144+65535;for(let _=0;_<64;_++)this.flameGradient1[_+192]=16777215;this.flameGradient2=new Int32Array(256);for(let _=0;_<64;_++)this.flameGradient2[_]=_*4;for(let _=0;_<64;_++)this.flameGradient2[_+64]=_*262144+255;for(let _=0;_<64;_++)this.flameGradient2[_+128]=_*1024+16711935;for(let _=0;_<64;_++)this.flameGradient2[_+192]=16777215;this.flameGradient=new Int32Array(256),this.flameBuffer0=new Int32Array(32768),this.flameBuffer1=new Int32Array(32768),this.updateFlameBuffer(null),this.flameBuffer3=new Int32Array(32768),this.flameBuffer2=new Int32Array(32768),this.drawProgress(10,"Connecting to fileserver").then(()=>{if(!this.flameActive)this.flameActive=!0,this.flamesInterval=setInterval(this.runFlames.bind(this),35)})}async drawTitle(){if(p1&&!this.botAutoLoginAttempted&&this.lastProgressPercent>=100){let E=w1(),u=C1();if(E!=="default"&&u)this.botAutoLoginAttempted=!0,this.autoLogin(E,u).catch((O)=>{})}await this.loadTitle(),this.imageTitle4?.bind(),this.imageTitlebox?.draw(0,0);let _=360,R=200;if(this.titleScreenState===0){let E=(R/2|0)+80,u=(R/2|0)-20;if(this.onDemand)this.fontPlain11?.drawStringTaggableCenter(_/2,E,this.onDemand.message,7711145,!0);this.fontBold12?.drawStringTaggableCenter(_/2,u,"Welcome to RuneScape",16776960,!0),u+=30;let O=(_/2|0)-80;u=(R/2|0)+20,this.imageTitlebutton?.draw(O-73,u-20),this.fontBold12?.drawStringTaggableCenter(O,u+5,"New user",16777215,!0),O=(_/2|0)+80,this.imageTitlebutton?.draw(O-73,u-20),this.fontBold12?.drawStringTaggableCenter(O,u+5,"Existing User",16777215,!0)}else if(this.titleScreenState===2){let E=(_/2|0)-80,u=(R/2|0)-40;if(this.loginMessage0.length>0)this.fontBold12?.drawStringTaggableCenter(_/2,u-15,this.loginMessage0,16776960,!0),this.fontBold12?.drawStringTaggableCenter(_/2,u,this.loginMessage1,16776960,!0),u+=30;else this.fontBold12?.drawStringTaggableCenter(_/2,u-7,this.loginMessage1,16776960,!0),u+=30;this.fontBold12?.drawStringTaggable(_/2-90,u,`Username: ${this.username}${this.titleLoginField===0&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),u+=15,this.fontBold12?.drawStringTaggable(_/2-88,u,`Password: ${c.toAsterisks(this.password)}${this.titleLoginField===1&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),u+=15,E=(_/2|0)-80,u=(R/2|0)+50,this.imageTitlebutton?.draw(E-73,u-20),this.fontBold12?.drawStringTaggableCenter(E,u+5,"Login",16777215,!0),E=(_/2|0)+80,this.imageTitlebutton?.draw(E-73,u-20),this.fontBold12?.drawStringTaggableCenter(E,u+5,"Cancel",16777215,!0)}else if(this.titleScreenState===3){let E=_/2|0,u=(R/2|0)-60;this.fontBold12?.drawStringTaggableCenter(E,u,"Create a free account",16776960,!0),u=(R/2|0)-35,this.fontBold12?.drawStringTaggableCenter(E,u,"To create a new account you need to",16777215,!0),u+=15,this.fontBold12?.drawStringTaggableCenter(E,u,"go back to the main RuneScape webpage",16777215,!0),u+=15,this.fontBold12?.drawStringTaggableCenter(E,u,"and choose the red 'create account'",16777215,!0),u+=15,this.fontBold12?.drawStringTaggableCenter(E,u,"button at the top right of that page.",16777215,!0),u+=15,E=_/2|0,u=(R/2|0)+50,this.imageTitlebutton?.draw(E-73,u-20),this.fontBold12?.drawStringTaggableCenter(E,u+5,"Cancel",16777215,!0)}if(this.imageTitle4?.draw(202,171),this.redrawFrame)this.redrawFrame=!1,this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(202,371),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(562,265),this.imageTitle7?.draw(128,171),this.imageTitle8?.draw(562,171)}drawGame(){if(this.players===null)return;if(this.redrawFrame){if(this.redrawFrame=!1,this.areaBackleft1?.draw(0,4),this.areaBackleft2?.draw(0,357),this.areaBackright1?.draw(722,4),this.areaBackright2?.draw(743,205),this.areaBacktop1?.draw(0,0),this.areaBackvmid1?.draw(516,4),this.areaBackvmid2?.draw(516,205),this.areaBackvmid3?.draw(496,357),this.areaBackhmid2?.draw(0,338),this.redrawSidebar=!0,this.redrawChatback=!0,this.redrawSideicons=!0,this.redrawPrivacySettings=!0,this.sceneState!==2)this.areaViewport?.draw(4,4),this.areaMapback?.draw(550,4)}if(this.sceneState===2)this.drawScene();if(this.menuVisible&&this.menuArea===1)this.redrawSidebar=!0;if(this.sidebarInterfaceId!==-1){if(this.updateInterfaceAnimation(this.sidebarInterfaceId,this.sceneDelta))this.redrawSidebar=!0}if(this.selectedArea===2)this.redrawSidebar=!0;if(this.objDragArea===2)this.redrawSidebar=!0;if(this.redrawSidebar)this.drawSidebar(),this.redrawSidebar=!1;if(this.chatInterfaceId===-1){if(this.chatInterface.scrollPosition=this.chatScrollHeight-this.chatScrollOffset-77,this.mouseX>448&&this.mouseX<560&&this.mouseY>332)this.handleScrollInput(this.mouseX-17,this.mouseY-357,this.chatScrollHeight,77,!1,463,0,this.chatInterface);let _=this.chatScrollHeight-this.chatInterface.scrollPosition-77;if(_<0)_=0;if(_>this.chatScrollHeight-77)_=this.chatScrollHeight-77;if(this.chatScrollOffset!==_)this.chatScrollOffset=_,this.redrawChatback=!0}if(this.chatInterfaceId!==-1){if(this.updateInterfaceAnimation(this.chatInterfaceId,this.sceneDelta))this.redrawChatback=!0}if(this.selectedArea===3)this.redrawChatback=!0;if(this.objDragArea===3)this.redrawChatback=!0;if(this.modalMessage)this.redrawChatback=!0;if(this.menuVisible&&this.menuArea===2)this.redrawChatback=!0;if(this.redrawChatback)this.drawChat(),this.redrawChatback=!1;if(this.sceneState===2)this.drawMinimap(),this.areaMapback?.draw(550,4);if(this.flashingTab!==-1)this.redrawSideicons=!0;if(this.redrawSideicons){if(this.flashingTab!==-1&&this.flashingTab===this.selectedTab)this.flashingTab=-1,this.out.p1isaac(243),this.out.p1(this.selectedTab);if(this.redrawSideicons=!1,this.areaBackhmid1?.bind(),this.imageBackhmid1?.draw(0,0),this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===0)this.imageRedstone1?.draw(22,10);else if(this.selectedTab===1)this.imageRedstone2?.draw(54,8);else if(this.selectedTab===2)this.imageRedstone2?.draw(82,8);else if(this.selectedTab===3)this.imageRedstone3?.draw(110,8);else if(this.selectedTab===4)this.imageRedstone2h?.draw(153,8);else if(this.selectedTab===5)this.imageRedstone2h?.draw(181,8);else if(this.selectedTab===6)this.imageRedstone1h?.draw(209,9)}if(this.tabInterfaceId[0]!==-1&&(this.flashingTab!==0||this.loopCycle%20<10))this.imageSideicons[0]?.draw(29,13);if(this.tabInterfaceId[1]!==-1&&(this.flashingTab!==1||this.loopCycle%20<10))this.imageSideicons[1]?.draw(53,11);if(this.tabInterfaceId[2]!==-1&&(this.flashingTab!==2||this.loopCycle%20<10))this.imageSideicons[2]?.draw(82,11);if(this.tabInterfaceId[3]!==-1&&(this.flashingTab!==3||this.loopCycle%20<10))this.imageSideicons[3]?.draw(115,12);if(this.tabInterfaceId[4]!==-1&&(this.flashingTab!==4||this.loopCycle%20<10))this.imageSideicons[4]?.draw(153,13);if(this.tabInterfaceId[5]!==-1&&(this.flashingTab!==5||this.loopCycle%20<10))this.imageSideicons[5]?.draw(180,11);if(this.tabInterfaceId[6]!==-1&&(this.flashingTab!==6||this.loopCycle%20<10))this.imageSideicons[6]?.draw(208,13)}if(this.areaBackhmid1?.draw(516,160),this.areaBackbase2?.bind(),this.imageBackbase2?.draw(0,0),this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===7)this.imageRedstone1v?.draw(42,0);else if(this.selectedTab===8)this.imageRedstone2v?.draw(74,0);else if(this.selectedTab===9)this.imageRedstone2v?.draw(102,0);else if(this.selectedTab===10)this.imageRedstone3v?.draw(130,1);else if(this.selectedTab===11)this.imageRedstone2hv?.draw(173,0);else if(this.selectedTab===12)this.imageRedstone2hv?.draw(201,0);else if(this.selectedTab===13)this.imageRedstone1hv?.draw(229,0)}if(this.tabInterfaceId[8]!==-1&&(this.flashingTab!==8||this.loopCycle%20<10))this.imageSideicons[7]?.draw(74,2);if(this.tabInterfaceId[9]!==-1&&(this.flashingTab!==9||this.loopCycle%20<10))this.imageSideicons[8]?.draw(102,3);if(this.tabInterfaceId[10]!==-1&&(this.flashingTab!==10||this.loopCycle%20<10))this.imageSideicons[9]?.draw(137,4);if(this.tabInterfaceId[11]!==-1&&(this.flashingTab!==11||this.loopCycle%20<10))this.imageSideicons[10]?.draw(174,2);if(this.tabInterfaceId[12]!==-1&&(this.flashingTab!==12||this.loopCycle%20<10))this.imageSideicons[11]?.draw(201,2);if(this.tabInterfaceId[13]!==-1&&(this.flashingTab!==13||this.loopCycle%20<10))this.imageSideicons[12]?.draw(226,2)}this.areaBackbase2?.draw(496,466),this.areaViewport?.bind()}if(this.redrawPrivacySettings){if(this.redrawPrivacySettings=!1,this.areaBackbase1?.bind(),this.imageBackbase1?.draw(0,0),this.fontPlain12?.drawStringTaggableCenter(55,28,"Public chat",16777215,!0),this.chatPublicMode===0)this.fontPlain12?.drawStringTaggableCenter(55,41,"On",65280,!0);if(this.chatPublicMode===1)this.fontPlain12?.drawStringTaggableCenter(55,41,"Friends",16776960,!0);if(this.chatPublicMode===2)this.fontPlain12?.drawStringTaggableCenter(55,41,"Off",16711680,!0);if(this.chatPublicMode===3)this.fontPlain12?.drawStringTaggableCenter(55,41,"Hide",65535,!0);if(this.fontPlain12?.drawStringTaggableCenter(184,28,"Private chat",16777215,!0),this.chatPrivateMode===0)this.fontPlain12?.drawStringTaggableCenter(184,41,"On",65280,!0);if(this.chatPrivateMode===1)this.fontPlain12?.drawStringTaggableCenter(184,41,"Friends",16776960,!0);if(this.chatPrivateMode===2)this.fontPlain12?.drawStringTaggableCenter(184,41,"Off",16711680,!0);if(this.fontPlain12?.drawStringTaggableCenter(324,28,"Trade/duel",16777215,!0),this.chatTradeMode===0)this.fontPlain12?.drawStringTaggableCenter(324,41,"On",65280,!0);if(this.chatTradeMode===1)this.fontPlain12?.drawStringTaggableCenter(324,41,"Friends",16776960,!0);if(this.chatTradeMode===2)this.fontPlain12?.drawStringTaggableCenter(324,41,"Off",16711680,!0);this.fontPlain12?.drawStringTaggableCenter(458,33,"Report abuse",16777215,!0),this.areaBackbase1?.draw(0,453),this.areaViewport?.bind()}if(this.botOverlay)this.botOverlay.update(),this.botOverlay.tick();this.sceneDelta=0}drawScene(){if(this.sceneCycle++,this.pushNpcs(!0),this.pushPlayers(),this.pushNpcs(!1),this.pushProjectiles(),this.pushSpotanims(),!this.cutscene){let N=this.orbitCameraPitch;if((this.cameraPitchClamp/256|0)>N)N=this.cameraPitchClamp/256|0;if(this.cameraModifierEnabled[4]&&this.cameraModifierWobbleScale[4]+128>N)N=this.cameraModifierWobbleScale[4]+128;let G=this.orbitCameraYaw+this.macroCameraAngle&2047;if(this.localPlayer)this.orbitCamera(this.orbitCameraX,this.getHeightmapY(this.currentLevel,this.localPlayer.x,this.localPlayer.z)-50,this.orbitCameraZ,G,N,N*3+600);if(s.cyclelogic2++,s.cyclelogic2>1802){s.cyclelogic2=0,this.out.p1isaac(223),this.out.p1(0);let H=this.out.pos;if(this.out.p2(29711),this.out.p1(70),this.out.p1(Math.random()*256|0),this.out.p1(242),this.out.p1(186),this.out.p1(39),this.out.p1(61),(Math.random()*2|0)===0)this.out.p1(13);if((Math.random()*2|0)===0)this.out.p2(57856);this.out.p2(Math.random()*65536|0),this.out.psize1(this.out.pos-H)}}let _;if(this.cutscene)_=this.getTopLevelCutscene();else _=this.getTopLevel();let R=this.cameraX,E=this.cameraY,u=this.cameraZ,O=this.cameraPitch,b=this.cameraYaw;for(let N=0;N<5;N++)if(this.cameraModifierEnabled[N]){let G=Math.random()*(this.cameraModifierJitter[N]*2+1)-this.cameraModifierJitter[N]+Math.sin(this.cameraModifierCycle[N]*(this.cameraModifierWobbleSpeed[N]/100))*this.cameraModifierWobbleScale[N]|0;if(N===0)this.cameraX+=G;else if(N===1)this.cameraY+=G;else if(N===2)this.cameraZ+=G;else if(N===3)this.cameraYaw=this.cameraYaw+G&2047;else if(N===4){if(this.cameraPitch+=G,this.cameraPitch<128)this.cameraPitch=128;if(this.cameraPitch>383)this.cameraPitch=383}}let L=X.cycle;U.checkHover=!0,U.pickedCount=0,U.mouseX=this.mouseX-4,U.mouseY=this.mouseY-4,I.clear(),this.scene?.draw(this.cameraX,this.cameraY,this.cameraZ,_,this.cameraYaw,this.cameraPitch,this.loopCycle),this.scene?.clearLocChanges(),this.draw2DEntityElements(),this.drawTileHint(),this.updateTextures(L),this.draw3DEntityElements(),this.areaViewport?.draw(4,4),this.cameraX=R,this.cameraY=E,this.cameraZ=u,this.cameraPitch=O,this.cameraYaw=b}pushPlayers(){if(!this.localPlayer)return;if(this.localPlayer.x>>7===this.flagSceneTileX&&this.localPlayer.z>>7===this.flagSceneTileZ)this.flagSceneTileX=0;for(let _=-1;_<this.playerCount;_++){let R,E;if(_===-1)R=this.localPlayer,E=33538048;else R=this.players[this.playerIds[_]],E=this.playerIds[_]<<14;if(!R||!R.isVisible())continue;if(R.lowMemory=!1,(s.lowMemory&&this.playerCount>50||this.playerCount>200)&&_!=-1&&R.secondarySeqId==R.readyanim)R.lowMemory=!0;let u=R.x>>7,O=R.z>>7;if(u<0||u>=104||O<0||O>=104)continue;if(!R.locModel||this.loopCycle<R.locStartCycle||this.loopCycle>=R.locStopCycle){if((R.x&127)===64&&(R.z&127)===64){if(this.tileLastOccupiedCycle[u][O]==this.sceneCycle&&_!=-1)continue;this.tileLastOccupiedCycle[u][O]=this.sceneCycle}R.y=this.getHeightmapY(this.currentLevel,R.x,R.z),this.scene?.changeLoc(this.currentLevel,R.x,R.y,R.z,R,E,R.yaw,60,R.needsForwardDrawPadding)}else R.lowMemory=!1,R.y=this.getHeightmapY(this.currentLevel,R.x,R.z),this.scene?.changeLoc2(this.currentLevel,R.x,R.y,R.z,R.minTileX,R.minTileZ,R.maxTileX,R.maxTileZ,R,E,R.yaw)}}pushNpcs(_){for(let R=0;R<this.npcCount;R++){let E=this.npcs[this.npcIds[R]],u=(this.npcIds[R]<<14)+536870912|0;if(!E||!E.isVisible()||E.type?.alwaysontop!==_)continue;let O=E.x>>7,b=E.z>>7;if(O<0||O>=104||b<0||b>=104)continue;if(E.size===1&&(E.x&127)===64&&(E.z&127)===64){if(this.tileLastOccupiedCycle[O][b]===this.sceneCycle)continue;this.tileLastOccupiedCycle[O][b]=this.sceneCycle}this.scene?.changeLoc(this.currentLevel,E.x,this.getHeightmapY(this.currentLevel,E.x,E.z),E.z,E,u,E.yaw,(E.size-1)*64+60,E.needsForwardDrawPadding)}}pushProjectiles(){for(let _=this.projectiles.head();_;_=this.projectiles.next())if(_.projLevel!==this.currentLevel||this.loopCycle>_.lastCycle)_.unlink();else if(this.loopCycle>=_.startCycle){if(_.projTarget>0){let R=this.npcs[_.projTarget-1];if(R)_.updateVelocity(R.x,this.getHeightmapY(_.projLevel,R.x,R.z)-_.projOffsetY,R.z,this.loopCycle)}if(_.projTarget<0){let R=-_.projTarget-1,E;if(R===this.localPid)E=this.localPlayer;else E=this.players[R];if(E)_.updateVelocity(E.x,this.getHeightmapY(_.projLevel,E.x,E.z)-_.projOffsetY,E.z,this.loopCycle)}_.update(this.sceneDelta),this.scene?.changeLoc(this.currentLevel,_.x|0,_.y|0,_.z|0,_,-1,_.yaw,60,!1)}}pushSpotanims(){for(let _=this.spotanims.head();_;_=this.spotanims.next())if(_.spotLevel!==this.currentLevel||_.seqComplete)_.unlink();else if(this.loopCycle>=_.startCycle)if(_.update(this.sceneDelta),_.seqComplete)_.unlink();else this.scene?.changeLoc(_.spotLevel,_.x,_.y,_.z,_,-1,0,60,!1)}orbitCamera(_,R,E,u,O,b){let L=2048-O&2047,N=2048-u&2047,G=0,H=0,Q=b,$,J,T;if(L!==0)$=X.sinTable[L],J=X.cosTable[L],T=H*J-b*$>>16,Q=H*$+b*J>>16,H=T;if(N!==0)$=X.sinTable[N],J=X.cosTable[N],T=Q*$+G*J>>16,Q=Q*J-G*$>>16,G=T;this.cameraX=_-G,this.cameraY=R-H,this.cameraZ=E-Q,this.cameraPitch=O,this.cameraYaw=u}getTopLevelCutscene(){if(!this.levelTileFlags)return 0;return this.getHeightmapY(this.currentLevel,this.cameraX,this.cameraZ)-this.cameraY>=800||(this.levelTileFlags[this.currentLevel][this.cameraX>>7][this.cameraZ>>7]&4)===0?3:this.currentLevel}getTopLevel(){let _=3;if(this.cameraPitch<310&&this.localPlayer){let R=this.cameraX>>7,E=this.cameraZ>>7,u=this.localPlayer.x>>7,O=this.localPlayer.z>>7;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][E]&4)!==0)_=this.currentLevel;let b;if(u>R)b=u-R;else b=R-u;let L;if(O>E)L=O-E;else L=E-O;if(b>L){let N=L*65536/b|0,G=32768;while(R!==u){if(R<u)R++;else if(R>u)R--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][E]&4)!==0)_=this.currentLevel;if(G+=N,G>=65536){if(G-=65536,E<O)E++;else if(E>O)E--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][E]&4)!==0)_=this.currentLevel}}}else{let N=b*65536/L|0,G=32768;while(E!==O){if(E<O)E++;else if(E>O)E--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][E]&4)!==0)_=this.currentLevel;if(G+=N,G>=65536){if(G-=65536,R<u)R++;else if(R>u)R--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][E]&4)!==0)_=this.currentLevel}}}}if(this.localPlayer&&this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][this.localPlayer.x>>7][this.localPlayer.z>>7]&4)!==0)_=this.currentLevel;return _}draw2DEntityElements(){this.chatCount=0;for(let _=-1;_<this.playerCount+this.npcCount;_++){let R=null;if(_===-1)R=this.localPlayer;else if(_<this.playerCount)R=this.players[this.playerIds[_]];else R=this.npcs[this.npcIds[_-this.playerCount]];if(!R||!R.isVisible())continue;if(_>=this.playerCount){let E=R.type;if(E&&E.headicon>=0&&E.headicon<this.imageHeadicon.length){if(this.projectFromEntity(R,R.height+15),this.projectX>-1)this.imageHeadicon[E.headicon]?.draw(this.projectX-12,this.projectY-30)}if(this.hintType===1&&this.hintNpc===this.npcIds[_-this.playerCount]&&this.loopCycle%20<10){if(this.projectFromEntity(R,R.height+15),this.projectX>-1)this.imageHeadicon[2]?.draw(this.projectX-12,this.projectY-28)}}else{let E=30,u=R;if(u.headicons!==0){if(this.projectFromEntity(R,R.height+15),this.projectX>-1){for(let O=0;O<8;O++)if((u.headicons&1<<O)!==0)this.imageHeadicon[O]?.draw(this.projectX-12,this.projectY-E),E-=25}}if(_>=0&&this.hintType===10&&this.hintPlayer===this.playerIds[_]){if(this.projectFromEntity(R,R.height+15),this.projectX>-1)this.imageHeadicon[7]?.draw(this.projectX-12,this.projectY-E)}}if(R.chatMessage&&(_>=this.playerCount||this.chatPublicMode===0||this.chatPublicMode===3||this.chatPublicMode===1&&this.isFriend(R.name))){if(this.projectFromEntity(R,R.height),this.projectX>-1&&this.chatCount<50&&this.fontBold12){if(this.chatWidth[this.chatCount]=this.fontBold12.stringWidth(R.chatMessage)/2|0,this.chatHeight[this.chatCount]=this.fontBold12.height2d,this.chatX[this.chatCount]=this.projectX,this.chatY[this.chatCount]=this.projectY,this.chatColors[this.chatCount]=R.chatColour,this.chatEffect[this.chatCount]=R.chatEffect,this.chatTimers[this.chatCount]=R.chatTimer,this.chats[this.chatCount++]=R.chatMessage,this.chatEffects===0&&R.chatEffect===1)this.chatHeight[this.chatCount]+=10,this.chatY[this.chatCount]+=5;if(this.chatEffects===0&&R.chatEffect===2)this.chatWidth[this.chatCount]=60}}if(R.combatCycle>this.loopCycle+100){if(this.projectFromEntity(R,R.height+15),this.projectX>-1){let E=R.health*30/R.totalHealth|0;if(E>30)E=30;I.fillRect2d(this.projectX-15,this.projectY-3,E,5,65280),I.fillRect2d(this.projectX-15+E,this.projectY-3,30-E,5,16711680)}}for(let E=0;E<4;++E)if(R.damageCycles[E]>this.loopCycle){if(this.projectFromEntity(R,R.height/2|0),this.projectX<=-1)continue;if(E==1)this.projectY-=20;else if(E==2)this.projectX-=15,this.projectY-=10;else if(E==3)this.projectX+=15,this.projectY-=10;this.imageHitmarks[R.damageTypes[E]]?.draw(this.projectX-12,this.projectY-12),this.fontPlain11?.drawStringCenter(this.projectX,this.projectY+4,R.damageValues[E].toString(),0),this.fontPlain11?.drawStringCenter(this.projectX-1,this.projectY+3,R.damageValues[E].toString(),16777215)}}for(let _=0;_<this.chatCount;_++){let R=this.chatX[_],E=this.chatY[_],u=this.chatWidth[_],O=this.chatHeight[_],b=!0;while(b){b=!1;for(let N=0;N<_;N++)if(E+2>this.chatY[N]-this.chatHeight[N]&&E-O<this.chatY[N]+2&&R-u<this.chatX[N]+this.chatWidth[N]&&R+u>this.chatX[N]-this.chatWidth[N]&&this.chatY[N]-this.chatHeight[N]<E)E=this.chatY[N]-this.chatHeight[N],b=!0}this.projectX=this.chatX[_],this.projectY=this.chatY[_]=E;let L=this.chats[_];if(this.chatEffects===0){let N=16776960;if(this.chatColors[_]<6)N=s.CHAT_COLORS[this.chatColors[_]];else if(this.chatColors[_]===6)N=this.sceneCycle%20<10?16711680:16776960;else if(this.chatColors[_]===7)N=this.sceneCycle%20<10?255:65535;else if(this.chatColors[_]===8)N=this.sceneCycle%20<10?45056:8454016;else if(this.chatColors[_]===9){let G=150-this.chatTimers[_];if(G<50)N=G*1280+16711680;else if(G<100)N=16776960-(G-50)*327680;else if(G<150)N=(G-100)*5+65280}else if(this.chatColors[_]===10){let G=150-this.chatTimers[_];if(G<50)N=G*5+16711680;else if(G<100)N=16711935-(G-50)*327680;else if(G<150)N=(G-100)*327680+255-(G-100)*5}if(this.chatColors[_]===11){let G=150-this.chatTimers[_];if(G<50)N=16777215-G*327685;else if(G<100)N=(G-50)*327685+65280;else if(G<150)N=16777215-(G-100)*327680}if(this.chatEffect[_]===0)this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,L,0),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,L,N);else if(this.chatEffect[_]===1)this.fontBold12?.drawCenteredWave(this.projectX,this.projectY+1,L,0,this.sceneCycle),this.fontBold12?.drawCenteredWave(this.projectX,this.projectY,L,N,this.sceneCycle);else if(this.chatEffect[_]===2){let G=this.fontBold12?.stringWidth(L)??0,H=(150-this.chatTimers[_])*(G+100)/150;I.setBounds(this.projectX-50,0,this.projectX+50,334),this.fontBold12?.drawString(this.projectX+50-H,this.projectY+1,L,0),this.fontBold12?.drawString(this.projectX+50-H,this.projectY,L,N),I.resetBounds()}}else this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,L,0),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,L,16776960)}}drawTileHint(){if(this.hintType!==2||!this.imageHeadicon[2])return;if(this.projectFromGround((this.hintTileX-this.sceneBaseTileX<<7)+this.hintOffsetX,this.hintHeight*2,(this.hintTileZ-this.sceneBaseTileZ<<7)+this.hintOffsetZ),this.projectX>-1&&this.loopCycle%20<10)this.imageHeadicon[2].draw(this.projectX-12,this.projectY-28)}projectFromEntity(_,R){this.projectFromGround(_.x,R,_.z)}projectFromGround(_,R,E){if(_<128||E<128||_>13056||E>13056){this.projectX=-1,this.projectY=-1;return}let u=this.getHeightmapY(this.currentLevel,_,E)-R;this.project(_,u,E)}project(_,R,E){let u=_-this.cameraX,O=R-this.cameraY,b=E-this.cameraZ,L=X.sinTable[this.cameraPitch],N=X.cosTable[this.cameraPitch],G=X.sinTable[this.cameraYaw],H=X.cosTable[this.cameraYaw],Q=b*G+u*H>>16;if(b=b*H-u*G>>16,u=Q,Q=O*N-b*L>>16,b=O*L+b*N>>16,O=Q,b>=50)this.projectX=X.centerX+((u<<9)/b|0),this.projectY=X.centerY+((O<<9)/b|0);else this.projectX=-1,this.projectY=-1}getHeightmapY(_,R,E){if(!this.levelHeightmap)return 0;let u=R>>7,O=E>>7;if(u<0||O<0||u>103||O>103)return 0;let b=_;if(_<3&&this.levelTileFlags&&(this.levelTileFlags[1][u][O]&2)===2)b=_+1;let L=R&127,N=E&127,G=this.levelHeightmap[b][u][O]*(128-L)+this.levelHeightmap[b][u+1][O]*L>>7,H=this.levelHeightmap[b][u][O+1]*(128-L)+this.levelHeightmap[b][u+1][O+1]*L>>7;return G*(128-N)+H*N>>7}updateTextures(_){if(!s.lowMemory){if(X.textureCycle[17]>=_){let R=X.textures[17];if(!R)return;let E=R.width2d*R.height2d-1,u=R.width2d*this.sceneDelta*2,O=R.pixels,b=this.textureBuffer;for(let L=0;L<=E;L++)b[L]=O[L-u&E];R.pixels=b,this.textureBuffer=O,X.pushTexture(17)}if(X.textureCycle[24]>=_){let R=X.textures[24];if(!R)return;let E=R.width2d*R.height2d-1,u=R.width2d*this.sceneDelta*2,O=R.pixels,b=this.textureBuffer;for(let L=0;L<=E;L++)b[L]=O[L-u&E];R.pixels=b,this.textureBuffer=O,X.pushTexture(24)}}}draw3DEntityElements(){if(this.drawPrivateMessages(),this.crossMode===1)this.imageCrosses[this.crossCycle/100|0]?.draw(this.crossX-8-4,this.crossY-8-4);else if(this.crossMode===2)this.imageCrosses[(this.crossCycle/100|0)+4]?.draw(this.crossX-8-4,this.crossY-8-4);if(this.viewportOverlayInterfaceId!==-1)this.updateInterfaceAnimation(this.viewportOverlayInterfaceId,this.sceneDelta),this.drawInterface(g.types[this.viewportOverlayInterfaceId],0,0,0);if(this.field1264>0){let _=302-(Math.abs(Math.sin(this.field1264/10)*10)|0);for(let R=0;R<30;R++){let E=(30-R)*16;I.drawHorizontalLineAlpha(256-E/2,_+R,16776960,E,this.field1264)}}if(this.viewportInterfaceId!==-1)this.updateInterfaceAnimation(this.viewportInterfaceId,this.sceneDelta),this.drawInterface(g.types[this.viewportInterfaceId],0,0,0);if(this.updateWorldLocation(),!this.menuVisible)this.handleInput(),this.drawTooltip();else if(this.menuArea===0)this.drawMenu();if(this.inMultizone===1)if(this.wildernessLevel>0||this.worldLocationState===1)this.imageHeadicon[1]?.draw(472,258);else this.imageHeadicon[1]?.draw(472,296);if(this.wildernessLevel>0)this.imageHeadicon[0]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Level: "+this.wildernessLevel,16776960);if(this.worldLocationState===1)this.imageHeadicon[6]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Arena",16776960);if(this.displayFps){let _=507,R=20,E=16776960;if(this.fps<15)E=16711680;this.fontPlain12?.drawStringRight(_,R,"Fps:"+this.fps,E),R+=15;let u=-1;if(typeof window.performance.memory<"u")u=window.performance.memory.usedJSHeapSize/1024|0;if(u!==-1)this.fontPlain12?.drawStringRight(_,R,"Mem:"+u+"k",16776960)}if(this.systemUpdateTimer!==0){let _=this.systemUpdateTimer/50|0,R=_/60|0;if(_%=60,_<10)this.fontPlain12?.drawString(4,329,"System update in: "+R+":0"+_,16776960);else this.fontPlain12?.drawString(4,329,"System update in: "+R+":"+_,16776960)}}drawPrivateMessages(){if(this.splitPrivateChat===0)return;let _=this.fontPlain12,R=0;if(this.systemUpdateTimer!==0)R=1;for(let E=0;E<100;E++){if(!this.messageText[E])continue;let u=this.messageType[E],O=this.messageSender[E],b=0;if(O&&O.startsWith("@cr1@"))O=O.substring(5),b=1;else if(O&&O.startsWith("@cr2@"))O=O.substring(5),b=2;if((u==3||u==7)&&(u==7||this.chatPrivateMode==0||this.chatPrivateMode==1&&this.isFriend(O))){let L=329-R*13,N=4;if(_?.drawString(4,L,"From",0),_?.drawString(4,L-1,"From",65535),N+=_?.stringWidth("From ")??0,b==1)this.imageModIcons[0].draw(N,L-12),N+=14;else if(b==2)this.imageModIcons[1].draw(N,L-12),N+=14;if(_?.drawString(N,L,O+": "+this.messageText[E],0),_?.drawString(N,L-1,O+": "+this.messageText[E],65535),R++,R>=5)return}else if(u===5&&this.chatPrivateMode<2){let L=329-R*13;if(_?.drawString(4,L,this.messageText[E],0),_?.drawString(4,L-1,this.messageText[E],65535),R++,R>=5)return}else if(u===6&&this.chatPrivateMode<2){let L=329-R*13;if(_?.drawString(4,L,"To "+O+": "+this.messageText[E],0),_?.drawString(4,L-1,"To "+O+": "+this.messageText[E],65535),R++,R>=5)return}}}updateWorldLocation(){if(!this.localPlayer)return;let _=(this.localPlayer.x>>7)+this.sceneBaseTileX,R=(this.localPlayer.z>>7)+this.sceneBaseTileZ;if(_>=2944&&_<3392&&R>=3520&&R<6400)this.wildernessLevel=((R-3520)/8|0)+1;else if(_>=2944&&_<3392&&R>=9920&&R<12800)this.wildernessLevel=((R-9920)/8|0)+1;else this.wildernessLevel=0;if(this.worldLocationState=0,_>=3328&&_<3392&&R>=3200&&R<3264){let E=_&63,u=R&63;if(E>=4&&E<=29&&u>=44&&u<=58)this.worldLocationState=1;else if(E>=36&&E<=61&&u>=44&&u<=58)this.worldLocationState=1;else if(E>=4&&E<=29&&u>=25&&u<=39)this.worldLocationState=1;else if(E>=36&&E<=61&&u>=25&&u<=39)this.worldLocationState=1;else if(E>=4&&E<=29&&u>=6&&u<=20)this.worldLocationState=1;else if(E>=36&&E<=61&&u>=6&&u<=20)this.worldLocationState=1}if(this.worldLocationState===0&&_>=3328&&_<=3393&&R>=3203&&R<=3325)this.worldLocationState=2;if(this.overrideChat=0,_>=3053&&_<=3156&&R>=3056&&R<=3136)this.overrideChat=1;else if(_>=3072&&_<=3118&&R>=9492&&R<=9535)this.overrideChat=1;if(this.overrideChat===1&&_>=3139&&_<=3199&&R>=3008&&R<=3062)this.overrideChat=0}drawTooltip(){if(this.menuSize<2&&this.objSelected===0&&this.spellSelected===0)return;let _;if(this.objSelected===1&&this.menuSize<2)_="Use "+this.objSelectedName+" with...";else if(this.spellSelected===1&&this.menuSize<2)_=this.spellCaption+"...";else _=this.menuOption[this.menuSize-1];if(this.menuSize>2)_=_+"@whi@ / "+(this.menuSize-2)+" more options";this.fontBold12?.drawStringTooltip(4,15,_,16777215,!0,this.loopCycle/1000|0)}drawMenu(){let _=this.menuX,R=this.menuY,E=this.menuWidth,u=this.menuHeight,O=6116423;I.fillRect2d(_,R,E,u,O),I.fillRect2d(_+1,R+1,E-2,16,0),I.drawRect(_+1,R+18,E-2,u-19,0),this.fontBold12?.drawString(_+3,R+14,"Choose Option",O);let b=this.mouseX,L=this.mouseY;if(this.menuArea===0)b-=4,L-=4;else if(this.menuArea===1)b-=553,L-=205;else if(this.menuArea===2)b-=17,L-=357;for(let N=0;N<this.menuSize;N++){let G=R+(this.menuSize-1-N)*15+31,H=16777215;if(b>_&&b<_+E&&L>G-13&&L<G+3)H=16776960;this.fontBold12?.drawStringTaggable(_+3,G,this.menuOption[N],H,!0)}}drawMinimapLoc(_,R,E,u,O){if(!this.scene||!this.imageMinimap)return;let b=this.scene.getWallTypecode(E,_,R);if(b!==0){let L=this.scene.getInfo(E,_,R,b),N=L>>6&3,G=L&31,H=u;if(b>0)H=O;let Q=this.imageMinimap.pixels,$=_*4+(103-R)*512*4+24624,J=b>>14&32767,T=o.get(J);if(T.mapscene===-1){if(G===n.WALL_STRAIGHT.id||G===n.WALL_L.id){if(N===0)Q[$]=H,Q[$+512]=H,Q[$+1024]=H,Q[$+1536]=H;else if(N===1)Q[$]=H,Q[$+1]=H,Q[$+2]=H,Q[$+3]=H;else if(N===2)Q[$+3]=H,Q[$+3+512]=H,Q[$+3+1024]=H,Q[$+3+1536]=H;else if(N===3)Q[$+1536]=H,Q[$+1536+1]=H,Q[$+1536+2]=H,Q[$+1536+3]=H}if(G===n.WALL_SQUARE_CORNER.id){if(N===0)Q[$]=H;else if(N===1)Q[$+3]=H;else if(N===2)Q[$+3+1536]=H;else if(N===3)Q[$+1536]=H}if(G===n.WALL_L.id){if(N===3)Q[$]=H,Q[$+512]=H,Q[$+1024]=H,Q[$+1536]=H;else if(N===0)Q[$]=H,Q[$+1]=H,Q[$+2]=H,Q[$+3]=H;else if(N===1)Q[$+3]=H,Q[$+3+512]=H,Q[$+3+1024]=H,Q[$+3+1536]=H;else if(N===2)Q[$+1536]=H,Q[$+1536+1]=H,Q[$+1536+2]=H,Q[$+1536+3]=H}}else{let m=this.imageMapscene[T.mapscene];if(m){let q=(T.width*4-m.width2d)/2|0,K=(T.length*4-m.height2d)/2|0;m.draw(_*4+48+q,(104-R-T.length)*4+K+48)}}}if(b=this.scene.getLocTypecode(E,_,R),b!==0){let L=this.scene.getInfo(E,_,R,b),N=L>>6&3,G=L&31,H=b>>14&32767,Q=o.get(H);if(Q.mapscene===-1){if(G===n.WALL_DIAGONAL.id){let $=15658734;if(b>0)$=15597568;let J=this.imageMinimap.pixels,T=_*4+(104-1-R)*512*4+24624;if(N===0||N===2)J[T+1536]=$,J[T+1024+1]=$,J[T+512+2]=$,J[T+3]=$;else J[T]=$,J[T+512+1]=$,J[T+1024+2]=$,J[T+1536+3]=$}}else{let $=this.imageMapscene[Q.mapscene];if($){let J=(Q.width*4-$.width2d)/2|0,T=(Q.length*4-$.height2d)/2|0;$.draw(_*4+48+J,(104-R-Q.length)*4+T+48)}}}if(b=this.scene.getGroundDecorTypecode(E,_,R),b!==0){let L=b>>14&32767,N=o.get(L);if(N.mapscene!==-1){let G=this.imageMapscene[N.mapscene];if(G){let H=(N.width*4-G.width2d)/2|0,Q=(N.length*4-G.height2d)/2|0;G.draw(_*4+48+H,(104-R-N.length)*4+Q+48)}}}}interactWithLoc(_,R,E,u){if(!this.localPlayer||!this.scene)return!1;let O=u>>14&32767,b=this.scene.getInfo(this.currentLevel,R,E,u);if(b===-1)return!1;let L=b&31,N=b>>6&3;if(L===n.CENTREPIECE_STRAIGHT.id||L===n.CENTREPIECE_DIAGONAL.id||L===n.GROUND_DECOR.id){let G=o.get(O),H,Q;if(N===0||N===2)H=G.width,Q=G.length;else H=G.length,Q=G.width;let $=G.forceapproach;if(N!==0)$=($<<N&15)+($>>4-N);this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],R,E,2,H,Q,0,0,$,!1)}else this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],R,E,2,0,0,N,L+1,0,!1);return this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(_),this.out.p2(R+this.sceneBaseTileX),this.out.p2(E+this.sceneBaseTileZ),this.out.p2(O),!0}tryMove(_,R,E,u,O,b,L,N,G,H,Q){let $=this.levelCollisionMap[this.currentLevel];if(!$)return!1;let J=104,T=104;for(let f=0;f<J;f++)for(let S=0;S<T;S++){let j=_0.index(f,S);this.bfsDirection[j]=0,this.bfsCost[j]=99999999}let m=_,q=R,K=_0.index(_,R);this.bfsDirection[K]=99,this.bfsCost[K]=0;let F=0,w=0;this.bfsStepX[F]=_,this.bfsStepZ[F++]=R;let k=!1,Y=this.bfsStepX.length,A=$.flags;while(w!==F){if(m=this.bfsStepX[w],q=this.bfsStepZ[w],w=(w+1)%Y,m===E&&q===u){k=!0;break}if(G!==n.WALL_STRAIGHT.id){if((G<n.WALLDECOR_STRAIGHT_OFFSET.id||G===n.CENTREPIECE_STRAIGHT.id)&&$.reachedWall(m,q,E,u,G-1,N)){k=!0;break}if(G<n.CENTREPIECE_STRAIGHT.id&&$.reachedWallDecoration(m,q,E,u,G-1,N)){k=!0;break}}if(b!==0&&L!==0&&$.reachedLoc(m,q,E,u,b,L,H)){k=!0;break}let f=this.bfsCost[_0.index(m,q)]+1,S=_0.index(m-1,q);if(m>0&&this.bfsDirection[S]===0&&(A[S]&2621704)===0)this.bfsStepX[F]=m-1,this.bfsStepZ[F]=q,F=(F+1)%Y,this.bfsDirection[S]=2,this.bfsCost[S]=f;if(S=_0.index(m+1,q),m<J-1&&this.bfsDirection[S]===0&&(A[S]&2621824)===0)this.bfsStepX[F]=m+1,this.bfsStepZ[F]=q,F=(F+1)%Y,this.bfsDirection[S]=8,this.bfsCost[S]=f;if(S=_0.index(m,q-1),q>0&&this.bfsDirection[S]===0&&(A[S]&2621698)===0)this.bfsStepX[F]=m,this.bfsStepZ[F]=q-1,F=(F+1)%Y,this.bfsDirection[S]=1,this.bfsCost[S]=f;if(S=_0.index(m,q+1),q<T-1&&this.bfsDirection[S]===0&&(A[S]&2621728)===0)this.bfsStepX[F]=m,this.bfsStepZ[F]=q+1,F=(F+1)%Y,this.bfsDirection[S]=4,this.bfsCost[S]=f;if(S=_0.index(m-1,q-1),m>0&&q>0&&this.bfsDirection[S]===0&&(A[S]&2621710)===0&&(A[_0.index(m-1,q)]&2621704)===0&&(A[_0.index(m,q-1)]&2621698)===0)this.bfsStepX[F]=m-1,this.bfsStepZ[F]=q-1,F=(F+1)%Y,this.bfsDirection[S]=3,this.bfsCost[S]=f;if(S=_0.index(m+1,q-1),m<J-1&&q>0&&this.bfsDirection[S]===0&&(A[S]&2621827)===0&&(A[_0.index(m+1,q)]&2621824)===0&&(A[_0.index(m,q-1)]&2621698)===0)this.bfsStepX[F]=m+1,this.bfsStepZ[F]=q-1,F=(F+1)%Y,this.bfsDirection[S]=9,this.bfsCost[S]=f;if(S=_0.index(m-1,q+1),m>0&&q<T-1&&this.bfsDirection[S]===0&&(A[S]&2621752)===0&&(A[_0.index(m-1,q)]&2621704)===0&&(A[_0.index(m,q+1)]&2621728)===0)this.bfsStepX[F]=m-1,this.bfsStepZ[F]=q+1,F=(F+1)%Y,this.bfsDirection[S]=6,this.bfsCost[S]=f;if(S=_0.index(m+1,q+1),m<J-1&&q<T-1&&this.bfsDirection[S]===0&&(A[S]&2621920)===0&&(A[_0.index(m+1,q)]&2621824)===0&&(A[_0.index(m,q+1)]&2621728)===0)this.bfsStepX[F]=m+1,this.bfsStepZ[F]=q+1,F=(F+1)%Y,this.bfsDirection[S]=12,this.bfsCost[S]=f}if(this.tryMoveNearest=0,!k){if(Q){let f=100;for(let S=1;S<2;S++){for(let j=E-S;j<=E+S;j++)for(let W=u-S;W<=u+S;W++){let B=_0.index(j,W);if(j>=0&&W>=0&&j<104&&W<104&&this.bfsCost[B]<f)f=this.bfsCost[B],m=j,q=W,this.tryMoveNearest=1,k=!0}if(k)break}}if(!k)return!1}w=0,this.bfsStepX[w]=m,this.bfsStepZ[w++]=q;let h=this.bfsDirection[_0.index(m,q)],Z=h;while(m!==_||q!==R){if(Z!==h)h=Z,this.bfsStepX[w]=m,this.bfsStepZ[w++]=q;if((Z&2)!==0)m++;else if((Z&8)!==0)m--;if((Z&1)!==0)q++;else if((Z&4)!==0)q--;Z=this.bfsDirection[_0.index(m,q)]}if(w>0){Y=Math.min(w,25),w--;let f=this.bfsStepX[w],S=this.bfsStepZ[w];if(O===0)this.out.p1isaac(182),this.out.p1(Y+Y+3);else if(O===1)this.out.p1isaac(198),this.out.p1(Y+Y+3+14);else if(O===2)this.out.p1isaac(216),this.out.p1(Y+Y+3);this.out.p1(1),this.out.p2(f+this.sceneBaseTileX),this.out.p2(S+this.sceneBaseTileZ),this.flagSceneTileX=this.bfsStepX[0],this.flagSceneTileZ=this.bfsStepZ[0];for(let j=1;j<Y;j++)w--,this.out.p1(this.bfsStepX[w]-f),this.out.p1(this.bfsStepZ[w]-S);return!0}return O!==1}async readPacket(){if(!this.stream)return!1;try{let _=this.stream.available;if(_===0)return!1;if(this.ptype===-1){if(await this.stream.readBytes(this.in.data,0,1),this.ptype=this.in.data[0]&255,this.randomIn)this.ptype=this.ptype-this.randomIn.nextInt&255;this.psize=E_[this.ptype],_--}if(this.psize===-1){if(_<=0)return!1;await this.stream.readBytes(this.in.data,0,1),this.psize=this.in.data[0]&255,_--}if(this.psize===-2){if(_<=1)return!1;await this.stream.readBytes(this.in.data,0,2),this.in.pos=0,this.psize=this.in.g2(),_-=2}if(_<this.psize)return!1;if(this.in.pos=0,await this.stream.readBytes(this.in.data,0,this.psize),this.idleNetCycles=0,this.ptype2=this.ptype1,this.ptype1=this.ptype0,this.ptype0=this.ptype,this.ptype===7){let R=this.in.g2();if(this.resetInterfaceAnimation(R),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;return this.chatInterfaceId=R,this.redrawChatback=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===229){let R=this.in.g2(),E=this.in.g2();if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=R,this.sidebarInterfaceId=E,this.redrawSidebar=!0,this.redrawSideicons=!0,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===174){if(this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===29){let R=this.in.g2(),E=this.in.g1();if(R===65535)R=-1;return this.tabInterfaceId[E]=R,this.redrawSidebar=!0,this.redrawSideicons=!0,this.ptype=-1,!0}if(this.ptype===177){let R=this.in.g2();if(this.resetInterfaceAnimation(R),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=R,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===236){let R=this.in.g2();if(this.resetInterfaceAnimation(R),this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.sidebarInterfaceId=R,this.redrawSidebar=!0,this.redrawSideicons=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===8)return this.selectedTab=this.in.g1(),this.redrawSidebar=!0,this.redrawSideicons=!0,this.ptype=-1,!0;if(this.ptype==115){let R=this.in.g2b();return this.viewportOverlayInterfaceId=R,this.ptype=-1,!0}if(this.ptype===135){let R=this.in.g2(),E=this.in.g2(),u=E>>10&31,O=E>>5&31,b=E&31;return g.types[R].colour=(u<<19)+(O<<11)+(b<<3),this.ptype=-1,!0}if(this.ptype===225){let R=this.in.g2(),E=this.in.g1()===1;return g.types[R].hide=E,this.ptype=-1,!0}if(this.ptype===153){let R=this.in.g2(),E=this.in.g2(),u=this.in.g2(),O=x.get(E);return g.types[R].modelType=4,g.types[R].model=E,g.types[R].xan=O.xan2d,g.types[R].yan=O.yan2d,g.types[R].zoom=O.zoom2d*100/u|0,this.ptype=-1,!0}if(this.ptype===60){let R=this.in.g2(),E=this.in.g2();return g.types[R].modelType=1,g.types[R].model=E,this.ptype=-1,!0}if(this.ptype===69){let R=this.in.g2();return g.types[R].anim=this.in.g2(),this.ptype=-1,!0}if(this.ptype===83){let R=this.in.g2();if(this.localPlayer)g.types[R].modelType=3,g.types[R].model=(this.localPlayer.appearance[8]<<6)+(this.localPlayer.appearance[0]<<12)+(this.localPlayer.colour[0]<<24)+(this.localPlayer.colour[4]<<18)+this.localPlayer.appearance[11];return this.ptype=-1,!0}if(this.ptype===32){let R=this.in.g2(),E=this.in.gjstr();if(g.types[R].text=E,g.types[R].layer===this.tabInterfaceId[this.selectedTab])this.redrawSidebar=!0;return this.ptype=-1,!0}if(this.ptype===76){let R=this.in.g2(),E=this.in.g2();return g.types[R].modelType=2,g.types[R].model=E,this.ptype=-1,!0}if(this.ptype===230){let R=this.in.g2(),E=this.in.g2b(),u=this.in.g2b(),O=g.types[R];return O.x=E,O.y=u,this.ptype=-1,!0}if(this.ptype===226){let R=this.in.g2(),E=this.in.g2(),u=g.types[R];if(typeof u<"u"&&u.type===0){if(E<0)E=0;if(E>u.scroll-u.height)E=u.scroll-u.height;u.scrollPosition=E}return this.ptype=-1,!0}if(this.ptype===132){if(this.flashingTab=this.in.g1(),this.flashingTab===this.selectedTab){if(this.flashingTab===3)this.selectedTab=1;else this.selectedTab=3;this.redrawSidebar=!0}return this.ptype=-1,!0}if(this.ptype===152)return this.stickyChatInterfaceId=this.in.g2b(),this.redrawChatback=!0,this.ptype=-1,!0;if(this.ptype==108)return this.field1264=255,this.ptype=-1,!0;if(this.ptype===143){let R=this.in.g2(),E=g.types[R];if(E.invSlotObjId)for(let u=0;u<E.invSlotObjId.length;u++)E.invSlotObjId[u]=-1,E.invSlotObjId[u]=0;return this.ptype=-1,!0}if(this.ptype===156){this.redrawSidebar=!0;let R=this.in.g2(),E=g.types[R],u=this.in.g1();if(E.invSlotObjId&&E.invSlotObjCount){for(let O=0;O<u;O++){E.invSlotObjId[O]=this.in.g2();let b=this.in.g1();if(b===255)b=this.in.g4();E.invSlotObjCount[O]=b}for(let O=u;O<E.invSlotObjId.length;O++)E.invSlotObjId[O]=0,E.invSlotObjCount[O]=0}else for(let O=0;O<u;O++)if(this.in.g2(),this.in.g1()===255)this.in.g4();return this.ptype=-1,!0}if(this.ptype===95){this.redrawSidebar=!0;let R=this.in.g2(),E=g.types[R];while(this.in.pos<this.psize){let u=this.in.g1(),O=this.in.g2(),b=this.in.g1();if(b===255)b=this.in.g4();if(E.invSlotObjId&&E.invSlotObjCount&&u>=0&&u<E.invSlotObjId.length)E.invSlotObjId[u]=O,E.invSlotObjCount[u]=b}return this.ptype=-1,!0}if(this.ptype===123){if(this.cutscene=!0,this.cutsceneDstLocalTileX=this.in.g1(),this.cutsceneDstLocalTileZ=this.in.g1(),this.cutsceneDstHeight=this.in.g2(),this.cutsceneRotateSpeed=this.in.g1(),this.cutsceneRotateAcceleration=this.in.g1(),this.cutsceneRotateAcceleration>=100){let R=this.cutsceneDstLocalTileX*128+64,E=this.cutsceneDstLocalTileZ*128+64,u=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight,O=R-this.cameraX,b=u-this.cameraY,L=E-this.cameraZ,N=Math.sqrt(O*O+L*L)|0;if(this.cameraPitch=(Math.atan2(b,N)*325.949|0)&2047,this.cameraYaw=(Math.atan2(O,L)*-325.949|0)&2047,this.cameraPitch<128)this.cameraPitch=128;else if(this.cameraPitch>383)this.cameraPitch=383}return this.ptype=-1,!0}if(this.ptype===103){let R=this.in.g1(),E=this.in.g1(),u=this.in.g1(),O=this.in.g1();return this.cameraModifierEnabled[R]=!0,this.cameraModifierJitter[R]=E,this.cameraModifierWobbleScale[R]=u,this.cameraModifierWobbleSpeed[R]=O,this.cameraModifierCycle[R]=0,this.ptype=-1,!0}if(this.ptype===86){if(this.cutscene=!0,this.cutsceneSrcLocalTileX=this.in.g1(),this.cutsceneSrcLocalTileZ=this.in.g1(),this.cutsceneSrcHeight=this.in.g2(),this.cutsceneMoveSpeed=this.in.g1(),this.cutsceneMoveAcceleration=this.in.g1(),this.cutsceneMoveAcceleration>=100)this.cameraX=this.cutsceneSrcLocalTileX*128+64,this.cameraZ=this.cutsceneSrcLocalTileZ*128+64,this.cameraY=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;return this.ptype=-1,!0}if(this.ptype===134){this.cutscene=!1;for(let R=0;R<5;R++)this.cameraModifierEnabled[R]=!1;return this.ptype=-1,!0}if(this.ptype===105)return this.getNpcPos(this.in,this.psize),this.ptype=-1,!0;if(this.ptype===161){if(this.getPlayerPos(this.in,this.psize),this.awaitingSync=!1,this.onGameTickCallback)this.onGameTickCallback();return this.ptype=-1,!0}if(this.ptype===165){let R=b0.stop();if(R)this.out.p1isaac(19),this.out.p2(R.pos),this.out.pdata(R.data,R.pos,0),R.release();return this.ptype=-1,!0}if(this.ptype===28)return b0.setEnabled(),this.ptype=-1,!0;if(this.ptype===175){let R=this.in.gjstr();if(R.endsWith(":tradereq:")){let E=R.substring(0,R.indexOf(":")),u=c.toBase37(E),O=!1;for(let b=0;b<this.ignoreCount;b++)if(this.ignoreName37[b]===u){O=!0;break}if(!O&&this.overrideChat===0)this.addMessage(4,"wishes to trade with you.",E)}else if(R.endsWith(":duelreq:")){let E=R.substring(0,R.indexOf(":")),u=c.toBase37(E),O=!1;for(let b=0;b<this.ignoreCount;b++)if(this.ignoreName37[b]===u){O=!0;break}if(!O&&this.overrideChat===0)this.addMessage(8,"wishes to duel with you.",E)}else this.addMessage(0,R,"");return this.ptype=-1,!0}if(this.ptype===181){this.ignoreCount=this.psize/8|0;for(let R=0;R<this.ignoreCount;R++)this.ignoreName37[R]=this.in.g8();return this.ptype=-1,!0}if(this.ptype===2)return this.chatPublicMode=this.in.g1(),this.chatPrivateMode=this.in.g1(),this.chatTradeMode=this.in.g1(),this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.ptype=-1,!0;if(this.ptype===207){let R=this.in.g8(),E=this.in.g4(),u=this.in.g1(),O=!1;for(let b=0;b<100;b++)if(this.messageTextIds[b]===E){O=!0;break}if(u<=1){for(let b=0;b<this.ignoreCount;b++)if(this.ignoreName37[b]===R){O=!0;break}}if(!O&&this.overrideChat===0)try{this.messageTextIds[this.privateMessageCount]=E,this.privateMessageCount=(this.privateMessageCount+1)%100;let b=g0.unpack(this.in,this.psize-13),L=z0.filter(b);if(u===2||u===3)this.addMessage(7,L,"@cr2@"+c.formatName(c.fromBase37(R)));else if(u===1)this.addMessage(7,L,"@cr1@"+c.formatName(c.fromBase37(R)));else this.addMessage(3,L,c.formatName(c.fromBase37(R)))}catch(b){}return this.ptype=-1,!0}if(this.ptype===109){let R=this.in.g8(),E=this.in.g1(),u=c.formatName(c.fromBase37(R));for(let b=0;b<this.friendCount;b++)if(R===this.friendName37[b]){if(this.friendWorld[b]!==E){if(this.friendWorld[b]=E,this.redrawSidebar=!0,E>0)this.addMessage(5,u+" has logged in.","");if(E===0)this.addMessage(5,u+" has logged out.","")}u=null;break}if(u&&this.friendCount<200)this.friendName37[this.friendCount]=R,this.friendName[this.friendCount]=u,this.friendWorld[this.friendCount]=E,this.friendCount++,this.redrawSidebar=!0;let O=!1;while(!O){O=!0;for(let b=0;b<this.friendCount-1;b++)if(this.friendWorld[b]!==s.nodeId&&this.friendWorld[b+1]===s.nodeId||this.friendWorld[b]===0&&this.friendWorld[b+1]!==0){let L=this.friendWorld[b];this.friendWorld[b]=this.friendWorld[b+1],this.friendWorld[b+1]=L;let N=this.friendName[b];this.friendName[b]=this.friendName[b+1],this.friendName[b+1]=N;let G=this.friendName37[b];this.friendName37[b]=this.friendName37[b+1],this.friendName37[b+1]=G,this.redrawSidebar=!0,O=!1}}return this.ptype=-1,!0}if(this.ptype===233)return this.flagSceneTileX=0,this.ptype=-1,!0;if(this.ptype===70){if(this.selectedTab===12)this.redrawSidebar=!0;return this.runweight=this.in.g2b(),this.ptype=-1,!0}if(this.ptype===243){if(this.hintType=this.in.g1(),this.hintType===1)this.hintNpc=this.in.g2();if(this.hintType>=2&&this.hintType<=6){if(this.hintType===2)this.hintOffsetX=64,this.hintOffsetZ=64;else if(this.hintType===3)this.hintOffsetX=0,this.hintOffsetZ=64;else if(this.hintType===4)this.hintOffsetX=128,this.hintOffsetZ=64;else if(this.hintType===5)this.hintOffsetX=64,this.hintOffsetZ=0;else if(this.hintType===6)this.hintOffsetX=64,this.hintOffsetZ=128;this.hintType=2,this.hintTileX=this.in.g2(),this.hintTileZ=this.in.g2(),this.hintHeight=this.in.g1()}if(this.hintType===10)this.hintPlayer=this.in.g2();return this.ptype=-1,!0}if(this.ptype===26)return this.systemUpdateTimer=this.in.g2()*30,this.ptype=-1,!0;if(this.ptype===110){this.redrawSidebar=!0;let R=this.in.g1(),E=this.in.g4(),u=this.in.g1();this.skillExperience[R]=E,this.skillLevel[R]=u,this.skillBaseLevel[R]=1;for(let O=0;O<98;O++)if(E>=this.levelExperience[O])this.skillBaseLevel[R]=O+2;return this.ptype=-1,!0}if(this.ptype===208){if(this.selectedTab===12)this.redrawSidebar=!0;return this.runenergy=this.in.g1(),this.ptype=-1,!0}if(this.ptype===144){for(let R=0;R<this.players.length;R++){let E=this.players[R];if(!E)continue;E.primarySeqId=-1}for(let R=0;R<this.npcs.length;R++){let E=this.npcs[R];if(!E)continue;E.primarySeqId=-1}return this.ptype=-1,!0}if(this.ptype===49)return this.localPid=this.in.g2(),this.membersAccount=this.in.g1(),this.ptype=-1,!0;if(this.ptype===238){if(this.lastAddress=this.in.g4(),this.daysSinceLastLogin=this.in.g2(),this.daysSinceRecoveriesChanged=this.in.g1(),this.unreadMessages=this.in.g2(),this.warnMembersInNonMembers=this.in.g1(),this.lastAddress!==0&&this.viewportInterfaceId===-1){this.closeInterfaces();let R=650;if(this.daysSinceRecoveriesChanged!==201||this.warnMembersInNonMembers==1)R=655;this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let E=0;E<g.types.length;E++)if(g.types[E]&&g.types[E].clientCode===R){this.viewportInterfaceId=g.types[E].layer;break}}return this.ptype=-1,!0}if(this.ptype===36)return await this.logout(),this.ptype=-1,!1;if(this.ptype===56){if(this.showSocialInput=!1,this.chatbackInputOpen=!0,this.chatbackInput="",this.redrawChatback=!0,this.isMobile)F0.show();return this.ptype=-1,!0}if(this.ptype===35)return this.inMultizone=this.in.g1(),this.ptype=-1,!0;if(this.ptype===66){let R=this.in.g2(),E=this.in.g2();if(this.sceneCenterZoneX===R&&this.sceneCenterZoneZ===E&&this.sceneState!==0)return this.ptype=-1,!0;if(this.sceneCenterZoneX=R,this.sceneCenterZoneZ=E,this.sceneBaseTileX=(this.sceneCenterZoneX-6)*8,this.sceneBaseTileZ=(this.sceneCenterZoneZ-6)*8,this.withinTutorialIsland=!1,(this.sceneCenterZoneX/8==48||this.sceneCenterZoneX/8==49)&&this.sceneCenterZoneZ/8==48)this.withinTutorialIsland=!0;else if(this.sceneCenterZoneX/8==48&&this.sceneCenterZoneZ/8==148)this.withinTutorialIsland=!0;this.sceneState=1,this.sceneLoadStartTime=performance.now(),this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(4,4);let u=0;for(let T=(this.sceneCenterZoneX-6)/8|0;T<=((this.sceneCenterZoneX+6)/8|0);T++)for(let m=(this.sceneCenterZoneZ-6)/8|0;m<=((this.sceneCenterZoneZ+6)/8|0);m++)u++;this.sceneMapLandData=new C(u,null),this.sceneMapLocData=new C(u,null),this.sceneMapIndex=new Int32Array(u),this.sceneMapLandFile=Array(u),this.sceneMapLocFile=Array(u);let O=0;for(let T=(this.sceneCenterZoneX-6)/8|0;T<=((this.sceneCenterZoneX+6)/8|0);T++)for(let m=(this.sceneCenterZoneZ-6)/8|0;m<=((this.sceneCenterZoneZ+6)/8|0);m++)if(this.sceneMapIndex[O]=(T<<8)+m,this.withinTutorialIsland&&(m==49||m==149||m==147||T==50||T==49&&m==47))this.sceneMapLandFile[O]=-1,this.sceneMapLocFile[O]=-1,O++;else if(this.onDemand){let q=this.sceneMapLandFile[O]=this.onDemand.getMapFile(T,m,0);if(q!=-1)this.onDemand.request(3,q);let K=this.sceneMapLocFile[O]=this.onDemand.getMapFile(T,m,1);if(K!=-1)this.onDemand.request(3,K);O++}let b=this.sceneBaseTileX-this.scenePrevBaseTileX,L=this.sceneBaseTileZ-this.scenePrevBaseTileZ;this.scenePrevBaseTileX=this.sceneBaseTileX,this.scenePrevBaseTileZ=this.sceneBaseTileZ;for(let T=0;T<8192;T++){let m=this.npcs[T];if(m){for(let q=0;q<10;q++)m.routeTileX[q]-=b,m.routeTileZ[q]-=L;m.x-=b*128,m.z-=L*128}}for(let T=0;T<2048;T++){let m=this.players[T];if(m){for(let q=0;q<10;q++)m.routeTileX[q]-=b,m.routeTileZ[q]-=L;m.x-=b*128,m.z-=L*128}}this.awaitingSync=!0;let N=0,G=104,H=1;if(b<0)N=104-1,G=-1,H=-1;let Q=0,$=104,J=1;if(L<0)Q=104-1,$=-1,J=-1;for(let T=N;T!==G;T+=H)for(let m=Q;m!==$;m+=J){let q=T+b,K=m+L;for(let F=0;F<4;F++)if(q>=0&&K>=0&&q<104&&K<104)this.objStacks[F][T][m]=this.objStacks[F][q][K];else this.objStacks[F][T][m]=null}for(let T=this.locChanges.head();T;T=this.locChanges.next())if(T.x-=b,T.z-=L,T.x<0||T.z<0||T.x>=104||T.z>=104)T.unlink();if(this.flagSceneTileX!==0)this.flagSceneTileX-=b,this.flagSceneTileZ-=L;return this.cutscene=!1,this.ptype=-1,!0}if(this.ptype===192){let R=this.in.g2(),E=this.in.g1b();if(this.varCache[R]=E,this.varps[R]!==E){if(this.varps[R]=E,this.updateVarp(R),this.redrawSidebar=!0,this.stickyChatInterfaceId!==-1)this.redrawChatback=!0}return this.ptype=-1,!0}if(this.ptype===75){let R=this.in.g2(),E=this.in.g4();if(this.varCache[R]=E,this.varps[R]!==E){if(this.varps[R]=E,this.updateVarp(R),this.redrawSidebar=!0,this.stickyChatInterfaceId!==-1)this.redrawChatback=!0}return this.ptype=-1,!0}if(this.ptype===25){for(let R=0;R<this.varps.length;R++)if(this.varps[R]!==this.varCache[R])this.varps[R]=this.varCache[R],this.updateVarp(R),this.redrawSidebar=!0;return this.ptype=-1,!0}if(this.ptype===209){let R=this.in.g2(),E=this.in.g1(),u=this.in.g2();if(this.waveEnabled&&!s.lowMemory&&this.waveCount<50)this.waveIds[this.waveCount]=R,this.waveLoops[this.waveCount]=E,this.waveDelay[this.waveCount]=u+O0.delays[R],this.waveCount++;return this.ptype=-1,!0}if(this.ptype===96){let R=this.in.g2();if(R==65535)R=-1;if(this.nextMidiSong!=R&&this.midiActive&&!s.lowMemory)this.midiSong=R,this.midiFading=!0,this.onDemand?.request(2,this.midiSong);return this.nextMidiSong=R,this.nextMusicDelay=0,this.ptype=-1,!0}if(this.ptype===39){let R=this.in.g2(),E=this.in.g2();if(this.midiActive&&!s.lowMemory)this.midiSong=R,this.midiFading=!1,this.onDemand?.request(2,this.midiSong),this.nextMusicDelay=E;return this.ptype=-1,!0}if(this.ptype===203)return this.baseX=this.in.g1(),this.baseZ=this.in.g1(),this.ptype=-1,!0;if(this.ptype===140){this.baseX=this.in.g1(),this.baseZ=this.in.g1();for(let R=this.baseX;R<this.baseX+8;R++)for(let E=this.baseZ;E<this.baseZ+8;E++)if(this.objStacks[this.currentLevel][R][E])this.objStacks[this.currentLevel][R][E]=null,this.sortObjStacks(R,E);for(let R=this.locChanges.head();R;R=this.locChanges.next())if(R.x>=this.baseX&&R.x<this.baseX+8&&R.z>=this.baseZ&&R.z<this.baseZ+8&&R.level===this.currentLevel)R.endTime=0;return this.ptype=-1,!0}if(this.ptype===15){this.baseX=this.in.g1(),this.baseZ=this.in.g1();while(this.in.pos<this.psize){let R=this.in.g1();this.readZonePacket(this.in,R)}return this.ptype=-1,!0}if(this.ptype===151||this.ptype===188||this.ptype===190||this.ptype===141||this.ptype===187||this.ptype===13||this.ptype===94||this.ptype===71||this.ptype===198||this.ptype===119)return this.readZonePacket(this.in,this.ptype),this.ptype=-1,!0;await this.logout()}catch(_){let R=`T2 - ${this.ptype},${this.psize} - ${this.ptype1},${this.ptype2} - ${this.psize},${(this.localPlayer?.routeTileX[0]??0)+this.sceneBaseTileX},${(this.localPlayer?.routeTileZ[0]??0)+this.sceneBaseTileZ} -`;for(let E=0;E<this.psize&&E<50;E++)R+=this.in.data[E]+",";await this.logout()}return!0}readZonePacket(_,R){let E=_.g1(),u=this.baseX+(E>>4&7),O=this.baseZ+(E&7);if(R===119){let b=_.g1(),L=b>>2,N=b&3,G=n.of(L).layer,H=_.g2();if(u>=0&&O>=0&&u<104&&O<104)this.appendLoc(-1,H,N,G,O,L,this.currentLevel,u,0)}else if(R===198){let b=_.g1(),L=b>>2,N=b&3,G=n.of(L).layer;if(u>=0&&O>=0&&u<104&&O<104)this.appendLoc(-1,-1,N,G,O,L,this.currentLevel,u,0)}else if(R===71){let b=_.g1(),L=b>>2,N=b&3,G=n.of(L).layer,H=_.g2();if(u>=0&&O>=0&&u<104&&O<104&&this.scene&&this.levelHeightmap){let Q=this.levelHeightmap[this.currentLevel][u][O],$=this.levelHeightmap[this.currentLevel][u+1][O],J=this.levelHeightmap[this.currentLevel][u+1][O+1],T=this.levelHeightmap[this.currentLevel][u][O+1];if(G==0){let m=this.scene.getWall(this.currentLevel,u,O);if(m){let q=m.typecode>>14&32767;if(L==2)m.model1=new R0(this.loopCycle,q,2,N+4,Q,$,J,T,H,!1),m.model2=new R0(this.loopCycle,q,2,N+1&3,Q,$,J,T,H,!1);else m.model1=new R0(this.loopCycle,q,L,N,Q,$,J,T,H,!1)}}else if(G==1){let m=this.scene.getDecor(this.currentLevel,O,u);if(m)m.model=new R0(this.loopCycle,m.typecode>>14&32767,4,0,Q,J,J,T,H,!1)}else if(G==2){let m=this.scene.getLoc(this.currentLevel,u,O);if(L==11)L=10;if(m)m.model=new R0(this.loopCycle,m.typecode>>14&32767,L,N,Q,$,J,T,H,!1)}else if(G==3){let m=this.scene.getGroundDecor(this.currentLevel,u,O);if(m)m.model=new R0(this.loopCycle,m.typecode>>14&32767,22,N,Q,$,J,T,H,!1)}}}else if(R===94){let b=_.g2(),L=_.g2();if(u>=0&&O>=0&&u<104&&O<104){let N=new o0(b,L);if(!this.objStacks[this.currentLevel][u][O])this.objStacks[this.currentLevel][u][O]=new K0;this.objStacks[this.currentLevel][u][O]?.push(N),this.sortObjStacks(u,O)}}else if(R===13){let b=_.g2();if(u>=0&&O>=0&&u<104&&O<104){let L=this.objStacks[this.currentLevel][u][O];if(L){for(let N=L.head();N;N=L.next())if(N.index===(b&32767)){N.unlink();break}if(!L.head())this.objStacks[this.currentLevel][u][O]=null;this.sortObjStacks(u,O)}}}else if(R===187){let b=u+_.g1b(),L=O+_.g1b(),N=_.g2b(),G=_.g2(),H=_.g1(),Q=_.g1(),$=_.g2(),J=_.g2(),T=_.g1(),m=_.g1();if(u>=0&&O>=0&&u<104&&O<104&&b>=0&&L>=0&&b<104&&L<104){u=u*128+64,O=O*128+64,b=b*128+64,L=L*128+64;let q=new K1(G,this.currentLevel,u,this.getHeightmapY(this.currentLevel,u,O)-H,O,$+this.loopCycle,J+this.loopCycle,T,m,N,Q);q.updateVelocity(b,this.getHeightmapY(this.currentLevel,b,L)-Q,L,$+this.loopCycle),this.projectiles.push(q)}}else if(R===141){let b=_.g2(),L=_.g1(),N=_.g2();if(u>=0&&O>=0&&u<104&&O<104){u=u*128+64,O=O*128+64;let G=new F1(b,this.currentLevel,u,O,this.getHeightmapY(this.currentLevel,u,O)-L,this.loopCycle,N);this.spotanims.push(G)}}else if(R===190){let b=_.g2(),L=_.g2(),N=_.g2();if(u>=0&&O>=0&&u<104&&O<104&&N!==this.localPid){let G=new o0(b,L);if(!this.objStacks[this.currentLevel][u][O])this.objStacks[this.currentLevel][u][O]=new K0;this.objStacks[this.currentLevel][u][O]?.push(G),this.sortObjStacks(u,O)}}else if(R===188){let b=_.g1(),L=b>>2,N=b&3,G=n.of(L).layer,H=_.g2(),Q=_.g2(),$=_.g2(),J=_.g2(),T=_.g1b(),m=_.g1b(),q=_.g1b(),K=_.g1b(),F;if(J===this.localPid)F=this.localPlayer;else F=this.players[J];if(F&&this.levelHeightmap){let w=o.get(H),k=this.levelHeightmap[this.currentLevel][u][O],Y=this.levelHeightmap[this.currentLevel][u+1][O],A=this.levelHeightmap[this.currentLevel][u+1][O+1],h=this.levelHeightmap[this.currentLevel][u][O+1],Z=w.getModel(L,N,k,Y,A,h,-1);if(Z){this.appendLoc($+1,-1,0,G,O,0,this.currentLevel,u,Q+1),F.locStartCycle=Q+this.loopCycle,F.locStopCycle=$+this.loopCycle,F.locModel=Z;let{width:f,length:S}=w;if(N===1||N===3)f=w.length,S=w.width;F.locOffsetX=u*128+f*64,F.locOffsetZ=O*128+S*64,F.locOffsetY=this.getHeightmapY(this.currentLevel,F.locOffsetX,F.locOffsetZ);let j;if(T>q)j=T,T=q,q=j;if(m>K)j=m,m=K,K=j;F.minTileX=u+T,F.maxTileX=u+q,F.minTileZ=O+m,F.maxTileZ=O+K}}}else if(R===151){let b=_.g2(),L=_.g2(),N=_.g2();if(u>=0&&O>=0&&u<104&&O<104){let G=this.objStacks[this.currentLevel][u][O];if(G){for(let H=G.head();H;H=G.next())if(H.index===(b&32767)&&H.count===L){H.count=N;break}this.sortObjStacks(u,O)}}}}appendLoc(_,R,E,u,O,b,L,N,G){let H=null;for(let Q=this.locChanges.head();Q;Q=this.locChanges.next())if(Q.level===this.currentLevel&&Q.x===N&&Q.z===O&&Q.layer===u){H=Q;break}if(!H)H=new U1,H.level=L,H.layer=u,H.x=N,H.z=O,this.storeLoc(H),this.locChanges.push(H);H.newType=R,H.newShape=b,H.newAngle=E,H.startTime=G,H.endTime=_}storeLoc(_){if(!this.scene)return;let R=0,E=-1,u=0,O=0;if(_.layer===0)R=this.scene.getWallTypecode(_.level,_.x,_.z);else if(_.layer===1)R=this.scene.getDecorTypecode(_.level,_.z,_.x);else if(_.layer===2)R=this.scene.getLocTypecode(_.level,_.x,_.z);else if(_.layer===3)R=this.scene.getGroundDecorTypecode(_.level,_.x,_.z);if(R!==0){let b=this.scene.getInfo(_.level,_.x,_.z,R);E=R>>14&32767,u=b&31,O=b>>6}_.oldType=E,_.oldShape=u,_.oldAngle=O}addLoc(_,R,E,u,O,b,L){if(R<1||E<1||R>102||E>102)return;if(s.lowMemory&&_!==this.currentLevel)return;if(!this.scene)return;let N=0;if(L===0)N=this.scene.getWallTypecode(_,R,E);else if(L===1)N=this.scene.getDecorTypecode(_,E,R);else if(L===2)N=this.scene.getLocTypecode(_,R,E);else if(L===3)N=this.scene.getGroundDecorTypecode(_,R,E);if(N!==0){let G=this.scene.getInfo(_,R,E,N),H=N>>14&32767,Q=G&31,$=G>>6;if(L===0){this.scene?.removeWall(_,R,E,1);let J=o.get(H);if(J.blockwalk)this.levelCollisionMap[_]?.removeWall(R,E,Q,$,J.blockrange)}else if(L===1)this.scene?.removeWallDecoration(_,R,E);else if(L===2){this.scene.removeLoc(_,R,E);let J=o.get(H);if(R+J.width>104-1||E+J.width>104-1||R+J.length>104-1||E+J.length>104-1)return;if(J.blockwalk)this.levelCollisionMap[_]?.removeLoc(R,E,J.width,J.length,$,J.blockrange)}else if(L===3){this.scene?.removeGroundDecoration(_,R,E);let J=o.get(H);if(J.blockwalk&&J.active)this.levelCollisionMap[_]?.removeFloor(R,E)}}if(u>=0){let G=_;if(this.levelTileFlags&&_<3&&(this.levelTileFlags[1][R][E]&2)===2)G=_+1;if(this.levelHeightmap)i.addLoc(this.loopCycle,_,R,E,this.scene,this.levelHeightmap,this.levelCollisionMap[_],u,b,O,G)}}sortObjStacks(_,R){let E=this.objStacks[this.currentLevel][_][R];if(!E){this.scene?.removeGroundObject(this.currentLevel,_,R);return}let u=-99999999,O=null;for(let G=E.head();G;G=E.next()){let H=x.get(G.index),Q=H.cost;if(H.stackable)Q*=G.count+1;if(Q>u)u=Q,O=G}if(!O)return;E.addHead(O);let b=null,L=null;for(let G=E.head();G;G=E.next()){if(G.index!==O.index&&b===null)b=G;if(G.index!==O.index&&b&&G.index!==b.index&&L===null)L=G}let N=_+(R<<7)+1610612736|0;this.scene?.addGroundObject(_,R,this.getHeightmapY(this.currentLevel,_*128+64,R*128+64),this.currentLevel,N,O,L,b)}getPlayerPos(_,R){this.entityRemovalCount=0,this.entityUpdateCount=0,this.getPlayerLocal(_),this.getPlayerOldVis(_),this.getPlayerNewVis(_,R),this.getPlayerExtended(_);for(let E=0;E<this.entityRemovalCount;E++){let u=this.entityRemovalIds[E],O=this.players[u];if(!O)continue;if(O.cycle!==this.loopCycle)this.players[u]=null}if(_.pos!==R)throw Error("eek");for(let E=0;E<this.playerCount;E++)if(!this.players[this.playerIds[E]])throw Error("eek")}getPlayerLocal(_){if(_.bits(),_.gBit(1)!==0){let E=_.gBit(2);if(E===0)this.entityUpdateIds[this.entityUpdateCount++]=2047;else if(E===1){let u=_.gBit(3);if(this.localPlayer?.step(!1,u),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}else if(E===2){let u=_.gBit(3);this.localPlayer?.step(!0,u);let O=_.gBit(3);if(this.localPlayer?.step(!0,O),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}else if(E===3){this.currentLevel=_.gBit(2);let u=_.gBit(7),O=_.gBit(7),b=_.gBit(1);if(this.localPlayer?.move(b===1,u,O),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}}}getPlayerOldVis(_){let R=_.gBit(8);if(R<this.playerCount)for(let E=R;E<this.playerCount;E++)this.entityRemovalIds[this.entityRemovalCount++]=this.playerIds[E];if(R>this.playerCount)throw Error();this.playerCount=0;for(let E=0;E<R;E++){let u=this.playerIds[E],O=this.players[u];if(_.gBit(1)===0){if(this.playerIds[this.playerCount++]=u,O)O.cycle=this.loopCycle}else{let L=_.gBit(2);if(L===0){if(this.playerIds[this.playerCount++]=u,O)O.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=u}else if(L===1){if(this.playerIds[this.playerCount++]=u,O)O.cycle=this.loopCycle;let N=_.gBit(3);if(O?.step(!1,N),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=u}else if(L===2){if(this.playerIds[this.playerCount++]=u,O)O.cycle=this.loopCycle;let N=_.gBit(3);O?.step(!0,N);let G=_.gBit(3);if(O?.step(!0,G),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=u}else if(L===3)this.entityRemovalIds[this.entityRemovalCount++]=u}}}getPlayerNewVis(_,R){while(_.bitPos+10<R*8){let E=_.gBit(11);if(E===2047)break;if(!this.players[E]){this.players[E]=new J0;let G=this.playerAppearanceBuffer[E];if(G)this.players[E]?.read(G)}this.playerIds[this.playerCount++]=E;let u=this.players[E];if(u)u.cycle=this.loopCycle;let O=_.gBit(5);if(O>15)O-=32;let b=_.gBit(5);if(b>15)b-=32;let L=_.gBit(1);if(this.localPlayer)u?.move(L===1,this.localPlayer.routeTileX[0]+O,this.localPlayer.routeTileZ[0]+b);if(_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=E}_.bytes()}getPlayerExtended(_){for(let R=0;R<this.entityUpdateCount;R++){let E=this.entityUpdateIds[R],u=this.players[E];if(!u)continue;let O=_.g1();if((O&128)!==0)O+=_.g1()<<8;this.getPlayerExtendedInfo(u,E,O,_)}}getPlayerExtendedInfo(_,R,E,u){if((E&1)!==0){let O=u.g1(),b=new Uint8Array(O),L=new P(b);u.gdata(O,0,b),this.playerAppearanceBuffer[R]=L,_.read(L)}if((E&2)!==0){let O=u.g2();if(O===65535)O=-1;if(O===_.primarySeqId)_.primarySeqLoop=0;let b=u.g1();if(_.primarySeqId===O&&O!==-1){let L=e.types[O].duplicatebehavior;if(L==1)_.primarySeqFrame=0,_.primarySeqCycle=0,_.primarySeqDelay=b,_.primarySeqLoop=0;else if(L==2)_.primarySeqLoop=0}else if(O===-1||_.primarySeqId===-1||e.types[O].priority>e.types[_.primarySeqId].priority||e.types[_.primarySeqId].priority===0)_.primarySeqId=O,_.primarySeqFrame=0,_.primarySeqCycle=0,_.primarySeqDelay=b,_.primarySeqLoop=0,_.preanimRouteLength=_.routeLength}if((E&4)!==0){if(_.targetId=u.g2(),_.targetId===65535)_.targetId=-1}if((E&8)!==0){if(_.chatMessage=u.gjstr(),_.chatColour=0,_.chatEffect=0,_.chatTimer=150,_.name)this.addMessage(2,_.chatMessage,_.name)}if((E&16)!==0){let O=u.g1(),b=u.g1();_.hit(this.loopCycle,b,O),_.combatCycle=this.loopCycle+400,_.health=u.g1(),_.totalHealth=u.g1()}if((E&32)!==0)_.targetTileX=u.g2(),_.targetTileZ=u.g2();if((E&64)!==0){let O=u.g2(),b=u.g1(),L=u.g1(),N=u.pos;if(_.name&&_.visible){let G=c.toBase37(_.name),H=!1;if(b<=1){for(let Q=0;Q<this.ignoreCount;Q++)if(this.ignoreName37[Q]===G){H=!0;break}}if(!H&&this.overrideChat===0)try{let Q=g0.unpack(u,L),$=z0.filter(Q);if(_.chatMessage=$,_.chatColour=O>>8,_.chatEffect=O&255,_.chatTimer=150,b===2||b===3)this.addMessage(1,$,"@cr2@"+_.name);else if(b===1)this.addMessage(1,$,"@cr1@"+_.name);else this.addMessage(2,$,_.name)}catch(Q){}}u.pos=N+L}if((E&256)!==0){_.spotanimId=u.g2();let O=u.g4();if(_.spotanimHeight=O>>16,_.spotanimLastCycle=this.loopCycle+(O&65535),_.spotanimFrame=0,_.spotanimCycle=0,_.spotanimLastCycle>this.loopCycle)_.spotanimFrame=-1;if(_.spotanimId===65535)_.spotanimId=-1}if((E&512)!==0)_.forceMoveStartSceneTileX=u.g1(),_.forceMoveStartSceneTileZ=u.g1(),_.forceMoveEndSceneTileX=u.g1(),_.forceMoveEndSceneTileZ=u.g1(),_.forceMoveEndCycle=u.g2()+this.loopCycle,_.forceMoveStartCycle=u.g2()+this.loopCycle,_.forceMoveFaceDirection=u.g1(),_.clearRoute();if((E&1024)!==0){let O=u.g1(),b=u.g1();_.hit(this.loopCycle,b,O),_.combatCycle=this.loopCycle+400,_.health=u.g1(),_.totalHealth=u.g1()}}getNpcPos(_,R){this.entityRemovalCount=0,this.entityUpdateCount=0,this.getNpcPosOldVis(_),this.getNpcPosNewVis(_,R),this.getNpcPosExtended(_);for(let E=0;E<this.entityRemovalCount;E++){let u=this.entityRemovalIds[E],O=this.npcs[u];if(!O)continue;if(O.cycle!==this.loopCycle)O.type=null,this.npcs[u]=null}if(_.pos!==R)throw Error("eek");for(let E=0;E<this.npcCount;E++)if(!this.npcs[this.npcIds[E]])throw Error("eek")}getNpcPosOldVis(_){_.bits();let R=_.gBit(8);if(R<this.npcCount)for(let E=R;E<this.npcCount;E++)this.entityRemovalIds[this.entityRemovalCount++]=this.npcIds[E];if(R>this.npcCount)throw Error("eek");this.npcCount=0;for(let E=0;E<R;E++){let u=this.npcIds[E],O=this.npcs[u];if(_.gBit(1)===0){if(this.npcIds[this.npcCount++]=u,O)O.cycle=this.loopCycle}else{let L=_.gBit(2);if(L===0){if(this.npcIds[this.npcCount++]=u,O)O.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=u}else if(L===1){if(this.npcIds[this.npcCount++]=u,O)O.cycle=this.loopCycle;let N=_.gBit(3);if(O?.step(!1,N),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=u}else if(L===2){if(this.npcIds[this.npcCount++]=u,O)O.cycle=this.loopCycle;let N=_.gBit(3);O?.step(!0,N);let G=_.gBit(3);if(O?.step(!0,G),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=u}else if(L===3)this.entityRemovalIds[this.entityRemovalCount++]=u}}}getNpcPosNewVis(_,R){while(_.bitPos+21<R*8){let E=_.gBit(13);if(E===8191)break;if(!this.npcs[E])this.npcs[E]=new T1;let u=this.npcs[E];if(this.npcIds[this.npcCount++]=E,u)u.cycle=this.loopCycle,u.type=A0.get(_.gBit(11)),u.size=u.type.size,u.walkanim=u.type.walkanim,u.walkanim_b=u.type.walkanim_b,u.walkanim_l=u.type.walkanim_r,u.walkanim_r=u.type.walkanim_l,u.readyanim=u.type.readyanim;else _.gBit(11);let O=_.gBit(5);if(O>15)O-=32;let b=_.gBit(5);if(b>15)b-=32;if(this.localPlayer)u?.move(!1,this.localPlayer.routeTileX[0]+O,this.localPlayer.routeTileZ[0]+b);if(_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=E}_.bytes()}getNpcPosExtended(_){for(let R=0;R<this.entityUpdateCount;R++){let E=this.entityUpdateIds[R],u=this.npcs[E];if(!u)continue;let O=_.g1();if((O&1)!==0){let b=_.g1(),L=_.g1();u.hit(this.loopCycle,L,b),u.combatCycle=this.loopCycle+400,u.health=_.g1(),u.totalHealth=_.g1()}if((O&2)!==0){let b=_.g2();if(b===65535)b=-1;if(b===u.primarySeqId)u.primarySeqLoop=0;let L=_.g1();if(u.primarySeqId===b&&b!==-1){let N=e.types[b].duplicatebehavior;if(N==1)u.primarySeqFrame=0,u.primarySeqCycle=0,u.primarySeqDelay=L,u.primarySeqLoop=0;else if(N==2)u.primarySeqLoop=0}else if(b===-1||u.primarySeqId===-1||e.types[b].priority>e.types[u.primarySeqId].priority||e.types[u.primarySeqId].priority===0)u.primarySeqId=b,u.primarySeqFrame=0,u.primarySeqCycle=0,u.primarySeqDelay=L,u.primarySeqLoop=0,u.preanimRouteLength=u.routeLength}if((O&4)!==0){if(u.targetId=_.g2(),u.targetId===65535)u.targetId=-1}if((O&8)!==0)u.chatMessage=_.gjstr(),u.chatTimer=100;if((O&16)!==0){let b=_.g1(),L=_.g1();u.hit(this.loopCycle,L,b),u.combatCycle=this.loopCycle+400,u.health=_.g1(),u.totalHealth=_.g1()}if((O&32)!==0)u.type=A0.get(_.g2()),u.walkanim=u.type.walkanim,u.walkanim_b=u.type.walkanim_b,u.walkanim_l=u.type.walkanim_r,u.walkanim_r=u.type.walkanim_l,u.readyanim=u.type.readyanim;if((O&64)!==0){u.spotanimId=_.g2();let b=_.g4();if(u.spotanimHeight=b>>16,u.spotanimLastCycle=this.loopCycle+(b&65535),u.spotanimFrame=0,u.spotanimCycle=0,u.spotanimLastCycle>this.loopCycle)u.spotanimFrame=-1;if(u.spotanimId===65535)u.spotanimId=-1}if((O&128)!==0)u.targetTileX=_.g2(),u.targetTileZ=_.g2()}}showContextMenu(){let _=0;if(this.fontBold12){_=this.fontBold12.stringWidth("Choose Option");let O;for(let b=0;b<this.menuSize;b++)if(O=this.fontBold12.stringWidth(this.menuOption[b]),O>_)_=O}_+=8;let R=this.menuSize*15+21,E,u;if(this.mouseClickX>4&&this.mouseClickY>4&&this.mouseClickX<516&&this.mouseClickY<338){if(E=this.mouseClickX-(_/2|0)-8,E+_>512)E=512-_;if(E<0)E=0;if(u=this.mouseClickY-11,u+R>334)u=334-R;if(u<0)u=0;this.menuVisible=!0,this.menuArea=0,this.menuX=E,this.menuY=u,this.menuWidth=_,this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>553&&this.mouseClickY>205&&this.mouseClickX<743&&this.mouseClickY<466){if(E=this.mouseClickX-(_/2|0)-553,E<0)E=0;else if(E+_>190)E=190-_;if(u=this.mouseClickY-205,u<0)u=0;else if(u+R>261)u=261-R;this.menuVisible=!0,this.menuArea=1,this.menuX=E,this.menuY=u,this.menuWidth=_,this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>17&&this.mouseClickY>357&&this.mouseClickX<496&&this.mouseClickY<453){if(E=this.mouseClickX-(_/2|0)-17,E<0)E=0;else if(E+_>479)E=479-_;if(u=this.mouseClickY-357,u<0)u=0;else if(u+R>96)u=96-R;this.menuVisible=!0,this.menuArea=2,this.menuX=E,this.menuY=u,this.menuWidth=_,this.menuHeight=this.menuSize*15+22}}isAddFriendOption(_){if(_<0)return!1;let R=this.menuAction[_];if(R>=2000)R-=2000;return R===406}useMenuOption(_){if(_<0)return;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;let R=this.menuAction[_],E=this.menuParamA[_],u=this.menuParamB[_],O=this.menuParamC[_];if(R>=2000)R-=2000;if(R===224||R===993||R===99||R===746||R===877){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],u,O,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],u,O,2,1,1,0,0,0,!1);if(this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,R===224)this.out.p1isaac(113);if(R===993)this.out.p1isaac(238);if(R===99)this.out.p1isaac(55);if(R===746)this.out.p1isaac(17);if(R===877)this.out.p1isaac(247);this.out.p2(u+this.sceneBaseTileX),this.out.p2(O+this.sceneBaseTileZ),this.out.p2(E)}}if(R===1102){let b=x.get(E),L;if(!b.desc)L="It's a "+b.name+".";else L=b.desc;this.addMessage(0,L,"")}if(R===965){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],u,O,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],u,O,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(122),this.out.p2(u+this.sceneBaseTileX),this.out.p2(O+this.sceneBaseTileZ),this.out.p2(E),this.out.p2(this.activeSpellId)}}if(R===217){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],u,O,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],u,O,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(143),this.out.p2(u+this.sceneBaseTileX),this.out.p2(O+this.sceneBaseTileZ),this.out.p2(E),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}}if(R===728||R===542||R===6||R===963||R===245){let b=this.npcs[E];if(b&&this.localPlayer){if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],b.routeTileX[0],b.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,R===728)this.out.p1isaac(180);if(R===542)this.out.p1isaac(252);if(R===6){if((E&3)===0)s.oplogic2++;if(s.oplogic2>=124)this.out.p1isaac(95),this.out.p4(0);this.out.p1isaac(196)}if(R===963)this.out.p1isaac(107);if(R===245){if((E&3)===0)s.oplogic4++;if(s.oplogic4>=85)this.out.p1isaac(186),this.out.p2(39596);this.out.p1isaac(43)}this.out.p2(E)}}if(R===1607){let b=this.npcs[E];if(b&&b.type){let L;if(!b.type.desc)L="It's a "+b.type.name+".";else L=b.type.desc;this.addMessage(0,L,"")}}if(R===265){let b=this.npcs[E];if(b&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],b.routeTileX[0],b.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(141),this.out.p2(E),this.out.p2(this.activeSpellId)}if(R===900){let b=this.npcs[E];if(b&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],b.routeTileX[0],b.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(14),this.out.p2(E),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}if(R===285)this.interactWithLoc(1,u,O,E);if(R===504)this.interactWithLoc(219,u,O,E);if(R===364)this.interactWithLoc(226,u,O,E);if(R===581){if((E&3)===0)s.oplogic1++;if(s.oplogic1>=99)this.out.p1isaac(87),this.out.p4(0);this.interactWithLoc(204,u,O,E)}if(R===1501){if(s.oplogic6+=this.sceneBaseTileZ,s.oplogic6>=92)this.out.p1isaac(250),this.out.p4(0);this.interactWithLoc(86,u,O,E)}if(R===1175){let b=E>>14&32767,L=o.get(b),N;if(!L.desc)N="It's a "+L.name+".";else N=L.desc;this.addMessage(0,N,"")}if(R===55){if(this.interactWithLoc(208,u,O,E))this.out.p2(this.activeSpellId)}if(R===450){if(this.interactWithLoc(147,u,O,E))this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}if(R===1373||R===1544||R===151||R===1101){let b=this.players[E];if(b&&this.localPlayer){if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],b.routeTileX[0],b.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,R===1101)this.out.p1isaac(135);if(R===151){if(s.oplogic8++,s.oplogic8>=90)this.out.p1isaac(171),this.out.p2(31114);this.out.p1isaac(165)}if(R===1544)this.out.p1isaac(172);if(R===1373)this.out.p1isaac(54);this.out.p2(E)}}if(R===903||R===363){let b=this.menuOption[_],L=b.indexOf("@whi@");if(L!==-1){b=b.substring(L+5).trim();let N=c.formatName(c.fromBase37(c.toBase37(b))),G=!1;for(let H=0;H<this.playerCount;H++){let Q=this.players[this.playerIds[H]];if(Q&&Q.name&&Q.name.toLowerCase()===N.toLowerCase()&&this.localPlayer){if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],Q.routeTileX[0],Q.routeTileZ[0],2,1,1,0,0,0,!1),R===363)this.out.p1isaac(135);if(R===903)this.out.p1isaac(54);this.out.p2(this.playerIds[H]),G=!0;break}}if(!G)this.addMessage(0,"Unable to find "+N,"")}}if(R===651){let b=this.players[E];if(b&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],b.routeTileX[0],b.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(52),this.out.p2(E),this.out.p2(this.activeSpellId)}if(R===367){let b=this.players[E];if(b&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],b.routeTileX[0],b.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(210),this.out.p2(E),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}if(R===405||R===38||R===422||R===478||R===347){if(R===405){if(s.oplogic3+=E,s.oplogic3>=97)this.out.p1isaac(146),this.out.p3(14953816);this.out.p1isaac(104)}if(R===38)this.out.p1isaac(193);if(R===422)this.out.p1isaac(115);if(R===478){if((u&3)===0)s.oplogic5++;if(s.oplogic5>=90)this.out.p1isaac(74);this.out.p1isaac(194)}if(R===347)this.out.p1isaac(9);if(this.out.p2(E),this.out.p2(u),this.out.p2(O),this.selectedCycle=0,this.selectedInterface=O,this.selectedItem=u,this.selectedArea=2,g.types[O].layer===this.viewportInterfaceId)this.selectedArea=1;if(g.types[O].layer===this.chatInterfaceId)this.selectedArea=3}if(R===1773){let b=x.get(E),L;if(O>=1e5)L=O+" x "+b.name;else if(!b.desc)L="It's a "+b.name+".";else L=b.desc;this.addMessage(0,L,"")}if(R===188){this.objSelected=1,this.objSelectedSlot=u,this.objSelectedInterface=O,this.objInterface=E,this.objSelectedName=x.get(E).name,this.spellSelected=0,this.redrawSidebar=!0;return}if(R===930){let b=g.types[O];this.spellSelected=1,this.activeSpellId=O,this.activeSpellFlags=b.targetMask,this.objSelected=0,this.redrawSidebar=!0;let L=b.targetVerb;if(L&&L.indexOf(" ")!==-1)L=L.substring(0,L.indexOf(" "));let N=b.targetVerb;if(N&&N.indexOf(" ")!==-1)N=N.substring(N.indexOf(" ")+1);if(this.spellCaption=L+" "+b.targetText+" "+N,this.activeSpellFlags===16)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;return}if(R===391){if(this.out.p1isaac(188),this.out.p2(E),this.out.p2(u),this.out.p2(O),this.out.p2(this.activeSpellId),this.selectedCycle=0,this.selectedInterface=O,this.selectedItem=u,this.selectedArea=2,g.types[O].layer===this.viewportInterfaceId)this.selectedArea=1;if(g.types[O].layer===this.chatInterfaceId)this.selectedArea=3}if(R===881){if(this.out.p1isaac(126),this.out.p2(E),this.out.p2(u),this.out.p2(O),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface),this.selectedCycle=0,this.selectedInterface=O,this.selectedItem=u,this.selectedArea=2,g.types[O].layer===this.viewportInterfaceId)this.selectedArea=1;if(g.types[O].layer===this.chatInterfaceId)this.selectedArea=3}if(R===602||R===596||R===22||R===892||R===415){if(R===602)this.out.p1isaac(13);if(R===596)this.out.p1isaac(58);if(R===22)this.out.p1isaac(48);if(R===892){if((u&3)===0)s.oplogic9++;if(s.oplogic9>=130)this.out.p1isaac(233),this.out.p1(177);this.out.p1isaac(183)}if(R===415){if((O&3)===0)s.oplogic7++;if(s.oplogic7>=55)this.out.p1isaac(119),this.out.p4(0);this.out.p1isaac(242)}if(this.out.p2(E),this.out.p2(u),this.out.p2(O),this.selectedCycle=0,this.selectedInterface=O,this.selectedItem=u,this.selectedArea=2,g.types[O].layer===this.viewportInterfaceId)this.selectedArea=1;if(g.types[O].layer===this.chatInterfaceId)this.selectedArea=3}if(R===465){this.out.p1isaac(177),this.out.p2(O);let b=g.types[O];if(b.scripts&&b.scripts[0]&&b.scripts[0][0]===5){let L=b.scripts[0][1];this.varps[L]=1-this.varps[L],this.updateVarp(L),this.redrawSidebar=!0}}if(R===951){let b=g.types[O],L=!0;if(b.clientCode>0)L=this.handleInterfaceAction(b);if(L)this.out.p1isaac(177),this.out.p2(O)}if(R===960){this.out.p1isaac(177),this.out.p2(O);let b=g.types[O];if(b.scripts&&b.scripts[0]&&b.scripts[0][0]===5){let L=b.scripts[0][1];if(b.scriptOperand&&this.varps[L]!==b.scriptOperand[0])this.varps[L]=b.scriptOperand[0],this.updateVarp(L),this.redrawSidebar=!0}}if(R===44){if(!this.pressedContinueOption)this.out.p1isaac(239),this.out.p2(O),this.pressedContinueOption=!0}if(R===947)this.closeInterfaces();if(R===34){let b=this.menuOption[_],L=b.indexOf("@whi@");if(L!==-1){this.closeInterfaces(),this.reportAbuseInput=b.substring(L+5).trim(),this.reportAbuseMuteOption=!1;for(let N=0;N<g.types.length;N++)if(g.types[N]&&g.types[N].clientCode===600){this.reportAbuseInterfaceId=this.viewportInterfaceId=g.types[N].layer;break}}}if(R===660)if(this.menuVisible)this.scene?.click(u-8,O-11);else this.scene?.click(this.mouseClickX-8,this.mouseClickY-11);if(R===406||R===436||R===557||R===556){let b=this.menuOption[_],L=b.indexOf("@whi@");if(L!==-1){let N=c.toBase37(b.substring(L+5).trim());if(R===406)this.addFriend(N);else if(R===436)this.addIgnore(N);else if(R===557)this.removeFriend(N);else if(R===556)this.removeIgnore(N)}}if(R===679){let b=this.menuOption[_],L=b.indexOf("@whi@");if(L!==-1){let N=c.toBase37(b.substring(L+5).trim()),G=-1;for(let H=0;H<this.friendCount;H++)if(this.friendName37[H]===N){G=H;break}if(G!==-1&&this.friendWorld[G]>0)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=3,this.socialName37=this.friendName37[G],this.socialMessage="Enter message to send to "+this.friendName[G]}}this.objSelected=0,this.spellSelected=0,this.redrawSidebar=!0}addNpcOptions(_,R,E,u){if(this.menuSize>=400)return;let O=_.name;if(_.vislevel!==0&&this.localPlayer)O=O+this.getCombatLevelTag(this.localPlayer.combatLevel,_.vislevel)+" (level-"+_.vislevel+")";if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @yel@"+O,this.menuAction[this.menuSize]=900,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=u,this.menuSize++;else if(this.spellSelected!==1){let b;if(_.op){for(b=4;b>=0;b--)if(_.op[b]&&_.op[b]?.toLowerCase()!=="attack"){if(this.menuOption[this.menuSize]=_.op[b]+" @yel@"+O,b===0)this.menuAction[this.menuSize]=728;else if(b===1)this.menuAction[this.menuSize]=542;else if(b===2)this.menuAction[this.menuSize]=6;else if(b===3)this.menuAction[this.menuSize]=963;else if(b===4)this.menuAction[this.menuSize]=245;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=u,this.menuSize++}}if(_.op){for(b=4;b>=0;b--)if(_.op[b]&&_.op[b]?.toLowerCase()==="attack"){let L=0;if(this.localPlayer&&_.vislevel>this.localPlayer.combatLevel)L=2000;if(this.menuOption[this.menuSize]=_.op[b]+" @yel@"+O,b===0)this.menuAction[this.menuSize]=L+728;else if(b===1)this.menuAction[this.menuSize]=L+542;else if(b===2)this.menuAction[this.menuSize]=L+6;else if(b===3)this.menuAction[this.menuSize]=L+963;else if(b===4)this.menuAction[this.menuSize]=L+245;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=u,this.menuSize++}}this.menuOption[this.menuSize]="Examine @yel@"+O,this.menuAction[this.menuSize]=1607,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=u,this.menuSize++}else if((this.activeSpellFlags&2)===2)this.menuOption[this.menuSize]=this.spellCaption+" @yel@"+O,this.menuAction[this.menuSize]=265,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=u,this.menuSize++}addPlayerOptions(_,R,E,u){if(_===this.localPlayer||this.menuSize>=400)return;let O=null;if(this.localPlayer)O=_.name+this.getCombatLevelTag(this.localPlayer.combatLevel,_.combatLevel)+" (level-"+_.combatLevel+")";if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @whi@"+O,this.menuAction[this.menuSize]=367,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=u,this.menuSize++;else if(this.spellSelected!==1){if(this.menuOption[this.menuSize]="Follow @whi@"+O,this.menuAction[this.menuSize]=1544,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=u,this.menuSize++,this.overrideChat===0)this.menuOption[this.menuSize]="Trade with @whi@"+O,this.menuAction[this.menuSize]=1373,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=u,this.menuSize++;if(this.wildernessLevel>0){if(this.menuOption[this.menuSize]="Attack @whi@"+O,this.localPlayer&&this.localPlayer.combatLevel>=_.combatLevel)this.menuAction[this.menuSize]=151;else this.menuAction[this.menuSize]=2151;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=u,this.menuSize++}if(this.worldLocationState===1)this.menuOption[this.menuSize]="Fight @whi@"+O,this.menuAction[this.menuSize]=151,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=u,this.menuSize++;if(this.worldLocationState===2)this.menuOption[this.menuSize]="Duel-with @whi@"+O,this.menuAction[this.menuSize]=1101,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=u,this.menuSize++}else if((this.activeSpellFlags&8)===8)this.menuOption[this.menuSize]=this.spellCaption+" @whi@"+O,this.menuAction[this.menuSize]=651,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=u,this.menuSize++;for(let b=0;b<this.menuSize;b++)if(this.menuAction[b]===660){this.menuOption[b]="Walk here @whi@"+O;break}}getCombatLevelTag(_,R){let E=_-R;if(E<-9)return"@red@";else if(E<-6)return"@or3@";else if(E<-3)return"@or2@";else if(E<0)return"@or1@";else if(E>9)return"@gre@";else if(E>6)return"@gr3@";else if(E>3)return"@gr2@";else if(E>0)return"@gr1@";else return"@yel@"}drawInterface(_,R,E,u){if(_.type!==0||!_.children||_.hide&&this.viewportHoveredInterfaceIndex!==_.id&&this.sidebarHoveredInterfaceIndex!==_.id&&this.chatHoveredInterfaceIndex!==_.id)return;let O=I.left,b=I.top,L=I.right,N=I.bottom;I.setBounds(R,E,R+_.width,E+_.height);let G=_.children.length;for(let H=0;H<G;H++){if(!_.childX||!_.childY)continue;let Q=_.childX[H]+R,$=_.childY[H]+E-u,J=g.types[_.children[H]];if(Q+=J.x,$+=J.y,J.clientCode>0)this.updateInterfaceContent(J);if(J.type===0){if(J.scrollPosition>J.scroll-J.height)J.scrollPosition=J.scroll-J.height;if(J.scrollPosition<0)J.scrollPosition=0;if(this.drawInterface(J,Q,$,J.scrollPosition),J.scroll>J.height)this.drawScrollbar(Q+J.width,$,J.scrollPosition,J.scroll,J.height)}else if(J.type===2){let T=0;for(let m=0;m<J.height;m++)for(let q=0;q<J.width;q++){if(!J.invSlotOffsetX||!J.invSlotOffsetY||!J.invSlotObjId||!J.invSlotObjCount)continue;let K=Q+q*(J.marginX+32),F=$+m*(J.marginY+32);if(T<20)K+=J.invSlotOffsetX[T],F+=J.invSlotOffsetY[T];if(J.invSlotObjId[T]>0){let w=0,k=0,Y=J.invSlotObjId[T]-1;if(K>I.left-32&&K<I.right&&F>I.top-32&&F<I.bottom||this.objDragArea!==0&&this.objDragSlot===T){let A=0;if(this.objSelected==1&&this.objSelectedSlot==T&&this.objSelectedInterface==J.id)A=16777215;let h=x.getIcon(Y,J.invSlotObjCount[T],A);if(h){if(this.objDragArea!==0&&this.objDragSlot===T&&this.objDragInterfaceId===J.id){if(w=this.mouseX-this.objGrabX,k=this.mouseY-this.objGrabY,w<5&&w>-5)w=0;if(k<5&&k>-5)k=0;if(this.objDragCycles<5)w=0,k=0;if(h.drawAlpha(128,K+w,F+k),F+k<I.top&&_.scrollPosition>0){let Z=(I.top-F-k)*this.sceneDelta/3;if(Z>this.sceneDelta*10)Z=this.sceneDelta*10;if(Z>_.scrollPosition)Z=_.scrollPosition;_.scrollPosition-=Z,this.objGrabY+=Z}if(F+k+32>I.bottom&&_.scrollPosition<_.scroll-_.height){let Z=(F+k+32-I.bottom)*this.sceneDelta/3;if(Z>this.sceneDelta*10)Z=this.sceneDelta*10;if(Z>_.scroll-_.height-_.scrollPosition)Z=_.scroll-_.height-_.scrollPosition;_.scrollPosition+=Z,this.objGrabY-=Z}}else if(this.selectedArea!==0&&this.selectedItem===T&&this.selectedInterface===J.id)h.drawAlpha(128,K,F);else h.draw(K,F);if(h.width===33||J.invSlotObjCount[T]!==1){let Z=J.invSlotObjCount[T];this.fontPlain11?.drawString(K+w+1,F+10+k,this.formatObjCount(Z),0),this.fontPlain11?.drawString(K+w,F+9+k,this.formatObjCount(Z),16776960)}}}}else if(J.invSlotGraphic&&T<20)J.invSlotGraphic[T]?.draw(K,F);T++}}else if(J.type===3){let T=!1;if(this.chatHoveredInterfaceIndex===J.id||this.sidebarHoveredInterfaceIndex===J.id||this.viewportHoveredInterfaceIndex===J.id)T=!0;let m=0;if(this.executeInterfaceScript(J)){if(m=J.activeColour,T&&J.activeOverColour!==0)m=J.activeOverColour}else if(m=J.colour,T&&J.overColour!==0)m=J.overColour;if(J.alpha===0)if(J.fill)I.fillRect2d(Q,$,J.width,J.height,m);else I.drawRect(Q,$,J.width,J.height,m);else if(J.fill)I.fillRectAlpha(Q,$,J.width,J.height,m,256-(J.alpha&255));else I.drawRect(Q,$,J.width,J.height,m),I.drawRectAlpha(Q,$,J.width,J.height,m,256-(J.alpha&255))}else if(J.type===4){let{font:T,text:m}=J,q=!1;if(this.chatHoveredInterfaceIndex===J.id||this.sidebarHoveredInterfaceIndex===J.id||this.viewportHoveredInterfaceIndex===J.id)q=!0;let K=0;if(this.executeInterfaceScript(J)){if(K=J.activeColour,q&&J.activeOverColour!==0)K=J.activeOverColour;if(J.activeText&&J.activeText.length>0)m=J.activeText}else if(K=J.colour,q&&J.overColour!==0)K=J.overColour;if(J.buttonType===6&&this.pressedContinueOption)m="Please wait...",K=J.colour;if(I.width2d==479){if(K==16776960)K=255;if(K==49152)K=16777215}if(!T||!m)continue;for(let F=$+T.height2d;m.length>0;F+=T.height2d){if(m.indexOf("%")!==-1){do{let Y=m.indexOf("%1");if(Y===-1)break;m=m.substring(0,Y)+this.getIntString(this.executeClientScript(J,0))+m.substring(Y+2)}while(!0);do{let Y=m.indexOf("%2");if(Y===-1)break;m=m.substring(0,Y)+this.getIntString(this.executeClientScript(J,1))+m.substring(Y+2)}while(!0);do{let Y=m.indexOf("%3");if(Y===-1)break;m=m.substring(0,Y)+this.getIntString(this.executeClientScript(J,2))+m.substring(Y+2)}while(!0);do{let Y=m.indexOf("%4");if(Y===-1)break;m=m.substring(0,Y)+this.getIntString(this.executeClientScript(J,3))+m.substring(Y+2)}while(!0);do{let Y=m.indexOf("%5");if(Y===-1)break;m=m.substring(0,Y)+this.getIntString(this.executeClientScript(J,4))+m.substring(Y+2)}while(!0)}let w=m.indexOf("\\n"),k;if(w!==-1)k=m.substring(0,w),m=m.substring(w+2);else k=m,m="";if(J.center)T.drawStringTaggableCenter(Q+(J.width/2|0),F,k,K,J.shadowed);else T.drawStringTaggable(Q,F,k,K,J.shadowed)}}else if(J.type===5){let T;if(this.executeInterfaceScript(J))T=J.activeGraphic;else T=J.graphic;T?.draw(Q,$)}else if(J.type===6){let T=X.centerX,m=X.centerY;X.centerX=Q+(J.width/2|0),X.centerY=$+(J.height/2|0);let q=X.sinTable[J.xan]*J.zoom>>16,K=X.cosTable[J.xan]*J.zoom>>16,F=this.executeInterfaceScript(J),w;if(F)w=J.activeAnim;else w=J.anim;let k=null;if(w===-1)k=J.getModel(-1,-1,F,this.localPlayer);else{let Y=e.types[w];if(Y.frames&&Y.iframes)k=J.getModel(Y.frames[J.seqFrame],Y.iframes[J.seqFrame],F,this.localPlayer)}if(k)k.drawSimple(0,J.yan,0,J.xan,0,q,K);X.centerX=T,X.centerY=m}else if(J.type===7){let T=J.font;if(!T||!J.invSlotObjId||!J.invSlotObjCount)continue;let m=0;for(let q=0;q<J.height;q++)for(let K=0;K<J.width;K++){if(J.invSlotObjId[m]>0){let F=x.get(J.invSlotObjId[m]-1),w=F.name;if(F.stackable||J.invSlotObjCount[m]!==1)w=w+" x"+this.formatObjCountTagged(J.invSlotObjCount[m]);if(!w)continue;let k=Q+K*(J.marginX+115),Y=$+q*(J.marginY+12);if(J.center)T.drawStringTaggableCenter(k+(J.width/2|0),Y,w,J.colour,J.shadowed);else T.drawStringTaggable(k,Y,w,J.colour,J.shadowed)}m++}}}I.setBounds(O,b,L,N)}drawScrollbar(_,R,E,u,O){this.imageScrollbar0?.draw(_,R),this.imageScrollbar1?.draw(_,R+O-16),I.fillRect2d(_,R+16,16,O-32,2301979);let b=(O-32)*O/u|0;if(b<8)b=8;let L=(O-b-32)*E/(u-O)|0;I.fillRect2d(_,R+L+16,16,b,5063219),I.drawVerticalLine(_,R+L+16,7759444,b),I.drawVerticalLine(_+1,R+L+16,7759444,b),I.drawHorizontalLine(_,R+L+16,7759444,16),I.drawHorizontalLine(_,R+L+17,7759444,16),I.drawVerticalLine(_+15,R+L+16,3353893,b),I.drawVerticalLine(_+14,R+L+17,3353893,b-1),I.drawHorizontalLine(_,R+L+b+15,3353893,16),I.drawHorizontalLine(_+1,R+L+b+14,3353893,15)}formatObjCount(_){if(_<1e5)return String(_);else if(_<1e7)return(_/1000|0)+"K";else return(_/1e6|0)+"M"}formatObjCountTagged(_){let R=String(_);for(let E=R.length-3;E>0;E-=3)R=R.substring(0,E)+","+R.substring(E);if(R.length>8)R="@gre@"+R.substring(0,R.length-8)+" million @whi@("+R+")";else if(R.length>4)R="@cya@"+R.substring(0,R.length-4)+"K @whi@("+R+")";return" "+R}handleScrollInput(_,R,E,u,O,b,L,N){if(this.scrollGrabbed)this.scrollInputPadding=32;else this.scrollInputPadding=0;if(this.scrollGrabbed=!1,_>=b&&_<b+16&&R>=L&&R<L+16){if(N.scrollPosition-=this.dragCycles*4,O)this.redrawSidebar=!0}else if(_>=b&&_<b+16&&R>=L+u-16&&R<L+u){if(N.scrollPosition+=this.dragCycles*4,O)this.redrawSidebar=!0}else if(_>=b-this.scrollInputPadding&&_<b+this.scrollInputPadding+16&&R>=L+16&&R<L+u-16&&this.dragCycles>0){let G=(u-32)*u/E|0;if(G<8)G=8;let H=R-L-(G/2|0)-16,Q=u-G-32;if(N.scrollPosition=(E-u)*H/Q|0,O)this.redrawSidebar=!0;this.scrollGrabbed=!0}}getIntString(_){return _<999999999?String(_):"*"}executeInterfaceScript(_){if(!_.scriptComparator)return!1;for(let R=0;R<_.scriptComparator.length;R++){if(!_.scriptOperand)return!1;let E=this.executeClientScript(_,R),u=_.scriptOperand[R];if(_.scriptComparator[R]===2){if(E>=u)return!1}else if(_.scriptComparator[R]===3){if(E<=u)return!1}else if(_.scriptComparator[R]===4){if(E===u)return!1}else if(E!==u)return!1}return!0}executeClientScript(_,R){if(!_.scripts||R>=_.scripts.length)return-2;try{let E=_.scripts[R];if(!E)return-1;let u=0,O=0;while(!0){let b=E[O++];if(b===0)return u;if(b===1)u+=this.skillLevel[E[O++]];else if(b===2)u+=this.skillBaseLevel[E[O++]];else if(b===3)u+=this.skillExperience[E[O++]];else if(b===4){let L=g.types[E[O++]],N=E[O++]+1;if(L.invSlotObjId&&L.invSlotObjCount){for(let G=0;G<L.invSlotObjId.length;G++)if(L.invSlotObjId[G]===N)u+=L.invSlotObjCount[G]}else u+=0}else if(b===5)u+=this.varps[E[O++]];else if(b===6)u+=this.levelExperience[this.skillBaseLevel[E[O++]]-1];else if(b===7)u+=this.varps[E[O++]]*100/46875|0;else if(b===8)u+=this.localPlayer?.combatLevel||0;else if(b===9)for(let L=0;L<19;L++){if(L===18)L=20;u+=this.skillBaseLevel[L]}else if(b===10){let L=g.types[E[O++]],N=E[O++]+1;if(L.invSlotObjId){for(let G=0;G<L.invSlotObjId.length;G++)if(L.invSlotObjId[G]===N){u+=999999999;break}}}else if(b===11)u+=this.runenergy;else if(b===12)u+=this.runweight;else if(b===13){let L=this.varps[E[O++]],N=E[O++];u+=(L&1<<N)===0?0:1}}}catch(E){return-1}}handleInterfaceInput(_,R,E,u,O,b){if(_.type!==0||!_.children||_.hide||R<u||E<O||R>u+_.width||E>O+_.height||!_.childX||!_.childY)return;let L=_.children.length;for(let N=0;N<L;N++){let G=_.childX[N]+u,H=_.childY[N]+O-b,Q=g.types[_.children[N]];if(G+=Q.x,H+=Q.y,(Q.overlayer>=0||Q.overColour!==0)&&R>=G&&E>=H&&R<G+Q.width&&E<H+Q.height)if(Q.overlayer>=0)this.lastHoveredInterfaceId=Q.overlayer;else this.lastHoveredInterfaceId=Q.id;if(Q.type===0){if(this.handleInterfaceInput(Q,R,E,G,H,Q.scrollPosition),Q.scroll>Q.height)this.handleScrollInput(R,E,Q.scroll,Q.height,!0,G+Q.width,H,Q)}else if(Q.type===2){let $=0;for(let J=0;J<Q.height;J++)for(let T=0;T<Q.width;T++){let m=G+T*(Q.marginX+32),q=H+J*(Q.marginY+32);if($<20&&Q.invSlotOffsetX&&Q.invSlotOffsetY)m+=Q.invSlotOffsetX[$],q+=Q.invSlotOffsetY[$];if(R<m||E<q||R>=m+32||E>=q+32){$++;continue}if(this.hoveredSlot=$,this.hoveredSlotParentId=Q.id,!Q.invSlotObjId||Q.invSlotObjId[$]<=0){$++;continue}let K=x.get(Q.invSlotObjId[$]-1);if(this.objSelected===1&&Q.interactable){if(Q.id!==this.objSelectedInterface||$!==this.objSelectedSlot)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+K.name,this.menuAction[this.menuSize]=881,this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=$,this.menuParamC[this.menuSize]=Q.id,this.menuSize++}else if(this.spellSelected===1&&Q.interactable){if((this.activeSpellFlags&16)===16)this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+K.name,this.menuAction[this.menuSize]=391,this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=$,this.menuParamC[this.menuSize]=Q.id,this.menuSize++}else{if(Q.interactable){for(let F=4;F>=3;F--)if(K.iop&&K.iop[F]){if(this.menuOption[this.menuSize]=K.iop[F]+" @lre@"+K.name,F===3)this.menuAction[this.menuSize]=478;else if(F===4)this.menuAction[this.menuSize]=347;this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=$,this.menuParamC[this.menuSize]=Q.id,this.menuSize++}else if(F===4)this.menuOption[this.menuSize]="Drop @lre@"+K.name,this.menuAction[this.menuSize]=347,this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=$,this.menuParamC[this.menuSize]=Q.id,this.menuSize++}if(Q.usable)this.menuOption[this.menuSize]="Use @lre@"+K.name,this.menuAction[this.menuSize]=188,this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=$,this.menuParamC[this.menuSize]=Q.id,this.menuSize++;if(Q.interactable&&K.iop){for(let F=2;F>=0;F--)if(K.iop[F]){if(this.menuOption[this.menuSize]=K.iop[F]+" @lre@"+K.name,F===0)this.menuAction[this.menuSize]=405;else if(F===1)this.menuAction[this.menuSize]=38;else if(F===2)this.menuAction[this.menuSize]=422;this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=$,this.menuParamC[this.menuSize]=Q.id,this.menuSize++}}if(Q.iop){for(let F=4;F>=0;F--)if(Q.iop[F]){if(this.menuOption[this.menuSize]=Q.iop[F]+" @lre@"+K.name,F===0)this.menuAction[this.menuSize]=602;else if(F===1)this.menuAction[this.menuSize]=596;else if(F===2)this.menuAction[this.menuSize]=22;else if(F===3)this.menuAction[this.menuSize]=892;else if(F===4)this.menuAction[this.menuSize]=415;this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=$,this.menuParamC[this.menuSize]=Q.id,this.menuSize++}}if(this.menuOption[this.menuSize]="Examine @lre@"+K.name,this.menuAction[this.menuSize]=1773,this.menuParamA[this.menuSize]=K.id,Q.invSlotObjCount)this.menuParamC[this.menuSize]=Q.invSlotObjCount[$];this.menuSize++}$++}}else if(R>=G&&E>=H&&R<G+Q.width&&E<H+Q.height){if(Q.buttonType===1){let $=!1;if(Q.clientCode!==0)$=this.handleSocialMenuOption(Q);if(!$&&Q.option)this.menuOption[this.menuSize]=Q.option,this.menuAction[this.menuSize]=951,this.menuParamC[this.menuSize]=Q.id,this.menuSize++}else if(Q.buttonType===2&&this.spellSelected===0){let $=Q.targetVerb;if($&&$.indexOf(" ")!==-1)$=$.substring(0,$.indexOf(" "));this.menuOption[this.menuSize]=$+" @gre@"+Q.targetText,this.menuAction[this.menuSize]=930,this.menuParamC[this.menuSize]=Q.id,this.menuSize++}else if(Q.buttonType===3)this.menuOption[this.menuSize]="Close",this.menuAction[this.menuSize]=947,this.menuParamC[this.menuSize]=Q.id,this.menuSize++;else if(Q.buttonType===4&&Q.option)this.menuOption[this.menuSize]=Q.option,this.menuAction[this.menuSize]=465,this.menuParamC[this.menuSize]=Q.id,this.menuSize++;else if(Q.buttonType===5&&Q.option)this.menuOption[this.menuSize]=Q.option,this.menuAction[this.menuSize]=960,this.menuParamC[this.menuSize]=Q.id,this.menuSize++;else if(Q.buttonType===6&&!this.pressedContinueOption&&Q.option)this.menuOption[this.menuSize]=Q.option,this.menuAction[this.menuSize]=44,this.menuParamC[this.menuSize]=Q.id,this.menuSize++}}}handleSocialMenuOption(_){let R=_.clientCode;if(R>=1&&R<=200||R>=701&&R<=900){if(R>=801)R-=701;else if(R>=701)R-=601;else if(R>=101)R-=101;else R--;return this.menuOption[this.menuSize]="Remove @whi@"+this.friendName[R],this.menuAction[this.menuSize]=557,this.menuSize++,this.menuOption[this.menuSize]="Message @whi@"+this.friendName[R],this.menuAction[this.menuSize]=679,this.menuSize++,!0}else if(R>=401&&R<=500)return this.menuOption[this.menuSize]="Remove @whi@"+_.text,this.menuAction[this.menuSize]=556,this.menuSize++,!0;return!1}resetInterfaceAnimation(_){let R=g.types[_];if(!R.children)return;for(let E=0;E<R.children.length&&R.children[E]!==-1;E++){let u=g.types[R.children[E]];if(u.type===1)this.resetInterfaceAnimation(u.id);u.seqFrame=0,u.seqCycle=0}}updateInterfaceAnimation(_,R){let E=g.types[_];if(!E.children)return!1;let u=!1;for(let O=0;O<E.children.length&&E.children[O]!==-1;O++){let b=g.types[E.children[O]];if(b.type===1)u||=this.updateInterfaceAnimation(b.id,R);if(b.type===6&&(b.anim!==-1||b.activeAnim!==-1)){let L=this.executeInterfaceScript(b),N;if(L)N=b.activeAnim;else N=b.anim;if(N!==-1){let G=e.types[N];b.seqCycle+=R;while(b.seqCycle>G.getFrameDuration(b.seqFrame)){if(b.seqCycle-=G.getFrameDuration(b.seqFrame)+1,b.seqFrame++,b.seqFrame>=G.frameCount){if(b.seqFrame-=G.loops,b.seqFrame<0||b.seqFrame>=G.frameCount)b.seqFrame=0}u=!0}}}}return u}updateVarp(_){let R=D0.types[_].clientcode;if(R===0)return;let E=this.varps[_];if(R===1){if(E===1)X.initColourTable(0.9);else if(E===2)X.initColourTable(0.8);else if(E===3)X.initColourTable(0.7);else if(E===4)X.initColourTable(0.6);x.iconCache?.clear(),this.redrawFrame=!0}else if(R===3){let u=this.midiActive;if(E===0)this.midiVolume=128,M1(128),this.midiActive=!0;else if(E===1)this.midiVolume=96,M1(96),this.midiActive=!0;else if(E===2)this.midiVolume=64,M1(64),this.midiActive=!0;else if(E===3)this.midiVolume=32,M1(32),this.midiActive=!0;else if(E===4)this.midiActive=!1;if(this.midiActive!==u){if(this.midiActive)this.midiSong=this.nextMidiSong,this.midiFading=!1,this.onDemand?.request(2,this.midiSong);else N_(!1);this.nextMusicDelay=0}}else if(R===4){if(E===0)this.waveVolume=128,X1(128),this.waveEnabled=!0;else if(E===1)this.waveVolume=96,X1(96),this.waveEnabled=!0;else if(E===2)this.waveVolume=64,X1(64),this.waveEnabled=!0;else if(E===3)this.waveVolume=32,X1(32),this.waveEnabled=!0;else if(E===4)this.waveEnabled=!1}else if(R===5)this.oneMouseButton=E;else if(R===6)this.chatEffects=E;else if(R===8)this.splitPrivateChat=E,this.redrawChatback=!0;else if(R===9)this.bankArrangeMode=E}updateInterfaceContent(_){let R=_.clientCode;if(R>=1&&R<=100||R>=701&&R<=800){if(R>700)R-=601;else R--;if(R>=this.friendCount)_.text="",_.buttonType=0;else _.text=this.friendName[R],_.buttonType=1}else if(R>=101&&R<=200||R>=801&&R<=900){if(R>800)R-=701;else R-=101;if(R>=this.friendCount)_.text="",_.buttonType=0;else{if(this.friendWorld[R]===0)_.text="@red@Offline";else if(this.friendWorld[R]===s.nodeId)_.text="@gre@World-"+(this.friendWorld[R]-9);else _.text="@yel@World-"+(this.friendWorld[R]-9);_.buttonType=1}}else if(R===203){if(_.scroll=this.friendCount*15+20,_.scroll<=_.height)_.scroll=_.height+1}else if(R>=401&&R<=500)if(R-=401,R>=this.ignoreCount)_.text="",_.buttonType=0;else _.text=c.formatName(c.fromBase37(this.ignoreName37[R])),_.buttonType=1;else if(R===503){if(_.scroll=this.ignoreCount*15+20,_.scroll<=_.height)_.scroll=_.height+1}else if(R===327){if(_.xan=150,_.yan=(Math.sin(this.loopCycle/40)*256|0)&2047,this.updateDesignModel){for(let b=0;b<7;b++){let L=this.designKits[b];if(L>=0&&!U0.types[L].modelIsReady())return}this.updateDesignModel=!1;let E=new C(7,null),u=0;for(let b=0;b<7;b++){let L=this.designKits[b];if(L>=0)E[u++]=U0.types[L].getModel()}let O=U.modelFromModels(E,u);for(let b=0;b<5;b++)if(this.designColours[b]!==0){if(O.recolour(J0.DESIGN_IDK_COLORS[b][0],J0.DESIGN_IDK_COLORS[b][this.designColours[b]]),b===1)O.recolour(J0.TORSO_RECOLORS[0],J0.TORSO_RECOLORS[this.designColours[b]])}if(O.createLabelReferences(),O.calculateNormals(64,850,-30,-50,-30,!0),this.localPlayer){let b=e.types[this.localPlayer.readyanim].frames;if(b)O.applyTransform(b[0])}_.modelType=5,_.model=0,g.cacheModel(O,5,0)}}else if(R===324){if(!this.genderButtonImage0)this.genderButtonImage0=_.graphic,this.genderButtonImage1=_.activeGraphic;if(this.designGender)_.graphic=this.genderButtonImage1;else _.graphic=this.genderButtonImage0}else if(R===325){if(!this.genderButtonImage0)this.genderButtonImage0=_.graphic,this.genderButtonImage1=_.activeGraphic;if(this.designGender)_.graphic=this.genderButtonImage0;else _.graphic=this.genderButtonImage1}else if(R===600)if(_.text=this.reportAbuseInput,this.loopCycle%20<10)_.text=_.text+"|";else _.text=_.text+" ";else if(R===613)if(this.staffmodlevel<1)_.text="";else if(this.reportAbuseMuteOption)_.colour=16711680,_.text="Moderator option: Mute player for 48 hours: <ON>";else _.colour=16777215,_.text="Moderator option: Mute player for 48 hours: <OFF>";else if(R===650||R===655)if(this.lastAddress===0)_.text="";else{let E;if(this.daysSinceLastLogin===0)E="earlier today";else if(this.daysSinceLastLogin===1)E="yesterday";else E=this.daysSinceLastLogin+" days ago";let u=c.formatIPv4(this.lastAddress);_.text="You last logged in "+E+(u==="127.0.0.1"?".":" from: "+u)}else if(R===651){if(this.unreadMessages===0)_.text="0 unread messages",_.colour=16776960;else if(this.unreadMessages===1)_.text="1 unread message",_.colour=65280;else if(this.unreadMessages>1)_.text=this.unreadMessages+" unread messages",_.colour=65280}else if(R===652)if(this.daysSinceRecoveriesChanged===201)if(this.warnMembersInNonMembers==1)_.text="@yel@This is a non-members world: @whi@Since you are a member we";else _.text="";else if(this.daysSinceRecoveriesChanged===200)_.text="You have not yet set any password recovery questions.";else{let E;if(this.daysSinceRecoveriesChanged===0)E="Earlier today";else if(this.daysSinceRecoveriesChanged===1)E="Yesterday";else E=this.daysSinceRecoveriesChanged+" days ago";_.text=E+" you changed your recovery questions"}else if(R===653)if(this.daysSinceRecoveriesChanged===201)if(this.warnMembersInNonMembers==1)_.text="@whi@recommend you use a members world instead. You may use";else _.text="";else if(this.daysSinceRecoveriesChanged===200)_.text="We strongly recommend you do so now to secure your account.";else _.text="If you do not remember making this change then cancel it immediately";else if(R===654)if(this.daysSinceRecoveriesChanged===201)if(this.warnMembersInNonMembers==1)_.text="@whi@this world but member benefits are unavailable whilst here.";else _.text="";else if(this.daysSinceRecoveriesChanged===200)_.text="Do this from the 'account management' area on our front webpage";else _.text="Do this from the 'account management' area on our front webpage"}handleInterfaceAction(_){let R=_.clientCode;if(R===201)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=1,this.socialMessage="Enter name of friend to add to list";else if(R===202)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=2,this.socialMessage="Enter name of friend to delete from list";else if(R===205)return this.idleTimeout=250,!0;else if(R===501)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=4,this.socialMessage="Enter name of player to add to list";else if(R===502)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=5,this.socialMessage="Enter name of player to delete from list";else if(R>=300&&R<=313){let E=(R-300)/2|0,u=R&1,O=this.designKits[E];if(O!==-1)while(!0){if(u===0){if(O--,O<0)O=U0.count-1}if(u===1){if(O++,O>=U0.count)O=0}if(!U0.types[O].disable&&U0.types[O].type===E+(this.designGender?0:7)){this.designKits[E]=O,this.updateDesignModel=!0;break}}}else if(R>=314&&R<=323){let E=(R-314)/2|0,u=R&1,O=this.designColours[E];if(u===0){if(O--,O<0)O=J0.DESIGN_IDK_COLORS[E].length-1}if(u===1){if(O++,O>=J0.DESIGN_IDK_COLORS[E].length)O=0}this.designColours[E]=O,this.updateDesignModel=!0}else if(R===324&&!this.designGender)this.designGender=!0,this.validateCharacterDesign();else if(R===325&&this.designGender)this.designGender=!1,this.validateCharacterDesign();else if(R===326){this.out.p1isaac(150),this.out.p1(this.designGender?0:1);for(let E=0;E<7;E++)this.out.p1(this.designKits[E]);for(let E=0;E<5;E++)this.out.p1(this.designColours[E]);return!0}else if(R===613)this.reportAbuseMuteOption=!this.reportAbuseMuteOption;else if(R>=601&&R<=612){if(this.closeInterfaces(),this.reportAbuseInput.length>0)this.out.p1isaac(205),this.out.p8(c.toBase37(this.reportAbuseInput)),this.out.p1(R-601),this.out.p1(this.reportAbuseMuteOption?1:0)}return!1}validateCharacterDesign(){this.updateDesignModel=!0;for(let _=0;_<7;_++){this.designKits[_]=-1;for(let R=0;R<U0.count;R++)if(!U0.types[R].disable&&U0.types[R].type===_+(this.designGender?0:7)){this.designKits[_]=R;break}}}drawSidebar(){if(this.areaSidebar?.bind(),this.areaSidebarOffsets)X.lineOffset=this.areaSidebarOffsets;if(this.imageInvback?.draw(0,0),this.sidebarInterfaceId!==-1)this.drawInterface(g.types[this.sidebarInterfaceId],0,0,0);else if(this.tabInterfaceId[this.selectedTab]!==-1)this.drawInterface(g.types[this.tabInterfaceId[this.selectedTab]],0,0,0);if(this.menuVisible&&this.menuArea===1)this.drawMenu();if(this.areaSidebar?.draw(553,205),this.areaViewport?.bind(),this.areaViewportOffsets)X.lineOffset=this.areaViewportOffsets}drawChat(){if(this.areaChatback?.bind(),this.areaChatbackOffsets)X.lineOffset=this.areaChatbackOffsets;if(this.imageChatback?.draw(0,0),this.showSocialInput)this.fontBold12?.drawStringCenter(239,40,this.socialMessage,0),this.fontBold12?.drawStringCenter(239,60,this.socialInput+"*",128);else if(this.chatbackInputOpen)this.fontBold12?.drawStringCenter(239,40,"Enter amount:",0),this.fontBold12?.drawStringCenter(239,60,this.chatbackInput+"*",128);else if(this.modalMessage)this.fontBold12?.drawStringCenter(239,40,this.modalMessage,0),this.fontBold12?.drawStringCenter(239,60,"Click to continue",128);else if(this.chatInterfaceId!==-1)this.drawInterface(g.types[this.chatInterfaceId],0,0,0);else if(this.stickyChatInterfaceId!==-1)this.drawInterface(g.types[this.stickyChatInterfaceId],0,0,0);else{let _=this.fontPlain12,R=0;I.setBounds(0,0,463,77);for(let u=0;u<100;u++){let O=this.messageText[u];if(!O)continue;let b=this.messageType[u],L=this.chatScrollOffset+70-R*14,N=this.messageSender[u],G=0;if(N&&N.startsWith("@cr1@"))N=N.substring(5),G=1;else if(N&&N.startsWith("@cr2@"))N=N.substring(5),G=2;if(b===0){if(L>0&&L<110)_?.drawString(4,L,O,0);R++}else if((b===1||b===2)&&(b===1||this.chatPublicMode===0||this.chatPublicMode===1&&this.isFriend(N))){if(L>0&&L<110){let H=4;if(G==1)this.imageModIcons[0].draw(H,L-12),H+=14;else if(G==2)this.imageModIcons[1].draw(H,L-12),H+=14;_?.drawString(H,L,N+":",0),H+=(_?.stringWidth(N)??0)+8,_?.drawString(H,L,O,255)}R++}else if((b===3||b===7)&&this.splitPrivateChat===0&&(b===7||this.chatPrivateMode===0||this.chatPrivateMode===1&&this.isFriend(N))){if(L>0&&L<110){let H=4;if(_?.drawString(H,L,"From ",0),H+=_?.stringWidth("From ")??0,G==1)this.imageModIcons[0].draw(H,L-12),H+=14;else if(G==2)this.imageModIcons[1].draw(H,L-12),H+=14;_?.drawString(H,L,N+":",0),H+=(_?.stringWidth(N)??0)+8,_?.drawString(H,L,O,8388608)}R++}else if(b===4&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(N))){if(L>0&&L<110)_?.drawString(4,L,N+" "+this.messageText[u],8388736);R++}else if(b===5&&this.splitPrivateChat===0&&this.chatPrivateMode<2){if(L>0&&L<110)_?.drawString(4,L,O,8388608);R++}else if(b===6&&this.splitPrivateChat===0&&this.chatPrivateMode<2){if(L>0&&L<110)_?.drawString(4,L,"To "+N+":",0),_?.drawString(_.stringWidth("To "+N)+12,L,O,8388608);R++}else if(b===8&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(N))){if(L>0&&L<110)_?.drawString(4,L,N+" "+this.messageText[u],8270336);R++}}if(I.resetBounds(),this.chatScrollHeight=R*14+7,this.chatScrollHeight<78)this.chatScrollHeight=78;this.drawScrollbar(463,0,this.chatScrollHeight-this.chatScrollOffset-77,this.chatScrollHeight,77);let E;if(this.localPlayer==null||this.localPlayer.name==null)E=c.formatName(this.username);else E=this.localPlayer.name;_?.drawString(4,90,E+":",0),_?.drawString(_.stringWidth(E+": ")+6,90,this.chatTyped+"*",255),I.drawHorizontalLine(0,77,0,479)}if(this.menuVisible&&this.menuArea===2)this.drawMenu();if(this.areaChatback?.draw(17,357),this.areaViewport?.bind(),this.areaViewportOffsets)X.lineOffset=this.areaViewportOffsets}drawMinimap(){if(!this.localPlayer)return;this.areaMapback?.bind();let _=this.orbitCameraYaw+this.macroMinimapAngle&2047,R=(this.localPlayer.x/32|0)+48,E=464-(this.localPlayer.z/32|0);this.imageMinimap?.drawRotatedMasked(25,5,146,151,this.minimapMaskLineOffsets,this.minimapMaskLineLengths,R,E,_,this.macroMinimapZoom+256),this.imageCompass?.drawRotatedMasked(0,0,33,33,this.compassMaskLineOffsets,this.compassMaskLineLengths,25,25,this.orbitCameraYaw,256);for(let u=0;u<this.activeMapFunctionCount;u++)R=this.activeMapFunctionX[u]*4+2-(this.localPlayer.x/32|0),E=this.activeMapFunctionZ[u]*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(E,this.activeMapFunctions[u],R);for(let u=0;u<104;u++)for(let O=0;O<104;O++)if(this.objStacks[this.currentLevel][u][O])R=u*4+2-(this.localPlayer.x/32|0),E=O*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(E,this.imageMapdot0,R);for(let u=0;u<this.npcCount;u++){let O=this.npcs[this.npcIds[u]];if(O&&O.isVisible()&&O.type&&O.type.minimap)R=(O.x/32|0)-(this.localPlayer.x/32|0),E=(O.z/32|0)-(this.localPlayer.z/32|0),this.drawOnMinimap(E,this.imageMapdot1,R)}for(let u=0;u<this.playerCount;u++){let O=this.players[this.playerIds[u]];if(O&&O.isVisible()&&O.name){R=(O.x/32|0)-(this.localPlayer.x/32|0),E=(O.z/32|0)-(this.localPlayer.z/32|0);let b=!1,L=c.toBase37(O.name);for(let N=0;N<this.friendCount;N++)if(L===this.friendName37[N]&&this.friendWorld[N]!==0){b=!0;break}if(b)this.drawOnMinimap(E,this.imageMapdot3,R);else this.drawOnMinimap(E,this.imageMapdot2,R)}}if(this.hintType!=0&&this.loopCycle%20<10){if(this.hintType==1&&this.hintNpc>=0&&this.hintNpc<this.npcs.length){let u=this.npcs[this.hintNpc];if(u!=null){let O=(u.x/32|0)-(this.localPlayer.x/32|0),b=(u.z/32|0)-(this.localPlayer.z/32|0);this.drawMinimapHint(O,b,this.imageMapmarker1)}}else if(this.hintType==2){let u=(this.hintTileX-this.sceneBaseTileX)*4+2-(this.localPlayer.x/32|0),O=(this.hintTileZ-this.sceneBaseTileZ)*4+2-(this.localPlayer.z/32|0);this.drawMinimapHint(u,O,this.imageMapmarker1)}else if(this.hintType==10&&this.hintPlayer>=0&&this.hintPlayer<this.players.length){let u=this.players[this.hintPlayer];if(u!=null){let O=(u.x/32|0)-(this.localPlayer.x/32|0),b=(u.z/32|0)-(this.localPlayer.z/32|0);this.drawMinimapHint(O,b,this.imageMapmarker1)}}}if(this.flagSceneTileX!==0)R=this.flagSceneTileX*4+2-(this.localPlayer.x/32|0),E=this.flagSceneTileZ*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(E,this.imageMapmarker0,R);I.fillRect2d(97,78,3,3,16777215),this.areaViewport?.bind()}drawMinimapHint(_,R,E){if(!E)return;let u=_*_+R*R;if(u<=4225||u>=90000){this.drawOnMinimap(R,E,_);return}let O=this.orbitCameraYaw+this.macroMinimapAngle&2047,b=X.sinTable[O],L=X.cosTable[O];b=b*256/(this.macroMinimapZoom+256)|0,L=L*256/(this.macroMinimapZoom+256)|0;let N=R*b+_*L>>16,G=R*L-_*b>>16,H=Math.atan2(N,G),Q=Math.sin(H)*63|0,$=Math.cos(H)*57|0;this.imageMapedge?.drawRotated(83-$-20,H,256,15,15,20,20,Q+94+4-10)}drawOnMinimap(_,R,E){if(!R)return;let u=E*E+_*_;if(u>6400)return;let O=this.orbitCameraYaw+this.macroMinimapAngle&2047,b=X.sinTable[O],L=X.cosTable[O];b=b*256/(this.macroMinimapZoom+256)|0,L=L*256/(this.macroMinimapZoom+256)|0;let N=_*b+E*L>>16,G=_*L-E*b>>16;if(u>2500&&this.imageMapback)R.drawMasked(N+94-(R.width/2|0)+4,83-G-(R.height/2|0)-4,this.imageMapback);else R.draw(N+94-(R.width/2|0)+4,83-G-(R.height/2|0)-4)}addMessage(_,R,E){if(_===0&&this.stickyChatInterfaceId!==-1)this.modalMessage=R,this.mouseClickButton=0;if(this.chatInterfaceId===-1)this.redrawChatback=!0;for(let u=99;u>0;u--)this.messageType[u]=this.messageType[u-1],this.messageSender[u]=this.messageSender[u-1],this.messageText[u]=this.messageText[u-1],this.messageTick[u]=this.messageTick[u-1];this.messageType[0]=_,this.messageSender[0]=E,this.messageText[0]=R,this.messageTick[0]=this.loopCycle}isFriend(_){if(!_)return!1;for(let R=0;R<this.friendCount;R++)if(_.toLowerCase()===this.friendName[R]?.toLowerCase())return!0;if(!this.localPlayer)return!1;return _.toLowerCase()===this.localPlayer.name?.toLowerCase()}addFriend(_){if(_===0n)return;if(this.friendCount>=100&&this.membersAccount!=1){this.addMessage(0,"Your friendlist is full. Max of 100 for free users, and 200 for members","");return}else if(this.friendCount>=200){this.addMessage(0,"Your friendlist is full. Max of 100 for free users, and 200 for members","");return}let R=c.formatName(c.fromBase37(_));for(let E=0;E<this.friendCount;E++)if(this.friendName37[E]===_){this.addMessage(0,R+" is already on your friend list","");return}for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===_){this.addMessage(0,"Please remove "+R+" from your ignore list first","");return}if(!this.localPlayer||!this.localPlayer.name)return;if(R!==this.localPlayer.name)this.friendName[this.friendCount]=R,this.friendName37[this.friendCount]=_,this.friendWorld[this.friendCount]=0,this.friendCount++,this.redrawSidebar=!0,this.out.p1isaac(116),this.out.p8(_)}removeFriend(_){if(_===0n)return;for(let R=0;R<this.friendCount;R++)if(this.friendName37[R]===_){this.friendCount--,this.redrawSidebar=!0;for(let E=R;E<this.friendCount;E++)this.friendName[E]=this.friendName[E+1],this.friendWorld[E]=this.friendWorld[E+1],this.friendName37[E]=this.friendName37[E+1];this.out.p1isaac(61),this.out.p8(_);return}}addIgnore(_){if(_===0n)return;if(this.ignoreCount>=100){this.addMessage(0,"Your ignore list is full. Max of 100 hit","");return}let R=c.formatName(c.fromBase37(_));for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===_){this.addMessage(0,R+" is already on your ignore list","");return}for(let E=0;E<this.friendCount;E++)if(this.friendName37[E]===_){this.addMessage(0,"Please remove "+R+" from your friend list first","");return}this.ignoreName37[this.ignoreCount++]=_,this.redrawSidebar=!0,this.out.p1isaac(20),this.out.p8(_)}removeIgnore(_){if(_===0n)return;for(let R=0;R<this.ignoreCount;R++)if(this.ignoreName37[R]===_){this.ignoreCount--,this.redrawSidebar=!0;for(let E=R;E<this.ignoreCount;E++)this.ignoreName37[E]=this.ignoreName37[E+1];this.out.p1isaac(4),this.out.p8(_);return}}unloadTitle(){if(this.flameActive=!1,this.flamesInterval)clearInterval(this.flamesInterval),this.flamesInterval=null;this.imageTitlebox=null,this.imageTitlebutton=null,this.imageRunes=[],this.flameGradient=null,this.flameGradient0=null,this.flameGradient1=null,this.flameGradient2=null,this.flameBuffer0=null,this.flameBuffer1=null,this.flameBuffer3=null,this.flameBuffer2=null,this.imageFlamesLeft=null,this.imageFlamesRight=null}runFlames(){if(!this.flameActive)return;this.flameCycle++,this.updateFlames(),this.updateFlames(),this.drawFlames()}updateFlames(){if(!this.flameBuffer3||!this.flameBuffer2||!this.flameBuffer0||!this.flameLineOffset)return;let _=256;for(let R=10;R<117;R++)if((Math.random()*100|0)<50)this.flameBuffer3[R+(_-2<<7)]=255;for(let R=0;R<100;R++){let E=(Math.random()*124|0)+2,u=(Math.random()*128|0)+128,O=E+(u<<7);this.flameBuffer3[O]=192}for(let R=1;R<_-1;R++)for(let E=1;E<127;E++){let u=E+(R<<7);this.flameBuffer2[u]=(this.flameBuffer3[u-1]+this.flameBuffer3[u+1]+this.flameBuffer3[u-128]+this.flameBuffer3[u+128])/4|0}if(this.flameCycle0+=128,this.flameCycle0>this.flameBuffer0.length)this.flameCycle0-=this.flameBuffer0.length,this.updateFlameBuffer(this.imageRunes[Math.random()*12|0]);for(let R=1;R<_-1;R++)for(let E=1;E<127;E++){let u=E+(R<<7),O=this.flameBuffer2[u+128]-(this.flameBuffer0[u+this.flameCycle0&this.flameBuffer0.length-1]/5|0);if(O<0)O=0;this.flameBuffer3[u]=O}for(let R=0;R<_-1;R++)this.flameLineOffset[R]=this.flameLineOffset[R+1];if(this.flameLineOffset[_-1]=Math.sin(this.loopCycle/14)*16+Math.sin(this.loopCycle/15)*14+Math.sin(this.loopCycle/16)*12|0,this.flameGradientCycle0>0)this.flameGradientCycle0-=4;if(this.flameGradientCycle1>0)this.flameGradientCycle1-=4;if(this.flameGradientCycle0===0&&this.flameGradientCycle1===0){let R=Math.random()*2000|0;if(R===0)this.flameGradientCycle0=1024;else if(R===1)this.flameGradientCycle1=1024}}updateFlameBuffer(_){if(!this.flameBuffer0||!this.flameBuffer1)return;let R=256;this.flameBuffer0.fill(0);for(let E=0;E<5000;E++){let u=Math.random()*128*R|0;this.flameBuffer0[u]=Math.random()*256|0}for(let E=0;E<20;E++){for(let O=1;O<R-1;O++)for(let b=1;b<127;b++){let L=b+(O<<7);this.flameBuffer1[L]=(this.flameBuffer0[L-1]+this.flameBuffer0[L+1]+this.flameBuffer0[L-128]+this.flameBuffer0[L+128])/4|0}let u=this.flameBuffer0;this.flameBuffer0=this.flameBuffer1,this.flameBuffer1=u}if(_){let E=0;for(let u=0;u<_.height2d;u++)for(let O=0;O<_.width2d;O++)if(_.pixels[E++]!==0){let b=O+_.cropX+16,L=u+_.cropY+16,N=b+(L<<7);this.flameBuffer0[N]=0}}}drawFlames(){if(!this.flameGradient||!this.flameGradient0||!this.flameGradient1||!this.flameGradient2||!this.flameLineOffset||!this.flameBuffer3)return;let _=256;if(this.flameGradientCycle0>0)for(let u=0;u<256;u++)if(this.flameGradientCycle0>768)this.flameGradient[u]=this.mix(this.flameGradient0[u],1024-this.flameGradientCycle0,this.flameGradient1[u]);else if(this.flameGradientCycle0>256)this.flameGradient[u]=this.flameGradient1[u];else this.flameGradient[u]=this.mix(this.flameGradient1[u],256-this.flameGradientCycle0,this.flameGradient0[u]);else if(this.flameGradientCycle1>0)for(let u=0;u<256;u++)if(this.flameGradientCycle1>768)this.flameGradient[u]=this.mix(this.flameGradient0[u],1024-this.flameGradientCycle1,this.flameGradient2[u]);else if(this.flameGradientCycle1>256)this.flameGradient[u]=this.flameGradient2[u];else this.flameGradient[u]=this.mix(this.flameGradient2[u],256-this.flameGradientCycle1,this.flameGradient0[u]);else for(let u=0;u<256;u++)this.flameGradient[u]=this.flameGradient0[u];for(let u=0;u<33920;u++)if(this.imageTitle0&&this.imageFlamesLeft)this.imageTitle0.pixels[u]=this.imageFlamesLeft.pixels[u];let R=0,E=1152;for(let u=1;u<_-1;u++){let b=(this.flameLineOffset[u]*(_-u)/_|0)+22;if(b<0)b=0;R+=b;for(let L=b;L<128;L++){let N=this.flameBuffer3[R++];if(N===0)E++;else{let G=N,H=256-N;if(N=this.flameGradient[N],this.imageTitle0){let Q=this.imageTitle0.pixels[E];this.imageTitle0.pixels[E++]=((N&16711935)*G+(Q&16711935)*H&4278255360)+((N&65280)*G+(Q&65280)*H&16711680)>>8}}}E+=b}this.imageTitle0?.draw(0,0);for(let u=0;u<33920;u++)if(this.imageTitle1&&this.imageFlamesRight)this.imageTitle1.pixels[u]=this.imageFlamesRight.pixels[u];R=0,E=1176;for(let u=1;u<_-1;u++){let O=this.flameLineOffset[u]*(_-u)/_|0,b=103-O;E+=O;for(let L=0;L<b;L++){let N=this.flameBuffer3[R++];if(N===0)E++;else{let G=N,H=256-N;if(N=this.flameGradient[N],this.imageTitle1){let Q=this.imageTitle1.pixels[E];this.imageTitle1.pixels[E++]=((N&16711935)*G+(Q&16711935)*H&4278255360)+((N&65280)*G+(Q&65280)*H&16711680)>>8}}}R+=128-b,E+=128-b-O}if(this.imageTitle1?.draw(637,0),this.isMobile)F0.draw()}mix(_,R,E){let u=256-R;return((_&16711935)*u+(E&16711935)*R&4278255360)+((_&65280)*u+(E&65280)*R&16711680)>>8}getTitleScreenState(){return this.titleScreenState}isChatBackInputOpen(){return this.chatbackInputOpen}isShowSocialInput(){return this.showSocialInput}getChatInterfaceId(){return this.chatInterfaceId}getViewportInterfaceId(){return this.viewportInterfaceId}getReportAbuseInterfaceId(){return this.reportAbuseInterfaceId}getBotState(){if(this.botOverlay)return this.botOverlay.getState();return null}}export{s as Client};

//# debugId=24A41202CC66C13164756E2164756E21
